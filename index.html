<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


    <title>帽子小猫cat</title>
    <link rel="stylesheet" href="style.css">
  
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="./manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">



<style>
    /* 强制禁止全局横向滚动 */
    html, body {
        overflow-x: hidden !important;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        background: #ffffff;
    }
    
    /* 强制禁止聊天列表和详情页横向滚动 */
    #chatDetailScreen, 
    #messagesContainer {
        overflow-x: hidden !important;
    }
    
    .phone-screen {
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        overflow: hidden !important;
        border-radius: 0 !important;
        flex-shrink: 0;
    }
</style>


</head>
<body>
    <div class="phone-screen">
        <!-- 主屏幕 -->
        <div class="main-screen" id="mainScreen">
            <div class="user-info" onclick="openEditModal()">
                <div class="avatar" id="mainAvatar">👤</div>
                <div class="user-id" id="mainUserId">我的小手机</div>
                <div class="signature" id="mainSignature">今天也要开心呀～</div>
            </div>
            
<div class="apps-grid">
    <div class="app-icon-wrapper">
        <div class="app-icon" onclick="openApp('world')">
            <div class="app-emoji ins-icon-box" id="icon-world">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
            </div>
        </div>
        <div class="app-name">世界书</div>
    </div>

    <div class="app-icon-wrapper">
        <div class="app-icon" onclick="openApp('chat')">
            <div class="app-emoji ins-icon-box" id="icon-chat">
                <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            </div>
        </div>
        <div class="app-name">聊天</div>
    </div>

    <div class="app-icon-wrapper">
        <div class="app-icon" onclick="openApp('wallpaper')">
            <div class="app-emoji ins-icon-box" id="icon-wallpaper">
                <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </div>
        </div>
        <div class="app-name">壁纸</div>
    </div>

    <div class="app-icon-wrapper">
        <div class="app-icon" onclick="openApp('api')">
            <div class="app-emoji ins-icon-box" id="icon-api">
                <svg viewBox="0 0 24 24"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
            </div>
        </div>
        <div class="app-name">API设置</div>
    </div>

    <div class="app-icon-wrapper">
    <div class="app-icon" onclick="openApp('otherSettings')">

            <div class="app-emoji ins-icon-box" id="icon-placeholder1">
                <svg viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
            </div>
        </div>
        <div class="app-name">其他设置</div>
    </div>

    <div class="app-icon-wrapper">
        <div class="app-icon" onclick="openApp('placeholder2')">
            <div class="app-emoji ins-icon-box" id="icon-placeholder2">
                <svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
            </div>
        </div>
        <div class="app-name">贴叭</div>
    </div>

    <div class="app-icon-wrapper">
        <div class="app-icon" onclick="openApp('placeholder3')">
            <div class="app-emoji ins-icon-box" id="icon-placeholder3">
                <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </div>
        </div>
        <div class="app-name">x</div>
    </div>

    <div class="app-icon-wrapper">
        <div class="app-icon" onclick="openApp('placeholder4')">
            <div class="app-emoji ins-icon-box" id="icon-placeholder4">
                <svg viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"></rect><path d="M6 12h4m-2-2v4"></path><line x1="15" y1="11" x2="15.01" y2="11"></line><line x1="18" y1="13" x2="18.01" y2="13"></line></svg>
            </div>
        </div>
        <div class="app-name">监控</div>
    </div>
</div>
<div class="widgets-row">
           <div class="widget-box music-widget" onclick="openWidgetSettings('music')">
    <div class="music-ring">
        <!-- 音乐封面图片 -->
        <img id="musicCoverDisplay" class="music-cover-img" style="display:none;" alt="音乐封面">
        <!-- 播放按钮（如果需要的话） -->
        <div class="music-icon" style="display:none;">▶</div>
    </div>
    <div class="music-title">Lover</div>
    <div class="music-desc">Taylor Swift</div>
</div>


             <div class="widget-box note-widget note-image-widget" onclick="openWidgetSettings('note')">
    <div class="note-image-frame" id="noteImageFrame">
        <img id="noteImageDisplay" class="note-image" style="display:none;" alt="">
    </div>
</div>

            </div>
  
            
            <div class="bottom-space"></div>

        </div>

        <!-- 壁纸设置页面 -->
     <div class="wallpaper-screen" id="wallpaperScreen">
    <div class="api-header" style="background: transparent; border: none; padding: 20px;">
        <button class="back-btn" onclick="backToMain()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
        <div class="header-title" style="font-weight: 700; letter-spacing: 1px;">WALLPAPER</div>
    </div>
    
    <div class="api-content" style="padding: 0 20px 40px;">
        
        <div class="api-card">
            <div class="api-section-title">
                <span>🎨 PREVIEW</span>
                <span>当前效果</span>
            </div>
            
            <div style="display: flex; gap: 20px; align-items: flex-start;">
                <div class="ins-phone-frame" id="wallpaperPreview">
                    </div>
                
                <div style="flex: 1;">
                    <div class="ins-tab-group">
                        <button class="ins-tab-btn active" onclick="switchTab('local')">相册</button>
                        <button class="ins-tab-btn" onclick="switchTab('url')">链接</button>
                    </div>
                    
                    <div class="tab-content active" id="localTab">
                        <div class="ins-upload-area" onclick="document.getElementById('wallpaperFile').click()">
                            <div class="ins-upload-icon">📁</div>
                            <div style="font-size: 12px; color: #999;">点击选择图片</div>
                            <input type="file" id="wallpaperFile" accept="image/*" style="display:none;">
                        </div>
                    </div>
                    
                    <div class="tab-content" id="urlTab">
                        <input type="url" class="ins-input" id="wallpaperUrl" placeholder="输入图片链接...">
                    </div>
                    
                    <button class="ins-line-btn ins-btn-black" onclick="saveWallpaper()" style="margin-top: 15px; width: 100%;">
                        <span>保存壁纸</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="api-card">
            <div class="api-section-title">
                <span>📱 ICONS</span>
                <span>图标定制</span>
            </div>
            
            <div class="ins-icon-grid">
                <div class="ins-icon-item" onclick="openIconEditor('world')">
                    <div class="ins-icon-preview-box" id="preview-world">🌍</div>
                    <div style="font-size: 11px; color: #999;">世界书</div>
                </div>
                <div class="ins-icon-item" onclick="openIconEditor('chat')">
                    <div class="ins-icon-preview-box" id="preview-chat">💬</div>
                    <div style="font-size: 11px; color: #999;">聊天</div>
                </div>
                <div class="ins-icon-item" onclick="openIconEditor('wallpaper')">
                    <div class="ins-icon-preview-box" id="preview-wallpaper">🎨</div>
                    <div style="font-size: 11px; color: #999;">壁纸</div>
                </div>
                <div class="ins-icon-item" onclick="openIconEditor('api')">
                    <div class="ins-icon-preview-box" id="preview-api">⚙️</div>
                    <div style="font-size: 11px; color: #999;">API</div>
                </div>
                
                <div class="ins-icon-item" onclick="openIconEditor('placeholder1')">
                    <div class="ins-icon-preview-box" id="preview-placeholder1">📱</div>
                    <div style="font-size: 11px; color: #999;">围脖</div>
                </div>
                <div class="ins-icon-item" onclick="openIconEditor('placeholder2')">
                    <div class="ins-icon-preview-box" id="preview-placeholder2">🎵</div>
                    <div style="font-size: 11px; color: #999;">贴叭</div>
                </div>
                <div class="ins-icon-item" onclick="openIconEditor('placeholder3')">
                    <div class="ins-icon-preview-box" id="preview-placeholder3">📷</div>
                    <div style="font-size: 11px; color: #999;">x</div>
                </div>
                <div class="ins-icon-item" onclick="openIconEditor('placeholder4')">
                    <div class="ins-icon-preview-box" id="preview-placeholder4">🎮</div>
                    <div style="font-size: 11px; color: #999;">监控</div>
                </div>
            </div>
        </div>
        
    </div>
</div>
      <!-- 世界书页面 -->
<div class="worldbook-screen" id="worldbookScreen">
<div class="api-header" style="background: transparent; border: none; padding: 20px;">
        <button class="back-btn" onclick="backToMain()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
        <div class="header-title" style="font-weight: 700; letter-spacing: 1px;">WORLDBOOK</div>
    </div>
    
    <div class="ins-category-scroll" id="categoryTags">
        </div>
    
    <div class="worldbook-content ins-book-list" id="worldbookList">
        </div>
    
    <button class="ins-float-add" onclick="openAddWorldbook()">+</button>
</div>
      <!-- API设置页面 -->

<div class="api-screen" id="apiScreen">
<div class="api-header" style="background: transparent; border: none;">
        <button class="back-btn" onclick="backToMain()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
        <div class="header-title" style="font-weight: 700; letter-spacing: 1px;">SETTINGS</div>
    </div>
    
    <div class="api-content">
        <div class="api-card">
            <div class="api-section-title">
                <span>⚡ SCHEME</span>
                <span>方案管理</span>
            </div>
            
            <div class="ins-input-group">
                <select id="apiSchemeSelect" class="ins-input" style="appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 15px center; background-size: 10px;">
                    <option value="">选择方案</option>
                </select>
            </div>
            
            <div class="ins-btn-row">
                <button class="ins-line-btn" onclick="newScheme()">
                    <span>+ 新建</span>
                </button>
                <button class="ins-line-btn ins-btn-red-line" onclick="deleteScheme()">
                    <span>🗑 删除</span>
                </button>
            </div>
        </div>
        
        <div class="api-card">
            <div class="api-section-title">
                <span>⚙️ CONFIG</span>
                <span>核心配置</span>
            </div>
            
            <div class="ins-input-group">
                <label class="ins-label">方案名称</label>
                <input type="text" id="apiName" class="ins-input" placeholder="给方案起个名字...">
            </div>
            
            <div class="ins-input-group">
                <label class="ins-label">API 接口地址 (Base URL)</label>
                <input type="url" id="apiBaseUrl" class="ins-input" placeholder="https://api.openai.com/v1">
            </div>
            
            <div class="ins-input-group">
                <label class="ins-label">API 密钥 (Key)</label>
                <input type="password" id="apiKey" class="ins-input" placeholder="sk-...">
            </div>

            <button class="ins-line-btn ins-btn-blue-line" onclick="getModels()" style="width: 100%; margin-top: 5px;">
                📡 点击获取模型列表
            </button>
            
            <div class="ins-input-group" id="modelGroup" style="display: none; margin-top: 15px;">
                <label class="ins-label">选择模型</label>
                <select id="modelSelect" class="ins-input">
                </select>
            </div>
        </div>
        
        <div class="api-footer-actions">
            <div class="ins-btn-row">
                <button class="ins-line-btn" onclick="testConnection()">
                    <span>⚡ 测试连接</span>
                </button>
                <button class="ins-line-btn" onclick="saveAsScheme()">
                    <span>💾 另存为</span>
                </button>
            </div>
            
            <button class="ins-line-btn ins-btn-black" onclick="saveConfig()" style="padding: 16px;">
                <span>确认保存当前配置</span>
            </button>
        </div>
    </div>
</div>

      <!-- 其他设置页面 (新加) -->
<div class="api-screen" id="otherSettingsScreen">
    <div class="api-header" style="background: transparent; border: none;">
        <button class="back-btn" onclick="backToMain()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
        <div class="header-title" style="font-weight: 700; letter-spacing: 1px;">OTHERS</div>
    </div>
    
    <div class="api-content">
        <!-- 第一组：系统与数据 -->
        <div class="api-card">
            <div class="api-section-title">
                <span>🛠 SYSTEM</span>
                <span>通用设置</span>
            </div>
            
            <div class="ins-list-group" style="margin: 0;">
                <!-- 1. 字体设置 -->
                <div class="ins-list-item" onclick="openFontSettings()">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>
                    <div class="ins-item-label">字体设置</div>
                    <div class="ins-arrow">›</div>
                </div>

                <!-- 2. 备份管理 -->
                <div class="ins-list-item" onclick="openBackupSettings()">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    <div class="ins-item-label">备份管理</div>
                    <div class="ins-arrow">›</div>
                </div>

                <!-- 3. 清除缓存 -->
                <div class="ins-list-item" onclick="clearAppCache()" style="border-bottom: none;">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    <div class="ins-item-label">清除缓存</div>
                    <div class="ins-arrow">›</div>
                </div>
                    <!-- 4. 初始化所有数据 -->
                <div class="ins-list-item" onclick="openResetModal()" style="border-bottom: none;">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="#ff4757" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
                    <div class="ins-item-label" style="color: #ff4757;">初始化所有数据</div>
                    <div class="ins-arrow">›</div>
                </div>
            </div>
        </div>

        <!-- 第二组：个性化与声音 -->
        <div class="api-card">
            <div class="api-section-title">
                <span>🎨 PERSONAL</span>
                <span>个性化</span>
            </div>

            <div class="ins-list-group" style="margin: 0;">
                <!-- 4. 美化设置 -->
                <div class="ins-list-item" onclick="openBeautifySettings()">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M14.31 8l5.74 9.94"/><path d="M9.69 8h11.48"/><path d="M7.38 12l5.74-9.94"/><path d="M9.69 16L3.95 6.06"/><path d="M14.31 16H2.83"/><path d="M16.62 12l-5.74 9.94"/></svg>
                    <div class="ins-item-label">美化设置</div>
                    <div class="ins-arrow">›</div>
                </div>

                <!-- 5. 角色语音 -->
                <div class="ins-list-item" onclick="openVoiceRoleSettings()">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    <div class="ins-item-label">角色语音</div>
                    <div class="ins-arrow">›</div>
                </div>

                <!-- 6. 消息提示音 -->
                <div class="ins-list-item" onclick="openNotificationSoundSettings()" style="border-bottom: none;">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    <div class="ins-item-label">消息提示音</div>
                    <div class="ins-arrow">›</div>
                </div>
            </div>
        </div>
        
        <!-- 底部版本号占位，增加专业感 -->
        <div style="text-align: center; color: #ccc; font-size: 12px; margin-top: 20px;">
            Version 1.0.0
        </div>
    </div>
</div>
<div class="api-screen" id="beautifySettingsScreen">
    <!-- 1. 顶部导航栏 (保持和其他设置一致) -->
    <div class="api-header" style="background: transparent; border: none;">
        <button class="back-btn" onclick="backToOtherSettings()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
        <div class="header-title" style="font-weight: 700; letter-spacing: 1px;">BEAUTIFY</div>
    </div>
    
    <!-- 2. 内容区域 (确保包含 api-content 类) -->
    <div class="api-content">
        
        <!-- 卡片容器 (确保包含 api-card 类) -->
        <div class="api-card">
            <div class="api-section-title">
                <span>🎨 THEME</span>
                <span>界面风格</span>
            </div>
            
            <div class="ins-list-group" style="margin: 0;">
      
            <!-- 1. 导航栏透明 (带开关) -->
                <div class="ins-list-item">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line></svg>
                    <div class="ins-item-label">导航栏透明</div>
                    <!-- 开关 -->
                    <input type="checkbox" id="navTransparentToggle" onchange="toggleNavTransparency(this)" style="accent-color: #333; transform: scale(1.2); cursor: pointer;">
                </div>

                             <!-- 2. 角色列表美化 -->
                <div class="ins-list-item" onclick="openCharListBeautify()">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <div class="ins-item-label">角色列表美化</div>
                    <div style="font-size: 12px; color: #ccc; font-weight: 700; margin-right: 4px; font-family: sans-serif;">GO</div>
                    <div class="ins-arrow">›</div>
                </div>

                              <!-- 3. 导航栏字体颜色 -->
                <div class="ins-list-item" onclick="openNavColorModal()">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
                    <div class="ins-item-label">导航栏字体颜色</div>
                    <div class="ins-arrow">›</div>
                </div>


                           <!-- 4. 对话页面美化 -->
                <div class="ins-list-item" onclick="openChatScreenBeautify()">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    <div class="ins-item-label">对话页面美化</div>
                    <div style="font-size: 12px; color: #ccc; font-weight: 700; margin-right: 4px; font-family: sans-serif;">GO</div>
                    <div class="ins-arrow">›</div>
                </div>


                         <!-- 5. 气泡美化 -->
                <div class="ins-list-item" onclick="openBubbleBeautify()" style="border-bottom: none;">
                    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    <div class="ins-item-label">气泡美化</div>
                    <div style="font-size: 12px; color: #ccc; font-weight: 700; margin-right: 4px; font-family: sans-serif;">GO</div>
                    <div class="ins-arrow">›</div>
                </div>



            </div>
        </div>
        
        <!-- 新增：整套方案管理 -->
        <div class="api-card" style="margin-top: 20px; border: 1px solid #333; background: #fff;">
            <div class="api-section-title">
                <span>SCHEMES</span>
                <span>主题预设</span>
            </div>
            
            <div style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.5;">
                将当前所有美化设置（列表、对话、气泡、导航栏）保存为一个方案。
            </div>

            <!-- 方案列表容器 -->
            <div id="themeSchemeList" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                <!-- JS 动态生成 -->
            </div>

            <button class="ins-line-btn ins-btn-black" onclick="saveCurrentThemeScheme()" style="width: 100%; padding: 14px;">
                <span>+ 保存当前所有设置</span>
            </button>
        </div>



    </div>
</div>

<!-- 角色列表美化编辑器 -->
<div class="api-screen" id="charListBeautifyScreen">
    <div class="api-header" style="background: transparent; border: none;">
        <button class="back-btn" onclick="backToBeautifySettings()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
        <div class="header-title" style="font-weight: 700; letter-spacing: 1px;">LIST STYLE</div>
        <!-- 恢复默认按钮 -->
        <button class="back-btn" onclick="resetCharListEditor()" style="width: auto; padding: 0 10px; font-size: 12px; border-radius: 16px; border: 1px solid #eee; color: #666;">恢复</button>
    </div>
    
    <div class="api-content" style="display: flex; flex-direction: column; height: 100%;">
        
           <!-- 1. 预览区域 (更新版) -->
        <div style="flex: none; display: flex; justify-content: center; margin-bottom: 20px;">
            <!-- ID 必须是 clPreviewFrame -->
            <div class="ins-phone-frame" id="clPreviewFrame" style="background: #f8f9fa; position: relative; display: flex; flex-direction: column; background-size: cover; background-position: center;">
                <!-- 模拟导航栏 -->
                <div id="clPreviewHeader" style="height: 50px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.95); background-size: cover; background-position: center;">
                    聊天
                </div>
                <!-- 模拟内容 -->
                <div style="flex: 1; padding: 10px; overflow: hidden;">
                    <div style="background: rgba(255,255,255,0.8); height: 40px; border-radius: 10px; margin-bottom: 8px;"></div>
                    <div style="background: rgba(255,255,255,0.8); height: 40px; border-radius: 10px; margin-bottom: 8px;"></div>
                    <div style="background: rgba(255,255,255,0.8); height: 40px; border-radius: 10px;"></div>
                </div>
                              <!-- 模拟底部栏 -->
                <div id="clPreviewBottom" style="height: 40px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: center; background: rgba(255,255,255,0.85); background-size: cover; background-position: center;">
                    <!-- 给这三个加 ID -->
                    <div id="clPreviewIcon1" class="cl-preview-icon" style="width: 20px; height: 20px; background: #999; border-radius: 4px; background-size: contain; background-repeat: no-repeat; background-position: center;"></div>
                    <div id="clPreviewIcon2" class="cl-preview-icon" style="width: 20px; height: 20px; background: #999; border-radius: 50%; background-size: contain; background-repeat: no-repeat; background-position: center;"></div>
                    <div id="clPreviewIcon3" class="cl-preview-icon" style="width: 20px; height: 20px; background: #999; border-radius: 4px; background-size: contain; background-repeat: no-repeat; background-position: center;"></div>
                </div>

            </div>
        </div>


        <!-- 2. 控制区域 (Tab切换) -->
        <div class="ins-tab-group">
            <button class="ins-tab-btn active" onclick="switchCLTab('global')">全局背景</button>
            <button class="ins-tab-btn" onclick="switchCLTab('header')">导航栏</button>
            <button class="ins-tab-btn" onclick="switchCLTab('bottom')">底部栏</button>
            <button class="ins-tab-btn" onclick="switchCLTab('icons')">图标</button>
        </div>

        <!-- Tab 内容容器 -->
        <div id="clTabContent" style="flex: 1;">
            <!-- 动态生成内容 -->
        </div>

        <!-- 3. 底部按钮 -->
        <button class="ins-line-btn ins-btn-black" onclick="applyCharListBeautify()" style="margin-top: 20px; padding: 16px;">
            <span>使用美化</span>
        </button>
    </div>
</div>

<!-- 对话页面美化编辑器 -->
<div class="api-screen" id="chatScreenBeautifyScreen">
    <div class="api-header" style="background: transparent; border: none;">
        <button class="back-btn" onclick="backToBeautifySettings_Chat()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
        <div class="header-title" style="font-weight: 700; letter-spacing: 1px;">CHAT STYLE</div>
        <button class="back-btn" onclick="resetChatScreenEditor()" style="width: auto; padding: 0 10px; font-size: 12px; border-radius: 16px; border: 1px solid #eee; color: #666;">恢复</button>
    </div>
    
    <div class="api-content" style="display: flex; flex-direction: column; height: 100%;">
        
        <!-- 1. 预览区域 -->
        <div style="flex: none; display: flex; justify-content: center; margin-bottom: 20px;">
            <div class="ins-phone-frame" id="csPreviewFrame" style="background: #f8f9fa; position: relative; display: flex; flex-direction: column; background-size: cover; background-position: center;">
                <!-- 模拟导航栏 -->
                <div id="csPreviewHeader" style="height: 50px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; padding: 0 15px; font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.95); background-size: cover; background-position: center;">
                    <div style="width: 20px;">←</div>
                    <div style="flex: 1; text-align: left; margin-left: 10px;">张三</div>
                    <div style="width: 20px;">...</div>
                </div>
                <!-- 模拟内容 -->
                <div style="flex: 1; padding: 10px; display: flex; flex-direction: column; justify-content: flex-end; gap: 10px;">
                    <div style="align-self: flex-start; background: white; padding: 8px 12px; border-radius: 12px; font-size: 12px; max-width: 70%;">你好呀！</div>
                    <div style="align-self: flex-end; background: #333; color: white; padding: 8px 12px; border-radius: 12px; font-size: 12px; max-width: 70%;">今天天气不错。</div>
                </div>
                <!-- 模拟底部栏 -->
                <div id="csPreviewBottom" style="height: 50px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; padding: 0 10px; gap: 8px; background: white; background-size: cover; background-position: center;">
                    <div id="csPreviewIconPlus" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; background-size: contain; background-position: center; background-repeat: no-repeat;">+</div>
                    <div style="flex: 1; height: 30px; border: 1px solid #eee; border-radius: 15px; background: rgba(255,255,255,0.5);"></div>
                    <div id="csPreviewIconSend" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; background-size: contain; background-position: center; background-repeat: no-repeat;">➤</div>
                    <div id="csPreviewIconReceive" style="width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; background-size: contain; background-position: center; background-repeat: no-repeat;">✉</div>
                </div>
            </div>
        </div>

        <!-- 2. 控制区域 -->
        <div class="ins-tab-group">
            <button class="ins-tab-btn active" onclick="switchCSTab('global')">背景</button>
            <button class="ins-tab-btn" onclick="switchCSTab('header')">导航栏</button>
            <button class="ins-tab-btn" onclick="switchCSTab('bottom')">底部栏</button>
            <button class="ins-tab-btn" onclick="switchCSTab('icons')">图标</button>
        </div>

        <div id="csTabContent" style="flex: 1;">
            <!-- 动态内容 -->
        </div>

        <!-- 3. 底部按钮 -->
        <button class="ins-line-btn ins-btn-black" onclick="applyChatScreenBeautify()" style="margin-top: 20px; padding: 16px;">
            <span>✨ 使用美化</span>
        </button>
    </div>
</div>

<!-- 气泡美化编辑器 (结构修复版) -->
<div class="api-screen" id="bubbleBeautifyScreen">
    <div class="api-header" style="background: transparent; border: none;">
        <button class="back-btn" onclick="backToBeautifySettings_Bubble()"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
        <div class="header-title" style="font-weight: 700; letter-spacing: 1px;">BUBBLE STYLE</div>
        <button class="back-btn" onclick="resetBubbleEditor()" style="width: auto; padding: 0 10px; font-size: 12px; border-radius: 16px; border: 1px solid #eee; color: #666;">恢复</button>
    </div>
    
    <div class="api-content" style="padding-bottom: 40px;">
        
               <!-- 1. 预览区域 (卡片样式版) -->
        <div class="api-card" style="position: sticky; top: 0; z-index: 100; margin-bottom: 20px; border: 1px solid #eaeaea; box-shadow: 0 8px 20px rgba(0,0,0,0.06);">
            
            <div style="font-size: 10px; color: #999; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 700; letter-spacing: 1px;">PREVIEW</span>
                <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">👀 实时效果</span>
            </div>
            
            <!-- 模拟聊天背景容器 (灰色背景，让白色气泡更明显) -->
            <div id="bubblePreviewContainer" style="background: #f5f7f9; border-radius: 12px; padding: 20px 15px; display: flex; flex-direction: column; gap: 15px; min-height: 120px; justify-content: center;">
                <!-- AI 气泡 -->
                <div class="message-item" style="margin: 0;">
                    <div class="message-bubble ai-preview-bubble">
                        你好呀！
                    </div>
                </div>
                
                <!-- 用户气泡 -->
                <div class="message-item me" style="margin: 0;">
                    <div class="message-bubble user-preview-bubble">
                        气泡样式预览
                    </div>
                </div>
            </div>
        </div>




        <!-- 2. 我的预设库 -->
        <div class="api-section-title" style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
            <span>🔖 我的预设库</span>
            <span style="font-size: 10px; color: #999;">预设可滑动</span>
        </div>
        
        <div style="display: flex; gap: 10px; overflow-x: auto; padding: 5px 2px 15px 2px; scrollbar-width: none; flex-shrink: 0;" id="bubblePresetList">
            <!-- 动态生成 -->
        </div>

        <!-- 3. 编辑模式切换 -->
        <div class="ins-tab-group" style="margin-top: 15px;">
            <button class="ins-tab-btn active" onclick="switchBubbleTab('ai')">左侧 (对方)</button>
            <button class="ins-tab-btn" onclick="switchBubbleTab('user')">右侧 (我)</button>
        </div>

        <!-- 4. 气泡制作器开关 -->
        <div class="ins-list-item" style="margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 15px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center;">
                <span style="font-size: 18px; margin-right: 8px;">🛠️</span>
                <div class="ins-item-label" style="font-weight: 600;">启用气泡制作器</div>
            </div>
            <input type="checkbox" id="bubbleCreatorToggle" onchange="toggleBubbleCreator(this)" style="accent-color: #333; transform: scale(1.2); cursor: pointer;">
        </div>

        <!-- 5. 气泡制作器面板 -->
        <div id="bubbleCreatorPanel" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 16px; border: 1px solid #eee; margin-top: 10px;">
            

<!-- 🎨 基础外观 -->
<div style="font-size: 12px; color: #999; margin-bottom: 10px; font-weight: 600;">🎨 基础外观</div>

<div style="display: flex; gap: 15px; margin-bottom: 15px;">
  <!-- 背景色 -->
  <div style="flex: 1;">
    <div style="font-size: 11px; margin-bottom: 8px; color: #666;">背景色</div>
    <div 
      id="creatorBgPreview" 
      onclick="document.getElementById('creatorBgPicker').click()" 
      style="width: 100%; height: 38px; background: #ffffff; cursor: pointer; border: 1px solid #e0e0e0;"
    ></div>
    <input type="color" id="creatorBgPicker" value="#ffffff" style="display: none;" oninput="updateColorFromPicker('bg', this.value)">
  </div>

  <!-- 文字色 -->
  <div style="flex: 1;">
    <div style="font-size: 11px; margin-bottom: 8px; color: #666;">文字色</div>
    <div 
      id="creatorTextPreview" 
      onclick="document.getElementById('creatorTextPicker').click()" 
      style="width: 100%; height: 38px; background: #1a1a1a; cursor: pointer; border: 1px solid #e0e0e0;"
    ></div>
    <input type="color" id="creatorTextPicker" value="#1a1a1a" style="display: none;" oninput="updateColorFromPicker('text', this.value)">
  </div>
</div>



            
<!-- 气泡质感 -->
<div style="margin-bottom: 15px;">
    <div style="font-size: 11px; margin-bottom: 5px; color: #666;">气泡质感</div>
    <select id="creatorEffect"
            class="ins-input"
            style="width: 100%; font-size: 12px;"
            onchange="generateBubbleCSS()">
        <option value="none">无</option>
        <option value="glass">拟态玻璃</option>
        <option value="highlight">高光短横线</option>
        <option value="jelly">果冻拟态</option>
    </select>
</div>


                       <!-- 圆角 (无数字版) -->
            <div style="margin-bottom: 15px;">
                <div style="font-size: 11px; margin-bottom: 5px; color: #666;">圆角大小</div>
                <!-- 注意：oninput 里去掉了更新文字的代码 -->
                <input type="range" id="creatorRadius" min="0" max="30" value="18" style="width: 100%; accent-color: #667eea;" oninput="generateBubbleCSS()">
            </div>

            <!-- 内边距 (无数字版) -->
            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <div style="font-size: 11px; margin-bottom: 5px; color: #666;">水平胖瘦</div>
                    <input type="range" id="creatorPadX" min="5" max="40" value="12" style="width: 100%; accent-color: #667eea;" oninput="generateBubbleCSS()">
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 11px; margin-bottom: 5px; color: #666;">垂直高矮</div>
                    <input type="range" id="creatorPadY" min="5" max="40" value="8" style="width: 100%; accent-color: #667eea;" oninput="generateBubbleCSS()">
                </div>
            </div>


            <!-- 多图层贴纸系统 -->
            <div style="font-size: 12px; color: #999; margin-bottom: 10px; font-weight: 600; border-top: 1px dashed #ddd; padding-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span>🖼️ 贴纸图层 (可叠加)</span>
                <button class="ins-line-btn" onclick="addNewStickerLayer()" style="padding: 4px 10px; font-size: 11px; border-radius: 12px;">+ 添加贴纸</button>
            </div>
            
            <div id="stickerLayerList" style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 5px; scrollbar-width: none; min-height: 40px;">
                <!-- JS 动态生成 -->
            </div>

            <div id="stickerEditorControls" style="display: none; background: #fff; padding: 12px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                    <input type="text" id="layerUrl" class="ins-input" placeholder="贴纸链接 (或上传 ->)" style="font-size: 11px; padding: 8px; flex: 1;" oninput="updateCurrentLayer('url', this.value)">
                    <button class="ins-line-btn" onclick="document.getElementById('layerFile').click()" style="padding: 0 12px;">📂</button>
                    <input type="file" id="layerFile" accept="image/*" style="display: none;" onchange="handleLayerUpload(this)">
                </div>

                <div style="margin-bottom: 12px;">
                    <div style="font-size: 10px; color: #999; margin-bottom: 6px;">基准位置 (锚点)</div>
                    <div style="display: flex; gap: 6px;">
                        <button class="pos-btn" onclick="updateCurrentLayer('anchor', 'top-left')" id="anchor-top-left" title="左上">↖</button>
                        <button class="pos-btn" onclick="updateCurrentLayer('anchor', 'top-right')" id="anchor-top-right" title="右上">↗</button>
                        <button class="pos-btn" onclick="updateCurrentLayer('anchor', 'bottom-left')" id="anchor-bottom-left" title="左下">↙</button>
                        <button class="pos-btn" onclick="updateCurrentLayer('anchor', 'bottom-right')" id="anchor-bottom-right" title="右下">↘</button>
                        <div style="flex: 1;"></div>
                        <button class="ins-line-btn" onclick="removeCurrentLayer()" style="color: #ff4757; border-color: #ff4757; font-size: 11px; padding: 4px 10px;">🗑 删除图层</button>
                    </div>
                </div>

               <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">

                    <div>
                        <div style="font-size: 10px; color: #666; margin-bottom: 4px;">大小: <span id="layerSizeVal">30px</span></div>
                        <input type="range" id="layerSize" min="10" max="150" style="width: 100%; accent-color: #667eea;" oninput="updateCurrentLayer('size', this.value)">
                    </div>
                    <div>
                        <div style="font-size: 10px; color: #666; margin-bottom: 4px;">水平位移 X: <span id="layerXVal">0px</span></div>
                        <input type="range" id="layerX" min="-50" max="100" style="width: 100%; accent-color: #333;" oninput="updateCurrentLayer('x', this.value)">
                    </div>
                    <div>

                        <div style="font-size: 10px; color: #666; margin-bottom: 4px;">垂直位移 Y: <span id="layerYVal">0px</span></div>
                        <input type="range" id="layerY" min="-50" max="100" style="width: 100%; accent-color: #333;" oninput="updateCurrentLayer('y', this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. CSS 代码编辑框 -->
        <div style="margin-top: 15px;">
            <div id="aiBubbleEditor" style="display: block;">
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">编辑 CSS 代码 (自动生成)</div>
                <textarea id="aiBubbleCssInput" class="ins-textarea" rows="8" style="font-family: monospace; font-size: 12px; color: #333; background: #fff; width: 100%;" oninput="updateBubblePreview()"></textarea>
            </div>

            <div id="userBubbleEditor" style="display: none;">
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">编辑 CSS 代码 (自动生成)</div>
                <textarea id="userBubbleCssInput" class="ins-textarea" rows="8" style="font-family: monospace; font-size: 12px; color: #333; background: #fff; width: 100%;" oninput="updateBubblePreview()"></textarea>
            </div>
        </div>

        <!-- 7. 底部按钮 -->
        <button class="ins-line-btn ins-btn-black" onclick="saveBubbleStyles()" style="margin-top: 30px; padding: 16px; width: 100%;">
            <span>✨ 应用气泡样式</span>
        </button>
    </div>
</div>



<!-- 隐藏输入框 -->
<input type="file" id="csGlobalFile" accept="image/*" style="display: none;" onchange="handleCSImage(this, 'global')">
<input type="file" id="csHeaderFile" accept="image/*" style="display: none;" onchange="handleCSImage(this, 'header')">
<input type="file" id="csBottomFile" accept="image/*" style="display: none;" onchange="handleCSImage(this, 'bottom')">
<input type="file" id="csIconPlusFile" accept="image/*" style="display: none;" onchange="handleCSImage(this, 'iconPlus')">
<input type="file" id="csIconSendFile" accept="image/*" style="display: none;" onchange="handleCSImage(this, 'iconSend')">
<input type="file" id="csIconReceiveFile" accept="image/*" style="display: none;" onchange="handleCSImage(this, 'iconReceive')">



<!-- 隐藏的文件输入框 -->
<input type="file" id="clGlobalFile" accept="image/*" style="display: none;" onchange="handleCLImage(this, 'global')">
<input type="file" id="clHeaderFile" accept="image/*" style="display: none;" onchange="handleCLImage(this, 'header')">
<input type="file" id="clBottomFile" accept="image/*" style="display: none;" onchange="handleCLImage(this, 'bottom')">
<input type="file" id="clIcon1File" accept="image/*" style="display: none;" onchange="handleCLImage(this, 'icon1')">
<input type="file" id="clIcon2File" accept="image/*" style="display: none;" onchange="handleCLImage(this, 'icon2')">
<input type="file" id="clIcon3File" accept="image/*" style="display: none;" onchange="handleCLImage(this, 'icon3')">



<!-- 聊天页面 -->
<div class="chat-screen" id="chatScreen">
<div class="chat-header">
    <button class="back-btn" onclick="backToMain()">
        <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>

    <div class="header-title">聊天</div>

    <!-- 只在朋友圈Tab显示的右侧按钮 -->
  <div class="chat-header-actions" id="momentsHeaderActions" style="display: none;">
    <!-- 分组 -->
    <button class="chat-header-icon-btn" onclick="openMomentsGroupPanel()" title="分组">
        <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M3.5 6.5a2 2 0 0 1 2-2h4.2c.5 0 1 .2 1.4.6l1 1c.3.3.6.4 1 .4H18.5a2 2 0 0 1 2 2v8.5a2.5 2.5 0 0 1-2.5 2.5h-12A2.5 2.5 0 0 1 3.5 17V6.5z"/>
        </svg>
    </button>

    <!-- 设置 -->
    <button class="chat-header-icon-btn" onclick="openMomentsSettingsPanel()" title="设置">
        <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M12 3.5c-4.7 0-8.5 3.6-8.5 8.1V20c0 .6.7 1 1.2.6l2.2-1.6c.2-.1.4-.2.6-.2h9c.2 0 .4.1.6.2l2.2 1.6c.5.4 1.2 0 1.2-.6v-8.4c0-4.5-3.8-8.1-8.5-8.1z"/>
            <circle cx="9" cy="11" r="1.2" fill="#ffffff"/>
            <circle cx="15" cy="11" r="1.2" fill="#ffffff"/>
        </svg>
    </button>

    <!-- 新增：加载转圈 (默认隐藏) -->
    <div id="momentsPublishLoading" style="display: none; margin-left: 6px;">
        <svg class="moments-loading-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="#999" stroke-width="3" stroke-opacity="0.3"></circle>
            <path d="M12 2a10 10 0 0 1 10 10" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round"></path>
        </svg>
    </div>
</div>

</div>


    
    <!-- 聊天列表 -->
    <div class="chat-list-container" id="chatListContainer">
        <!-- 聊天列表将在这里动态生成 -->
    </div>
    <div class="wallet-container" id="walletContainer" style="display: none;">
<!-- 替换开始：新的极简钱包头部 -->
    <div class="alipay-card" style="background: transparent; box-shadow: none; margin: 10px 0 0 0; padding: 30px 25px 10px; color: #333;">
        <div class="balance-label" style="color: #999; font-size: 14px; letter-spacing: 1px;">Total Balance</div>
        <div class="balance-amount" id="walletBalance" style="color: #333; font-weight: 300; font-size: 42px;">2,000.00</div>
        
        <div class="wallet-actions" style="margin-top: 25px;">
            <button class="wallet-act-btn" onclick="handleWalletAction('recharge')">充值</button>
            <button class="wallet-act-btn" onclick="handleWalletAction('withdraw')">提现</button>
        </div>
    </div>

    <div class="wallet-grid" style="border-bottom: 1px solid #f5f5f5; padding: 20px 15px;">
        <div class="wallet-grid-item">
            <!-- 使用 SVG 替换原来的 Emoji -->
            <div class="wallet-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            </div>
            <div class="wallet-text">账单</div>
        </div>
        <div class="wallet-grid-item">
            <div class="wallet-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            </div>
            <div class="wallet-text">亲密付</div>
        </div>
        <div class="wallet-grid-item">
            <div class="wallet-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            </div>
            <div class="wallet-text">理财</div>
        </div>
    </div>

    <div class="bill-section">
        <div class="bill-header" style="border:none; padding-top: 25px; font-size: 18px; font-weight: 700;">Recent Activity</div>
        <div id="billList" class="bill-list">
            <!-- JS会自动填充账单 -->
        </div>
    </div>


   

 
</div>

<!-- 朋友圈容器 -->
<div class="moments-container" id="momentsContainer" style="display: none;">
    <!-- 隐藏的文件输入框 (保持功能) -->
    <input type="file" id="momentsCoverInput" accept="image/*" style="display: none;" onchange="handleCoverSelect(this)">
    
    <div class="moments-scroll-content" onscroll="handleMomentsScroll(this)">
        
        <div class="social-combined-wrapper">
            <!-- 1. 顶部个人资料卡片 -->
            <div class="profile-header-card">
                <!-- 顶部背景图 (点击更换) -->
             <div class="ph-banner" id="momentsCover" onclick="document.getElementById('momentsCoverInput').click()">
    <!-- 图标已移除，只保留背景图点击换封面功能 -->
</div>

                
          <div class="ph-content">
    <!-- 头像 (点击编辑) -->
    <div class="ph-avatar-ring" onclick="openEditMomentsProfile()">
        <div class="ph-avatar-img" id="momentsUserAvatar">👤</div>
    </div>
    
    <!-- 名字 -->
    <div class="ph-name" id="momentsUserName" onclick="openEditMomentsProfile()">User</div>
</div>

            </div>

            <!-- 2. 动态流列表 -->
            <div class="feed-list" id="momentsList">
                <!-- JS 动态生成 -->
            </div>
            
            <div class="moments-footer">
                <div class="loading-line"></div>
            </div>
        </div>
    </div>
</div>



    <!-- 悬浮添加按钮 -->
 <button class="add-btn" onclick="openAddChatMenu()">+</button>
    
    <!-- 底部分组栏 -->
     <div class="chat-bottom-tabs">
        <!-- 1. 单聊/消息 Tab -->
        <div class="bottom-tab active" data-tab="single" onclick="switchChatTab('single')">
            <svg class="ins-icon" viewBox="0 0 24 24">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
        </div>

      <!-- 2. 朋友圈 Tab -->
<div class="bottom-tab" data-tab="moments" onclick="switchChatTab('moments')">
    <svg class="ins-icon" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="14.31" y1="8" x2="20.05" y2="17.94"></line>
        <line x1="9.69" y1="8" x2="21.17" y2="8"></line>
        <line x1="7.38" y1="12" x2="13.12" y2="2.06"></line>
        <line x1="9.69" y1="16" x2="3.95" y2="6.06"></line>
        <line x1="14.31" y1="16" x2="2.83" y2="16"></line>
        <line x1="16.62" y1="12" x2="10.88" y2="21.94"></line>
    </svg>
</div>


        <!-- 3. 钱包 Tab -->
        <div class="bottom-tab" data-tab="wallet" onclick="switchChatTab('wallet')">
            <svg class="ins-icon" viewBox="0 0 24 24">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
        </div>
        </div>
</div>

<!-- 朋友圈页面 -->
<div class="moments-screen" id="momentsScreen" style="display: none;">
    <!-- 顶部导航栏 (滚动变色) -->
    <div class="moments-nav-bar" id="momentsNavBar">
        <button class="back-btn" onclick="backToChatFromMoments()" style="color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <div class="nav-title" style="opacity: 0; color: #333; font-weight: 700;">朋友圈</div>
        <button class="camera-btn" onclick="openPostMomentModal()">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
        </button>
    </div>

    <!-- 滚动内容区域 -->
    <div class="moments-scroll-area" id="momentsScrollArea" onscroll="handleMomentsScroll(this)">
        <!-- 朋友圈头部 (封面+头像) -->
        <div class="moments-header">
            <div class="moments-cover" id="momentsCover" onclick="document.getElementById('momentsCoverInput').click()">
                <!-- 封面图将通过 CSS/JS 设置 -->
            </div>
            <div class="moments-user-row">
                <div class="moments-user-name" id="momentsUserName">我的名字</div>
                <div class="moments-user-avatar" id="momentsUserAvatar" onclick="openEditMomentsProfile()">👤</div>
            </div>
            <!-- 隐藏的封面上传 -->
            <input type="file" id="momentsCoverInput" accept="image/*" style="display: none;" onchange="handleCoverSelect(this)">
        </div>

        <!-- 朋友圈列表 -->
        <div class="moments-list" id="momentsList">
            <!-- 动态内容将在这里生成 -->
        </div>
        
        <div class="moments-footer">
            <div class="loading-line"></div>
        </div>
    </div>
</div>

<!-- ====== 朋友圈设置弹窗 START ====== -->
<div class="modal-overlay" id="momentsSettingsModal" onclick="closeMomentsSettingsModal(event)">
    <div class="modal moments-settings-modal" onclick="event.stopPropagation()">
        <div class="moments-settings-header">
            <div class="modal-title" style="margin: 0;">朋友圈设置</div>
        </div>

        <div class="moments-settings-body">
            <div class="form-group">
                <label class="form-label">副API方案</label>
                <select id="momentsSubApiSchemeSelect" class="form-input" onchange="handleMomentsSettingsChange()">
                    <option value="">请选择副API方案...</option>
                </select>
                <div style="font-size: 12px; color: #999; margin-top: 6px; line-height: 1.4;">
                    用于自动/立即发布时调用的接口（从 API设置 的方案中选择）。
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">发布动态人</label>

                <div style="display: flex; flex-direction: column; gap: 10px; background: #f9f9f9; border: 1px solid #eee; padding: 12px; border-radius: 12px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="radio" name="momentsPublisherMode" value="all" onchange="handleMomentsPublisherModeChange()" />
                        <span style="font-size: 14px; color:#333;">全部发动态（全员单聊）</span>
                    </label>

                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="radio" name="momentsPublisherMode" value="specified" onchange="handleMomentsPublisherModeChange()" />
                        <span style="font-size: 14px; color:#333;">指定角色发布动态</span>
                    </label>

                    <div id="momentsSpecifiedPanel" style="display:none; padding-left: 26px;">
                        <button class="ins-line-btn" onclick="openMomentsPublisherSelector()" style="width: 100%; justify-content: center;">
                            <span>选择角色</span>
                        </button>
                        <div id="momentsSpecifiedPreview" style="margin-top: 8px; font-size: 12px; color: #999; line-height: 1.5;">
                            未选择
                        </div>
                    </div>

                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="radio" name="momentsPublisherMode" value="random" onchange="handleMomentsPublisherModeChange()" />
                        <span style="font-size: 14px; color:#333;">随机角色发布动态</span>
                    </label>

                    <div id="momentsRandomPanel" style="display:none; padding-left: 26px; display:flex; align-items:center; gap:10px;">
                        <span style="font-size: 13px; color:#333;">随机</span>
                        <input type="number" id="momentsRandomCountInput" class="form-input" min="1" value="1" style="width: 90px;" oninput="handleMomentsSettingsChange()">
                        <span style="font-size: 13px; color:#333;">个人</span>
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label class="form-label">自动发布动态</label>

                <div style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; border:1px solid #eee; padding: 12px; border-radius: 12px;">
                    <span style="font-size: 14px; color:#333;">启用自动发布</span>
                    <input type="checkbox" id="momentsAutoPublishToggle" onchange="handleMomentsSettingsChange()" style="accent-color: #333; transform: scale(1.2); cursor:pointer;">
                </div>

                <div id="momentsAutoPublishPanel" style="display:none; margin-top: 10px; background:#fff; border:1px solid #eee; padding: 12px; border-radius: 12px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size: 13px; color:#333;">每</span>
                        <input type="number" id="momentsAutoPublishIntervalValue" class="form-input" min="1" value="30" style="width: 110px;" oninput="handleMomentsSettingsChange()">
                        <select id="momentsAutoPublishIntervalUnit" class="form-input" style="width: 110px;" onchange="handleMomentsSettingsChange()">
                            <option value="minutes">分钟</option>
                            <option value="hours">小时</option>
                        </select>
                        <span style="font-size: 13px; color:#333;">发布一次</span>
                    </div>
                    <div style="font-size: 12px; color:#999; margin-top: 8px; line-height: 1.4;">
                        页面打开时生效（浏览器关闭或刷新会重启计时）。
                    </div>
                    <div style="font-size: 12px; color:#999; margin-top: 6px; line-height: 1.4;">
                       最多只能生成5条动态。
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <button class="ins-line-btn ins-btn-black" onclick="triggerMomentsPublishNow()" style="width: 100%; justify-content: center;">
                    <span>立即发布一次</span>
                </button>
            </div>
        </div>

        <div class="moments-settings-footer">
            <div class="modal-buttons" style="margin-top: 0;">
                <button class="btn btn-cancel" onclick="closeMomentsSettingsModal()">关闭</button>
            </div>
        </div>
    </div>
</div>
<!-- ====== 朋友圈设置弹窗 END ====== -->



<!-- 朋友圈分组管理弹窗 -->
<div class="modal-overlay" id="momentsGroupModal" onclick="closeMomentsGroupModal(event)">
  <div class="modal" onclick="event.stopPropagation()">

        <div class="modal-title">分组管理</div>

        <div class="form-group">
            <label class="form-label">新建分组</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="momentsNewGroupName" class="form-input" placeholder="输入分组名称" style="flex: 1;">
                <button class="btn btn-save" onclick="createMomentsGroup()" style="flex: none; padding: 12px 16px; white-space: nowrap;">新建</button>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 6px; line-height: 1.4;">
                新建后会立即弹出成员选择。
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">分组列表</label>
            <div id="momentsGroupList" style="max-height: 260px; overflow-y: auto;"></div>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeMomentsGroupModal()">关闭</button>
        </div>
    </div>
</div>



<!-- 发布动态弹窗 (美化版) -->
<div class="modal-overlay" id="postMomentModal" onclick="closePostMomentModal(event)">
    <div class="modal post-modal-card" onclick="event.stopPropagation()">
        
        <!-- 顶部栏 -->
        <div class="post-header">
            <button class="post-btn-cancel" onclick="closePostMomentModal()">取消</button>
            <div class="post-title">新动态</div>
            <button class="post-btn-publish" onclick="publishMoment()">发布</button>
        </div>
        
        <!-- 内容区域 -->
        <div class="post-body">
            <!-- 文本输入 -->
            <textarea id="momentContent" class="post-textarea" placeholder="分享此刻的想法..."></textarea>
            
            <!-- 图片网格 -->
            <div class="post-media-area">
                <div class="post-grid" id="momentImgGrid">
                    <!-- 上传按钮 -->
                    <div class="post-add-box" onclick="document.getElementById('momentImgInput').click()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </div>
                </div>
            </div>
            
            <!-- 隐藏的输入框 -->
            <input type="file" id="momentImgInput" accept="image/*" multiple style="display: none;" onchange="handleMomentImgSelect(this)">
            
            <!-- 选项列表 -->
            <div class="post-options-list">
                <div class="post-option-item">
                    <span class="opt-icon"></span>
                    <span class="opt-label">所在位置</span>
                    <span class="opt-arrow">›</span>
                </div>
                <div class="post-option-item">
                    <span class="opt-icon"></span>
                    <span class="opt-label">提醒谁看</span>
                    <span class="opt-arrow">›</span>
                </div>
              <!-- ====== 谁可以看（可见性）START ====== -->
<div class="post-option-item" onclick="openMomentVisibilityModal()">
    <span class="opt-icon"></span>
    <span class="opt-label">谁可以看</span>
    <span class="opt-value" id="momentVisibilityValue">公开</span>
    <span class="opt-arrow">›</span>
</div>
<!-- ====== 谁可以看（可见性）END ====== -->

            </div>
        </div>
    </div>
</div>


<!-- 朋友圈资料编辑弹窗 -->
<div class="modal-overlay" id="momentsProfileModal" onclick="closeEditMomentsProfile(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">朋友圈资料</div>
        <div class="form-group">
            <label class="form-label">昵称</label>
            <input type="text" id="momentsProfileName" class="form-input" placeholder="设置朋友圈昵称">
        </div>
        <div class="form-group">
    <label class="form-label">昵称颜色</label>
    <input type="color" id="momentsProfileNameColor" class="form-input" value="#ffffff" style="height: 44px; padding: 6px;">
</div>

        <div class="form-group">
            <label class="form-label">头像</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="momentsProfileAvatarPreview" style="width: 40px; height: 40px; border-radius: 6px; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">👤</div>
                <button class="api-btn" onclick="document.getElementById('momentsAvatarInput').click()">更换头像</button>
                <input type="file" id="momentsAvatarInput" accept="image/*" style="display: none;" onchange="handleMomentsAvatarSelect(this)">
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeEditMomentsProfile()">取消</button>
            <button class="btn btn-save" onclick="saveMomentsProfile()">保存</button>
        </div>
    </div>
</div>



<div class="memory-screen" id="memoryScreen">
    <div class="memory-header">
      <button class="back-btn" onclick="backToCharacterInfoFromMemory()">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
</button>

        <div class="header-title" style="flex: 1; text-align: center; margin-left: 40px; font-weight: 700;">ARCHIVES</div>
 
 
<button id="headerAnalyzeBtn" onclick="analyzeProfile()" style="
    display: none;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 8px;
    margin-left: auto;
">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="23 4 23 10 17 10"></polyline>
        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
    </svg>
</button>



    </div>

    <div class="memory-tabs">
        <div class="memory-tab-item active" onclick="switchMemoryTab('profile')" id="tab-profile">他的档案</div>
        <div class="memory-tab-item" onclick="switchMemoryTab('tags')" id="tab-tags">他眼中的你</div>
        <div class="memory-tab-item" onclick="switchMemoryTab('timeline')" id="tab-timeline">时光相册</div>
    </div>

    <div class="memory-content-area">
        
      <div id="archiveProfileView" style="display: block;">
            
        <div class="archive-card-base">
    <button class="archive-analyze-btn" onclick="analyzeProfile()" id="analyzeBtn">
        <span>⚡</span> 分析
    </button>

    <div class="archive-avatar" id="arcAvatar">👤</div>
    <div class="archive-base-info">
        <div class="archive-name">
            <span id="arcName">Character</span>
        </div>
        <div class="archive-meta-row">
            <span id="arcBirthday">未知生日</span>
        </div>
    </div>
</div>


          <div class="archive-grid-box">
                <div class="archive-grid-item">
                    <span class="grid-label">HEIGHT</span>
                    <span class="grid-value" id="arcHeight">--</span>
                </div>
                <div class="archive-grid-item">
                    <span class="grid-label">WEIGHT</span>
                    <span class="grid-value" id="arcWeight">--</span>
                </div>
                <div class="archive-grid-item">
                    <span class="grid-label">LIKES (爱好)</span>
                    <span class="grid-value" id="arcLikes" style="font-size: 13px; text-align: center;">--</span>
                </div>
                <div class="archive-grid-item">
                    <span class="grid-label">DISLIKES (厌恶)</span>
                    <span class="grid-value" id="arcDislikes" style="font-size: 13px; text-align: center;">--</span>
                </div>
            </div>

          <div class="archive-deep-section">
                <div class="archive-section-title">✨性格分析 (Analysis)</div>
                <div class="archive-text-box" id="arcCorePersonality" style="color: #999; font-style: italic;">
                    （暂无分析，请生成...）
                </div>
            </div>

            <div class="archive-deep-section">
                <div class="archive-section-title">🔒 秘密档案 (Secret)</div>
                <div class="archive-text-box" id="arcSecret">这里记录着他不为人知的一面...</div>
            </div>
        </div>

    <div id="memoryTagsList" style="display: none;">
    <div class="archive-subtitle">Fragments of you in his mind...</div>
    
    <!-- 情绪贴纸区 -->
    <div class="emotion-section">
        <div class="emotion-header">
            <span class="emotion-title">🎭 TA的心情记录</span>
            <span class="emotion-time" id="emotionUpdateTime">--</span>
        </div>
        <div class="emotion-display">
            <div class="emotion-sticker" id="currentEmotionSticker">☀️</div>
            <div class="emotion-info">
                <div class="emotion-label" id="currentEmotionLabel">阳光明媚</div>
                
                <!-- ▼▼▼ 修改部分开始：原本是进度条，现在改成 TA 的话 ▼▼▼ -->
                <div class="emotion-comment-box" style="margin-top: 8px; background: #f9f9f9; padding: 8px 12px; border-radius: 8px; font-size: 13px; color: #555; line-height: 1.5; font-style: italic;">
                    <span id="emotionCommentText">（等待记录...）</span>
                </div>
                <!-- ▲▲▲ 修改部分结束 ▲▲▲ -->
                
            </div>
        </div>
    </div>

    <!-- 印象标签区 -->
    <div class="tags-section">
        <div class="tags-header">
            <span class="tags-title">🏷️ TA 眼中的你</span>
            <span class="tags-count" id="tagsCount">0 个标签</span>
        </div>
        <div id="tagsContainer" class="memory-tags-container">
            <div class="empty-tags-hint">还没有印象标签，多聊聊天吧~</div>
        </div>
    </div>
    
    <!-- 闪光时刻区 -->
    <div class="flashbulb-section">
        <div class="flashbulb-header">
            <span class="flashbulb-title">📸 闪光时刻</span>
            <span class="flashbulb-count" id="flashbulbCount">0 个瞬间</span>
        </div>
        <div id="flashbulbContainer" class="flashbulb-list">
            <div class="empty-flashbulb-hint">重要时刻会被记录在这里~</div>
        </div>
    </div>
</div>

        
        <div class="memory-timeline" id="memoryTimelineList" style="display: none;">
            </div>
    </div>

    <button class="add-btn" id="memoryFloatingBtn" onclick="handleMemoryFloatClick()">+</button>
</div>

<div class="modal-overlay" id="editArchiveModal" onclick="closeEditArchiveModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">编辑私密档案</div>
        
  <div class="form-group">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label class="form-label">爱好 (1-3个)</label>
                    <input type="text" id="editArcLikes" class="form-input" placeholder="如: 摄影, 甜食">
                </div>
                <div style="flex:1">
                    <label class="form-label">厌恶 (可无)</label>
                    <input type="text" id="editArcDislikes" class="form-input" placeholder="如: 香菜, 甚至没有">
                </div>
            </div>
        </div>

        <div class="form-group">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label class="form-label">MBTI</label>
                    <input type="text" id="editArcMbti" class="form-input" placeholder="如: INTJ">
                </div>
                <div style="flex:1">
                    <label class="form-label">血型</label>
                    <input type="text" id="editArcBlood" class="form-input" placeholder="如: A型">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">秘密/背景故事 (仅展示用)</label>
            <textarea id="editArcSecret" class="form-input" rows="5" placeholder="写下关于他的秘密或背景故事..."></textarea>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeEditArchiveModal()">取消</button>
            <button class="btn btn-save" onclick="saveExtendedArchive()">保存</button>
        </div>
    </div>
</div>


<!-- 聊天详情页面 -->
<div class="chat-detail-screen" id="chatDetailScreen">
<div class="chat-detail-header">
    <button class="back-btn" onclick="backToChatList()">
        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; stroke: #333; stroke-width: 2.5; fill: none; stroke-linecap: round; stroke-linejoin: round;"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>

    <div id="chatHeaderAvatar" class="header-avatar"></div>
    
    <div style="flex: 1; display: flex; flex-direction: column;">
        <div class="chat-detail-title" id="chatDetailTitle">张三</div>
        <div class="character-status" id="characterStatus" style="display: none;"></div>
    </div>
    <!-- ★★★ 在这里插入搜索按钮 (更多按钮的上面) ★★★ -->
<button class="back-btn" onclick="openScheduleScreen()" style="margin-right: 2px;">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="7"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
</button>
   <!-- 右上角更多按钮 (修复版) -->
    <button class="back-btn" onclick="openCharacterInfo()" style="margin-left: auto;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="2.5"></circle>
            <circle cx="19" cy="12" r="2.5"></circle>
            <circle cx="5" cy="12" r="2.5"></circle>
        </svg>
    </button>
</div>


<!-- 状态监控悬浮条 (可拖动版) -->
<!-- 注意：这里删掉了 onclick 属性，将在 JS 中处理点击 -->
<div class="status-heartbeat-bar" id="statusHeartbeatBar" style="display: none;">
    <div class="heartbeat-center">
        <span class="heartbeat-icon">♥</span>
        <span class="heartbeat-bpm" id="heartbeatBpm">72</span>
    </div>
</div>


    <div class="messages-container" id="messagesContainer">
        <button class="load-more-btn" id="loadMoreBtn" style="display: none;" onclick="loadMoreMessages()">
            点击查看历史消息
        </button>
        <div id="messagesList"></div>
    </div>
    <!-- 引用消息框 -->
<div class="quote-box" id="quoteBox" style="display: none;">
    <div class="quote-header">
        <span id="quoteAuthor">引用：张三</span>
        <span class="quote-close" onclick="cancelQuote()">×</span>
    </div>
    <div class="quote-content" id="quoteContent">消息内容...</div>
</div>

<!-- 多选模式操作栏 -->
<div class="multi-select-bar" id="multiSelectBar" style="display: none;">
    <div class="selected-count">已选<span id="selectedCountText">0</span>条</div>
    <div class="multi-select-actions">
        <button class="btn-multi-cancel" onclick="cancelMultiSelect()">取消</button>
        <button class="btn-multi-delete" onclick="deleteSelectedMessages()">删除</button>
    </div>
</div>
<!-- 表情包按钮 -->
<div class="emoji-btn-wrapper">
    <button class="emoji-btn" onclick="toggleEmojiPanel()" title="表情">
       <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
    </button>
    
    <button class="emoji-btn" id="retryBtn" onclick="retryAIReply()" title="撤回重发">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="1 4 1 10 7 10"></polyline>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
        </svg>
    </button>

 <!-- ▼▼▼ 新增：文字图按钮 (SVG 线条风格) ▼▼▼ -->
    <button class="emoji-btn" onclick="openTextImageModal()" title="发送文字图">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <!-- 外框卡片 -->
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <!-- 里面的文字线条 -->
            <line x1="7" y1="8" x2="17" y2="8"></line>
            <line x1="7" y1="12" x2="17" y2="12"></line>
            <line x1="7" y1="16" x2="13" y2="16"></line>
        </svg>
    </button>
    <!-- ▲▲▲ 新增结束 ▲▲▲ -->

    <button class="emoji-btn" onclick="document.getElementById('imageInput').click()" title="发送图片">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
    </button>
    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">

    <button class="emoji-btn" onclick="openTransferModal()" title="转账">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="4" width="20" height="16" rx="2"></rect>
            <line x1="12" y1="11" x2="12" y2="17"></line>
            <line x1="9" y1="14" x2="15" y2="14"></line>
            <path d="M12 7v1"></path>
        </svg>
    </button>

    <button class="emoji-btn" onclick="openVoiceModal()" title="发送语音">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
    </button>

    <button class="emoji-btn" onclick="openCall()" title="视频通话">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="23 7 16 12 23 17 23 7"></polygon>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
        </svg>
    </button>

    <button class="emoji-btn" onclick="openShopping()" title="购物">
       <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
    </button>

    <!-- 抽签功能 -->
<button class="emoji-btn" onclick="openDrawLotModal()" title="抽签">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
        <path d="M9 9h.01"></path>
        <path d="M15 9h.01"></path>
        <path d="M9 15h.01"></path>
        <path d="M15 15h.01"></path>
        <line x1="12" y1="2" x2="12" y2="4"></line>
        <line x1="12" y1="20" x2="12" y2="22"></line>
    </svg>
</button>


</div>



<!-- 表情包面板 -->
<div class="emoji-panel" id="emojiPanel" style="display: none;">
    <!-- 顶部操作栏 -->
    <div class="emoji-panel-header">
        <button class="emoji-header-btn" onclick="openEmojiUpload()">上传</button>
        <button class="emoji-header-btn" onclick="openEmojiCategoryManager()">分类管理</button>
<button class="emoji-header-btn" id="clearEmojiBtn" onclick="clearCurrentEmojis()" style="display: none; color: #ff4757; border-color: #ff4757;">清空当前</button>
        <button class="emoji-header-btn" onclick="toggleEmojiDeleteMode()">删除模式</button>
    </div>
    
    <!-- 搜索框 -->
    <div class="emoji-search-box">
        <input type="text" class="emoji-search-input" id="emojiSearchInput" placeholder="🔍 搜索表情包..." oninput="searchEmojis()">
    </div>
    
    <!-- 分类标签栏 -->
    <div class="emoji-category-bar" id="emojiCategoryBar">
        <span class="emoji-category-tag active" data-category="all" onclick="switchEmojiCategory('all')">全部</span>
        <!-- 其他分类将动态生成 -->
    </div>
    
    <!-- 表情包网格 -->
    <div class="emoji-grid-container">
        <div class="emoji-grid" id="emojiGrid">
            <!-- 表情包将动态生成 -->
        </div>
    </div>
</div>

    <div class="chat-input-bar">
    
        <textarea class="chat-input" id="chatInput" placeholder="打字输入中..." rows="1"></textarea>
      <button class="action-icon-btn" onclick="sendMessage()" title="发送消息">
           <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(45deg); margin-left: -2px;">
    <line x1="22" y1="2" x2="11" y2="13"></line>
    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
</svg>
        </button>

        <button class="action-icon-btn" id="receiveBtn" onclick="receiveAIReply()" title="接收回信">
           <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
</svg>
        </button>
    </div>
</div>
<!-- ============ 日程计划页面 (更新后) ============ -->
<div id="scheduleScreen" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 2000; flex-direction: column;">
    
    <!-- 右上角加载圈 (默认隐藏) -->
<div id="scheduleLoadingIcon" style="display: none; position: absolute; top: 30px; right: 25px; z-index: 2002;">
    <svg class="schedule-spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
    </svg>
</div>

    <!-- 标题区 -->
    <div style="padding: 30px 20px 10px;">
        <h1 style="font-size: 28px; font-weight: 800; color: #333; margin-bottom: 5px; letter-spacing: -0.5px;">Schedule</h1>
        <p style="font-size: 13px; color: #999;">规划与 <span id="scheduleCharName">TA</span> 的一天</p>
    </div>

    <!-- 滚动内容区 -->
    <div style="flex: 1; overflow-y: auto; padding: 0 20px 80px;">
        
        <!-- 1. 我的计划 -->
        <div class="ins-list-group" style="margin-top: 10px;">
            <div class="ins-list-item" onclick="openUserPlanModal()">
                <div style="width: 36px; height: 36px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 18px;">📅</div>
                <div style="flex: 1;">
                    <div class="ins-item-label" style="font-size: 15px; font-weight: 600;">我的计划</div>
                    <div id="userPlanPreview" style="font-size: 12px; color: #999; margin-top: 2px;">点击填写今日安排</div>
                </div>
                <div class="ins-arrow">›</div>
            </div>
        </div>

        <!-- 2. 他的作息 (选填) -->
        <div class="ins-list-group">
            <div class="ins-list-item" onclick="openRoutineModal()">
                <div style="width: 36px; height: 36px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 18px;">⏰</div>
                <div style="flex: 1;">
                    <div class="ins-item-label" style="font-size: 15px; font-weight: 600;">TA的作息 (选填)</div>
                    <div id="charRoutinePreview" style="font-size: 12px; color: #999; margin-top: 2px;">默认按人设自由发挥</div>
                </div>
                <div class="ins-arrow">›</div>
            </div>
        </div>

        <!-- 3. 生成按钮 -->
        <button class="ins-line-btn ins-btn-black" onclick="generateDaySchedule()" style="width: 100%; padding: 16px; margin-top: 20px; font-weight: 600; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
             生成今日行程
        </button>

        <!-- 4. 行程展示区 (时间轴) -->
        <div id="scheduleResultArea" style="margin-top: 30px; display: none;">
            <div style="font-size: 12px; color: #999; font-weight: 700; letter-spacing: 1px; margin-bottom: 15px;">TODAY'S TIMELINE</div>
            <div id="scheduleTimeline" class="schedule-timeline">
                <!-- JS 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 悬浮返回按钮 -->
    <button onclick="closeScheduleScreen()" style="position: absolute; bottom: 40px; right: 30px; width: 56px; height: 56px; border-radius: 50%; background: #333; color: white; border: none; box-shadow: 0 8px 25px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2001;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
</div>

<!-- 角色信息页面 -->
<div class="character-info-screen ins-profile-screen" id="characterInfoScreen">
    <div class="chat-detail-header" style="background: white; border:none;">
      <button class="back-btn" onclick="backToDetail()">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
</button>

        <div class="chat-detail-title" style="text-align: center; font-weight: 700;">PROFILE</div>
        <button class="back-btn" style="opacity: 0; pointer-events: none;">⋮</button>
    </div>
    
    <div class="character-info-content" style="background: #f9f9f9;">
        
        <div class="ins-profile-header">
            <div class="ins-avatar-box" onclick="openEditBasicInfo()">
                <div class="character-avatar ins-avatar-img" id="charAvatar">👤</div>
            </div>
            <div class="character-name ins-char-name" id="charDisplayName" onclick="openEditBasicInfo()">Character</div>
            
            <div class="ins-stats-row">
                <div class="ins-stat-item" onclick="openDiaryList()">
                    <div class="stat-number ins-stat-num" id="charFollowers">0</div>
                    <div class="stat-label ins-stat-label">日记</div>
                </div>
             <div class="ins-stat-item" onclick="openMemoryScreen()"> <div class="stat-number ins-stat-num" id="charFollowing">0</div>
    <div class="stat-label ins-stat-label">档案</div>
</div>
                <div class="ins-stat-item">
                    <div class="stat-number ins-stat-num" id="charItinerary">0</div>
                    <div class="stat-label ins-stat-label">邮件</div>
                </div>
            </div>
        </div>

        <div class="ins-list-group">
            <div class="ins-list-item">
                <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                <div class="ins-item-label">备注名</div>
                <input type="text" id="charRemark" class="ins-item-input" placeholder="未设置">
            </div>
            
            <div class="ins-list-item">
                <svg class="ins-item-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <div class="ins-item-label">生日</div>
                <input type="date" id="charBirthday" class="ins-item-input">
            </div>

            <div class="ins-list-item">
                <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                <div class="ins-item-label">城市信息</div>
                <div style="display: flex; align-items: center;">
                    <span id="viewWeatherBtn" style="font-size: 12px; color: #667eea; margin-right: 10px; display: none;" onclick="viewCurrentWeather(event)">查看详情</span>
                    <input type="checkbox" id="cityInfoCheckbox" onclick="handleCityInfoCheckbox()" style="accent-color: #333;">
                </div>
            </div>
            <div class="ins-list-item">
    <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
    <div class="ins-item-label">状态监控</div>
    <div style="display: flex; align-items: center;">
        <input type="checkbox" id="statusMonitorCheckbox" onclick="handleStatusMonitorCheckbox()" style="accent-color: #333;">
    </div>
</div>

<!-- ====== HTML插件开关 START ====== -->
<div class="ins-list-item">
    <!-- 中文注释：这里图标随便先用一个“卡片/模块”感觉的，保持和其它项一致的SVG风格 -->
    <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="16" rx="2"></rect>
        <line x1="7" y1="9" x2="17" y2="9"></line>
        <line x1="7" y1="13" x2="14" y2="13"></line>
    </svg>
    <div class="ins-item-label">html插件</div>
    <div style="display: flex; align-items: center;">
        <!-- 中文注释：只做开关本身，实际能不能用要后续由“关联世界书是否有html分类”决定 -->
        <input type="checkbox" id="htmlPluginCheckbox" style="accent-color: #333;">
    </div>
</div>
<!-- ====== HTML插件开关 END ====== -->


<!-- ====== 关系网入口 START ====== -->
<div class="ins-list-item" onclick="openRelationshipModal()">
    <svg class="ins-item-icon" viewBox="0 0 24 24">
        <path d="M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3z"></path>
        <path d="M8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3z"></path>
        <path d="M16 13c-2.67 0-8 1.34-8 4v2"></path>
        <path d="M8 13c-2.67 0-8 1.34-8 4v2"></path>
    </svg>
    <div class="ins-item-label">关系网</div>
    <div class="ins-arrow">›</div>
</div>
<!-- ====== 关系网入口 END ====== -->

        </div>

<div class="ins-list-group">
    <div style="padding: 15px 0; border-top: 0.5px solid #f5f5f5;">
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <div class="ins-item-label">他的人设</div>
        </div>
        <div class="ins-textarea-box">
            <textarea id="charPersonality" class="ins-textarea" rows="4" placeholder="TA是什么样的人？描述TA的性格、特点..."></textarea>
        </div>
    </div>
</div>

        
        <div class="ins-list-group">


            <div style="padding: 15px 0; border-top: 0.5px solid #f5f5f5;">
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <div class="ins-item-label">我的人设</div>
                </div>
                <div class="ins-textarea-box">
                    <textarea id="myPersonality" class="ins-textarea" rows="4" placeholder="你在TA眼中是什么样的人？"></textarea>
                </div>
            </div>
        </div>

        <div class="ins-list-group">
<div class="ins-list-item" onclick="openWorldbookSelectorModal()">
    <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
    <div class="ins-item-label">关联世界书</div>
    <div style="display: flex; align-items: center; gap: 8px;">
        <span id="worldbookCountText" style="font-size: 13px; color: #999;">未选择</span>
        <div class="ins-arrow">›</div>
    </div>
</div>

<!-- ▼▼▼ 新增：角色发图设置 ▼▼▼ -->
<div style="padding: 15px 0; border-top: 0.5px solid #f5f5f5;">
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <div class="ins-item-label">角色发图模式</div>
    </div>
    
    <select id="charImageMode" class="ins-input" style="width: 100%; padding: 12px; font-size: 14px; border-radius: 12px; border: 1px solid #f0f0f0; background: #f9f9f9; color: #333;">
        <option value="text">文字图</option>
        <option value="worldbook">世界书图</option>
        <option value="hybrid">共存模式</option>
    </select>
</div>
<!-- ▲▲▲ 新增结束 ▲▲▲ -->


            <div style="padding: 15px 0; border-top: 0.5px solid #f5f5f5;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <svg class="ins-item-icon" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                    <div class="ins-item-label">记忆轮数 <span id="contextMessagesCount" style="font-size:12px; color:#999; margin-left:5px;">(60条)</span></div>
                    <input type="number" id="contextRoundsInput" value="30" style="width: 50px; border:none; background:#f0f0f0; border-radius:4px; text-align:center;">
                </div>
                <input type="range" id="contextRoundsSlider" min="0" max="300" value="30" style="width: 100%;">
            </div>
               <!-- 新增：自动总结开关 -->
            <div style="padding: 15px 0; border-top: 0.5px solid #f5f5f5;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center;">
                        <!-- 使用星星图标代表智能生成 -->
                        <svg class="ins-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                        <div class="ins-item-label">自动总结记忆</div>
                    </div>
                    <!-- 开关 -->
                    <input type="checkbox" id="autoSummaryCheckbox" onchange="document.getElementById('autoSummarySettingsPanel').style.display = this.checked ? 'block' : 'none'" style="accent-color: #333;">
                </div>
                
                <!-- 隐藏的设置面板 -->
                <div id="autoSummarySettingsPanel" style="display: none; padding-left: 34px;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 8px; line-height: 1.4;">
                        聊天每增加一定轮数，自动生成时光相册节点。
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="number" id="autoSummaryThresholdInput" value="50" min="10" step="5" 
                               style="width: 60px; border: 1px solid #e1e1e1; background: #fff; border-radius: 4px; padding: 6px; text-align: center; margin-right: 8px; font-size: 14px;">
                        <span style="font-size: 13px; color: #333;">轮触发一次</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="ins-list-group">
            <div class="ins-list-item" onclick="exportChatHistory()" style="cursor: pointer;">
                <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <div class="ins-item-label" style="color: #667eea;">导出聊天记录</div>
                <div class="ins-arrow">›</div>
            </div>
            
            <div class="ins-list-item" onclick="document.getElementById('importChatFile').click()" style="cursor: pointer;">
                <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                <div class="ins-item-label" style="color: #667eea;">导入聊天记录</div>
                <div class="ins-arrow">›</div>
                <input type="file" id="importChatFile" accept=".txt" style="display: none;" onchange="importChatHistory(event)">
            </div>

            <div class="ins-list-item" onclick="clearChatHistory()" style="cursor: pointer;">
                <svg class="ins-item-icon" viewBox="0 0 24 24" style="stroke: #ff4757;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                <div class="ins-item-label" style="color: #ff4757;">清除聊天记录</div>
                <div class="ins-arrow">›</div>
            </div>
        </div>

        <button class="ins-save-btn" onclick="saveCharacterInfo()">保存修改</button>
        
    </div>
</div>

<!-- 日记列表页面 -->
<div class="diary-screen" id="diaryScreen">
    <div class="chat-detail-header">
        <button class="back-btn" onclick="backToCharacterInfo()">←</button>
        <div class="chat-detail-title" id="diaryOwnerName">日记</div>
        <button class="back-btn" style="opacity: 0; pointer-events: none;">⋮</button>
    </div>
    
    <!-- 召唤卡片 -->
    <div class="summon-card" id="summonCard" onclick="summonDiary()">
        <div class="summon-text">💌 快来喊TA写日记吧~</div>
        <div class="stars-container" id="starsContainer"></div>
    </div>
    
    <!-- 写日记状态 -->
    <div class="writing-diary-card" id="writingCard" style="display: none;">
        <div class="writing-avatar" id="writingAvatar">👤</div>
        <div class="writing-text">
            <span id="writerName">张三</span>正在写日记...
        </div>
        <div class="pen-animation">✍️</div>
    </div>
    
    <!-- 日记列表 -->
    <div class="diary-list-container" id="diaryListContainer">
        <!-- 日记卡片将在这里动态生成 -->
    </div>
</div>

<!-- 日记详情页 -->
<div class="diary-detail-screen" id="diaryDetailScreen">
    <div class="chat-detail-header">
        <button class="back-btn" onclick="backToDiaryList()">←</button>
        <div class="chat-detail-title">日记详情</div>
        <button class="back-btn" onclick="deleteDiaryWithConfirm()" style="color: #ff4757;">删除</button>
    </div>


    
    <div class="diary-detail-content" id="diaryDetailContent">
        <!-- 日记详细内容将在这里渲染 -->
    </div>
</div>


    </div>
<div class="modal-overlay" id="condenseModal" onclick="closeCondenseModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">✨ 整理记忆</div>
        <div style="text-align: center; margin-bottom: 20px; color: #666; font-size: 14px;">
            当前共有 <span id="totalMemoriesCount" style="font-weight: bold; color: #667eea;">0</span> 条时光记忆
        </div>
        
        <div class="form-group">
            <label class="form-label">选择范围</label>
            <select id="condenseRange" class="form-input">
                <option value="recent_20">精简最近 20 条</option>
                <option value="recent_50">精简最近 50 条</option>
                <option value="all">精简全部 (慎用)</option>
            </select>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeCondenseModal()">取消</button>
            <button class="btn btn-save" onclick="startCondense()" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); border: none; color: white;">开始整理</button>
        </div>
    </div>
</div>
<!-- 编辑弹窗 -->
<div class="modal-overlay" id="editModal" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-height: 80vh; overflow-y: auto; width: 90%; max-width: 320px; padding: 20px;">
        <div class="modal-title" style="font-size: 17px; margin-bottom: 18px;">编辑个人信息</div>
        
        <div class="form-group" style="margin-bottom: 14px;">
            <label class="form-label" style="font-size: 13px;">头像</label>
            <div class="avatar-preview" id="avatarPreview" style="width: 50px; height: 50px; margin: 8px auto;">👤</div>
            <div style="text-align: center;">
                <label for="avatarInput" class="file-button" style="padding: 6px 12px; font-size: 13px;">选择头像</label>
            </div>
            <input type="file" id="avatarInput" class="file-input" accept="image/*">
        </div>
        
        <div class="form-group" style="margin-bottom: 14px;">
            <label class="form-label" style="font-size: 13px;">ID名称</label>
            <input type="text" id="userIdInput" class="form-input" placeholder="输入你的ID" style="padding: 10px; font-size: 16px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 14px;">
            <label class="form-label" style="font-size: 13px;">个性签名</label>
            <input type="text" id="signatureInput" class="form-input" placeholder="输入个性签名" style="padding: 10px; font-size: 16px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 14px;">
            <label class="form-label" style="font-size: 13px;">字体颜色</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="color" id="textColorInput" class="form-input" value="#ffffff" style="flex: 1; height: 38px; padding: 2px;">
                <div id="textColorPreview" style="width: 38px; height: 38px; border-radius: 6px; border: 2px solid #e1e5e9; background: #ffffff; flex-shrink: 0;"></div>
            </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 14px;">
            <label class="form-label" style="font-size: 13px;">App图标字体颜色</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="color" id="appTextColorInput" class="form-input" value="#ffffff" style="flex: 1; height: 38px; padding: 2px;">
                <div id="appTextColorPreview" style="width: 38px; height: 38px; border-radius: 6px; border: 2px solid #e1e5e9; background: #ffffff; flex-shrink: 0;"></div>
            </div>
        </div>

        <div style="text-align: center; font-size: 10px; color: #999; margin-top: 12px; padding: 8px; background: #f9f9f9; border-radius: 6px;">
            天气数据由 <a href="https://openweathermap.org" target="_blank" style="color: #667eea; text-decoration: none;">OpenWeatherMap</a> 提供
        </div>

        <div class="modal-buttons" style="margin-top: 16px; gap: 10px;">
            <button class="btn btn-cancel" onclick="closeModal()" style="padding: 10px; font-size: 14px;">取消</button>
            <button class="btn btn-save" onclick="saveUserInfo()" style="padding: 10px; font-size: 14px;">保存</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="musicSettingsModal" onclick="closeWidgetSettings('music')">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">音乐组件设置</div>
        
        <div class="form-group">
            <label class="form-label">组件背景图</label>
            <div class="file-input-area" onclick="document.getElementById('musicBgInput').click()" style="padding: 10px;">
                <div style="font-size: 12px;">点击更换背景</div>
                <input type="file" id="musicBgInput" accept="image/*" style="display: none;" onchange="handleWidgetImage(this, 'musicBgPreview')">
            </div>
            <div id="musicBgPreview" style="height: 40px; margin-top: 5px; border-radius: 8px; background: #f0f0f0; display: none; background-size: cover; background-position: center;"></div>
            <button class="api-btn" onclick="clearWidgetImage('musicBg')" style="margin-top: 5px; background: #f0f0f0; color: #666;">恢复默认透明</button>
        </div>

        <div class="form-group">
            <label class="form-label">字体颜色</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="color" id="musicTextColorInput" class="form-input" style="height: 40px; padding: 2px; width: 60px; flex: none;">
                <div style="font-size: 12px; color: #999;">修改歌名和歌手的颜色</div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">圆环内图片 (专辑封面)</label>
            <div class="file-input-area" onclick="document.getElementById('musicCoverInput').click()" style="padding: 10px;">
                <div style="font-size: 12px;">点击更换封面</div>
                <input type="file" id="musicCoverInput" accept="image/*" style="display: none;" onchange="handleWidgetImage(this, 'musicCoverPreview')">
            </div>
            <div id="musicCoverPreview" style="height: 40px; margin-top: 5px; border-radius: 8px; background: #f0f0f0; display: none; background-size: cover; background-position: center;"></div>
        </div>

        <div class="form-group">
            <label class="form-label">歌曲信息</label>
            <input type="text" id="musicTitleInput" class="form-input" placeholder="歌名 (如: Lover)" style="margin-bottom: 5px;">
            <input type="text" id="musicArtistInput" class="form-input" placeholder="歌手 (如: Taylor Swift)">
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeWidgetSettings('music')">取消</button>
            <button class="btn btn-save" onclick="saveMusicSettings()">保存</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="noteSettingsModal" onclick="closeWidgetSettings('note')">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">便签组件设置</div>

        <div class="form-group">
            <label class="form-label">便签图片</label>

            <div class="file-input-area" onclick="document.getElementById('noteImageInput').click()" style="padding: 10px;">
                <div style="font-size: 12px;">点击选择图片</div>
                <input type="file" id="noteImageInput" accept="image/*" style="display: none;">
            </div>

            <div id="noteImagePreview" style="height: 40px; margin-top: 5px; border-radius: 8px; background: #f0f0f0; display: none; background-size: cover; background-position: center;"></div>

            <button class="api-btn" onclick="clearNoteImage()" style="margin-top: 8px; background: #f0f0f0; color: #666;">清除图片</button>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeWidgetSettings('note')">取消</button>
            <button class="btn btn-save" onclick="saveNoteImage()">保存</button>
        </div>
    </div>
</div>



<!-- 世界书编辑弹窗 -->
<div class="modal-overlay" id="worldbookModal" onclick="closeWorldbookModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title" id="worldbookModalTitle">添加世界书</div>
        
        <div class="form-group">
            <label class="form-label">标题</label>
            <input type="text" id="worldbookTitle" class="form-input" placeholder="输入世界书标题">
        </div>
        
        <div class="form-group">
            <label class="form-label">分类</label>
            <select id="worldbookCategory" class="form-input">
                <option value="默认分类">默认分类</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">内容</label>
            <textarea id="worldbookContent" class="form-input" rows="6" placeholder="输入世界书内容..."></textarea>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeWorldbookModal()">取消</button>
            <button class="btn btn-save" onclick="saveWorldbook()">保存</button>
        </div>
    </div>
</div>
<!-- 分类管理弹窗 -->
<div class="modal-overlay" id="categoryModal" onclick="closeCategoryModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">管理分类</div>
        
        <div class="form-group">
            <label class="form-label">添加新分类</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="newCategoryName" class="form-input" placeholder="输入分类名称" style="flex: 1;">
                <button class="btn btn-save" onclick="addCategory()" style="flex: none; padding: 12px 16px;">添加</button>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">现有分类</label>
            <div id="categoryList" style="max-height: 200px; overflow-y: auto;">
                <!-- 分类列表将在这里生成 -->
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeCategoryModal()">关闭</button>
        </div>
    </div>
</div>
<!-- 添加单聊弹窗 -->
<div class="modal-overlay" id="addSingleChatModal" onclick="closeAddSingleModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">添加单聊</div>
        
        <div class="form-group">
            <label class="form-label">角色名字</label>
            <input type="text" id="singleChatName" class="form-input" placeholder="输入角色名字">
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeAddSingleModal()">取消</button>
            <button class="btn btn-save" onclick="createSingleChat()">确定</button>
        </div>
    </div>
</div>

<!-- 选择成员弹窗 -->
<div class="modal-overlay" id="selectMembersModal" onclick="closeSelectMembersModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 90%; width: 320px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div class="modal-title" style="margin: 0;">选择成员</div>
            <button class="btn btn-save" onclick="confirmMemberSelection()" style="padding: 8px 16px; margin: 0;">确定</button>
        </div>
        
        <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px; color: #666;">
            已选：<span id="selectedCount">0</span>人
        </div>
        
        <div id="membersList" style="max-height: 300px; overflow-y: auto;">
            <!-- 成员列表将在这里动态生成 -->
        </div>
    </div>
</div>
  <!-- 消息操作菜单弹窗 -->
<div class="modal-overlay" id="messageMenuModal" onclick="closeMessageMenu(event)">
    <div class="modal" onclick="event.stopPropagation()" style="padding: 20px; width: 280px;">
        <div class="modal-title" style="margin-bottom: 20px;">选择操作</div>
        
       <button class="message-menu-btn" id="deleteMessageBtn" onclick="startMultiSelectMode()">
    删除
</button>
<button class="message-menu-btn" id="quoteMessageBtn" onclick="quoteSelectedMessage()">
    引用
</button>
<button class="message-menu-btn" id="revokeMessageBtn" onclick="revokeSelectedMessage()">
    撤回
</button>
<button class="message-menu-btn" onclick="closeMessageMenu()" style="background: #f0f0f0; color: #666;">
    取消
</button>

    </div>
</div>
<!-- 基本信息编辑弹窗 -->
<div class="modal-overlay" id="editBasicInfoModal" onclick="closeEditBasicInfo(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">编辑基本信息</div>
        
        <div class="form-group">
            <label class="form-label">头像</label>
            <div class="avatar-preview" id="editAvatarPreview">👤</div>
            <label for="editAvatarInput" class="file-button">选择头像</label>
            <input type="file" id="editAvatarInput" class="file-input" accept="image/*">
        </div>
        
        <div class="form-group">
            <label class="form-label">角色名字</label>
            <input type="text" id="editCharName" class="form-input" placeholder="输入角色名字">
        </div>
        
     
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeEditBasicInfo()">取消</button>
            <button class="btn btn-save" onclick="saveBasicInfo()">保存</button>
        </div>
    </div>
</div>
<!-- 图标编辑弹窗 -->
<div class="modal-overlay" id="iconEditorModal" onclick="closeIconEditor(event)">
    <div class="modal" onclick="event.stopPropagation()" style="background: #fff; border-radius: 24px; padding: 25px; width: 300px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
        
        <div class="modal-title" style="font-size: 16px; font-weight: 700; margin-bottom: 20px; letter-spacing: 1px;">EDIT ICON</div>
        
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <div class="ins-icon-preview-box" id="currentIconPreview" style="width: 80px; height: 80px; font-size: 36px; border: 2px solid #eee;">
                </div>
        </div>
        
        <div class="ins-tab-group">
            <button class="ins-tab-btn active" onclick="switchIconTab('local')">本地</button>
            <button class="ins-tab-btn" onclick="switchIconTab('url')">链接</button>
            <button class="ins-tab-btn" onclick="resetToDefaultIcon()">恢复</button>
        </div>
        
        <div class="tab-content active" id="iconLocalTab">
            <div class="ins-upload-area" onclick="document.getElementById('iconFile').click()" style="padding: 20px;">
                <div style="font-size: 12px; color: #999;">点击选择新图标</div>
                <input type="file" id="iconFile" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <div class="tab-content" id="iconUrlTab">
            <input type="url" class="ins-input" id="iconUrl" placeholder="输入图片链接...">
        </div>
        
        <div class="ins-btn-row" style="margin-top: 20px;">
            <button class="ins-line-btn" onclick="closeIconEditor()">取消</button>
            <button class="ins-line-btn ins-btn-black" onclick="saveAppIcon()">保存</button>
        </div>
    </div>
</div>
<!-- 城市信息设置弹窗 -->
<div class="modal-overlay" id="cityInfoModal" onclick="closeCityInfoModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        
        <div class="ins-modal-header">LOCATION</div>
        
        <div class="ins-modal-body">
            
            <div class="ins-group-title">THEIR LOCATION</div>
            <div class="ins-list-group" style="margin: 0;">
                <div class="ins-list-item">
                    <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <div class="ins-item-label">虚拟</div>
                    <input type="text" id="charVirtualAddress" class="ins-item-input" placeholder="如: 哥谭市">
                </div>
                <div class="ins-list-item">
                    <svg class="ins-item-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <div class="ins-item-label">参照</div>
                    <input type="text" id="charRealAddress" class="ins-item-input" placeholder="如: New York (英文)">
                </div>
            </div>

            <div class="ins-group-title" style="margin-top: 20px;">MY LOCATION</div>
            <div class="ins-list-group" style="margin: 0;">
                <div class="ins-list-item">
                    <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <div class="ins-item-label">虚拟</div>
                    <input type="text" id="myVirtualAddress" class="ins-item-input" placeholder="如: 快乐星球">
                </div>
                <div class="ins-list-item">
                    <svg class="ins-item-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    <div class="ins-item-label">参照</div>
                    <input type="text" id="myRealAddress" class="ins-item-input" placeholder="如: Beijing (英文)">
                </div>
            </div>

            <button class="ins-fetch-btn" onclick="fetchWeatherData()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M21.34 5.5A10 10 0 1 1 11.26 2.75"/></svg>
                同步天气信息
            </button>
            
            <div id="weatherPreview" style="display: none;">
                </div>
        </div>

        <div class="ins-modal-footer">
            <button class="btn btn-cancel" onclick="closeCityInfoModal()" style="border-radius: 20px;">取消</button>
            <button class="btn btn-save" onclick="saveCityInfo()" style="border-radius: 20px; background: #333;">保存</button>
        </div>
    </div>
</div>

<!-- 表情包上传弹窗 -->
<div class="modal-overlay" id="emojiUploadModal" onclick="closeEmojiUploadModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">批量上传表情包</div>
        
        <div class="form-group">
            <label class="form-label">选择分类</label>
            <select id="emojiUploadCategory" class="form-input">
                <!-- 分类将动态生成 -->
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">批量输入（支持多种格式）</label>
            <textarea id="emojiUploadText" class="form-input" rows="8" placeholder="支持以下格式（每行一个）：&#10;哈哈https://example.com/1.jpg&#10;笑哭,https://example.com/2.jpg&#10;爱心 https://example.com/3.jpg&#10;点赞：https://example.com/4.jpg"></textarea>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                支持格式：文本链接 | 文本,链接 | 文本 链接 | 文本：链接
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeEmojiUploadModal()">取消</button>
            <button class="btn btn-save" onclick="confirmEmojiUpload()">确定上传</button>
        </div>
    </div>
</div>

<!-- 分类管理弹窗 -->
<div class="modal-overlay" id="emojiCategoryModal" onclick="closeEmojiCategoryModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">分类管理</div>
        
        <div class="form-group">
            <label class="form-label">添加新分类</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="newEmojiCategoryName" class="form-input" placeholder="输入分类名称" style="flex: 1;">
                <button class="btn btn-save" onclick="addEmojiCategory()" style="flex: none; padding: 12px 16px;">添加</button>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">现有分类</label>
            <div id="emojiCategoryList" style="max-height: 200px; overflow-y: auto;">
                <!-- 分类列表将动态生成 -->
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeEmojiCategoryModal()">关闭</button>
        </div>
    </div>
</div>
<!-- 转账弹窗 -->
<div class="modal-overlay" id="transferModal" onclick="closeTransferModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="width: 280px;">
        <div class="modal-title" id="transferModalTitle">转账给 张三</div>
        
        <div class="form-group">
            <label class="form-label">金额</label>
            <input type="number" id="transferAmount" class="form-input" placeholder="0.00" step="0.01" min="0.01" style="font-size: 20px; text-align: center; color: #ff4757;">
        </div>
        
        <!-- 快捷金额 -->
        <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
            <button class="quick-amount-btn" onclick="setQuickAmount(5.20)">¥5.20</button>
            <button class="quick-amount-btn" onclick="setQuickAmount(52)">¥52</button>
            <button class="quick-amount-btn" onclick="setQuickAmount(66)">¥66</button>
            <button class="quick-amount-btn" onclick="setQuickAmount(88)">¥88</button>
            <button class="quick-amount-btn" onclick="setQuickAmount(520)">¥520</button>
        </div>
        
     
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeTransferModal()">取消</button>
            <button class="btn btn-save" onclick="confirmTransfer()">确认转账</button>
        </div>
    </div>
</div>
<!-- 语音消息弹窗 -->
<div class="modal-overlay" id="voiceModal" onclick="closeVoiceModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="width: 280px;">
        <div class="modal-title">发送语音</div>
        
        <div class="form-group">
            <textarea id="voiceTextInput" class="form-input" rows="4" placeholder="请输入要转成语音的内容..." maxlength="200" style="resize: none;"></textarea>
            <div style="font-size: 12px; color: #999; margin-top: 5px; text-align: right;">
                <span id="voiceCharCount">0</span>/200字
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeVoiceModal()">取消</button>
            <button class="btn btn-save" onclick="sendVoiceMessage()">发送</button>
        </div>
    </div>
</div>
<!-- 通话页面 -->
<div class="call-screen" id="callScreen">
<!-- 右上角小窗 - 显示用户头像/摄像头 -->
<div class="pip-window" id="pipWindow" style="display: none;">
    <div class="pip-avatar" id="pipAvatar">👤</div>
    <!-- ▼▼▼ 新增：相机画面 ▼▼▼ -->
    <video id="localVideo" autoplay playsinline muted style="display: none; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
    <!-- ▲▲▲ 新增结束 ▲▲▲ -->
</div>


    <!-- 顶部状态区 -->
    <div class="call-header">
        <div class="call-name" id="callCharacterName">张三</div>
        <div class="call-status" id="callStatus">正在呼叫...</div>
             <button class="call-settings-btn" onclick="openCallSettings()">⚙️</button>

    </div>

    
    <!-- 对话区域 -->
    <div class="call-messages-container" id="callMessagesContainer">
        <div class="call-messages" id="callMessages">
            <!-- 对话内容将动态生成 -->
        </div>
    </div>
    
    <!-- 按钮区域 -->
<div class="call-hangup-section">
    <!-- 左边：小窗开关 -->
    <button class="pip-btn" onclick="togglePIPWindow()" title="显示/隐藏小窗">
        📱
    </button>
    
    <!-- 中间：挂断 -->
    <button class="hangup-btn" onclick="hangupCall()">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
        </svg>
    </button>

    <!-- ▼▼▼ 右边：相机开关 ▼▼▼ -->
    <button class="pip-btn" onclick="toggleCamera()" title="开启/关闭摄像头" style="margin-right: 0; margin-left: 15px;">
        📷
    </button>
    <!-- ▲▲▲ 新增结束 ▲▲▲ -->
</div>


    
    <!-- 输入栏（复制聊天页的） -->
    <div class="call-input-bar">
        <textarea class="chat-input" id="callInput" placeholder="输入消息..." rows="1" disabled></textarea>
        <button class="action-icon-btn" onclick="sendCallMessage()" id="callSendBtn">
            <img src="https://img.heliar.top/file/1765364506053_feather.png" alt="发送">
        </button>
        <button class="action-icon-btn" onclick="receiveCallReply()" id="callReceiveBtn">
            <img src="https://img.heliar.top/file/1765364502822_mail.png" alt="接收">
        </button>
    </div>

<!-- 通话设置弹窗 -->
<div class="modal-overlay" id="callSettingsModal" onclick="closeCallSettings(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 90%; width: 280px; max-height: 80vh; overflow-y: auto; padding: 20px;">

        <div class="modal-title">通话设置</div>
        
        <!-- 壁纸设置 -->
        <div class="form-group">
            <label class="form-label">通话壁纸</label>
            <div class="file-input-area" onclick="document.getElementById('callWallpaperFile').click()">
                <div>📁 点击选择图片</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">支持 JPG、PNG 格式</div>
                <input type="file" id="callWallpaperFile" accept="image/*" style="display: none;">
            </div>
            <button class="api-btn" onclick="resetCallWallpaper()" style="margin-top: 10px; background: #999;">恢复默认渐变</button>
        </div>

<!-- 用户头像设置 -->
<div class="form-group">
    <label class="form-label">用户头像</label>
    <div class="file-input-area" id="userAvatarArea" onclick="document.getElementById('userAvatarFile').click()">
        <div class="avatar-upload-content">
            <div style="font-size: 12px;">📁 点击选择头像</div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">支持 JPG、PNG 格式</div>
        </div>
        <input type="file" id="userAvatarFile" accept="image/*" style="display: none;">
    </div>
</div>



<!-- 聊天气泡主题选择 -->
<div class="form-group">
    <label class="form-label">聊天气泡主题</label>
    <div style="display: flex; gap: 20px; margin-top: 10px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="callTheme" value="light" checked style="cursor: pointer;">
            <span style="font-size: 13px; color: #333;">白底黑字</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="callTheme" value="dark" style="cursor: pointer;">
            <span style="font-size: 13px; color: #333;">黑底白字</span>
        </label>
    </div>
</div>



        
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="btn btn-cancel" onclick="closeCallSettings()">取消</button>
            <button class="btn btn-save" onclick="saveCallSettings()">保存</button>
        </div>
    </div>
</div>
</div>


<!-- ============ 购物页面 ============ -->
<div class="shopping-screen" id="shoppingScreen">
    <!-- 顶部导航栏 -->
<div class="shopping-header">
    <button class="back-btn" onclick="backFromShopping()">←</button>
    
    <div class="header-title" style="margin: 0; display: flex; justify-content: center;">
        <div class="shopping-switch-container">
            <button class="shopping-switch-btn active" id="btn-goods" onclick="switchShoppingTab('goods')">百货</button>
            <button class="shopping-switch-btn" id="btn-food" onclick="switchShoppingTab('food')">外卖</button>
        </div>
    </div>
    
    <button class="back-btn" onclick="openShoppingCart()" style="position: relative;">
        🛒
        <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
    </button>
</div>
    
 <!-- 搜索区域 -->
<div class="shopping-search-area">
    <div class="search-card">
        <div class="search-icon">🔍</div>
        <input type="text" id="shoppingSearchInput" class="search-input" placeholder="搜索你想要的商品...">
        <button class="search-btn" onclick="generateProducts()">搜索</button>
    </div>
</div>


    
    <!-- 商品列表 -->
    <div class="shopping-content" id="shoppingProductList">
        <!-- 商品卡片将在这里动态生成 -->
    </div>
    
    <!-- 添加商品按钮 -->
    <button class="add-btn" onclick="openAddProduct()">+</button>
</div>

<!-- 购物车页面 -->
<div class="shopping-cart-screen" id="shoppingCartScreen">
    <div class="shopping-header">
        <button class="back-btn" onclick="backToShopping()">←</button>
        <div class="header-title">购物车</div>
        <button class="back-btn" style="opacity: 0; pointer-events: none;">⋮</button>
    </div>
    
    <div class="cart-content" id="cartContent">
        <!-- 购物车商品将在这里动态生成 -->
    </div>
    
    <div class="cart-footer" id="cartFooter">
        <div class="cart-total">
            合计: <span id="cartTotalPrice">¥0.00</span>
        </div>
        <button class="btn-checkout" onclick="checkout()">结算</button>
    </div>
</div>

<!-- 添加/编辑商品弹窗 -->
<div class="modal-overlay" id="productModal" onclick="closeProductModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title" id="productModalTitle">添加商品</div>
        
        <div class="form-group">
            <label class="form-label">商品名称</label>
            <input type="text" id="productName" class="form-input" placeholder="输入商品名称">
        </div>
        
        <div class="form-group">
            <label class="form-label">商品价格</label>
            <input type="number" id="productPrice" class="form-input" placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="form-group">
            <label class="form-label">商品描述（选填）</label>
            <textarea id="productDescription" class="form-input" rows="3" placeholder="输入商品描述..."></textarea>
        </div>
        
      
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeProductModal()">取消</button>
            <button class="btn btn-save" onclick="saveProduct()">保存</button>
        </div>
    </div>
</div>

<!-- 记忆编辑弹窗 -->
<div class="modal-overlay" id="memoryEditModal" onclick="closeMemoryEditModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title" id="memoryModalTitle">编辑记忆</div>
        
        <!-- 内容输入 -->
        <div class="form-group">
            <label class="form-label">内容</label>
            <textarea id="memoryContentInput" class="form-input" rows="4" placeholder="写下这段记忆..."></textarea>
        </div>
        
        <!-- 日期选项 -->
        <div class="form-group" id="dateOptionGroup">
            <label class="form-label">发生日期</label>
            <input type="date" id="memoryDateInput" class="form-input">
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" id="btnDeleteMemory" onclick="deleteCurrentMemory()" style="background: #ff4757; color: white; display: none;">删除</button>
            <button class="btn btn-cancel" onclick="closeMemoryEditModal()">取消</button>
            <button class="btn btn-save" onclick="saveMemory()">保存</button>
        </div>
    </div>
</div>


<!-- 状态监控弹窗 -->
<div class="modal-overlay" id="statusMonitorModal" onclick="closeStatusMonitorModal(event)">
    <div class="status-monitor-panel" onclick="event.stopPropagation()">
        <div class="status-monitor-header">
            <div class="status-monitor-title">状态监控</div>
            <button class="status-close-btn" onclick="closeStatusMonitorModal()">×</button>
        </div>
        
        <div class="status-monitor-scroll">
            <!-- 此刻心情 -->
            <div class="status-block">
                <div class="status-block-header">
                    <div class="status-block-title">
                        <span class="status-emoji">💭</span>
                        此刻心情
                    </div>
                    <div class="status-heartbeat-mini">
                        <svg class="ecg-mini" viewBox="0 0 60 20" preserveAspectRatio="none">
                            <polyline class="ecg-line-mini" points="0,10 10,10 15,3 20,17 25,10 35,10 40,3 45,17 50,10 60,10"/>
                        </svg>
                        <span class="bpm-mini" id="statusBpm">72 BPM</span>
                    </div>
                </div>
                <div class="status-block-content" id="statusMoodText">今天心情不错，阳光正好~</div>
                <div class="mood-progress">
                    <div class="mood-progress-fill" id="moodProgressFill" style="width: 75%;"></div>
                </div>
                <div class="mood-label"><span id="moodPercent">75</span>% 积极</div>
            </div>
            
            <!-- 今日穿着 -->
            <div class="status-block">
                <div class="status-block-header">
                    <div class="status-block-title">
                        <span class="status-emoji">👔</span>
                        今日穿着
                    </div>
                </div>
                <div class="status-block-content" id="statusClothesText">简约休闲风</div>
                <div class="clothes-tag-list" id="statusClothesTags">
                    <span class="clothes-tag">白色T恤</span>
                    <span class="clothes-tag">牛仔裤</span>
                    <span class="clothes-tag">运动鞋</span>
                </div>
            </div>
            
            <!-- 当前行为 -->
            <div class="status-block">
                <div class="status-block-header">
                    <div class="status-block-title">
                        <span class="status-emoji">🚶</span>
                        当前行为
                    </div>
                </div>
                <div class="status-block-content" id="statusActionText">正在咖啡厅看书，享受午后时光。</div>
            </div>
            
            <!-- 内心想法 -->
            <div class="status-block">
                <div class="status-block-header">
                    <div class="status-block-title">
                        <span class="status-emoji">💡</span>
                        内心想法
                    </div>
                </div>
                <div class="status-block-content" id="statusThoughtsText">最近在思考人生的意义，也许应该计划一次旅行放松一下。</div>
            </div>
            
         
        </div>
    </div>
</div>

<!-- 摄像头免责声明弹窗 -->
<div class="modal-overlay" id="cameraPrivacyModal">
    <div class="modal" style="width: 300px; text-align: center;">
        <div style="font-size: 40px; margin-bottom: 10px;">🔒</div>
        <div class="modal-title" style="margin-bottom: 10px;">隐私安全提示</div>
        <div style="font-size: 14px; color: #666; line-height: 1.6; text-align: left; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 10px;">
            开启摄像头后，画面将用于 AI 视觉识别。<br><br>
            <strong>免责声明：</strong><br>
            1. 所有视频数据仅在<strong>本地浏览器</strong>处理。<br>
            2. 画面截图仅发送给您配置的 API 服务商。<br>
            3. 作者无法获取您的任何画面或数据。<br>
            4.请注意您的隐私<br><br>
            点击“确认开启”即代表您已知晓并同意。
        </div>
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeCameraPrivacyModal()">取消</button>
            <button class="btn btn-save" onclick="confirmOpenCamera()">确认开启</button>
        </div>
    </div>
</div>
<!-- 字体设置弹窗 -->
<div class="modal-overlay" id="fontSettingsModal" onclick="closeFontSettingsModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">字体设置</div>
        
        <!-- 预设管理 -->
        <div class="form-group">
            <label class="form-label">我的预设</label>
            <div style="display: flex; gap: 10px;">
                <select id="fontPresetSelect" class="form-input" onchange="applyFontPreset()">
                    <option value="">选择预设...</option>
                </select>
                              <button class="btn btn-save" onclick="saveFontPreset()" style="width: auto; padding: 0 12px; white-space: nowrap;">保存当前</button>                      
                <button class="btn btn-cancel" onclick="deleteFontPreset()" style="width: auto; padding: 0 12px; background: #ff4757; color: white; white-space: nowrap;">删除</button>
            </div>
        </div>

        <!-- 字体 URL -->
        <div class="form-group">
            <label class="form-label">字体链接 (URL)</label>
            <input type="url" id="fontUrlInput" class="form-input" placeholder="输入 .woff2 或 .ttf 字体直链">
            <div style="font-size: 10px; color: #999; margin-top: 5px;">留空则恢复默认字体。</div>
        </div>

        <!-- 字体大小 -->
        <div class="form-group">
            <div style="display: flex; justify-content: space-between;">
                <label class="form-label">字体大小</label>
                <span id="fontSizeDisplay" style="font-size: 14px; color: #667eea; font-weight: bold;">14px</span>
            </div>
            <input type="range" id="fontSizeInput" class="form-input" min="12" max="20" step="1" value="14" oninput="previewFontSize(this.value)">
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeFontSettingsModal()">取消</button>
            <button class="btn btn-save" onclick="saveFontSettings()">应用并保存</button>
        </div>
    </div>
</div>


<!-- 备份管理弹窗 -->
<div class="modal-overlay" id="backupSettingsModal" onclick="closeBackupSettingsModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">备份管理</div>
        
        <div style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; line-height: 1.5;">
            ℹ️ <strong>提示：</strong><br>
            备份文件包含您所有的数据（聊天记录、图片、设置、记忆等）。<br>
            请妥善保管您的备份文件（.json）。
        </div>

        <!-- 导出 -->
        <div class="form-group">
            <label class="form-label">导出数据</label>
            <button class="ins-line-btn ins-btn-black" onclick="exportFullBackup()" style="width: 100%; justify-content: center;">
                <span>📤 立即生成全量备份</span>
            </button>
            <div style="font-size: 10px; color: #999; margin-top: 5px; text-align: center;">包含所有图片和聊天记录，文件可能较大</div>
        </div>

        <div style="height: 1px; background: #eee; margin: 20px 0;"></div>

        <!-- 导入 -->
        <div class="form-group">
            <label class="form-label">恢复数据</label>
            <div class="file-input-area" onclick="document.getElementById('backupFileInput').click()" style="border: 2px dashed #ccc; background: #fafafa;">
                <div style="font-size: 14px; color: #666;">📥 点击选择备份文件</div>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">支持 .json 格式</div>
                <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="handleBackupFileSelect(this)">
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeBackupSettingsModal()">关闭</button>
        </div>
    </div>
</div>

<!-- 清除缓存弹窗 -->
<div class="modal-overlay" id="cleanCacheModal" onclick="closeCleanCacheModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">清除缓存</div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 40px; margin-bottom: 10px;">🧹</div>
            <div style="font-size: 14px; color: #666; line-height: 1.6;">
                即将清理聊天记录中的<br>
                <strong>图片</strong> 和 <strong>表情包</strong>
            </div>
        </div>

        <div style="background: #fff5f5; border: 1px solid #ffcccc; color: #e11d48; padding: 12px; border-radius: 8px; font-size: 12px; margin-bottom: 20px; text-align: left;">
            ⚠️ <strong>注意：</strong><br>
            • 文字聊天记录会被<strong>保留</strong>。<br>
            • 清理后的图片将无法恢复。<br>
            • 此操作可显著减少卡顿。
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeCleanCacheModal()">取消</button>
            <button class="btn btn-save" onclick="confirmClearCache()" style="background: #ff4757; color: white; border: none;">确认清理</button>
        </div>
    </div>
</div>
<!-- 初始化数据弹窗 -->
<div class="modal-overlay" id="resetDataModal" onclick="closeResetModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">初始化所有数据</div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 40px; margin-bottom: 10px;">⚠️</div>
            <div style="font-size: 14px; color: #333; font-weight: 600;">
                危险操作警告
            </div>
        </div>

        <div style="background: #fff5f5; border: 1px solid #ffcccc; color: #e11d48; padding: 15px; border-radius: 12px; font-size: 13px; margin-bottom: 25px; line-height: 1.6;">
            此操作将<strong>永久删除</strong>所有数据：<br>
            • 所有聊天记录与图片<br>
            • 角色设定与记忆<br>
            • API配置与个性化设置<br>
            <br>
            APP 将恢复到刚安装时的状态，且<strong>无法撤销</strong>。
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeResetModal()">取消</button>
            <button class="btn btn-save" onclick="confirmResetData()" style="background: #ff4757; color: white; border: none;">确认初始化</button>
        </div>
    </div>
</div>
<!-- 导航栏颜色设置弹窗 -->
<div class="modal-overlay" id="navColorModal" onclick="closeNavColorModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">导航栏字体颜色</div>
        
        <div class="form-group">
            <label class="form-label">选择颜色</label>
            <div style="display: flex; align-items: center; gap: 15px;">
                <input type="color" id="navColorInput" class="form-input" style="height: 50px; padding: 2px; flex: 1;" oninput="previewNavColor(this.value)">
                <div id="navColorPreviewText" style="font-size: 16px; font-weight: bold; color: #333;">预览文字</div>
            </div>
        </div>
        
        <div style="font-size: 12px; color: #999; margin-top: 10px;">
            将应用到：角色列表页、聊天详情页
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeNavColorModal()">取消</button>
            <button class="btn btn-save" onclick="saveNavColor()">保存</button>
        </div>
    </div>
</div>

<!-- 消息提示音设置弹窗 -->
<div class="modal-overlay" id="notificationSoundModal" onclick="closeNotificationSoundModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">🔔 消息提示音</div>
        
        <!-- 1. 开关 -->
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 12px;">
            <label class="form-label" style="margin: 0; font-weight: 600;">启用提示音</label>
            <input type="checkbox" id="soundEnabledToggle" style="accent-color: #333; transform: scale(1.3);">
        </div>

        <!-- 2. 声音文件 -->
        <div class="form-group">
            <label class="form-label">自定义声音 (mp3/wav)</label>
            
            <!-- 文件选择区 -->
            <div class="file-input-area" onclick="document.getElementById('soundFileInput').click()" style="padding: 15px; border: 2px dashed #eee; background: #fff;">
                <div id="soundFileName" style="font-size: 13px; color: #333; font-weight: bold;">使用默认音效</div>
                <div style="font-size: 11px; color: #999; margin-top: 5px;">点击上传自定义音效</div>
               <input type="file" id="soundFileInput" accept=".mp3,.wav,audio/*" style="display: none;" onchange="handleSoundUpload(this)">

            </div>
            
            <!-- 试听与重置 -->
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="ins-line-btn" onclick="previewSound()" style="flex: 1;">
                    ▶️ 试听当前
                </button>
                <button class="ins-line-btn" onclick="resetSoundToDefault()" style="flex: 1; color: #ff4757; border-color: #ff4757;">
                    ↺ 恢复默认
                </button>
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeNotificationSoundModal()">取消</button>
            <button class="btn btn-save" onclick="saveNotificationSoundSettings()">保存设置</button>
        </div>
    </div>
</div>

<!-- 角色语音设置弹窗 -->
<div class="modal-overlay" id="voiceRoleModal" onclick="closeVoiceRoleModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">角色语音</div>
        
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
            <label class="form-label" style="margin: 0;">启用角色语音</label>
            <input type="checkbox" id="voiceEnabled" style="accent-color: #333; transform: scale(1.3);">
        </div>
        
        <div id="voiceConfigPanel" style="display: none;">
            <div class="form-group">
                <label class="form-label">MiniMax API Key</label>
                <input type="password" id="minimaxApiKey" class="form-input" placeholder="sk-...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Group ID</label>
                <input type="text" id="minimaxGroupId" class="form-input" placeholder="输入Group ID">
            </div>
            
            <div class="form-group">
                <label class="form-label">语音音色ID</label>
                <input type="text" id="voiceCharacterId" class="form-input" placeholder="如: female-tianmei">
            </div>
            
            <div style="font-size: 12px; color: #999; background: #f0f0f0; padding: 10px; border-radius: 8px;">
                💡 提示：在 <a href="https://www.minimaxi.com" target="_blank" style="color: #667eea;">MiniMax官网</a> 的文字转语音页面查看可用音色
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeVoiceRoleModal()">关闭</button>
            <button class="btn btn-save" onclick="saveVoiceConfig()">保存</button>
        </div>
    </div>
</div>

<!-- 文字图输入弹窗 -->
<div class="modal-overlay" id="textImageModal" onclick="closeTextImageModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">发送文字图</div>
        <div class="form-group">
            <textarea id="textImageContent" class="form-input" rows="5" placeholder="描述画面内容...&#10;例如：午后的阳光洒在书桌上，一杯咖啡冒着热气。" style="resize: none;"></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeTextImageModal()">取消</button>
            <button class="btn btn-save" onclick="sendTextImage()">发送</button>
        </div>
    </div>
</div>
<!-- 文字图详情弹窗 -->
<div class="modal-overlay" id="textImageDetailModal" onclick="closeTextImageDetailModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="width: 80%; max-width: 300px;">
        <div class="modal-title" style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
            画面描述
        </div>
        <div id="textImageDetailContent" style="
            font-size: 15px; 
            color: #333; 
            line-height: 1.6; 
            padding: 15px; 
            background: #f9f9f9; 
            border-radius: 8px; 
            min-height: 60px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        "></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="btn btn-save" onclick="closeTextImageDetailModal()" style="width: 100%;">关闭</button>
        </div>
    </div>
</div>

<!-- 底部评论输入框容器 -->
<div id="commentInputBar" class="comment-input-bar" style="display: none;">
    <input type="text" id="commentInput" class="comment-input" placeholder="评论...">
    <button class="comment-send-btn" onclick="sendUserComment()">发送</button>
</div>

<!-- ====== 关系网弹窗 START ====== -->
<div class="modal-overlay" id="relationshipModal" onclick="closeRelationshipModal(event)">
    <div class="modal relationship-modal" onclick="event.stopPropagation()">
        <div class="modal-title">关系网</div>

        <div style="font-size: 12px; color: #999; line-height: 1.6; margin-bottom: 12px;">
            这里写下 TA 的朋友圈关系网。<br>
        
        </div>

        <div class="form-group">
            <textarea id="relationshipTextInput" class="form-input" rows="8" placeholder="例如：&#10;张三：从小一起长大，互怼但很照顾我。&#10;路人甲：楼下邻居，喜欢插科打诨。&#10;小夏：闺蜜，爱吐槽，信息很灵通。"></textarea>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeRelationshipModal()">取消</button>
            <button class="btn btn-save" onclick="saveRelationshipText()">保存</button>
        </div>
    </div>
</div>
<!-- ====== 关系网弹窗 END ====== -->

<!-- ====== 动态可见性选择弹窗 START ====== -->
<div class="modal-overlay" id="momentVisibilityModal" onclick="closeMomentVisibilityModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">谁可以看</div>

        <div class="form-group" style="display:flex; flex-direction:column; gap:10px;">
            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="radio" name="momentVisibilityMode" value="public" onchange="handleMomentVisibilityModeChange()">
                <span style="font-size:14px; color:#333;">公开（全员）</span>
            </label>

            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="radio" name="momentVisibilityMode" value="group" onchange="handleMomentVisibilityModeChange()">
                <span style="font-size:14px; color:#333;">分组可见</span>
            </label>
        </div>

        <div class="form-group" id="momentVisibilityGroupPanel" style="display:none;">
            <label class="form-label">选择分组</label>
            <select id="momentVisibilityGroupSelect" class="form-input" onchange="handleMomentVisibilityChange()">
                <option value="">请选择分组...</option>
            </select>
            <div style="font-size:12px; color:#999; margin-top:6px; line-height:1.4;">
                仅该分组内的角色会来评论（氛围）。
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeMomentVisibilityModal()">关闭</button>
        </div>
    </div>
</div>
<!-- ====== 动态可见性选择弹窗 END ====== -->

<!-- ====== 动态转发弹窗 START ====== -->
<div class="modal-overlay" id="momentForwardModal" onclick="closeMomentForwardModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-height: 80vh; overflow-y: auto;">
        <div class="modal-title">转发动态</div>

        <div style="background:#f9f9f9; border:1px solid #eee; padding:10px 12px; border-radius:12px; font-size:12px; color:#666; line-height:1.5; margin-bottom: 12px;">
            已选：<span id="forwardSelectedCount" style="font-weight:700; color:#333;">0</span> 人
        </div>

        <div id="momentForwardList" style="max-height: 320px; overflow-y: auto;"></div>

        <div class="modal-buttons" style="margin-top: 16px;">
            <button class="btn btn-cancel" onclick="closeMomentForwardModal()">取消</button>
            <button class="btn btn-save" onclick="confirmMomentForward()">确认转发</button>
        </div>
    </div>
</div>
<!-- ====== 动态转发弹窗 END ====== -->

<!-- ====== 关联世界书选择弹窗 START ====== -->
<div class="modal-overlay" id="worldbookSelectorModal" onclick="closeWorldbookSelectorModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 90%; width: 360px;">
        <div class="modal-title">选择关联世界书</div>
        
        <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px; color: #666;">
            已选：<span id="worldbookSelectedCount">0</span> 本
        </div>
        
        <!-- 分类筛选标签 -->
        <div id="worldbookCategoryFilter" style="display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 8px;">
            <!-- JS 动态生成 -->
        </div>
        
        <!-- 世界书列表 -->
        <div id="worldbookSelectorList" style="max-height: 320px; overflow-y: auto; border-top: 1px solid #f0f0f0;">
            <!-- JS 动态生成 -->
        </div>
        
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="btn btn-cancel" onclick="closeWorldbookSelectorModal()">取消</button>
            <button class="btn btn-save" onclick="saveWorldbookSelection()">保存</button>
        </div>
    </div>
</div>
<!-- ====== 关联世界书选择弹窗 END ====== -->


<!-- 用户计划弹窗 -->
<div class="modal-overlay" id="userPlanModal" onclick="closeUserPlanModal(event)" style="z-index: 2005;">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">我的今日计划</div>
        <div class="form-group">
            <label class="form-label">输入你的安排 (时间+事项)</label>
            <textarea id="userPlanInput" class="form-input" rows="6" placeholder="例如：&#10;09:00 去公司开会&#10;12:30 和同事吃饭&#10;19:00 去健身房&#10;22:00 回家打游戏"></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeUserPlanModal()">取消</button>
            <button class="btn btn-save" onclick="saveUserPlan()">保存</button>
        </div>
    </div>
</div>

<!-- 角色作息弹窗 -->
<div class="modal-overlay" id="charRoutineModal" onclick="closeRoutineModal(event)" style="z-index: 2005;">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">TA的作息习惯 (选填)</div>
        <div class="form-group">
            <label class="form-label">大致规律</label>
            <textarea id="charRoutineInput" class="form-input" rows="6" placeholder="例如：&#10;一般睡到中午才起&#10;下午必须喝咖啡&#10;晚上经常熬夜工作&#10;周五晚上喜欢去酒吧"></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeRoutineModal()">取消</button>
            <button class="btn btn-save" onclick="saveRoutine()">保存</button>
        </div>
    </div>
</div>

<!-- 抽签弹窗 -->
<div class="modal-overlay" id="drawLotModal" onclick="closeDrawLotModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 320px; text-align: center;">
        
      <!-- 标题（右上角绑定按钮） -->
<div style="position: relative; margin-bottom: 25px;">
    <div class="modal-title" style="margin: 0;">今日运势</div>

    <button class="back-btn" onclick="openFortuneWorldbookModal()" title="绑定世界书"
        style="position:absolute; top:-6px; right:-6px; width: 32px; height: 32px; border: 1px solid #eee; border-radius: 12px;">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
    </button>
</div>

        
        <!-- 舞台区域 -->
        <div id="lotStage" style="min-height: 280px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            
            <!-- 签桶 -->
            <div id="lotBucket" onclick="drawLot()" style="width: 140px; height: 140px; border-radius: 50%; background: #fafafa; border: 2px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s;">
                <div style="font-size: 48px;">🎴</div>
                <div style="font-size: 13px; font-weight: 600; color: #666; margin-top: 8px;">点击抽签</div>
            </div>
            
            <!-- 抽中的签 -->
            <div id="drawnLot" style="display: none;">
                <div id="lotResult" style="width: 100px; height: 100px; border-radius: 50%; background: #333; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 42px; font-weight: 700; margin-bottom: 20px;">吉</div>
                <button class="btn btn-save" onclick="viewLotDetail()" style="width: 100%; padding: 12px; border-radius: 12px;">查看签文</button>
            </div>
            
            <!-- 签文详情 -->
            <div id="lotDetailCard" style="display: none; width: 100%;">
                <div id="lotLoading" style="padding: 30px 0;">
                    <div style="width: 36px; height: 36px; border: 3px solid #f0f0f0; border-top-color: #333; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 15px;"></div>
                    <div style="color: #999; font-size: 13px;">生成签文中...</div>
                </div>
                <div id="lotContent" style="display: none;">
                    <div id="lotEventText" style="background: #f9f9f9; padding: 20px; border-radius: 12px; font-size: 15px; line-height: 1.8; color: #333; margin-bottom: 20px; border: 1px solid #f0f0f0;"></div>
                    <button class="btn btn-save" onclick="acceptLotAndClose()" style="width: 100%; padding: 14px; border-radius: 12px;">接受签文</button>
                </div>
            </div>
            
        </div>
        
    </div>
</div>


<!-- ====== 抽签专用：绑定世界书弹窗 START ====== -->
<div class="modal-overlay" id="fortuneWorldbookModal" onclick="closeFortuneWorldbookModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 90%; width: 360px;">
        <div class="modal-title">绑定抽签世界书</div>

        <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px; color: #666;">
            已选：<span id="fortuneWorldbookSelectedCount">0</span> 本
        </div>

        <div id="fortuneWorldbookSelectorList" style="max-height: 320px; overflow-y: auto; border-top: 1px solid #f0f0f0;">
            <!-- JS 动态生成 -->
        </div>

        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="btn btn-cancel" onclick="closeFortuneWorldbookModal()">取消</button>
            <button class="btn btn-save" onclick="saveFortuneWorldbookSelection()">保存</button>
        </div>
    </div>
</div>
<!-- ====== 抽签专用：绑定世界书弹窗 END ====== -->


<script src="script.js"></script>
<script src="extra.js"></script>
<script src="cat.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>



</body>
</html>
