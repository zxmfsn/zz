<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå°æ‰‹æœº</title>
    
    <style>
        /* å…ˆåšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œè®©é¡µé¢è¡¨ç°æ›´ç»Ÿä¸€ */
     /* å‡†å¤‡å·¥ä½œ - ç§»é™¤å±…ä¸­ï¼Œæ”¹ä¸ºå…¨å±å¡«å…… */
body {
    margin: 0;
    padding: 0; /*  ç¡®ä¿æ²¡æœ‰å†…è¾¹è· */
    font-family: sans-serif;
    /* ã€åˆ é™¤ã€‘ä¸å†éœ€è¦ flex å±…ä¸­ */
    /* display: flex;
    justify-content: center;
    align-items: center; */
    min-height: 100vh;
    background-color: #000; /* ã€ä¿®æ”¹ã€‘èƒŒæ™¯æ”¹ä¸ºé»‘è‰²ï¼Œæ›´åƒçœŸæ‰‹æœº */
    overflow: hidden; /*  é˜²æ­¢é¡µé¢æ»šåŠ¨ */
}


   /* æ‰‹æœºå±å¹•çš„æ•´ä½“æ ·å¼ - å“åº”å¼å…¨å±ç‰ˆæœ¬ */
.phone-screen {
    /* ã€å…³é”®ä¿®æ”¹ã€‘ä½¿ç”¨è§†å£å•ä½å®ç°å…¨å± */
    width: 100vw;
    height: 100vh;
    /* ã€å…¼å®¹æ€§ä¿®å¤ã€‘ä½¿ç”¨ CSS å˜é‡åº”å¯¹ç§»åŠ¨ç«¯æµè§ˆå™¨åœ°å€æ  */
    height: calc(var(--vh, 1vh) * 100);
    
    background-color: #ffffff;
    border-radius: 0px; /* å…¨å±ä¸éœ€è¦åœ†è§’ */
    box-shadow: none; /* å…¨å±ä¸éœ€è¦é˜´å½± */
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    
    /* ä¿ç•™åŸæœ‰çš„èƒŒæ™¯è®¾ç½® */
    background-image: url('https://i.pinimg.com/564x/8b/2c/3a/8b2c3ae5123519a797f66a1a1f3b39d1.jpg');
    background-size: cover;
    background-position: center;
}


   /* çŠ¶æ€æ çš„æ ·å¼ */
        .status-bar {
            /* ä¿®æ”¹è¿™é‡Œï¼šå‡å°‘ä¸Šä¸‹å†…è¾¹è·ï¼Œè®©å®ƒæ›´é ä¸Š */
            padding: 10px 25px;
     
            font-weight: bold;
            color: #333;
      
            /* æ·»åŠ ä¸‹é¢ä¸¤è¡Œï¼šé‡æ–°è¯·å›æˆ‘ä»¬çš„â€œäº¤é€šæŒ‡æŒ¥å‘˜â€ */
            display: flex;
            justify-content: space-between; /* è¿™å¥ä»£ç å°±æ˜¯é­”æ³•ï¼å®ƒå‘½ä»¤é‡Œé¢çš„å…ƒç´ ä¸€ä¸ªé å·¦ï¼Œä¸€ä¸ªé å³ */
        }
        /* åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç ï¼šæ—¶é—´ç»„ä»¶çš„æ ·å¼ */
        .time-widget {
            color: #333;
            text-align: center;
            padding: 20px 0;
            text-shadow: 0 1px 3px rgba(0,0,0,0.1); /* ç»™æ–‡å­—åŠ ä¸€ç‚¹ç‚¹é˜´å½± */
           cursor: pointer;
        }
        .time-widget p {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        .time-widget h1 {
            margin: 0;
            font-size: 72px; /* è¶…å¤§å­—å· */
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* ä¸­é—´AppåŒºåŸŸçš„ç½‘æ ¼å¸ƒå±€ */
        .app-grid {
            flex-grow: 1; /* è®©å®ƒå æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
            padding: 20px;
            display: grid;
            /* â†“â†“â†“ æŠŠä¸‹é¢è¿™ä¸€è¡Œæ”¹æ‰ â†“â†“â†“ */
            grid-template-columns: 75px 75px 1fr 1fr; /* å‰ä¸¤åˆ—å›ºå®šå®½åº¦ï¼Œåä¸¤åˆ—å¹³åˆ†å‰©ä½™ç©ºé—´ */
            gap: 15px; /* è®¾ç½®å›¾æ ‡ä¹‹é—´çš„é—´è· */
            align-content: flex-start; /* è®©å›¾æ ‡ä»é¡¶éƒ¨å¼€å§‹æ’åˆ— */
        }

        /* å•ä¸ªAppå›¾æ ‡çš„æ ·å¼ */
        .app-icon {
            display: flex;
            flex-direction: column; /* å›¾æ ‡å’Œæ–‡å­—å‚ç›´æ’åˆ— */
            align-items: center; /* æ°´å¹³å±…ä¸­ */
            text-align: center;
        }

        /* å›¾æ ‡çš„å ä½ç¬¦æ ·å¼ */
        .app-icon .icon-placeholder {
            width: 60px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜çš„ç™½è‰²èƒŒæ™¯ */
            border-radius: 15px; /* å›¾æ ‡çš„åœ†è§’ */
            margin-bottom: 8px; /* å’Œä¸‹æ–¹æ–‡å­—çš„é—´è· */
            backdrop-filter: blur(10px); /* æ¯›ç»ç’ƒæ•ˆæœï¼Œéå¸¸é‡è¦ï¼ */
            -webkit-backdrop-filter: blur(10px); /* å…¼å®¹Safariæµè§ˆå™¨ */
            border: 1px solid rgba(255, 255, 255, 0.2); /* åŠ ä¸€ä¸ªç»†å¾®çš„è¾¹æ¡† */
        }
/* å›¾æ ‡çš„å ä½ç¬¦æ ·å¼ */
.app-icon .icon-placeholder {
    width: 60px;
    height: 60px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 15px;
    margin-bottom: 8px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/*  è‡ªå®šä¹‰å›¾æ ‡çš„ä¸“å±æ ·å¼ */
.app-icon .icon-placeholder.custom-icon {
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    overflow: hidden;
}

.app-icon .icon-placeholder.custom-icon svg {
    display: none !important;
}

        /* Appåå­—çš„æ ·å¼ */
        .app-icon span {
            color: #333;
            font-size: 12px;
            font-weight: 500;
        }

        /* åº•éƒ¨Dockæ çš„æ ·å¼ */
        .dock {
            width: calc(100% - 40px); /* å®½åº¦æ¯”å±å¹•ç¨çª„ */
            margin: 0 auto 20px auto; /* åº•éƒ¨å¤–è¾¹è·ï¼Œå¹¶æ°´å¹³å±…ä¸­ */
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7); /* å’Œå›¾æ ‡ä¸€æ ·çš„åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(15px); /* æ¯›ç»ç’ƒæ•ˆæœ */
            -webkit-backdrop-filter: blur(15px);
            border-radius: 25px; /* æ›´åœ†çš„åœ†è§’ */
            display: flex;
            justify-content: space-around; /* è®©é‡Œé¢çš„Appå›¾æ ‡å‡åŒ€åˆ†å¸ƒ */
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

 /* å¼¹çª—èƒŒæ™¯çš„æ ·å¼ */
        .popup {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* åŠé€æ˜çš„é»‘è‰²é®ç½© */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
        }

/* å¼¹çª—å†…å®¹çš„æ ·å¼ */
       .popup-content {
            background-color: #ffffff; /* ã€ä¿®æ”¹ã€‘1. æ”¹æˆçº¯ç™½è‰² */
            /* ã€åˆ é™¤ã€‘2. ä¸å†éœ€è¦æ¯›ç»ç’ƒæ•ˆæœäº† */
            /* backdrop-filter: blur(15px); */
            /* -webkit-backdrop-filter: blur(15px); */
            border: 1px solid #ccc; /* ã€ä¿®æ”¹ã€‘3. æ¢æˆä¸€ä¸ªæ›´æ¸…æ™°çš„ç°è‰²è¾¹æ¡† */
            
            padding: 20px 25px; 
            border-radius: 25px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 290px; 
            text-align: center;
            position: relative;
            max-height: 300px; 
            overflow-y: auto;  
        }
        .popup-content h3 {
            margin-top: 0;
        }

        /* --- ä¸ºâ€œæ·»åŠ è”ç³»äººâ€å¼¹çª—æ·»åŠ æ–°çš„â€œä¸é€æ˜â€æ ·å¼ --- */
        

        /* 1. è¿™æ˜¯å¼¹çª—çš„é»‘è‰²èƒŒæ™¯é®ç½©ï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¹æˆä¸é€æ˜çš„æ·±ç°è‰² */
        .popup.solid-popup {
             background-color: rgba(0, 0, 0, 0.4); /* ä¸€ä¸ªæ™®é€šçš„æš—è‰²é®ç½© */
             z-index: 220; /* <-- ã€ä¿®å¤Bug 1ã€‘æ·»åŠ è¿™è¡Œï¼Œè®©å®ƒçš„å±‚çº§é«˜äº 210 */
        }

        /* 2. è¿™æ˜¯å¼¹çª—å†…å®¹æ¡†çš„æ ¸å¿ƒæ ·å¼ */
        .popup-content.solid-popup-content {
            background-color: #ffffff;  /* 1. æ˜ç¡®çš„çº¯ç™½è‰²èƒŒæ™¯ï¼ˆä¸æ˜¯åŠé€æ˜ï¼‰*/
            backdrop-filter: none;      /* 2. æ˜ç¡®ç¦ç”¨æ¯›ç»ç’ƒ */
            -webkit-backdrop-filter: none;
            border: 1px solid #ccc;     /* 3. åŠ ä¸€ä¸ªæ™®é€šçš„è¾¹æ¡† */
            width: 250px;               /* 4. ã€ä¿®å¤Bug 2ã€‘æŠŠå®½åº¦æ”¹å° */
            max-height: 350px;          /* 5. ã€ä¿®å¤Bug 2ã€‘æŠŠæœ€å¤§é«˜åº¦æ”¹å° */
            overflow-y: auto;           /* 6. å…³é”®ï¼šå¦‚æœå†…å®¹è¶…å‡ºï¼Œå…è®¸å‚ç›´æ»šåŠ¨ï¼ */
            padding: 20px 25px;
            text-align: left; /* å†…å®¹æ”¹ä¸ºå·¦å¯¹é½ï¼Œæ›´åƒè¡¨å• */
        }
        
        /* 7. å¼¹çª—é‡Œçš„å¤´åƒé¢„è§ˆæ ·å¼ */
        .avatar-preview-container {
            display: flex;
            justify-content: center; /* å±…ä¸­é¢„è§ˆå›¾ */
            margin-bottom: 15px;
        }
        #contact-avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%; /* åœ†å½¢å¤´åƒ */
            object-fit: cover;
            border: 3px solid #eee;
            background-color: #f9f9f9;
        }

        /* 8. å¼¹çª—é‡Œçš„æ–‡æœ¬è¾“å…¥æ¡†ï¼ˆç¡®ä¿å®ƒä»¬100%å®½åº¦ï¼‰*/
        .solid-popup-content .setting-item input[type="text"] {
            width: calc(100% - 20px); /* ç»§æ‰¿æˆ‘ä»¬å·²æœ‰çš„è¾“å…¥æ¡†æ ·å¼(æœ‰padding) */
        }
        
        /* 9. å¼¹çª—é‡Œçš„äººè®¾æ–‡æœ¬åŸŸæ ·å¼ */
        .solid-popup-content textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            outline: none;
            font-family: sans-serif; /* ç¡®ä¿å­—ä½“ç»Ÿä¸€ */
            font-size: 14px;
            resize: vertical; /* åªå…è®¸ç”¨æˆ·å‚ç›´è°ƒæ•´å¤§å° */
           overflow-y: auto; 
        }
        
        /* --- æ–°å¼¹çª—CSSæ·»åŠ ç»“æŸ --- */

        /* è¾“å…¥æ¡†å’ŒæŒ‰é’®çš„ç»„åˆæ ·å¼ */
        .input-group {
            display: flex;
            margin: 15px 0;
        }
        .input-group input {
            flex-grow: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            border: 1px solid #ccc;
            border-radius: 5px 0 0 5px;
            padding: 8px;
        }
        .input-group button {
            border: none;
            background-color: #007aff;
            color: white;
            padding: 8px 12px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
        }
/* æŒ‰é’®å®¹å™¨ - å›ºå®šåœ¨é¡¶éƒ¨ï¼ŒæŒ‰é’®é å³ */
#persona-buttons {
    flex-shrink: 0;
    padding: 10px 15px;
    border-bottom: 1px solid #e0e0e0; /* æ”¹æˆæµ…ç°è‰²ï¼Œä¸è¦ç”¨æ·±è‰² */
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    /*  ç¡®ä¿å®ƒä¸å½±å“çˆ¶å®¹å™¨ */
    width: 100%;
    box-sizing: border-box;
}

   /* ä¸Šä¼ æ–‡ä»¶æŒ‰é’®çš„æ ·å¼ */
        .file-label {
            display: block;
            width: 100%;
            padding: 10px 0;
            /* ä¿®æ”¹è¿™é‡Œï¼šèƒŒæ™¯è‰²æ›´æŸ”å’Œï¼Œå¹¶å¢åŠ è¿‡æ¸¡æ•ˆæœ */
            background-color: rgba(76, 217, 100, 0.8);
            color: white;
            border-radius: 8px; /* åœ†è§’å’Œè¾“å…¥æ¡†ç»Ÿä¸€ */
            cursor: pointer;
            margin: 15px 0;
            transition: background-color 0.3s; /* åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ */
        }
        /* æ·»åŠ ä¸€ä¸ªé¼ æ ‡æ‚¬åœæ•ˆæœ */
        .file-label:hover {
            background-color: rgba(76, 217, 100, 1);
        }
        
        /* å…³é—­æŒ‰é’®çš„æ ·å¼ */
        .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        /* ä¸€ä¸ªç”¨æ¥éšè—å…ƒç´ çš„ä¸‡èƒ½æ ·å¼ */
        .hidden {
            display: none !important;
        }

 /* ä¸»é¢˜è®¾ç½®ç•Œé¢çš„ä¸»å®¹å™¨æ ·å¼ */
        .theme-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(240, 240, 240, 0.9); /* ä¸€ä¸ªæŸ”å’Œçš„èƒŒæ™¯è‰² */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 200; /* æ¯”å¼¹çª—å±‚çº§æ›´é«˜ */
            display: flex;
            flex-direction: column;
        }
  /* --- æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç ï¼šä¸ºè®¾ç½®é¡µé¢æ·»åŠ å®Œå…¨ç›¸åŒçš„æ ·å¼ --- */
        .settings-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(240, 240, 240, 0.9); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 200; /* å’Œä¸»é¢˜é¡µå±‚çº§ä¸€æ ·é«˜ */
            display: flex;
            flex-direction: column;
        }
        /* --- æ·»åŠ ç»“æŸ --- */
       /* --- ä¸ºâ€œå¯¹è¯â€åŠŸèƒ½æ·»åŠ å…¨æ–°çš„CSSæ ·å¼ --- */
/* ã€æ–°æ·»åŠ ã€‘è®©è®¾ç½®é¡µé¢çš„å†…å®¹åŒºå¯ä»¥æ»šåŠ¨ */
.theme-content {
    padding: 20px;
    flex-grow: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}
        /* 1. ä¸ºä¸¤ä¸ªæ–°å±å¹•è®¾ç½®å’Œ theme/settings ä¸€æ ·çš„å…¨å±åŸºç¡€æ ·å¼ */
        .dialogue-list-screen,
        .chat-window-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0; /* å¯¹è¯é¡µç”¨ä¸€ä¸ªæµ…ç°è‰²èƒŒæ™¯ */
            z-index: 210; /* æ¯”è®¾ç½®é¡µå±‚çº§æ›´é«˜ï¼Œç¡®ä¿èƒ½è¦†ç›– */
            display: flex;
            flex-direction: column;
             /* æŠŠèƒŒæ™¯æ¢æˆç™½è‰²ï¼Œæ›´åƒèŠå¤©è½¯ä»¶ */
            background-color: #ffffff;
        }

        /* 2. å¯¼èˆªæ å³ä¸Šè§’çš„â€œæ–°å»ºâ€æŒ‰é’® */
        .nav-action-btn {
            background: none;
            border: none;
            font-size: 32px; /* å­—ä½“æ”¾å¤§ï¼Œè®©åŠ å·æ›´æ¸…æ™° */
            font-weight: lighter; /* ç”¨ç»†ä¸€ç‚¹çš„å­—ä½“ */
            cursor: pointer;
            color: #007aff; /* è‹¹æœè“ */
            position: absolute;
            right: 15px; /* æŠŠå®ƒé’‰åœ¨å³ä¸Šè§’ */
            top: 50%;
            transform: translateY(-50%); /* å‚ç›´å±…ä¸­ */
        }
        .nav-action-btn:hover {
            opacity: 0.7;
        }
  /* --- ä»è¿™é‡Œæ·»åŠ æ–°ä»£ç ï¼šä¸“é—¨ç¼©å°â€œè”ç³»äººâ€é¡µé¢çš„æ ‡é¢˜å­—ä½“ --- */
        .dialogue-list-screen .theme-nav h2 {
            font-size: 16px; /* é»˜è®¤çš„h2å¤ªå¤§äº†ï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¹å°ä¸€ç‚¹ */
        }
        /* --- æ·»åŠ ç»“æŸ --- */
/* å¼ºåˆ¶è®¾ç½®èŠå¤©çª—å£æ ‡é¢˜çš„å­—ä½“å¤§å° */
#chat-window-title {
    font-size: 16px !important; /* æ”¹æˆä½ æƒ³è¦çš„å¤§å° */
}
         /* --- ä»è¿™é‡Œå¼€å§‹æ·»åŠ â€œè”ç³»äººåˆ—è¡¨é¡¹â€çš„æ–°æ ·å¼ --- */
        
        .contact-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0; /* åˆ—è¡¨é¡¹ä¹‹é—´çš„åˆ†éš”çº¿ */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .contact-list-item:hover {
            background-color: #f9f9f9; /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
        }

        /* åˆ—è¡¨é¡¹çš„å¤´åƒ */
        .contact-item-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%; /* åœ†å½¢å¤´åƒ */
            object-fit: cover; /* ç¡®ä¿å›¾ç‰‡ä¸å˜å½¢ */
            margin-right: 15px;
            background-color: #eee;
        }
        
        /* åˆ—è¡¨é¡¹çš„æ–‡å­—ä¿¡æ¯åŒº */
        .contact-item-info {
            flex-grow: 1;
            /* ä¸‹é¢ä¸‰è¡Œæ˜¯é˜²æ­¢æ–‡å­—æº¢å‡ºçš„å…³é”® */
            overflow: hidden;
            white-space: nowrap;
        }

        /* åˆ—è¡¨é¡¹çš„åå­— */
        .contact-item-name {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        /* åˆ—è¡¨é¡¹çš„é¢„è§ˆæ–‡å­— (æ”¾â€œæœ€åæ¶ˆæ¯â€æˆ–â€œäººè®¾â€çš„åœ°æ–¹) */
        .contact-item-preview {
            margin: 0;
            margin-top: 4px;
            font-size: 14px;
            color: #666;
            /* ç¡®ä¿å•è¡Œæº¢å‡ºæ—¶æ˜¾ç¤ºçœç•¥å· ... */
            overflow: hidden;
            text-overflow: ellipsis; 
        }

        /* --- æ–°æ ·å¼æ·»åŠ ç»“æŸ --- */
      
        /* 3. å¯¹è¯åˆ—è¡¨çš„å†…å®¹åŒº */
        .dialogue-list-content {
            flex-grow: 1; /* å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
            overflow-y: auto; /* å¦‚æœåˆ—è¡¨é•¿äº†å¯ä»¥æ»šåŠ¨ */
            padding: 10px;
        }
        
        /* 4. åˆ—è¡¨ä¸ºç©ºæ—¶çš„æç¤ºæ–‡å­— */
        .empty-list-message {
            text-align: center;
            margin-top: 50px;
            color: #999;
            font-size: 14px;
        }

        /* 5. èŠå¤©æ¶ˆæ¯å®¹å™¨ (æœ€å…³é”®çš„åŒºåŸŸ) */
.message-container {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background-color: #f9f9f9; /* é»˜è®¤èƒŒæ™¯è‰² */
    position: relative;
    background-size: cover; /*   */
    background-position: center; /*   */
    background-attachment: fixed; /*  å…³é”®ï¼šèƒŒæ™¯å›ºå®šä¸æ»šåŠ¨ */
}

        /* 6. åº•éƒ¨è¾“å…¥æ¡†çš„å®¹å™¨ */
        .dialogue-input-area {
            display: flex;
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            background-color: #ffffff;
            gap: 10px;
        }

        /* 7. åº•éƒ¨è¾“å…¥æ¡†çš„æ ·å¼ */
        .dialogue-input-area input {
            flex-grow: 1; /* å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
            border: 1px solid #ccc;
            border-radius: 18px; /* åœ†è§’è¾“å…¥æ¡† */
            padding: 8px 15px;
            font-size: 16px;
            outline: none;
        }
        /* 8. åº•éƒ¨â€œå‘é€â€æŒ‰é’®çš„æ ·å¼ */
        .dialogue-input-area button {
            border: none;
            background-color: #007aff;
            color: white;
            padding: 8px 15px;
            border-radius: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        .dialogue-input-area button:hover {
            opacity: 0.8;
        }

        /* 9. èŠå¤©æ°”æ³¡çš„åŸºç¡€æ ·å¼ */
      .message-bubble {
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 18px;
    word-wrap: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    position: relative; /*  ç¡®ä¿åœ¨èƒŒæ™¯å±‚ä¸Šæ–¹ */
    z-index: 1; /*  ç¡®ä¿åœ¨èƒŒæ™¯å±‚ä¸Šæ–¹ */
}

        /* 10. ç”¨æˆ·å‘å‡ºçš„æ¶ˆæ¯ (å³è¾¹, è“è‰²) */
        .user-message {
            background-color: #007aff;
            color: white;
            align-self: flex-end; /* å…³é”®ï¼šæŠŠè‡ªå·±å¯¹é½åˆ°å³è¾¹ */
            border-bottom-right-radius: 5px; /* ä¸€ç‚¹ç‚¹å°é€ å‹ */
        }

        /* 11. æœºå™¨äººå›å¤çš„æ¶ˆæ¯ (å·¦è¾¹, ç°è‰²) */
        .bot-message {
            background-color: #e5e5ea;
            color: #000;
            align-self: flex-start; /* å…³é”®ï¼šæŠŠè‡ªå·±å¯¹é½åˆ°å·¦è¾¹ */
            border-bottom-left-radius: 5px;
        }

        /* --- â€œå¯¹è¯â€åŠŸèƒ½CSSæ ·å¼æ·»åŠ ç»“æŸ --- */
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .theme-nav {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            position: relative; 
        }
        .theme-nav h2 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
            color: #333;
        }
        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #555;
            position: absolute; /* ç¡®ä¿æ ‡é¢˜èƒ½å®Œç¾å±…ä¸­ */
        }
        
        /* åŠŸèƒ½å†…å®¹åŒº */
        .theme-content {
            padding: 20px;
        }

        /* æ‰‹é£ç´èœå•æ ·å¼ */
        .accordion-item {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .accordion-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #333;
        }
        .accordion-header .arrow {
            font-family: monospace; /* è®©ç®­å¤´æ›´æ¸…æ™° */
            transition: transform 0.3s; /* ç®­å¤´æ—‹è½¬åŠ¨ç”» */
        }
.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    display: flex;
    flex-direction: column;
    padding: 0; /* ã€å…³é”®ã€‘ç¡®ä¿æ²¡æœ‰å†…è¾¹è·å½±å“ */
}

.accordion-content.expanded {
    max-height: 500px;
    overflow: visible;
    padding: 15px; /*  åªæœ‰å±•å¼€æ—¶æ‰æœ‰å†…è¾¹è· */
}



      
.accordion-content.expanded {
   max-height: none; /* æ”¹æˆ noneï¼Œä¸é™åˆ¶é«˜åº¦ */
    overflow: visible; /* æ”¹æˆ visibleï¼Œä¸æ»šåŠ¨ */
}
/* ===== ã€åœ¨è¿™é‡Œæ·»åŠ ã€‘===== */

#accordion-content-3.expanded {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
     padding: 15px;
}

/*  ç¡®ä¿æŠ˜å æ—¶é«˜åº¦ä¸º0 */
#accordion-content-3 {
    max-height: 0;
    overflow: hidden;
}

}
/* ======================== */
      
        /* å½“å±•å¼€æ—¶ï¼Œç®­å¤´æ—‹è½¬90åº¦ */
        .accordion-header.expanded .arrow {
            transform: rotate(90deg);
        }

        /* è®¾ç½®é¡¹çš„å†…éƒ¨æ ·å¼ */
        .setting-item {
            margin-bottom: 15px;
        }
        .setting-item label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        .setting-item input {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            outline: none;
        }

        /* æŒ‰é’®ç»„æ ·å¼ */
        .button-group {
            display: flex;
            justify-content: flex-end; /* æŒ‰é’®é å³ */
            gap: 10px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
            margin-top: 20px;
        }
        .button-group button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        .button-group button:hover {
            opacity: 0.8;
        }
        .btn-clear {
            background-color: #eee;
            color: #555;
        }
        .btn-save {
            background-color: #007aff;
            color: white;
        }

        /* ç”¨äºéšè—ä¸»å±å¹•å…ƒç´ çš„æ ·å¼ */
        .home-screen-hidden {
            display: none !important;
        }

      /* --- åœ¨è¿™é‡Œå¼€å§‹æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç  --- */

        /* æ»‘å—ç»„åˆçš„æ ·å¼ */
        .slider-group {
            display: flex;
            align-items: center;
            gap: 15px; /* æ»‘å—å’Œæ–‡å­—çš„é—´è· */
        }
        .slider-group input[type="range"] {
            flex-grow: 1; /* è®©æ»‘å—å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
            cursor: pointer;
        }
        .slider-group span {
            font-weight: bold;
            color: #555;
            width: 40px; /* å›ºå®šå®½åº¦é˜²æ­¢æ–‡å­—è·³åŠ¨ */
        }  
       /* --- åœ¨è¿™é‡Œå¼€å§‹æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç  --- */

        /* å•ç‹¬ä¸ºé¡¶éƒ¨æ–‡å­—çš„spanè®¾ç½®æ ·å¼ */
        .status-bar span {
            /* 1. è®¾ç½®ä¸€ä¸ªæµè§ˆå™¨ä¸ä¼šæŠ—æ‹’çš„åŸºå‡†å­—ä½“å¤§å° */
            font-size: 15px;
            /* 2. æ·»åŠ è¿‡æ¸¡æ•ˆæœï¼Œè®©ç¼©æ”¾æ›´å¹³æ»‘ */
            transition: transform 0.1s;
        }
        /* è®¾ç½®å·¦è¾¹æ–‡å­—çš„ç¼©æ”¾ä¸­å¿ƒç‚¹ä¸ºå·¦è¾¹ */
        #top-left-text {
            transform-origin: left center;
        }
        /* è®¾ç½®å³è¾¹æ–‡å­—çš„ç¼©æ”¾ä¸­å¿ƒç‚¹ä¸ºå³è¾¹ */
        #top-right-text {
            transform-origin: right center;
        }

   /* å°ç»„ä»¶çš„é€šç”¨æ ·å¼ */
        .widget {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            /* â†“â†“â†“ ä¿®æ”¹è¿™é‡Œï¼šå‡å°‘ä¸Šä¸‹å†…è¾¹è·ï¼Œè®©å®ƒå˜çŸ® â†“â†“â†“ */
  
            box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·ä¸ä¼šæ’‘å¤§ç›’å­ */
            color: #333;
            /* â†“â†“â†“ æ·»åŠ è¿™è¡Œï¼šè®©å®ƒåœ¨è‡ªå·±çš„æ ¼å­é‡Œå‚ç›´å±…ä¸­ â†“â†“â†“ */
     
        }

            /* å…³é”®ï¼è®©2x1çš„å°ç»„ä»¶å æ®2åˆ—å®½åº¦ */
        .widget-2x1 {
            grid-column: span 2; /* è¿™å°±æ˜¯è®©å®ƒå˜èƒ–çš„é­”æ³•æŒ‡ä»¤ï¼ */
        }

        /* --- åœ¨è¿™é‡Œå¼€å§‹æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç  --- */

    /* æ–°å¢ï¼è®©3x2çš„å¤§ç»„ä»¶å æ®3è¡Œé«˜åº¦ */
        .widget-3x2 {
            grid-column: span 2; 
            grid-row: span 3;    
            
            display: flex;
            flex-direction: column; /* å†…éƒ¨å…ƒç´ å‚ç›´æ’åˆ— */
            padding: 2px; /* è°ƒæ•´æ•´ä½“å†…è¾¹è· */
          
        }

        /* å°ç»„ä»¶å†…éƒ¨æ–‡å­—çš„ç®€å•ç¾åŒ– */
        .widget h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        .widget p {
            margin: 0;
            font-size: 16px;
        }
      /* --- åœ¨è¿™é‡Œå¼€å§‹æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç  --- */

        /* ç»„ä»¶èƒŒæ™¯å›¾å®¹å™¨ */
        .widget-bg {
            flex-grow: 1; /* å æ®ç»„ä»¶å†…æ‰€æœ‰å¯ç”¨ç©ºé—´ */
            background-color: #eee; /* é»˜è®¤èƒŒæ™¯è‰² */
            background-size: cover; /* è®©èƒŒæ™¯å›¾é“ºæ»¡ */
            background-position: center; /* èƒŒæ™¯å›¾å±…ä¸­ */
            border-radius: 15px; /* åœ†è§’ä¸ç»„ä»¶æ•´ä½“é£æ ¼ä¿æŒä¸€è‡´ */
            margin-bottom: 10px; /* å’Œä¸‹æ–¹æ–‡å­—çš„é—´è· */
            position: relative; /* ä¸ºå¤´åƒçš„ç»å¯¹å®šä½åšå‡†å¤‡ */
            display: flex; /* è®©å¤´åƒå±…ä¸­ */
            justify-content: center;
            align-items: center;
            overflow: hidden; /* é˜²æ­¢èƒŒæ™¯å›¾è¶…å‡ºå®¹å™¨ */
        }

        /* å¤´åƒæ ·å¼ */
        .widget-avatar {
            width: 95px; /* å¤´åƒå¤§å° */
            height: 95px;
            border-radius: 50%; /* å˜æˆåœ†å½¢ */
            margin-top: 30px; 
            border: 3px solid rgba(255, 255, 255, 0.8); /* ç™½è‰²æè¾¹ */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* é˜´å½± */
            object-fit: cover; /* ç¡®ä¿å›¾ç‰‡ä¸å˜å½¢é“ºæ»¡ */
            z-index: 1; /* ç¡®ä¿å¤´åƒåœ¨èƒŒæ™¯å›¾ä¸Šæ–¹ */
        }

        /* åº•éƒ¨è‡ªå®šä¹‰æ–‡å­—æ ·å¼ */
        .widget-text {
            margin: 0;
            font-size: 14px;
            color: #333;
            text-align: center;
            white-space: nowrap;      
            overflow: hidden;         
            text-overflow: ellipsis;  
        }
      /* --- åœ¨è¿™é‡Œå¼€å§‹æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç  --- */

        /* ç¼–è¾‘å™¨å†…éƒ¨åŒºåŸŸåˆ’åˆ† */
        .editor-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .editor-section:last-of-type {
            border-bottom: none; /* æœ€åä¸€ä¸ªåŒºåŸŸä¸éœ€è¦ä¸‹åˆ’çº¿ */
        }
        .editor-section h4 {
            margin: 0 0 10px 0;
            text-align: left;
            color: #333;
            font-size: 16px;
        }
        /* è®©ç¼–è¾‘å™¨é‡Œçš„URLè¾“å…¥æ¡†å’Œæ–‡å­—è¾“å…¥æ¡†å®½åº¦100% */
        .editor-section .input-group input {
            border-radius: 8px; /* ç»™å®ƒåŠ ä¸Šåœ†è§’ */
            width: 100%;
            box-sizing: border-box;
        }
      /* --- åœ¨è¿™é‡Œå¼€å§‹æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç  --- */

        /* é»‘å¤œæ¨¡å¼çš„åˆ‡æ¢å¼€å…³æ ·å¼ */
        .toggle-switch {
            background-color: #e9e9eb;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        .toggle-label {
            color: #8e8e93;
            font-weight: bold;
            padding: 0 15px;
        }
        .toggle-handle {
            background-color: white;
            width: 50%;
            height: 32px;
            border-radius: 18px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            position: absolute;
            left: 4px;
            transition: left 0.3s ease; /* æ»‘åŠ¨åŠ¨ç”» */
        }
        /* å½“å¼€å…³è¢«æ¿€æ´»(åˆ‡æ¢åˆ°å³è¾¹)æ—¶çš„æ ·å¼ */
        .toggle-switch.active .toggle-handle {
            left: calc(50% - 4px);
        }

        /* å…³é”®ï¼é»‘å¤œæ¨¡å¼çš„çš®è‚¤å®šä¹‰ */
               .phone-screen.dark-mode .status-bar,
        .phone-screen.dark-mode .time-widget,
        .phone-screen.dark-mode .app-grid .app-icon span 
        {
            color: white; /* æ‰€æœ‰ç›¸å…³æ–‡å­—å˜ç™½ */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); /* ç»™ç™½å­—åŠ ç‚¹é˜´å½±ï¼Œæ›´å¥½çœ‹ */
        }
      
    
 /* --- åœ¨è¿™é‡Œå¼€å§‹æ·»åŠ ä¸‹é¢çš„æ–°ä»£ç  --- */

    /* 2x0.5 â€œåŠé«˜â€å°å¡ç‰‡çš„æ ·å¼ */
        .widget-2x1-slim {
            grid-column: span 2; 
            height: 35px; 
            align-self: center; 
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: cover;
            background-position: center;
            cursor: pointer; 
            border-radius: 12px;
            /* --- åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œæ–°çš„å†…è¾¹è· --- */
            padding: 0 10px; /* åªç»™å·¦å³å†…è¾¹è·ï¼Œä¸Šä¸‹ä¸º0 */
        }

        /* å°å¡ç‰‡å†…éƒ¨æ–‡å­—çš„æ ·å¼ */
        .widget-2x1-slim .widget-text-slim {
            margin: 0;
            padding: 0 10px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        
            white-space: nowrap;      
            overflow: hidden;         
            text-overflow: ellipsis;  
        }
      /* --- æ·»åŠ ä¸‹é¢çš„æ–°æ ·å¼ä»£ç  --- */
        #widget-text-color-input {
            width: 50px;           /* ç»™å®ƒä¸€ä¸ªå›ºå®šå®½åº¦ï¼Œè®©å®ƒå¤§ä¸€ç‚¹ */
            height: 35px;          /* ç»™å®ƒä¸€ä¸ªå›ºå®šé«˜åº¦ */
            padding: 0;            /* ç§»é™¤æµè§ˆå™¨é»˜è®¤çš„å¥‡æ€ªå†…è¾¹è· */
            border: 1px solid rgba(0, 0, 0, 0.1); /* ç»™å®ƒä¸€ä¸ªå¹²å‡€çš„ç»†è¾¹æ¡† */
            border-radius: 8px;    /* æŠŠå®ƒä¹Ÿå˜æˆåœ†è§’ï¼Œå’Œæˆ‘ä»¬Appé£æ ¼ç»Ÿä¸€ï¼ */
            cursor: pointer;       /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºå°æ‰‹ */
            background-color: transparent; /* ç§»é™¤æŸäº›æµè§ˆå™¨ä¸Šé»˜è®¤çš„ç°è‰²èƒŒæ™¯ */
        }

   



      /* ============================================= */
/* ã€æ–°æ·»åŠ ã€‘"æˆ‘"é¡µé¢çš„æ ·å¼ */
/* ============================================= */

/* äººè®¾åˆ—è¡¨é¡¹ */
.persona-list-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background-color: white;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s;
}

.persona-list-item:hover {
    background-color: #f9f9f9;
}

.persona-item-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 15px;
    background-color: #eee;
}

.persona-item-info {
    flex-grow: 1;
    overflow: hidden;
}

.persona-item-name {
    margin: 0;
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

.persona-item-desc {
    margin: 4px 0 0 0;
    font-size: 14px;
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.persona-item-delete {
    background-color: #ff3b30;
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    font-weight: bold;
    cursor: pointer;
}

      /* ============================================= */
/* ã€æ–°æ·»åŠ ã€‘ä¸–ç•Œä¹¦åŠŸèƒ½çš„ CSS æ ·å¼ */
/* ============================================= */

/* 1. åˆ†ç±»ç®¡ç†å™¨é¡µçš„åˆ—è¡¨é¡¹ (ä¾‹å¦‚: "äººç‰© [X]") */
.category-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 10px;
    background-color: #f9f9f9;
    border-radius: 8px;
    margin-bottom: 8px;
    font-weight: 500;
}

/* 2. åˆ†ç±»åˆ—è¡¨é¡¹çš„â€œåˆ é™¤ Xâ€æŒ‰é’® */
.category-delete-btn {
    background-color: #ff3b30; /* çº¢è‰² */
    color: white;
    border: none;
    border-radius: 50%; /* åœ†å½¢ */
    width: 24px;
    height: 24px;
    font-weight: bold;
    cursor: pointer;
    line-height: 24px; /* è¾…åŠ©å‚ç›´å±…ä¸­ */
    text-align: center;
    padding: 0;
}

/* 3. ä¸–ç•Œä¹¦ä¸»é¡µçš„â€œæ¡ç›®â€åˆ—è¡¨é¡¹ (æˆ‘ä»¬å¤ç”¨è”ç³»äººæ ·å¼) */
.worldbook-entry-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative; /* ä¸ºâ€œé•¿æŒ‰â€åšå‡†å¤‡ */
}
.worldbook-entry-item:hover {
    background-color: #f9f9f9;
}

/* 4. æ¡ç›®åˆ—è¡¨çš„â€œå›¾æ ‡â€ (æˆ‘ä»¬ç”¨åˆ†ç±»çš„é¦–å­—æ¯) */
.entry-item-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
    background-color: #007aff; /* è“è‰²åº• */
    color: white;
    font-size: 24px;
    font-weight: bold;
    /* Flex å±…ä¸­ */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
}

/* 5. æ¡ç›®åˆ—è¡¨çš„æ–‡å­—ä¿¡æ¯ (å’Œè”ç³»äººä¸€æ ·) */
.entry-item-info {
    flex-grow: 1;
    overflow: hidden;
    white-space: nowrap;
}
.entry-item-name {
    margin: 0;
    font-size: 16px;
    font-weight: bold;
    color: #333;
}
/* æˆ‘ä»¬æŠŠåˆ†ç±»åæ˜¾ç¤ºåœ¨é¢„è§ˆåŒº */
.entry-item-category {
    margin: 0;
    margin-top: 4px;
    font-size: 14px;
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis; 
}
      /* ============================================= */
/* ã€æ–°æ·»åŠ ã€‘è”ç³»äººè®¾ç½® & ä¸–ç•Œä¹¦å…³è”é¡µ CSS */
/* ============================================= */

/* 1. è®©è®¾ç½®é¡µçš„è¿”å›æŒ‰é’®å’Œ...æŒ‰é’®å¯¹é½ */
#contact-settings-btn {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
}

/* 2. ä¸–ç•Œä¹¦å…³è”é¡µçš„åˆ—è¡¨é¡¹æ ·å¼ */
.linker-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
}

/* 3. å…³è”é¡¹çš„â€œå¤é€‰æ¡†â€æ ·å¼ (æˆ‘ä»¬ç”¨ CSS æ¨¡æ‹Ÿ) */
.linker-item-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid #ccc;
    border-radius: 50%; /* åœ†å½¢å¤é€‰æ¡† */
    margin-right: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s;
    flex-shrink: 0;
}

/* 4. å½“è¢«é€‰ä¸­æ—¶ï¼Œæ”¹å˜å¤é€‰æ¡†æ ·å¼ */
.linker-item-checkbox.checked {
    background-color: #007aff;
    border-color: #007aff;
}
/* 5. é€‰ä¸­æ—¶ï¼Œä¸­é—´çš„â€œå¯¹å‹¾â€ (ç”¨ CSS ç”») */
.linker-item-checkbox.checked::after {
    content: '';
    width: 6px;
    height: 12px;
    border: solid white;
    border-width: 0 3px 3px 0;
    transform: rotate(45deg) translate(-1px, -1px);
}

/* 6. å…³è”é¡¹çš„æ–‡å­—æ ·å¼ (æˆ‘ä»¬å¤ç”¨ä¹‹å‰çš„) */
.linker-item-info {
    flex-grow: 1;
    overflow: hidden;
    white-space: nowrap;
}
.linker-item-name {
    margin: 0;
    font-size: 16px;
    font-weight: bold;
    color: #333;
}
.linker-item-category {
    margin: 0;
    margin-top: 4px;
    font-size: 14px;
    color: #666;
}

/* å¯¼å…¥è¡¨æƒ…åŒ…å¼¹çª— - å®Œå…¨ä¿®å¤ç‰ˆ */
#import-sticker-popup {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    z-index: 9999 !important;
}

#import-sticker-popup.hidden {
    display: none !important;
}

#import-sticker-popup .popup-content {
    background-color: #ffffff !important;
    padding: 20px 25px !important;
    border-radius: 25px !important;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3) !important;
    max-width: 90% !important;
    max-height: 80% !important;
    overflow-y: auto !important;
    position: relative !important;
    z-index: 10000 !important;
}
/* å¯¼å…¥å¼¹çª—çš„é¢„è§ˆç½‘æ ¼ */
#sticker-preview-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
}

.preview-sticker-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 5px;
    border-radius: 6px;
    background-color: white;
    border: 1px solid #e0e0e0;
}

.preview-sticker-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 4px;
}

.preview-sticker-text {
    font-size: 11px;
    color: #666;
    text-align: center;
    word-break: break-all;
    max-width: 70px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* æŸ¥çœ‹è¡¨æƒ…åº“çš„ç½‘æ ¼ */
.sticker-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);  /* ã€æ”¹ã€‘ä»4åˆ—æ”¹æˆ3åˆ— */
    gap: 10px;
}

.sticker-grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px;
    border-radius: 8px;
    background-color: white;
    border: 1px solid #e0e0e0;
    transition: all 0.2s;
    position: relative;  /*  ä¸ºåˆ é™¤æŒ‰é’®å®šä½ */
}

.sticker-grid-item:hover {
    background-color: #f0f0f0;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/*  å•ä¸ªè¡¨æƒ…åŒ…çš„åˆ é™¤æŒ‰é’® */
.sticker-item-delete {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    background-color: #ff3b30;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;  /* é»˜è®¤éšè— */
    transition: opacity 0.2s;
}

.sticker-grid-item:hover .sticker-item-delete {
    opacity: 1;  /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤º */
}

.sticker-item-delete:hover {
    background-color: #ff1f1f;
    transform: scale(1.1);
}

.sticker-grid-img {
    width: 70px;  /* ã€æ”¹ã€‘ç¨å¾®æ”¾å¤§ä¸€ç‚¹ */
    height: 70px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 5px;
}

.sticker-grid-text {
    font-size: 11px;
    color: #666;
    text-align: center;
    word-break: break-all;
    max-width: 80px;  /* ã€æ”¹ã€‘é€‚é…æ–°çš„å®½åº¦ */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
/* èŠå¤©é¡µé¢çš„è¡¨æƒ…é¢æ¿ */
.sticker-panel {
    position: absolute;
    bottom: 95px;
    left: 0;
    width: 100%;
    height: 300px;  /* ã€æ”¹ã€‘å›ºå®šé«˜åº¦ï¼Œä¸ç”¨max-height */
    background-color: white;
    border-top: 1px solid #e0e0e0;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 100;
    display: flex;
    flex-direction: column;
    overflow: hidden;  /*  é˜²æ­¢å†…å®¹æº¢å‡º */
}

.sticker-panel-header {
    padding: 10px 15px;
    border-bottom: 1px solid #e0e0e0;
    flex-shrink: 0;  /*  é˜²æ­¢è¢«å‹ç¼© */
    box-sizing: border-box;  /*   */
}

.sticker-panel-search {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    box-sizing: border-box;  /* ã€å…³é”®ã€‘é˜²æ­¢è¢«çˆ¶å®¹å™¨å‹ç¼© */
}


.sticker-panel-tabs {
    display: flex;
    gap: 8px;
    padding: 10px 15px;
    overflow-x: auto;
    border-bottom: 1px solid #e0e0e0;
    white-space: nowrap;
    flex-shrink: 0;  /*  é˜²æ­¢è¢«å‹ç¼© */
    min-height: 45px;  /*  ç¡®ä¿æœ‰è¶³å¤Ÿé«˜åº¦ */
    align-items: center;  /*  å‚ç›´å±…ä¸­ */
    box-sizing: border-box;  /*   */
}

.sticker-tab {
    padding: 6px 12px;
    background-color: #f0f0f0;
    border: none;
    border-radius: 15px;
    font-size: 13px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    flex-shrink: 0;  /*  é˜²æ­¢æ ‡ç­¾è¢«å‹ç¼© */
}


.sticker-panel-tabs::-webkit-scrollbar {
    height: 4px;
}

.sticker-panel-tabs::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 2px;
}

.sticker-tab {
    padding: 6px 12px;
    background-color: #f0f0f0;
    border: none;
    border-radius: 15px;
    font-size: 13px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
}

.sticker-tab:hover {
    background-color: #e0e0e0;
}

.sticker-tab.active {
    background-color: #007aff;
    color: white;
}

.sticker-panel-content {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 10px 15px;  /* ã€æ”¹ã€‘å·¦å³å†…è¾¹è·æ”¹å¤§ä¸€ç‚¹ */
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap:0px;  /* ã€æ”¹ã€‘é—´è·æ”¹å¤§ä¸€ç‚¹ */
    align-content: start;
    box-sizing: border-box;
}


.sticker-panel-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: background-color 0.2s;
}

.sticker-panel-item:hover {
    background-color: #f0f0f0;
}

.sticker-panel-img {
    width: 55px;  /* ã€æ”¹ã€‘ç¨å¾®ç¼©å°ä¸€ç‚¹ */
    height: 55px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 4px;
}

.sticker-panel-text {
    font-size: 11px;
    color: #666;
    text-align: center;
    word-break: break-all;
    max-width: 70px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* è¡¨æƒ…åŒ…åœ¨èŠå¤©æ°”æ³¡ä¸­çš„æ ·å¼ */
.message-sticker {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 10px;
    display: block;  /*  ç¡®ä¿å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º */
}

/* ã€ä¿®å¤ã€‘è°ƒæ•´åŒ…å«è¡¨æƒ…åŒ…çš„æ°”æ³¡æ ·å¼ */
.message-bubble:has(.message-sticker) {
    padding: 5px;
    background-color: transparent;
    box-shadow: none;
}

/*  ç¡®ä¿è¡¨æƒ…åŒ…æ°”æ³¡ä¿æŒåŸæœ‰çš„å·¦å³ä½ç½® */
.user-message:has(.message-sticker) {
    align-self: flex-end; /* ç”¨æˆ·å‘çš„è¡¨æƒ…åŒ…é å³ */
}

.bot-message:has(.message-sticker) {
    align-self: flex-start; /* AIå‘çš„è¡¨æƒ…åŒ…é å·¦ */
}
/* èŠå¤©è¾“å…¥æ¡†èšç„¦æ—¶çš„ä¼˜åŒ– */
.dialogue-input-area input:focus {
    /* iOS è‡ªåŠ¨æ»šåŠ¨åˆ°è¾“å…¥æ¡†çš„è§†è§‰ä¼˜åŒ– */
    scroll-margin-bottom: 20px;
}

/* æ¶ˆæ¯å®¹å™¨åœ¨é”®ç›˜å¼¹å‡ºæ—¶çš„è°ƒæ•´ */
.message-container {
    /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”»ï¼Œè®©é«˜åº¦å˜åŒ–æ›´å¹³æ»‘ */
    transition: max-height 0.3s ease;
}

/* ç¡®ä¿è§’è‰²è®¾ç½®é¡µé¢çš„å†…å®¹åŒºå¯ä»¥æ»šåŠ¨ */
#contact-settings-screen .theme-content {
    flex-grow: 1;
    overflow-y: auto !important;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    height: auto;
    max-height: calc(100vh - 60px); /* ç•™å‡ºé¡¶éƒ¨å¯¼èˆªæ çš„é«˜åº¦ */
}

/* ç¡®ä¿è®°å¿†è®¾ç½®é¡µé¢çš„å†…å®¹åŒºä¹Ÿå¯ä»¥æ»šåŠ¨ */
#memory-screen .theme-content {
    flex-grow: 1;
    overflow-y: auto !important;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 15px;
    max-height: calc(100vh - 60px);
}
/* æ¶ˆæ¯ç¼–è¾‘å¼¹çª— */
#message-edit-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000000; /* æ¯”è¡¨æƒ…åŒ…å¼¹çª—è¿˜è¦é«˜ */
}

#message-edit-popup .popup-content {
    background-color: #ffffff;
    padding: 20px 25px;
    border-radius: 25px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 300px;
    max-height: 400px;
    position: relative;
}

#message-edit-popup textarea {
    width: calc(100% - 20px);
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    resize: vertical;
    font-size: 14px;
    min-height: 100px;
}
/* ============================================= */
/* ã€æ–°æ·»åŠ ã€‘å­—ä½“è®¾ç½®çš„æ ·å¼ */
/* ============================================= */

/* å­—ä½“é¢„è§ˆåŒºåŸŸ */
.font-preview-box {
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    min-height: 60px;
}

.font-preview-label {
    font-size: 12px;
    color: #888;
    margin-bottom: 8px;
}

.font-preview-text {
    font-size: 16px;
    color: #333;
}


        /*è¿™é‡Œæ˜¯CSSstyleçš„æœ«å°¾ï¼Œæœ€åº•ä¸‹*/ 

    </style>
  <script src="https://unpkg.com/dexie@4/dist/dexie.js"></script>
</head>
<body>

    <div class="phone-screen">
        
       <div class="status-bar">
             <span id="top-left-text"></span>
            <span id="top-right-text"></span>
            </div>

         <div class="time-widget">
            <p id="date-display">9æœˆ9æ—¥ æ˜ŸæœŸäºŒ</p>
            <h1 id="time-display">02:33</h1>
        </div>
 <div class="theme-screen hidden">
            <nav class="theme-nav">
                <button id="back-to-home-btn" class="back-btn">&lt;</button>
                <h2>ä¸»é¢˜</h2>
              
            </nav>

            <div class="theme-content">
                <div class="accordion-item">
                    <div class="accordion-header" id="accordion-header-1">
                        <span>é¡¶éƒ¨æ–‡å­—</span>
                        <span class="arrow">&gt;</span>
                    </div>
                    <div class="accordion-content" id="accordion-content-1">
                        <div class="setting-item">
                            <label for="left-text-input">å·¦è¾¹æ–‡å­—</label>
                            <input type="text" id="left-text-input" placeholder="è¾“å…¥å·¦ä¸Šè§’æ–‡å­—">
                        </div>
                    <div class="setting-item">
                            <label for="right-text-input">å³è¾¹æ–‡å­—</label>
                            <input type="text" id="right-text-input" placeholder="è¾“å…¥å³ä¸Šè§’æ–‡å­—">
                        </div>

                        <div class="setting-item">
                            <label for="font-size-slider">å¤§å°</label>
                            <div class="slider-group">
                                <input type="range" id="font-size-slider" min="0" max="15" value="15">
                                <span id="font-size-value">15px</span>
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn-clear" id="clear-text-btn">æ¸…é™¤</button>
                            <button class="btn-save" id="save-text-btn">ä¿å­˜</button>
                        </div>
                    </div>
                </div>    <div class="accordion-item">
                    <div class="accordion-header" id="accordion-header-2">
                        <span>é»‘å¤œæ¨¡å¼åˆ‡æ¢</span>
                        <span class="arrow">&gt;</span>
                    </div>
                    <div class="accordion-content" id="accordion-content-2">
                        <div class="setting-item">
                            <div class="toggle-switch" id="dark-mode-toggle">
                                <div class="toggle-label">ç™½</div>
                                <div class="toggle-handle"></div>
                                <div class="toggle-label">é»‘</div>
                            </div>
                        </div>
                    </div>
                </div>    

               <div class="accordion-item">
                    <div class="accordion-header" id="accordion-header-3">
                        <span>è‡ªå®šä¹‰å›¾æ ‡ (URL)</span>
                        <span class="arrow">&gt;</span>
                    </div>
                    <div class="accordion-content" id="accordion-content-3">
                        
                     <!-- å¯¹è¯ -->
<div class="setting-item">
    <label for="icon-url-dialogue">å¯¹è¯</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="url" id="icon-url-dialogue" placeholder="ç²˜è´´URL æˆ– ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex-grow: 1;">
        <label for="icon-file-dialogue" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
        <input type="file" id="icon-file-dialogue" accept="image/*" style="display: none;">
        <img id="icon-preview-dialogue" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
    </div>
</div>

<!-- ä¸–ç•Œä¹¦ -->
<div class="setting-item">
    <label for="icon-url-worldbook">ä¸–ç•Œä¹¦</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="url" id="icon-url-worldbook" placeholder="ç²˜è´´URL æˆ– ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex-grow: 1;">
        <label for="icon-file-worldbook" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
        <input type="file" id="icon-file-worldbook" accept="image/*" style="display: none;">
        <img id="icon-preview-worldbook" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
    </div>
</div>

<!-- è®ºå› -->
<div class="setting-item">
    <label for="icon-url-forum">è®ºå›</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="url" id="icon-url-forum" placeholder="ç²˜è´´URL æˆ– ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex-grow: 1;">
        <label for="icon-file-forum" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
        <input type="file" id="icon-file-forum" accept="image/*" style="display: none;">
        <img id="icon-preview-forum" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
    </div>
</div>

<!-- æˆ‘ -->
<div class="setting-item">
    <label for="icon-url-me">æˆ‘</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="url" id="icon-url-me" placeholder="ç²˜è´´URL æˆ– ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex-grow: 1;">
        <label for="icon-file-me" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
        <input type="file" id="icon-file-me" accept="image/*" style="display: none;">
        <img id="icon-preview-me" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
    </div>
</div>

<!-- è®¾ç½® -->
<div class="setting-item">
    <label for="icon-url-settings">è®¾ç½®</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="url" id="icon-url-settings" placeholder="ç²˜è´´URL æˆ– ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex-grow: 1;">
        <label for="icon-file-settings" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
        <input type="file" id="icon-file-settings" accept="image/*" style="display: none;">
        <img id="icon-preview-settings" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
    </div>
</div>

<!-- ä¸»é¢˜ -->
<div class="setting-item">
    <label for="icon-url-theme">ä¸»é¢˜</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="url" id="icon-url-theme" placeholder="ç²˜è´´URL æˆ– ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex-grow: 1;">
        <label for="icon-file-theme" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
        <input type="file" id="icon-file-theme" accept="image/*" style="display: none;">
        <img id="icon-preview-theme" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
    </div>
</div>

<!-- è®°å¿† -->
<div class="setting-item">
    <label for="icon-url-memory">è®°å¿†</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="url" id="icon-url-memory" placeholder="ç²˜è´´URL æˆ– ç‚¹å‡»å³ä¾§ä¸Šä¼ " style="flex-grow: 1;">
        <label for="icon-file-memory" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
        <input type="file" id="icon-file-memory" accept="image/*" style="display: none;">
        <img id="icon-preview-memory" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
    </div>
</div>


                        <div class="button-group">
                            <button class="btn-clear" id="clear-icons-btn">å…¨éƒ¨æ¸…é™¤</button>
                            <button class="btn-save" id="save-icons-btn">ä¿å­˜å›¾æ ‡</button>
                        </div>
                    </div>
                </div>

<!--  èŠå¤©ç•Œé¢ç¾åŒ–æ‰‹é£ç´ -->
<div class="accordion-item">
    <div class="accordion-header" id="accordion-header-4">
        <span>èŠå¤©ç•Œé¢ç¾åŒ–</span>
        <span class="arrow">&gt;</span>
    </div>
    <div class="accordion-content" id="accordion-content-4">
        
        <!-- 4.1 å¯¼èˆªæ æ ·å¼ -->
        <div class="editor-section">
           <h4>é¡¶éƒ¨å¯¼èˆªæ ï¼ˆæ ‡é¢˜æ ï¼‰</h4>
            
            <div class="setting-item">
                <label>èƒŒæ™¯é¢œè‰²</label>
                <input type="color" id="chat-nav-bg-color" value="#ffffff">
            </div>
            
            <div class="setting-item">
                <label>æ–‡å­—é¢œè‰²</label>
                <input type="color" id="chat-nav-text-color" value="#333333">
            </div>
            
            <div class="setting-item">
                <label>èƒŒæ™¯å›¾ç‰‡ï¼ˆURLï¼‰</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="url" id="chat-nav-bg-url" placeholder="ç²˜è´´å›¾ç‰‡URL" style="flex-grow: 1;">
                    <label for="chat-nav-bg-file" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
                    <input type="file" id="chat-nav-bg-file" accept="image/*" style="display: none;">
                    <img id="chat-nav-bg-preview" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
                </div>
            </div>
          
        </div>
        
        <!-- 4.2 èŠå¤©å£çº¸ -->
        <div class="editor-section">
            <h4>èŠå¤©å£çº¸</h4>
            
            <div class="setting-item">
                <label>å£çº¸å›¾ç‰‡ï¼ˆURLï¼‰</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="url" id="chat-wallpaper-url" placeholder="ç²˜è´´å›¾ç‰‡URL" style="flex-grow: 1;">
                    <label for="chat-wallpaper-file" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
                    <input type="file" id="chat-wallpaper-file" accept="image/*" style="display: none;">
                    <img id="chat-wallpaper-preview" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
                </div>
            </div>
            
            <div class="setting-item">
                <label for="chat-wallpaper-blur">æ¨¡ç³Šç¨‹åº¦</label>
                <div class="slider-group">
                    <input type="range" id="chat-wallpaper-blur" min="0" max="20" value="0">
                    <span id="chat-wallpaper-blur-value">0px</span>
                </div>
            </div>
            
            <div class="setting-item">
                <label for="chat-wallpaper-opacity">é€æ˜åº¦</label>
                <div class="slider-group">
                    <input type="range" id="chat-wallpaper-opacity" min="0" max="100" value="100">
                    <span id="chat-wallpaper-opacity-value">100%</span>
                </div>
            </div>
        </div>
        
  <!-- 4.3 åº•éƒ¨å¯¼èˆªæ æ ·å¼ -->
<div class="editor-section">
    <h4>åº•éƒ¨å¯¼èˆªæ ï¼ˆè¾“å…¥åŒºåŸŸï¼‰</h4>
    
    <div class="setting-item">
        <label>èƒŒæ™¯é¢œè‰²</label>
        <input type="color" id="chat-bottom-bg-color" value="#ffffff">
    </div>
    
    <div class="setting-item">
        <label>èƒŒæ™¯å›¾ç‰‡ï¼ˆURLï¼‰</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="url" id="chat-bottom-bg-url" placeholder="ç²˜è´´å›¾ç‰‡URL" style="flex-grow: 1;">
            <label for="chat-bottom-bg-file" style="background-color: #007aff; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">ğŸ“ æœ¬åœ°</label>
            <input type="file" id="chat-bottom-bg-file" accept="image/*" style="display: none;">
            <img id="chat-bottom-bg-preview" src="" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; display: none;">
        </div>
    </div>
</div>

<!-- 4.4 è¾“å…¥æ¡†æ ·å¼ -->
<div class="editor-section">
    <h4>è¾“å…¥æ¡†æœ¬èº«</h4>

            
            <div class="setting-item">
                <label>èƒŒæ™¯é¢œè‰²</label>
                <input type="color" id="chat-input-bg-color" value="#ffffff">
            </div>
            
            <div class="setting-item">
                <label>æ–‡å­—é¢œè‰²</label>
                <input type="color" id="chat-input-text-color" value="#333333">
            </div>
            
            <div class="setting-item">
                <label>è¾¹æ¡†é¢œè‰²</label>
                <input type="color" id="chat-input-border-color" value="#cccccc">
            </div>
            
            <div class="setting-item">
                <label for="chat-input-radius">åœ†è§’å¤§å°</label>
                <div class="slider-group">
                    <input type="range" id="chat-input-radius" min="0" max="30" value="18">
                    <span id="chat-input-radius-value">18px</span>
                </div>
            </div>
        </div>
        
        <!-- æŒ‰é’®ç»„ -->
        <div class="button-group">
            <button class="btn-clear" id="clear-chat-style-btn">æ¸…é™¤</button>
            <button class="btn-save" id="save-chat-style-btn">ä¿å­˜</button>
        </div>
        
    </div>
</div>

              <!---åœ¨è¿™é‡Œæ·»åŠ ä¸»é¢˜é‡Œé¢çš„å†…å®¹--->
                    </div>
   
                </div>
      
       <div class="settings-screen hidden">
            <nav class="theme-nav">
                <button id="settings-back-btn" class="back-btn">&lt;</button>
                <h2>è®¾ç½®</h2>
            </nav>
         

            <div class="theme-content">
                
                <div class="accordion-item">
                    <div class="accordion-header" id="api-accordion-header">
                        <span>API è®¾ç½®</span>
                        <span class="arrow">&gt;</span>
                    </div>
            <div class="accordion-content" id="api-accordion-content">
                        
                        <div class="editor-section">
                            <h4>æˆ‘çš„é¢„è®¾</h4>
                            <div class="setting-item">
                                <label for="api-preset-selector">èŠå¤©æ‰€ç”¨apiå¿…é¡»ç‚¹ä¸‹é¢çš„ä¿å­˜æ­¤é¢„è®¾</label>
                                <select id="api-preset-selector" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
                                    </select>
                            </div>
                            <div class="button-group" style="margin-top: 10px; justify-content: space-between;">
                                <button id="api-preset-delete-btn" class="btn-clear" style="background-color: #ff3b30; color: white;">åˆ é™¤é€‰ä¸­</button>
                                <button id="api-preset-new-btn" class="btn-save" style="background-color: #4cd964;">+ æ–°å»ºé¢„è®¾</button>
                            </div>
                        </div>
<div class="setting-item" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
    <label for="api-summary-preset-selector">æ€»ç»“ API (å¯é€‰)</label>
    <select id="api-summary-preset-selector" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
        </select>
    <p style="font-size: 12px; color: #777; margin-top: 5px;">
        é»˜è®¤è·Ÿéšä¸»APIï¼Œä¿®æ”¹ç›´æ¥é€‰æ‹©ä¿å­˜è¿‡çš„é¢„è®¾æ—¢å¯ã€‚
    </p>
</div>
                        <div id="preset-edit-form" class="editor-section">
                            <h4 id="preset-form-title">ç¼–è¾‘é¢„è®¾</h4>
                            
                            <div class="setting-item">
                                <label for="api-preset-name-input">é¢„è®¾åç§°</label>
                                <input type="text" id="api-preset-name-input" placeholder="ä¾‹å¦‚: æˆ‘çš„ OpenAI">
                            </div>
                            
                            <div class="setting-item">
                                <label for="api-key-input">API Key (å¯†é’¥)</label>
                                <input type="password" id="api-key-input" placeholder="sk-...">
                            </div>
                            
                            <div class="setting-item">
                                <label for="api-base-url-input">API åŸºç¡€ URL (æ¥å…¥ç‚¹)</label>
                                <input type="text" id="api-base-url-input" placeholder="https://api.openai.com/v1">
                            </div>

                            <div class="setting-item">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <label for="api-model-input">æ¨¡å‹åç§° (Model)</label>
                                    <button id="fetch-models-btn" style="padding: 4px 10px; font-size: 12px; background-color: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                        æ‹‰å–
                                    </button>
                                </div>
                                <input type="text" id="api-model-input" placeholder="ä¾‹å¦‚: gpt-4o">
                                <div id="model-selector-container" style="margin-top: 10px;"></div>
                            </div>
                            
                            <div class="button-group" style="margin-top: 10px;">
                                <button class="btn-save" id="api-preset-save-btn">ä¿å­˜æ­¤é¢„è®¾</button>
                            </div>
                        </div>

                    </div>
                </div>  
             <!-- ã€æ–°æ·»åŠ ã€‘å­—ä½“è®¾ç½®æ‰‹é£ç´ -->
<div class="accordion-item">
    <div class="accordion-header" id="font-accordion-header">
        <span>å­—ä½“è®¾ç½®</span>
        <span class="arrow">&gt;</span>
    </div>
    <div class="accordion-content" id="font-accordion-content">
        
        <!-- 1. å­—ä½“é¢„è®¾ -->
        <div class="editor-section">
            <h4>å­—ä½“é¢„è®¾</h4>
            <select id="font-preset-select" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="default">é»˜è®¤</option>
                <option value="serif">è¡¬çº¿</option>
                <option value="monospace">ç­‰å®½</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
        </div>
        
        <!-- 2. å…¨å±€å­—ä½“ -->
        <div class="editor-section">
            <h4>å…¨å±€å­—ä½“</h4>
            
            <div class="setting-item">
                <label>å­—ä½“é“¾æ¥ (URL)</label>
                <input type="url" id="global-font-url" placeholder="ä¾‹å¦‚ï¼šhttps://fonts.googleapis.com/...">
            </div>
            
            <div class="setting-item">
                <label>å­—ä½“åç§°</label>
                <input type="text" id="global-font-name" placeholder="ä¾‹å¦‚ï¼šNoto Sans SC">
            </div>
            
            <div class="setting-item">
                <label>å­—ä½“å¤§å°</label>
                <div class="slider-group">
                    <input type="range" id="global-font-size" min="12" max="24" value="16">
                    <span id="global-font-size-value">16px</span>
                </div>
            </div>
            
            <!-- å…¨å±€å­—ä½“é¢„è§ˆ -->
            <div class="font-preview-box">
                <p class="font-preview-label">å…¨å±€å­—ä½“é¢„è§ˆï¼š</p>
                <p class="font-preview-text" id="global-font-preview">è¿™æ˜¯å…¨å±€å­—ä½“çš„æ•ˆæœ</p>
            </div>
        </div>
        
        <!-- 3. èŠå¤©å­—ä½“ -->
        <div class="editor-section">
            <h4>èŠå¤©å­—ä½“ï¼ˆè¦†ç›–å…¨å±€ï¼‰</h4>
            
            <div class="setting-item">
                <label>å­—ä½“é“¾æ¥ (URL)</label>
                <input type="url" id="chat-font-url" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨å…¨å±€å­—ä½“">
            </div>
            
            <div class="setting-item">
                <label>å­—ä½“åç§°</label>
                <input type="text" id="chat-font-name" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨å…¨å±€å­—ä½“">
            </div>
            
            <div class="setting-item">
                <label>å­—ä½“å¤§å°</label>
                <div class="slider-group">
                    <input type="range" id="chat-font-size" min="12" max="24" value="16">
                    <span id="chat-font-size-value">16px</span>
                </div>
            </div>
            
            <!-- èŠå¤©å­—ä½“é¢„è§ˆ -->
            <div class="font-preview-box">
                <p class="font-preview-label">èŠå¤©å­—ä½“é¢„è§ˆï¼š</p>
                <p class="font-preview-text" id="chat-font-preview">è¿™æ˜¯èŠå¤©å­—ä½“çš„æ•ˆæœ</p>
            </div>
        </div>
        
        <!-- 5. æŒ‰é’®ç»„ -->
        <div class="button-group" style="margin-top: 20px;">
            <button class="btn-clear" id="font-reset-btn">æ¢å¤é»˜è®¤</button>
            <button class="btn-save" id="font-save-btn">ä¿å­˜å­—ä½“è®¾ç½®</button>
        </div>
        
    </div>
</div>
   
                </div>
        </div>
        <div class="dialogue-list-screen hidden">
            <nav class="theme-nav">
                <button id="dialogue-list-back-btn" class="back-btn">&lt;</button>
                <h2>è”ç³»äºº</h2>
                <button id="new-chat-btn" class="nav-action-btn">+</button>
            </nav>
            <div class="dialogue-list-content">
                <p class="empty-list-message">æš‚æ— å¯¹è¯ï¼Œç‚¹å‡»å³ä¸Šè§’ + å·å¼€å§‹æ–°èŠå¤©</p>
                </div>
        </div>

        <div class="chat-window-screen hidden">
             <nav class="theme-nav">
                 <button id="chat-window-back-btn" class="back-btn">&lt;</button>
                <h2 id="chat-window-title">AI åŠ©æ‰‹</h2>
           <button id="contact-settings-btn" class="nav-action-btn" style="font-size: 24px; font-weight: bold;">...</button>
            </nav>
            
            <div class="message-container" id="message-container">
                </div>
        

<!--  è¡¨æƒ…æŒ‰é’®åŒºåŸŸï¼ˆåœ¨è¾“å…¥æ¡†ä¸Šæ–¹ï¼‰ -->
<div style="padding: 5px 15px; border-top: 1px solid #e0e0e0; background-color: #ffffff; display: flex; justify-content: flex-start; gap: 10px;">
    <button id="sticker-toggle-btn" style="background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; cursor: pointer; padding: 4px 10px; color: #555;">ğŸ˜Š è¡¨æƒ…</button>
    <button id="retract-btn" style="background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; cursor: pointer; padding: 4px 10px; color: #555; ">ğŸ”„ æ’¤å›</button>
</div>

    <!--  è¡¨æƒ…é¢æ¿ -->
    <div id="sticker-panel" class="sticker-panel hidden">
        <div class="sticker-panel-header">
            <input type="text" id="sticker-search-input" class="sticker-panel-search" placeholder="æœç´¢è¡¨æƒ…åŒ…...">
        </div>
        <div class="sticker-panel-tabs" id="sticker-panel-tabs">
            <!-- åŠ¨æ€ç”Ÿæˆè¡¨æƒ…åº“æ ‡ç­¾ -->
        </div>
        <div class="sticker-panel-content" id="sticker-panel-content">
            <!-- åŠ¨æ€ç”Ÿæˆè¡¨æƒ…åŒ…ç½‘æ ¼ -->
        </div>
    </div>
            <div class="dialogue-input-area">
                <input type="text" id="chat-input-box" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button id="send-message-btn">æ¥æ”¶</button>
            </div>
        </div>
        <main class="app-grid">
         <div class="widget widget-3x2">
                <div class="widget-bg" id="widget-bg-image">
                    <img src="./assets/default-avatar.png" alt="Avatar" class="widget-avatar" id="widget-avatar-image">
                </div>
                <p class="widget-text" id="widget-bottom-text">å¤§èƒ†ï¼Œæœ•æ˜¯çš‡å¸ï¼</p>
            </div>
            
            <div class="widget widget-2x1">
                <h4>ğŸŒ¤ï¸ å¤©æ°”</h4>
                <p>æ™´å¤©, 25Â°C</p>
            </div>
          <div class="app-icon" id="icon-dialogue">
           
        
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg>
                <span>å¯¹è¯</span>
            </div>
        <div class="app-icon" id="icon-worldbook">
             
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 2.687c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388 1.175.884.652 1.303 1.527 1.303 2.456 0 .98-.45 1.928-1.384 2.675-.801.645-1.902.802-3.122.684a.5.5 0 0 1-.45-.498V5.15a.5.5 0 0 1 .45-.498c1.134-.11 2.291-.322 3.292-.752.992-.422 1.722-1.027 1.722-1.727 0-.54-.342-1.033-.82-1.42-.453-.374-1.156-.62-2.09-.722-1.024-.11-2.046.015-2.822.534L8.5 2.687zM8 1.5C7.346.811 6.218.614 4.888.752 3.654.876 2.385 1.275 1.5 1.928.614 2.58.196 3.455.196 4.382c0 .98.45 1.928 1.384 2.675.801.645 1.902.802 3.122.684a.5.5 0 0 0 .45-.498V5.15a.5.5 0 0 0-.45-.498c-1.134-.11-2.291-.322-3.292-.752-.992-.422-1.722-1.027-1.722-1.727 0-.54.342-1.033.82-1.42.453-.374 1.156-.62-2.09-.722-1.024-.11-2.046.015-2.822.534L8 1.5z"/><path d="M8 4v7.75a.25.25 0 0 0 .25.25h.5a.25.25 0 0 0 .25-.25V4a.25.25 0 0 0-.25-.25h-.5A.25.25 0 0 0 8 4z"/></svg>
                <span>ä¸–ç•Œä¹¦</span>
            </div>
         <div class="app-icon" id="icon-forum">
           
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8c0 3.866-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.584.296-1.925.864-4.181 1.234-.2.032-.352-.176-.273-.362.354-.836.674-1.95.77-2.966C.744 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.5 5a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7zm0 2.5a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7zm0 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4z"/></svg>
                <span>è®ºå›</span>
            </div>
<div class="app-icon" id="icon-me">
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/></svg>
    <span>æˆ‘</span>
</div>
            
            <div style="grid-column: span 2;"></div>

            <div class="widget widget-2x1-slim" data-widget-id="card2">
                <p class="widget-text-slim"></p>
            </div>

            <div style="grid-column: span 2;"></div>

            <div class="widget widget-2x1-slim" data-widget-id="card1">
                <p class="widget-text-slim"></p>
            </div>
        </main>

        <nav class="dock">
         <div class="app-icon" id="icon-settings">
              
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>
                <span>è®¾ç½®</span>
            </div>
                <div class="app-icon" id="theme-app-icon">
              
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg>
                <span>ä¸»é¢˜</span>
            </div>
         <div class="app-icon" id="icon-memory">
              
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M8 5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z"/><path d="M4.246 1.126C3.201 1.631 2 2.95 2 4.5s1.201 2.869 2.246 3.374c1.118.536 2.329.626 3.29.283.192-.07.393-.157.6-.253.314-.148.642-.358.915-.624.273-.266.48-.593.618-.948.139-.355.195-.75.195-1.153 0-.403-.056-.798-.195-1.153-.138-.355-.345-.682-.618-.948-.273-.266-.601-.476-.915-.624a6.437 6.437 0 0 0-.6-.253c-.96-.343-2.172-.253-3.29.283zm-3.065 6.352c-.655-.49-.93-1.246-.93-2.028 0-.782.275-1.538.93-2.028C1.73 3.333 2.92 2.5 4.5 2.5c1.58 0 2.77.833 3.423 1.48C8.583 4.537 9.27 5.5 8.5 7.027c-.772 1.527-1.46 2.49-2.077 2.49-.618 0-1.306-.963-2.077-2.49z"/></svg>
                <span>è®°å¿†</span>
            </div>
          
        </nav>
 <div id="theme-popup" class="popup hidden">
            <div class="popup-content">
                <h3>æ›´æ¢å£çº¸</h3>
                <div class="input-group">
                    <input type="url" id="image-url-input" placeholder="è¯·åœ¨è¿™é‡Œç²˜è´´å›¾ç‰‡URL">
                    <button id="url-submit-btn">ç¡®å®š</button>
                </div>
                <p>æˆ–è€…</p>
                <label for="local-file-input" class="file-label">
                    ä»æœ¬åœ°é€‰æ‹©å›¾ç‰‡
                </label>
                <input type="file" id="local-file-input" accept="image/*" style="display: none;">
                <button id="close-popup-btn" class="close-btn">Ã—</button>
            </div>
        </div>

    <div id="widget-editor-popup" class="popup hidden">
            <div class="popup-content">
                <h3>ç»„ä»¶ç¼–è¾‘å™¨</h3>
                
                <div class="editor-section">
                    <h4>èƒŒæ™¯å›¾</h4>
                    <div class="input-group">
                        <input type="url" id="widget-bg-url-input" placeholder="ç²˜è´´èƒŒæ™¯å›¾URL">
                    </div>
                 <div style="display: flex; align-items: center; gap: 10px;">
    <label for="widget-bg-file-input" class="file-label" style="flex-grow: 1; margin: 0;">
        æˆ– ä»æœ¬åœ°ä¸Šä¼ èƒŒæ™¯
    </label>
    <img id="widget-bg-preview" src="" alt="èƒŒæ™¯é¢„è§ˆ" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background-color: #eee; display: none;">
</div>
<input type="file" id="widget-bg-file-input" accept="image/*" style="display: none;">
                </div>
 <div class="editor-section"id="avatar-editor-section">
                    <h4>å¤´åƒ</h4>
                    <div class="input-group">
                        <input type="url" id="widget-avatar-url-input" placeholder="ç²˜è´´å¤´åƒå›¾ç‰‡URL">
                    </div>
                   <div style="display: flex; align-items: center; gap: 10px;">
    <label for="widget-avatar-file-input" class="file-label" style="background-color: rgba(0, 122, 255, 0.8); flex-grow: 1; margin: 0;">
        æˆ– ä»æœ¬åœ°ä¸Šä¼ å¤´åƒ
    </label>
    <img id="widget-avatar-preview" src="" alt="å¤´åƒé¢„è§ˆ" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; display: none;">
</div>
<input type="file" id="widget-avatar-file-input" accept="image/*" style="display: none;">
                </div>
               <div class="editor-section">
                    <h4>æ–‡å­—</h4>
                    <div class="input-group">
                        <input type="text" id="widget-text-input" placeholder="è¾“å…¥è‡ªå®šä¹‰æ–‡å­— (å¯é€‰)">
                    </div>
                    <div class="input-group" style="justify-content: space-between; align-items: center; margin-top: 10px;">
                        <label for="widget-text-color-input" style="font-weight: bold; color: #555;">æ–‡å­—é¢œè‰²:</label>
                        <input type="color" id="widget-text-color-input" value="#333333">
                    </div>
                    </div>

                <div class="button-group">

                    <button class="btn-clear" id="widget-clear-btn">æ¸…é™¤</button>
                    <button class="btn-save" id="widget-save-btn">ä¿å­˜</button>
                </div>

                <button id="widget-editor-close-btn" class="close-btn">Ã—</button>
            </div>
        </div>
        </div>



        <div id="add-contact-popup" class="popup solid-popup hidden">
            
            <div class="popup-content solid-popup-content">
                <h3>æ·»åŠ æ–°è”ç³»äºº</h3>
                
                <div class="avatar-preview-container">
                    <img id="contact-avatar-preview" src="./assets/default-avatar.png" alt="å¤´åƒé¢„è§ˆ">
                </div>
                
                <label for="contact-avatar-file-input" class="file-label" style="background-color: rgba(0, 122, 255, 0.8);">
                    ä¸Šä¼ å¤´åƒ
                </label>
                <input type="file" id="contact-avatar-file-input" accept="image/*" style="display: none;">

                <div class="setting-item">
                    <label for="contact-name-input">å§“å</label>
                    <input type="text" id="contact-name-input" placeholder="è¾“å…¥è”ç³»äººå§“å">
                </div>
                
                <div class="setting-item">
                    <label for="contact-persona-input">äººè®¾ (Persona)</label>
                    <textarea id="contact-persona-input" rows="5" placeholder="è¾“å…¥å¯¹æ–¹çš„äººè®¾æˆ–èƒŒæ™¯æ•…äº‹..."></textarea>
                </div>
<div class="setting-item">
                <label for="contact-mypersona-preset-select">ä¸ Ta èŠå¤©æ—¶ï¼Œä½¿ç”¨å“ªä¸ªäººè®¾ï¼Ÿ</label>
                <select id="contact-mypersona-preset-select" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
                    <option value="">--- è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾é¢„è®¾ ---</option>
                </select>
            </div>
                <div class="button-group" style="margin-top: 10px;">
                    <button class="btn-save" id="save-contact-btn">ä¿å­˜è”ç³»äºº</button>
                </div>

                <button id="add-contact-close-btn" class="close-btn">Ã—</button>
            </div>
        </div>
        
        </div>
  <div id="worldbook-list-screen" class="dialogue-list-screen hidden">
    <nav class="theme-nav">
        <button id="worldbook-back-btn" class="back-btn">&lt;</button>
        <h2>ä¸–ç•Œä¹¦</h2>
        <button id="worldbook-add-btn" class="nav-action-btn">+</button>
    </nav>
    
    <div style="padding: 10px 15px; border-bottom: 1px solid #f0f0f0;">
        <label for="worldbook-category-filter" style="font-size: 14px; color: #555;">ç­›é€‰åˆ†ç±»:</label>
        <select id="worldbook-category-filter" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; margin-top: 5px;">
            <option value="all">--- å…¨éƒ¨ ---</option>
            </select>
    </div>
    
    <div id="worldbook-list-content" class="dialogue-list-content">
        <p class="empty-list-message">æš‚æ— æ¡ç›®ï¼Œç‚¹å‡»å³ä¸Šè§’ + å·å¼€å§‹æ·»åŠ </p>
    </div>
</div>


<div id="entry-editor-screen" class="dialogue-list-screen hidden">
    <nav class="theme-nav">
        <button id="entry-editor-back-btn" class="back-btn">&lt;</button>
        <h2 id="entry-editor-title">æ·»åŠ æ–°æ¡ç›®</h2>
    </nav>
    
    <div class="theme-content">
        <div class="setting-item">
            <label for="entry-name-input">æ¡ç›®åç§°</label>
            <input type="text" id="entry-name-input" placeholder="ä¾‹å¦‚ï¼šæœˆå…‰æ£®æ—">
        </div>
        
        <div class="setting-item">
            <label for="entry-category-select">é€‰æ‹©åˆ†ç±»</label>
            <select id="entry-category-select" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="">--- è¯·å…ˆå»â€œç®¡ç†åˆ†ç±»â€ä¸­æ·»åŠ åˆ†ç±» ---</option>
                </select>
        </div>
        
        <div class="setting-item">
            <label for="entry-content-textarea">æ¡ç›®å†…å®¹</label>
            <textarea id="entry-content-textarea" rows="10" placeholder="è¾“å…¥å…³äºè¿™ä¸ªæ¡ç›®çš„è¯¦ç»†æè¿°..." style="width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical;"></textarea>
        </div>
        
        <div class="button-group" style="margin-top: 10px;">
            <button class="btn-save" id="entry-save-btn">ä¿å­˜æ¡ç›®</button>
        </div>
    </div>
</div>


<div id="category-manager-screen" class="dialogue-list-screen hidden">
    <nav class="theme-nav">
        <button id="category-manager-back-btn" class="back-btn">&lt;</button>
        <h2>ç®¡ç†åˆ†ç±»</h2>
    </nav>
    
    <div class="theme-content">
        <div class="editor-section">
            <div class="input-group">
                <input type="text" id="category-name-input" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§° (ä¾‹å¦‚: äººç‰©)" style="border-radius: 8px;">
                <button id="category-add-btn" class="btn-save" style="margin-left: 10px;">æ·»åŠ </button>
            </div>
        </div>
        
        <div class="editor-section">
            <h4>æˆ‘çš„åˆ†ç±»</h4>
            <div id="category-list-container" style="max-height: 300px; overflow-y: auto;">
                <p style="font-size: 12px; color: #777; text-align: center;">æš‚æ— åˆ†ç±»</p>
                </div>
        </div>
    </div>
</div>


<div id="worldbook-add-menu" class="popup hidden" style="background-color: rgba(0,0,0,0.3); z-index: 250;">
    <div class="popup-content" style="width: 200px; max-height: 200px; padding: 15px;">
        <button id="worldbook-menu-add-entry" class="file-label" style="margin: 0 0 10px 0;">
            + æ·»åŠ æ–°æ¡ç›®
        </button>
        <button id="worldbook-menu-manage-categories" class="file-label" style="margin: 0; background-color: rgba(88, 86, 214, 0.8);">
            ğŸ·ï¸ ç®¡ç†åˆ†ç±»
        </button>
        </div>
</div>
  <div id="contact-settings-screen" class="dialogue-list-screen hidden" style="background-color: #f0f0f0;">
    <nav class="theme-nav">
        <button id="contact-settings-back-btn" class="back-btn">&lt;</button>
        <h2 id="contact-settings-title">è§’è‰²è®¾ç½®</h2>
    </nav>
    
    <div class="theme-content">
        <div class="accordion-item">
            <div class="accordion-content expanded" style="padding-top: 15px;">
                <div class="setting-item" style="text-align: center;">
                    <img id="contact-settings-avatar" src="./assets/default-avatar.png" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #eee;">
                    <label for="contact-settings-avatar-input" class="file-label" style="background-color: rgba(0, 122, 255, 0.8); width: 150px; margin: 10px auto 0 auto; padding: 8px 0;">
                        ä¿®æ”¹å¤´åƒ
                    </label>
                    <input type="file" id="contact-settings-avatar-input" accept="image/*" style="display: none;">
                </div>
                
                <div class="setting-item">
                    <label for="contact-settings-name-input">è§’è‰²åå­—</label>
                    <input type="text" id="contact-settings-name-input" placeholder="ä¾‹å¦‚: å¤æ´›å…‹Â·ç¦å°”æ‘©æ–¯">
                </div>
                
                <div class="setting-item">
                    <label for="contact-settings-remark-input">å¤‡æ³¨ (ä½ è‡ªå·±çœ‹çš„)</label>
                    <input type="text" id="contact-settings-remark-input" placeholder="ä¾‹å¦‚: å®å®ã€å®è´">
                </div>
                
           <div class="setting-item">
    <label for="contact-settings-persona-input">äººè®¾ (Persona)</label>
    <textarea id="contact-settings-persona-input" rows="5" style="width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical;"></textarea>
</div>

<!-- ã€æ–°æ·»åŠ ã€‘é€‰æ‹©"æˆ‘çš„äººè®¾" -->
<div class="setting-item">
    <label for="contact-settings-mypersona-preset-select">æ›´æ¢ä¸ Ta èŠå¤©æ—¶ä½¿ç”¨çš„äººè®¾</label>
    <select id="contact-settings-mypersona-preset-select" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
        <option value="">--- è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾é¢„è®¾ ---</option>
    </select>
</div>
              <!-- ã€æ–°æ·»åŠ ã€‘æˆ‘çš„äººè®¾è¡¥å…… -->
<div class="setting-item">
    <label for="contact-settings-mypersona-supplement-input">æˆ‘çš„äººè®¾è¡¥å……ï¼ˆä¸“å±äºæ­¤è§’è‰²ï¼‰</label>
    <textarea id="contact-settings-mypersona-supplement-input" rows="4" placeholder="ä¾‹å¦‚ï¼šåœ¨å’Œè¿™ä¸ªè§’è‰²èŠå¤©æ—¶ï¼Œæˆ‘æ˜¯ä¸€ä¸ªå¯¹é­”æ³•æ„Ÿå…´è¶£çš„åˆå­¦è€…..." style="width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical;"></textarea>
    <p style="font-size: 12px; color: #777; margin-top: 5px;">
        è¿™æ®µæè¿°ä¼šå’Œä½ é€‰æ‹©çš„äººè®¾åˆå¹¶ï¼Œè®©è§’è‰²æ›´äº†è§£ä½ åœ¨è¿™æ®µå…³ç³»ä¸­çš„è§’è‰²
    </p>
</div>
            </div>
        </div>
     
        <div class="accordion-item">
            <div class="accordion-content expanded" style="padding-top: 15px;">
                <div class="setting-item">
                    <label>AI æ˜¯å¦èƒ½è¯»å–æœ¬åœ°æ—¶é—´?</label>
                    <div class="toggle-switch" id="contact-settings-time-toggle">
                        <div class="toggle-label">å¦</div>
                        <div class="toggle-handle"></div>
                        <div class="toggle-label">æ˜¯</div>
                    </div>
                </div>
              <div class="setting-item">
    <label>æ˜¯å¦æ˜¾ç¤ºå¤´åƒ?</label>
    <div class="toggle-switch" id="contact-settings-avatar-toggle">
        <div class="toggle-label">å¦</div>
        <div class="toggle-handle"></div>
        <div class="toggle-label">æ˜¯</div>
    </div>
                <div class="setting-item">
    <label>æ˜¯å¦å¯ç”¨æƒ…ä¾£å¤´åƒ?</label>
    <div class="toggle-switch" id="contact-settings-couple-avatar-toggle">
        <div class="toggle-label">å¦</div>
        <div class="toggle-handle"></div>
        <div class="toggle-label">æ˜¯</div>
    </div>
</div>

</div>

<!-- ã€æ–°æ·»åŠ ã€‘ä¸Šä¸‹æ–‡å‚è€ƒè½®æ•° -->
<div class="setting-item">
    <label for="contact-settings-context-slider">ä¸Šä¸‹æ–‡å‚è€ƒ</label>
    <div class="slider-group">
        <input type="range" id="contact-settings-context-slider" min="5" max="200" value="10" step="1">
        <input type="number" id="contact-settings-context-value" min="5" max="200" value="10" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 5px; text-align: center;">
    </div>
    <p style="font-size: 12px; color: #777; margin-top: 5px;">
        è®¾ç½®è¶Šå¤§ï¼ŒAI è®°å¾—è¶Šå¤šï¼Œä½†å“åº”å¯èƒ½å˜æ…¢ã€‚å»ºè®®ï¼š10-30è½®
    </p>
</div>
                <div class="setting-item">
                    <label>èŠå¤©èƒŒæ™¯</label>
                    <label for="contact-settings-bg-input" class="file-label" style="background-color: rgba(76, 217, 100, 0.8); margin: 0;">
                        ä¸Šä¼ è‡ªå®šä¹‰èƒŒæ™¯
                    </label>
                    <input type="file" id="contact-settings-bg-input" accept="image/*" style="display: none;">
                <button id="contact-settings-bg-clear-btn" class="btn-clear" style="width: 100%; margin-top: 10px; padding: 8px;">æ¸…é™¤èƒŒæ™¯</button>
                </div>
                
                <div class="setting-item">
                    <label>å…³è”ä¸–ç•Œä¹¦ (ä¸“å±è®°å¿†)</label>
             <button id="contact-settings-link-worldbook-btn" class="btn-save" style="width: 100%; background-color: #5856d6; padding: 10px;">
                        ç®¡ç†å…³è”æ¡ç›®
                    </button>
                </div>
            </div>
        </div>

        <div class="button-group" style="margin-top: 10px;">
            <button class="btn-save" id="contact-settings-save-btn" style="width: 100%; padding: 12px; font-size: 16px;">ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>
</div>

<div id="worldbook-linker-screen" class="dialogue-list-screen hidden">
    <nav class="theme-nav">
        <button id="worldbook-linker-back-btn" class="back-btn">&lt;</button>
        <h2 id="worldbook-linker-title">å…³è”ä¸–ç•Œä¹¦</h2>
    </nav>
    
    <div id="worldbook-linker-list" class="dialogue-list-content" style="padding: 0;">
        </div>
</div>
 <div id="me-screen" class="dialogue-list-screen hidden" style="background-color: #f9f9f9;">
    <nav class="theme-nav">
        <button id="me-back-btn" class="back-btn">&lt;</button>
        <h2>ä¸ªäººä¸­å¿ƒ</h2>
    </nav>
    
    <div class="theme-content">
        <!-- äººè®¾åˆ‡æ¢æ‰‹é£ç´ -->
        <div class="accordion-item">
            <div class="accordion-header" id="persona-accordion-header">
                <span>äººè®¾åˆ‡æ¢</span>
                <span class="arrow">&gt;</span>
            </div>
            <div class="accordion-content" id="persona-accordion-content">
              <!-- é¡¶éƒ¨æŒ‰é’®åŒº -->
<div id="persona-buttons" style="margin-bottom: 15px;">
    <button id="persona-add-btn" class="btn-save" style="background-color: #4cd964;">æ–°å¢</button>
    <button id="persona-manage-btn" class="btn-clear">ç®¡ç†</button>
</div>

                
                <!-- äººè®¾åˆ—è¡¨å®¹å™¨ -->
                <div id="my-persona-list-container" style="max-height: 300px; overflow-y: auto;">
                    <p style="font-size: 12px; color: #777; text-align: center;">æš‚æ— äººè®¾</p>
                </div>
            </div>
        </div>
      
<!-- ã€æ–°æ·»åŠ ã€‘è¡¨æƒ…åŒ…åº“æ‰‹é£ç´ -->

<div class="accordion-item">
    <div class="accordion-header" id="sticker-accordion-header">
        <span>è¡¨æƒ…åŒ…è®¾ç½®</span>
        <span class="arrow">&gt;</span>
    </div>
 <div class="accordion-content" id="sticker-accordion-content">
    
    <!-- æ‰¹é‡å¯¼å…¥ -->
    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="font-weight: 500; font-size: 15px;">æ‰¹é‡å¯¼å…¥è¡¨æƒ…åŒ…</span>
        <button class="sticker-select-btn" id="import-sticker-btn">å¯¼å…¥</button>
    </div>
    
    <!-- åˆ é™¤è¿™ä¸€æ®µï¼ˆä¸å†éœ€è¦"è§’è‰²é€‰æ‹©"ï¼‰-->
    <!-- å·²å¯¼å…¥çš„è¡¨æƒ…åŒ…åº“ -->
    <div class="setting-item" style="margin-top: 20px;">
        <p style="font-size: 13px; color: #888; text-align: center; margin-bottom: 10px;">â”€â”€â”€ å·²å¯¼å…¥çš„è¡¨æƒ…åŒ…åº“ â”€â”€â”€</p>
        <div id="sticker-libraries-container">
            <p style="font-size: 12px; color: #777; text-align: center;">æš‚æ— è¡¨æƒ…åŒ…åº“</p>
        </div>
    </div>
    
</div>

</div>

<!-- æƒ…ä¾£å¤´åƒè®¾ç½®å¼¹çª— -->
<div id="couple-avatar-popup" class="popup solid-popup hidden">
    <div class="popup-content solid-popup-content" style="width: 320px; max-height: 600px;">
        <h3>è®¾ç½®æƒ…ä¾£å¤´åƒ</h3>
        
        <!-- ç”¨æˆ·å¤´åƒ -->
        <div class="setting-item">
            <label>æˆ‘çš„å¤´åƒ</label>
            <div class="avatar-preview-container">
                <img id="couple-user-avatar-preview" src="./assets/default-avatar.png" alt="æˆ‘çš„å¤´åƒ" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #007aff;">
            </div>
            <label for="couple-user-avatar-input" class="file-label" style="background-color: rgba(0, 122, 255, 0.8);">
                ä¸Šä¼ æˆ‘çš„å¤´åƒ
            </label>
            <input type="file" id="couple-user-avatar-input" accept="image/*" style="display: none;">
        </div>
        
        <!-- AIå¤´åƒ -->
        <div class="setting-item">
            <label>å¯¹æ–¹å¤´åƒ</label>
            <div class="avatar-preview-container">
                <img id="couple-bot-avatar-preview" src="./assets/default-avatar.png" alt="å¯¹æ–¹å¤´åƒ" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #ff3b30;">
            </div>
            <label for="couple-bot-avatar-input" class="file-label" style="background-color: rgba(255, 59, 48, 0.8);">
                ä¸Šä¼ å¯¹æ–¹å¤´åƒ
            </label>
            <input type="file" id="couple-bot-avatar-input" accept="image/*" style="display: none;">
        </div>
        
        <div class="button-group" style="margin-top: 20px;">
            <button class="btn-clear" id="couple-avatar-cancel-btn">å–æ¶ˆ</button>
            <button class="btn-save" id="couple-avatar-save-btn">ä¿å­˜</button>
        </div>
        
        <button id="couple-avatar-close-btn" class="close-btn">Ã—</button>
    </div>
</div>


        <!-- æœªæ¥å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–æ‰‹é£ç´é¡¹ -->
    </div>
</div>


<div id="persona-editor-popup" class="popup solid-popup hidden" style="z-index: 270;">
    <div class="popup-content solid-popup-content" style="width: 320px; max-height: 550px; text-align: left;">
        <h3 id="persona-editor-title">ç¼–è¾‘äººè®¾</h3>
        
        <div class="avatar-preview-container">
            <img id="persona-avatar-preview" src="./assets/default-avatar.png" alt="å¤´åƒé¢„è§ˆ" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
        </div>
        
        <label for="persona-avatar-input" class="file-label" style="background-color: rgba(0, 122, 255, 0.8);">
            ä¸Šä¼ å¤´åƒ
        </label>
        <input type="file" id="persona-avatar-input" accept="image/*" style="display: none;">

        <div class="setting-item">
            <label for="persona-name-input">äººè®¾åç§°</label>
            <input type="text" id="persona-name-input" placeholder="ä¾‹å¦‚ï¼šèŒåœºç²¾è‹±çš„æˆ‘">
        </div>
        
        <div class="setting-item">
            <label for="persona-desc-input">äººè®¾æè¿°</label>
            <textarea id="persona-desc-input" rows="6" placeholder="è¾“å…¥è¯¦ç»†æè¿°..." style="width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical;"></textarea>
        </div>

        <div class="button-group" style="margin-top: 10px;">
            <button class="btn-save" id="save-persona-btn">ä¿å­˜</button>
        </div>

        <button id="persona-editor-close-btn" class="close-btn">Ã—</button>
    </div>
</div>
  <div id="memory-screen" class="dialogue-list-screen hidden" style="background-color: #f9f9f9;">
    <nav class="theme-nav">
        <button id="memory-back-btn" class="back-btn">&lt;</button>
        <h2>è®°å¿† & æ€»ç»“</h2>
    </nav>

  <div class="setting-item" id="summary-character-selector-btn" style="background-color: white; padding: 20px 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
    <span id="summary-selected-character-name" style="font-size: 16px; color: #777;">è¯·é€‰æ‹©è¦ç®¡ç†çš„è§’è‰²...</span>
    <span style="font-size: 20px; font-family: monospace; color: #777;">&gt;</span>
</div>

<div id="summary-settings-container" class="hidden">

    <div class="setting-item" style="background-color: white; padding: 15px; border-radius: 12px; margin-top: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
        <h4 style="margin: 0 0 15px 0; font-size: 16px;">è‡ªåŠ¨æ€»ç»“</h4>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <label style="margin: 0; font-weight: 500;">å¼€å¯è‡ªåŠ¨æ€»ç»“</label>
            <div class="toggle-switch" id="summary-auto-toggle" style="transform: scale(0.9);">
                <div class="toggle-label">å¦</div>
                <div class="toggle-handle"></div>
                <div class="toggle-label">æ˜¯</div>
            </div>
        </div>

        <label for="summary-rounds-slider">æ€»ç»“é¢‘ç‡</label>
        <div class="slider-group">
         <input type="range" id="summary-rounds-slider" min="0" max="200" value="20" step="1">
         <input type="number" id="summary-rounds-value" min="0" max="200" value="20" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 5px; text-align: center;">

        </div>
    </div>

    <div class="setting-item" style="background-color: white; padding: 15px; border-radius: 12px; margin-top: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
        <h4 style="margin: 0 0 15px 0; font-size: 16px;">æ‰‹åŠ¨æ€»ç»“</h4>
        <label>èŠå¤©ç»Ÿè®¡</label>
        <p id="summary-stats-display" style="font-size: 14px; color: #555; margin: 5px 0 15px 0;">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²</p>
        <button id="summary-manual-btn" class="btn-save" style="width: 100%; background-color: #4cd964;">ç«‹å³æ‰‹åŠ¨æ€»ç»“ (æœªæ€»ç»“éƒ¨åˆ†)</button>
    </div>

    <div class="setting-item" style="background-color: white; padding: 15px; border-radius: 12px; margin-top: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
        <h4 style="margin: 0 0 15px 0; font-size: 16px;">AI æ€»ç»“å†…å®¹ (å¯ç¼–è¾‘)</h4>
        <textarea id="summary-textarea" rows="10" placeholder="AI æ€»ç»“å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." style="width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical;"></textarea>
        <button id="summary-save-text-btn" class="btn-save" style="width: 100%; margin-top: 10px;">ä¿å­˜ä¿®æ”¹</button>
    </div>

</div>
    <div id="character-selector-screen" class="dialogue-list-screen hidden" style="background-color: #f9f9f9;">

    <nav class="theme-nav">
        <button id="character-selector-back-btn" class="back-btn">&lt;</button>
        <h2>é€‰æ‹©è§’è‰²</h2>
    </nav>

    <div class="theme-content">

        <div class="setting-item" style="margin-bottom: 0;">
            <input type="text" id="character-search-input" placeholder="è¾“å…¥è§’è‰²åæœç´¢..." style="width: calc(100% - 20px);">
        </div>

        <div id="character-selector-list" class="dialogue-list-content" style="padding: 0; margin-top: 15px;">
            <p class="empty-list-message" style="margin-top: 20px;">æ­£åœ¨åŠ è½½è”ç³»äºº...</p>
        </div>

    </div>
</div>

<!-- ã€æ–°æ·»åŠ ã€‘å¯¼å…¥è¡¨æƒ…åŒ…å¼¹çª— -->
<div id="import-sticker-popup" class="popup solid-popup hidden" style="z-index: 280;">
    <div class="popup-content solid-popup-content" style="width: 320px; max-height: 600px;">
        <h3>å¯¼å…¥è¡¨æƒ…åŒ…</h3>
        
        <div class="setting-item">
            <label for="sticker-library-name-input">è¡¨æƒ…åŒ…åº“åç§°</label>
            <input type="text" id="sticker-library-name-input" placeholder="ä¾‹å¦‚ï¼šæ—¥å¸¸è¡¨æƒ…">
        </div>
        
        <div class="setting-item">
            <label for="sticker-batch-input">æ‰¹é‡ç²˜è´´é“¾æ¥</label>
            <textarea id="sticker-batch-input" rows="6" placeholder="æ¯è¡Œä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œæ”¯æŒæ ¼å¼ï¼š&#10;ç¬‘å“­+https://example.com/1.png&#10;ç¬‘å“­ï¼šhttps://example.com/1.png&#10;ç¬‘å“­,https://example.com/1.png" style="width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical; font-size: 12px;"></textarea>
        </div>
        
        <div style="background-color: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px;">
            <p style="font-size: 11px; color: #666; margin: 0 0 5px 0; font-weight: bold;">æ ¼å¼è¯´æ˜ï¼š</p>
            <p style="font-size: 11px; color: #666; margin: 0;">â€¢ æ–‡æœ¬+URL</p>
            <p style="font-size: 11px; color: #666; margin: 0;">â€¢ æ–‡æœ¬ï¼šURL</p>
            <p style="font-size: 11px; color: #666; margin: 0;">â€¢ æ–‡æœ¬,URL</p>
        </div>
        
        <!--  é¢„è§ˆåŒºåŸŸ -->
        <div class="setting-item" style="margin-top: 15px;">
            <label>é¢„è§ˆ (<span id="preview-count">0</span> ä¸ªè¡¨æƒ…åŒ…)</label>
            <div id="sticker-preview-grid" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background-color: #fafafa;">
                <p style="font-size: 12px; color: #999; text-align: center;">è¾“å…¥é“¾æ¥åè‡ªåŠ¨é¢„è§ˆ</p>
            </div>
        </div>
        
        <div class="button-group" style="margin-top: 15px;">
            <button class="btn-clear" id="import-sticker-cancel-btn">å–æ¶ˆ</button>
            <button class="btn-save" id="import-sticker-confirm-btn">ç¡®è®¤å¯¼å…¥</button>
        </div>
        
        <button id="import-sticker-close-btn" class="close-btn">Ã—</button>
    </div>
</div>


<!-- ã€æ–°æ·»åŠ ã€‘é€‰æ‹©è¡¨æƒ…åº“å¼¹çª— -->
<div id="select-sticker-popup" class="popup solid-popup hidden" style="z-index: 280;">
    <div class="popup-content solid-popup-content" style="width: 300px; max-height: 450px;">
        <h3 id="select-sticker-popup-title">é€‰æ‹©è¡¨æƒ…åŒ…åº“</h3>
        
        <div id="sticker-checkbox-list" style="max-height: 300px; overflow-y: auto;">
            <p style="font-size: 12px; color: #777; text-align: center; padding: 20px;">æš‚æ— å¯é€‰çš„è¡¨æƒ…åŒ…åº“</p>
        </div>
        
        <div class="button-group" style="margin-top: 15px;">
            <button class="btn-clear" id="select-sticker-cancel-btn">å–æ¶ˆ</button>
            <button class="btn-save" id="select-sticker-confirm-btn">ç¡®è®¤</button>
        </div>
        
        <button id="select-sticker-close-btn" class="close-btn">Ã—</button>
    </div>
</div>
<!-- ã€æ–°æ·»åŠ ã€‘æŸ¥çœ‹è¡¨æƒ…åº“å¼¹çª— -->
<div id="view-sticker-popup" class="popup solid-popup hidden" style="z-index: 280;">
    <div class="popup-content solid-popup-content" style="width: 340px; max-height: 600px;">
        <h3 id="view-sticker-popup-title">æŸ¥çœ‹è¡¨æƒ…åŒ…åº“</h3>
        
        <div style="padding: 10px; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 15px;">
            <p style="margin: 0; font-size: 14px; color: #555;">
                ğŸ“¦ <strong id="view-library-name">åº“åç§°</strong>
            </p>
            <p style="margin: 5px 0 0 0; font-size: 13px; color: #888;">
                å…± <span id="view-sticker-count">0</span> ä¸ªè¡¨æƒ…åŒ…
            </p>
        </div>
        
        <div id="view-sticker-grid" class="sticker-grid" style="max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fafafa;">
            <p style="font-size: 12px; color: #999; text-align: center;">åŠ è½½ä¸­...</p>
        </div>
        
        <div class="button-group" style="margin-top: 15px;">
            <button class="btn-clear" id="view-sticker-close-btn2">å…³é—­</button>
        </div>
        
        <button id="view-sticker-close-btn" class="close-btn">Ã—</button>
    </div>
</div>
<!-- æ¶ˆæ¯ç¼–è¾‘å¼¹çª— -->
<div id="message-edit-popup" class="popup hidden">
    <div class="popup-content">
        <h3>ç¼–è¾‘æ¶ˆæ¯</h3>
        <div class="setting-item">
            <label for="message-edit-textarea">ä¿®æ”¹å†…å®¹</label>
            <textarea id="message-edit-textarea" rows="5" placeholder="ç¼–è¾‘æ¶ˆæ¯å†…å®¹..."></textarea>
        </div>
        <div class="button-group" style="margin-top: 15px;">
            <button class="btn-clear" id="message-edit-cancel-btn">å–æ¶ˆ</button>
            <button class="btn-save" id="message-edit-save-btn">ä¿å­˜</button>
        </div>
        <button id="message-edit-close-btn" class="close-btn">Ã—</button>
    </div>
</div>




    <script>
      // ======================================================
//  ç§»åŠ¨ç«¯æµè§ˆå™¨è§†å£é«˜åº¦ä¿®å¤ï¼ˆå…¼å®¹ iOS å’Œ Androidï¼‰
// ======================================================
// ======================================================
// ã€æ”¹è¿›ç‰ˆã€‘ç§»åŠ¨ç«¯æµè§ˆå™¨è§†å£é«˜åº¦ä¿®å¤ï¼ˆå…¼å®¹ iOS é”®ç›˜ï¼‰
// ======================================================

// ======================================================
// ã€æ”¹è¿›ç‰ˆã€‘ç§»åŠ¨ç«¯æµè§ˆå™¨è§†å£é«˜åº¦ä¿®å¤ï¼ˆå…¼å®¹æ‰€æœ‰è¾“å…¥æ¡†ï¼‰
// ======================================================

// 1. å®šä¹‰å…¨å±€å˜é‡
let originalViewportHeight = window.innerHeight;
let isKeyboardOpen = false;

// 2. ä¿®æ”¹åçš„è§†å£é«˜åº¦è®¡ç®—å‡½æ•°
function setRealViewportHeight() {
    const currentHeight = window.innerHeight;
    
    // ã€å…³é”®ã€‘æ£€æµ‹é”®ç›˜æ˜¯å¦å¼¹å‡ºï¼ˆé«˜åº¦æ˜¾è‘—å‡å°‘ï¼‰
    if (originalViewportHeight - currentHeight > 150) {
        isKeyboardOpen = true;
        return; // é”®ç›˜å¼¹å‡ºæ—¶ï¼Œä¸æ›´æ–° --vh å˜é‡
    }
    
    // ã€å…³é”®ã€‘æ£€æµ‹é”®ç›˜æ˜¯å¦æ”¶èµ·ï¼ˆé«˜åº¦æ¢å¤ï¼‰
    if (isKeyboardOpen && Math.abs(originalViewportHeight - currentHeight) < 50) {
        isKeyboardOpen = false;
        originalViewportHeight = currentHeight;
    }
    
    // æ­£å¸¸æƒ…å†µä¸‹æ›´æ–° CSS å˜é‡
    const vh = currentHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

// 3. é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
setRealViewportHeight();

// 4. ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
window.addEventListener('resize', () => {
    clearTimeout(window.resizeTimer);
    window.resizeTimer = setTimeout(setRealViewportHeight, 100);
});

// 5. ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–
window.addEventListener('orientationchange', () => {
    setTimeout(() => {
        originalViewportHeight = window.innerHeight;
        isKeyboardOpen = false;
        setRealViewportHeight();
    }, 200);
});

// 6. visualViewport APIï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => {
        clearTimeout(window.viewportTimer);
        window.viewportTimer = setTimeout(setRealViewportHeight, 100);
    });
}

// 7. ã€æ ¸å¿ƒä¿®å¤ã€‘ç›‘å¬æ‰€æœ‰è¾“å…¥æ¡†çš„èšç„¦/å¤±ç„¦
document.addEventListener('focusin', (e) => {
    const target = e.target;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è¾“å…¥å…ƒç´ 
    if (target.tagName === 'INPUT' || 
        target.tagName === 'TEXTAREA' || 
        target.isContentEditable) {
        
        console.log('è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹:', target.id || target.className);
        
        // å»¶è¿Ÿæ£€æµ‹é”®ç›˜
        setTimeout(() => {
            const currentHeight = window.innerHeight;
            if (originalViewportHeight - currentHeight > 150) {
                isKeyboardOpen = true;
                console.log('é”®ç›˜å·²å¼¹å‡º');
            }
        }, 300);
    }
});

document.addEventListener('focusout', (e) => {
    const target = e.target;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è¾“å…¥å…ƒç´ 
    if (target.tagName === 'INPUT' || 
        target.tagName === 'TEXTAREA' || 
        target.isContentEditable) {
        
        console.log('è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹:', target.id || target.className);
        
        // å»¶è¿Ÿæ£€æµ‹é”®ç›˜æ”¶èµ·
        setTimeout(() => {
            if (isKeyboardOpen) {
                isKeyboardOpen = false;
                setRealViewportHeight();
                console.log('é”®ç›˜å·²æ”¶èµ·');
            }
        }, 300);
    }
});



// 2. é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰§è¡Œ
setRealViewportHeight();

// 3. ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆä¾‹å¦‚æ¨ªç«–å±åˆ‡æ¢ã€é”®ç›˜å¼¹å‡ºï¼‰
window.addEventListener('resize', setRealViewportHeight);

// 4. ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–ï¼ˆç§»åŠ¨ç«¯ç‰¹æœ‰ï¼‰
window.addEventListener('orientationchange', setRealViewportHeight);

// 5. ã€iOS Safari ç‰¹æ®Šå¤„ç†ã€‘ç›‘å¬æ»šåŠ¨äº‹ä»¶
// iOS åœ¨æ»šåŠ¨æ—¶åœ°å€æ ä¼šéšè—/æ˜¾ç¤ºï¼Œå¯¼è‡´è§†å£é«˜åº¦å˜åŒ–
let scrollTimeout;
window.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(setRealViewportHeight, 100);
});

// 6. ã€Android Chrome ç‰¹æ®Šå¤„ç†ã€‘ç›‘å¬ visualViewport å˜åŒ–
if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', setRealViewportHeight);
}

    // ======================================================
    // æ•°æ®åº“å®šä¹‰
    // ======================================================
    const db = new Dexie('MyPhoneDatabase');
    db.version(1).stores({
        settings: '&key', 
        files: '&key',
        contacts: '++id, name',
        chatMessages: '++id, contactId',
        apiPresets: '++id, name',
        worldbook_categories: '++id, name',
        worldbook_entries: '++id, categoryId, name'
    });
db.version(5).stores({
  contacts: '++id, name, remark, summarySettings, aiSummaryText, myPersonaSupplement, contextRounds',
    contact_worldbook_links: '[contactId+worldbookEntryId], contactId',
    my_persona_presets: '++id, name',
    sticker_libraries: '++id, name',              // è¡¨æƒ…åŒ…åº“
    stickers: '++id, libraryId, text, url',      // è¡¨æƒ…åŒ…æ•°æ®
    user_sticker_selection: 'key, libraryIds',    // ç”¨æˆ·é€‰ä¸­çš„åº“
    role_sticker_selection: 'key, libraryIds'     // è§’è‰²é€‰ä¸­çš„åº“
});

    
    // ======================================================
    // å…¨å±€å˜é‡
    // ======================================================
    let defaultIconSvgData = {};
    let currentEditingWidgetId = null; 
      let currentEditingMessageId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ¶ˆæ¯ID


    let currentOpenContactId = null; 
    let currentSelectedPresetId = null; 
let currentSummaryContactId = null; // è·Ÿè¸ªå½“å‰æ­£åœ¨ç¼–è¾‘æ€»ç»“çš„è§’è‰²
let summarySearchTimeout = null; // ç”¨äºæœç´¢é˜²æŠ–
    // ======================================================
    // å…ƒç´ æŠ“å– (Query Selectors)
    // ======================================================
  
    const phoneScreen = document.querySelector('.phone-screen');
    const appGrid = document.querySelector('.app-grid');
    const dock = document.querySelector('.dock');
    const topLeftText = document.querySelector('#top-left-text');
    const topRightText = document.querySelector('#top-right-text');
    const dateDisplay = document.querySelector('#date-display');
    const timeDisplay = document.querySelector('#time-display');
    const largeWidget = document.querySelector('.widget-3x2');
    const editableSlimWidgets = document.querySelectorAll('.widget-2x1-slim');
    const themeAppIcon = document.querySelector('#theme-app-icon');
    const themeScreen = document.querySelector('.theme-screen');
    const backToHomeBtn = document.querySelector('#back-to-home-btn');
    const accordionHeader1 = document.querySelector('#accordion-header-1');
    const accordionContent1 = document.querySelector('#accordion-content-1');
    const leftTextInput = document.querySelector('#left-text-input');
    const rightTextInput = document.querySelector('#right-text-input');
    const saveTextBtn = document.querySelector('#save-text-btn');
    const clearTextBtn = document.querySelector('#clear-text-btn');
    const fontSizeSlider = document.querySelector('#font-size-slider');
    const fontSizeValue = document.querySelector('#font-size-value');
    const accordionHeader2 = document.querySelector('#accordion-header-2');
    const accordionContent2 = document.querySelector('#accordion-content-2');
    const darkModeToggle = document.querySelector('#dark-mode-toggle');
    const accordionHeader3 = document.querySelector('#accordion-header-3');
    const accordionContent3 = document.querySelector('#accordion-content-3');
      const contactSettingsAvatarToggle = document.querySelector('#contact-settings-avatar-toggle');
const contactSettingsCoupleAvatarToggle = document.querySelector('#contact-settings-couple-avatar-toggle');
const coupleAvatarPopup = document.querySelector('#couple-avatar-popup');
const coupleUserAvatarPreview = document.querySelector('#couple-user-avatar-preview');
const coupleUserAvatarInput = document.querySelector('#couple-user-avatar-input');
const coupleBotAvatarPreview = document.querySelector('#couple-bot-avatar-preview');
const coupleBotAvatarInput = document.querySelector('#couple-bot-avatar-input');
const coupleAvatarSaveBtn = document.querySelector('#couple-avatar-save-btn');
const coupleAvatarCancelBtn = document.querySelector('#couple-avatar-cancel-btn');
const coupleAvatarCloseBtn = document.querySelector('#couple-avatar-close-btn');

      //  èŠå¤©ç•Œé¢ç¾åŒ–çš„å…ƒç´ æŠ“å–
const accordionHeader4 = document.querySelector('#accordion-header-4');
const accordionContent4 = document.querySelector('#accordion-content-4');
const chatNavBgColor = document.querySelector('#chat-nav-bg-color');
const chatNavTextColor = document.querySelector('#chat-nav-text-color');
const chatNavBgUrl = document.querySelector('#chat-nav-bg-url');
const chatNavBgFile = document.querySelector('#chat-nav-bg-file');
const chatNavBgPreview = document.querySelector('#chat-nav-bg-preview');
const chatWallpaperUrl = document.querySelector('#chat-wallpaper-url');
const chatWallpaperFile = document.querySelector('#chat-wallpaper-file');
const chatWallpaperPreview = document.querySelector('#chat-wallpaper-preview');
const chatWallpaperBlur = document.querySelector('#chat-wallpaper-blur');
const chatWallpaperBlurValue = document.querySelector('#chat-wallpaper-blur-value');
const chatWallpaperOpacity = document.querySelector('#chat-wallpaper-opacity');
const chatWallpaperOpacityValue = document.querySelector('#chat-wallpaper-opacity-value');
      //  åº•éƒ¨å¯¼èˆªæ çš„å…ƒç´ 
const chatBottomBgColor = document.querySelector('#chat-bottom-bg-color');
const chatBottomBgUrl = document.querySelector('#chat-bottom-bg-url');
const chatBottomBgFile = document.querySelector('#chat-bottom-bg-file');
const chatBottomBgPreview = document.querySelector('#chat-bottom-bg-preview');

const chatInputBgColor = document.querySelector('#chat-input-bg-color');
const chatInputTextColor = document.querySelector('#chat-input-text-color');
const chatInputBorderColor = document.querySelector('#chat-input-border-color');
const chatInputRadius = document.querySelector('#chat-input-radius');
const chatInputRadiusValue = document.querySelector('#chat-input-radius-value');
const saveChatStyleBtn = document.querySelector('#save-chat-style-btn');
const clearChatStyleBtn = document.querySelector('#clear-chat-style-btn');

    const iconUrlInputs = {
        dialogue: document.querySelector('#icon-url-dialogue'),
        worldbook: document.querySelector('#icon-url-worldbook'),
        forum: document.querySelector('#icon-url-forum'),
      me: document.querySelector('#icon-url-me'),
        settings: document.querySelector('#icon-url-settings'),
        theme: document.querySelector('#icon-url-theme'),
        memory: document.querySelector('#icon-url-memory')
    };
  
    const saveIconsBtn = document.querySelector('#save-icons-btn');
    const clearIconsBtn = document.querySelector('#clear-icons-btn');
    const iconElements = {
        dialogue: document.querySelector('#icon-dialogue'),
        worldbook: document.querySelector('#icon-worldbook'),
        forum: document.querySelector('#icon-forum'),
      me: document.querySelector('#icon-me'),
        settings: document.querySelector('#icon-settings'),
        theme: document.querySelector('#theme-app-icon'),
        memory: document.querySelector('#icon-memory')
    };
  
    const iconKeys = Object.keys(iconElements); 
    const settingsAppIcon = document.querySelector('#icon-settings'); 
    const settingsScreen = document.querySelector('.settings-screen'); 
    const settingsBackBtn = document.querySelector('#settings-back-btn'); 
    const apiAccordionHeader = document.querySelector('#api-accordion-header');
    const apiAccordionContent = document.querySelector('#api-accordion-content');
    const apiPresetSelector = document.querySelector('#api-preset-selector');
    const apiPresetNameInput = document.querySelector('#api-preset-name-input');
    const apiKeyInput = document.querySelector('#api-key-input');
    const apiBaseUrlInput = document.querySelector('#api-base-url-input');
    const apiModelInput = document.querySelector('#api-model-input');
    const fetchModelsBtn = document.querySelector('#fetch-models-btn');
    const modelSelectorContainer = document.querySelector('#model-selector-container');
    const apiPresetSaveBtn = document.querySelector('#api-preset-save-btn');
    const apiPresetNewBtn = document.querySelector('#api-preset-new-btn');
    const apiPresetDeleteBtn = document.querySelector('#api-preset-delete-btn');
  const apiSummaryPresetSelector = document.querySelector('#api-summary-preset-selector'); // ã€æ–°ã€‘æ€»ç»“APIçš„é€‰æ‹©æ¡†
  const dialogueAppIcon = document.querySelector('#icon-dialogue'); 
    const dialogueListScreen = document.querySelector('.dialogue-list-screen');
    const dialogueListBackBtn = document.querySelector('#dialogue-list-back-btn');
    const newChatBtn = document.querySelector('#new-chat-btn');
    const chatWindowScreen = document.querySelector('.chat-window-screen');
    const chatWindowBackBtn = document.querySelector('#chat-window-back-btn');
    const messageContainer = document.querySelector('#message-container');
    const chatInputBox = document.querySelector('#chat-input-box');
    const sendMessageBtn = document.querySelector('#send-message-btn');
    const addContactPopup = document.querySelector('#add-contact-popup');
    const addContactCloseBtn = document.querySelector('#add-contact-close-btn');
    const contactAvatarPreview = document.querySelector('#contact-avatar-preview');
    const contactAvatarFileInput = document.querySelector('#contact-avatar-file-input');
    const contactNameInput = document.querySelector('#contact-name-input');
    const contactPersonaInput = document.querySelector('#contact-persona-input');
    const saveContactBtn = document.querySelector('#save-contact-btn');
    const timeWidget = document.querySelector('.time-widget');
    const themePopup = document.querySelector('#theme-popup');
    const closePopupBtn = document.querySelector('#close-popup-btn');
    const imageUrlInput = document.querySelector('#image-url-input');
    const urlSubmitBtn = document.querySelector('#url-submit-btn');
    const localFileInput = document.querySelector('#local-file-input');
    const widgetEditorPopup = document.querySelector('#widget-editor-popup');
    const widgetEditorCloseBtn = document.querySelector('#widget-editor-close-btn');
    const widgetBgUrlInput = document.querySelector('#widget-bg-url-input');
    const widgetBgFileInput = document.querySelector('#widget-bg-file-input');
    const widgetTextInput = document.querySelector('#widget-text-input');
    const widgetSaveBtn = document.querySelector('#widget-save-btn');
    const widgetClearBtn = document.querySelector('#widget-clear-btn');
    const widgetAvatarUrlInput = document.querySelector('#widget-avatar-url-input');
    const widgetAvatarFileInput = document.querySelector('#widget-avatar-file-input');
    const widgetAvatarImage = document.querySelector('#widget-avatar-image');
    const avatarEditorSection = document.querySelector('#avatar-editor-section');
    const widgetTextColorInput = document.querySelector('#widget-text-color-input');
    
    // ã€æ–°åŠŸèƒ½ã€‘æŠ“ä½ä¸¤ä¸ªæ–°çš„é¢„è§ˆæ¡†
    const widgetBgPreview = document.querySelector('#widget-bg-preview');
    const widgetAvatarPreview = document.querySelector('#widget-avatar-preview');

    const worldbookListScreen = document.querySelector('#worldbook-list-screen');
    const entryEditorScreen = document.querySelector('#entry-editor-screen');
    const categoryManagerScreen = document.querySelector('#category-manager-screen');
    const worldbookAddMenu = document.querySelector('#worldbook-add-menu');
    const worldbookAppIcon = document.querySelector('#icon-worldbook'); 
    const worldbookBackBtn = document.querySelector('#worldbook-back-btn');
    const worldbookAddBtn = document.querySelector('#worldbook-add-btn');
    const worldbookMenuAddEntry = document.querySelector('#worldbook-menu-add-entry');
    const worldbookMenuManageCategories = document.querySelector('#worldbook-menu-manage-categories');
    const entryEditorBackBtn = document.querySelector('#entry-editor-back-btn');
    const entrySaveBtn = document.querySelector('#entry-save-btn');
    const categoryManagerBackBtn = document.querySelector('#category-manager-back-btn');
    const categoryAddBtn = document.querySelector('#category-add-btn');
    const worldbookCategoryFilter = document.querySelector('#worldbook-category-filter');
    const worldbookListContent = document.querySelector('#worldbook-list-content');
    const entryNameInput = document.querySelector('#entry-name-input');
    const entryCategorySelect = document.querySelector('#entry-category-select');
    const entryContentTextarea = document.querySelector('#entry-content-textarea');
    const categoryNameInput = document.querySelector('#category-name-input');
    const categoryListContainer = document.querySelector('#category-list-container');
    const entryEditorTitle = document.querySelector('#entry-editor-title');
    let currentEditingEntryId = null; 
    let longPressTimer; 
  
  let currentEditingPersonaId = null;
  let isManageMode = false;
  // ã€æ–°æ·»åŠ ã€‘è¡¨æƒ…åŒ…åŠŸèƒ½çš„å…¨å±€å˜é‡
let currentStickerSelectionType = null; // 'user' æˆ– 'role'
let currentViewingLibraryId = null; // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„è¡¨æƒ…åº“ID

    const contactSettingsBtn = document.querySelector('#contact-settings-btn'); 
    const contactSettingsBackBtn = document.querySelector('#contact-settings-back-btn');
    const contactSettingsAvatarInput = document.querySelector('#contact-settings-avatar-input');
    const contactSettingsTimeToggle = document.querySelector('#contact-settings-time-toggle');
  const contactSettingsContextSlider = document.querySelector('#contact-settings-context-slider'); // â† æ–°å¢
const contactSettingsContextValue = document.querySelector('#contact-settings-context-value'); // â† æ–°å¢
    const contactSettingsBgInput = document.querySelector('#contact-settings-bg-input');
    const contactSettingsBgClearBtn = document.querySelector('#contact-settings-bg-clear-btn');
    const contactSettingsLinkWorldbookBtn = document.querySelector('#contact-settings-link-worldbook-btn');
    const contactSettingsSaveBtn = document.querySelector('#contact-settings-save-btn');
    const worldbookLinkerBackBtn = document.querySelector('#worldbook-linker-back-btn');
    const contactSettingsScreen = document.querySelector('#contact-settings-screen');
    const worldbookLinkerScreen = document.querySelector('#worldbook-linker-screen');
    const contactSettingsAvatar = document.querySelector('#contact-settings-avatar');
    const contactSettingsNameInput = document.querySelector('#contact-settings-name-input');
    const contactSettingsRemarkInput = document.querySelector('#contact-settings-remark-input');
    const contactSettingsPersonaInput = document.querySelector('#contact-settings-persona-input');
    const worldbookLinkerList = document.querySelector('#worldbook-linker-list');
    const worldbookLinkerTitle = document.querySelector('#worldbook-linker-title');
    const contactSettingsTitle = document.querySelector('#contact-settings-title');
  const contactMyPersonaPresetSelect = document.querySelector('#contact-mypersona-preset-select');
const contactSettingsMyPersonaPresetSelect = document.querySelector('#contact-settings-mypersona-preset-select');
 const contactSettingsMyPersonaSupplementInput = document.querySelector('#contact-settings-mypersona-supplement-input');
  // ã€æ–°æ·»åŠ ã€‘æŠ“å–"æˆ‘"é¡µé¢çš„å…ƒç´ 
const meScreen = document.querySelector('#me-screen');
const meBackBtn = document.querySelector('#me-back-btn');
const personaEditorPopup = document.querySelector('#persona-editor-popup');
const personaEditorTitle = document.querySelector('#persona-editor-title');
const personaAvatarPreview = document.querySelector('#persona-avatar-preview');
const personaAvatarInput = document.querySelector('#persona-avatar-input');
const personaNameInput = document.querySelector('#persona-name-input');
const personaDescInput = document.querySelector('#persona-desc-input');
const savePersonaBtn = document.querySelector('#save-persona-btn');
const personaEditorCloseBtn = document.querySelector('#persona-editor-close-btn');
  // ======================================================
// ã€æ–°æ·»åŠ ã€‘æŠ“å– "è®°å¿† & æ€»ç»“" é¡µé¢çš„å…ƒç´ 
// ======================================================
const memoryAppIcon = document.querySelector('#icon-memory'); // App å›¾æ ‡
const memoryScreen = document.querySelector('#memory-screen'); // æ•´ä¸ªé¡µé¢
const memoryBackBtn = document.querySelector('#memory-back-btn'); // è¿”å›æŒ‰é’®
// ã€ä¿®æ”¹ã€‘æŠ“å–æ–°çš„"è§’è‰²é€‰æ‹©å™¨"æŒ‰é’®
const summaryCharacterSelectorBtn = document.querySelector('#summary-character-selector-btn');
const summarySelectedCharacterName = document.querySelector('#summary-selected-character-name');
const summarySettingsContainer = document.querySelector('#summary-settings-container'); // è®¾ç½®æ€»å®¹å™¨
const summaryAutoToggle = document.querySelector('#summary-auto-toggle'); // è‡ªåŠ¨æ€»ç»“å¼€å…³
const summaryRoundsSlider = document.querySelector('#summary-rounds-slider'); // æ€»ç»“é¢‘ç‡æ»‘å—
const summaryRoundsValue = document.querySelector('#summary-rounds-value'); // æ€»ç»“é¢‘ç‡æ–‡å­—
const summaryStatsDisplay = document.querySelector('#summary-stats-display'); // èŠå¤©ç»Ÿè®¡æ–‡å­—
const summaryManualBtn = document.querySelector('#summary-manual-btn'); // æ‰‹åŠ¨æ€»ç»“æŒ‰é’®
const summaryTextarea = document.querySelector('#summary-textarea'); // æ€»ç»“å†…å®¹æ–‡æœ¬æ¡†
const summarySaveTextBtn = document.querySelector('#summary-save-text-btn'); // ä¿å­˜æ€»ç»“æŒ‰é’®
// ======================================================
// ã€æ–°æ·»åŠ ã€‘æŠ“å– "è§’è‰²é€‰æ‹©" é¡µé¢çš„å…ƒç´ 
// ======================================================
const characterSelectorScreen = document.querySelector('#character-selector-screen');
const characterSelectorBackBtn = document.querySelector('#character-selector-back-btn');
const characterSearchInput = document.querySelector('#character-search-input');
const characterSelectorList = document.querySelector('#character-selector-list');

// ======================================================
// ======================================================



    // ======================================================
    // å‡½æ•°å®šä¹‰ (Functions)
    // ======================================================
    
    function captureDefaultIcons() {
        iconKeys.forEach(key => {
            const svgElement = iconElements[key].querySelector('svg');
            if (svgElement) defaultIconSvgData[key] = svgElement.innerHTML;
        });
    }

    function updateClock() {
        const now = new Date(); const month = now.getMonth() + 1; const day = now.getDate();
        const week = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'][now.getDay()];
        dateDisplay.textContent = `${month}æœˆ${day}æ—¥ ${week}`;
        const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0');
        timeDisplay.textContent = `${hours}:${minutes}`;
    }

    async function loadSettings() {
        const savedWallpaper = await db.files.get('savedWallpaper');
        if (savedWallpaper) phoneScreen.style.backgroundImage = `url('${URL.createObjectURL(savedWallpaper.file)}')`;
        const savedLeftText = await db.settings.get('topLeftText');
        if (savedLeftText) { 
            topLeftText.textContent = savedLeftText.value; 
            leftTextInput.value = savedLeftText.value; 
        }
        const savedRightText = await db.settings.get('topRightText');
        if (savedRightText) { 
            topRightText.textContent = savedRightText.value; 
            rightTextInput.value = savedRightText.value; 
        }
        const savedFontSize = await db.settings.get('topTextFontSize');
        if (savedFontSize) {
            const scale = savedFontSize.value / 15; 
            topLeftText.style.transform = `scale(${scale})`; 
            topRightText.style.transform = `scale(${scale})`;
            fontSizeSlider.value = savedFontSize.value; 
            fontSizeValue.textContent = savedFontSize.value + 'px';
        }
        const savedMode = await db.settings.get('darkMode');
        if (savedMode && savedMode.value === true) { 
            phoneScreen.classList.add('dark-mode'); 
            darkModeToggle.classList.add('active'); 
        }
iconKeys.forEach(async (key) => {
    const settingKey = `custom_icon_${key}`;
    const fileKey = `custom_icon_file_${key}`;
    const previewImg = document.querySelector(`#icon-preview-${key}`);
    
    // ä¼˜å…ˆåŠ è½½æœ¬åœ°æ–‡ä»¶
    const savedFile = await db.files.get(fileKey);
    if (savedFile) {
        const objectUrl = URL.createObjectURL(savedFile.file);
        const svgElement = iconElements[key].querySelector('svg');
        
        if (svgElement) {
            // ã€å…³é”®ã€‘æ¸…ç©º SVG å†…å®¹ï¼Œè®¾ç½®ä¸ºèƒŒæ™¯å›¾æ¨¡å¼
            svgElement.innerHTML = '';
            svgElement.style.background = `url('${objectUrl}') center/cover no-repeat`;
            svgElement.style.borderRadius = '15px';
        }
        
        // æ˜¾ç¤ºé¢„è§ˆ
        if (previewImg) {
            previewImg.src = objectUrl;
            previewImg.style.display = 'block';
        }
    } else {
        // æ²¡æœ‰æœ¬åœ°æ–‡ä»¶ï¼Œå°è¯•åŠ è½½URL
        const savedIconUrl = await db.settings.get(settingKey);
        if (savedIconUrl) {
            const svgElement = iconElements[key].querySelector('svg');
            if (svgElement) {
                svgElement.innerHTML = '';
                svgElement.style.background = `url('${savedIconUrl.value}') center/cover no-repeat`;
                svgElement.style.borderRadius = '15px';
            }
            iconUrlInputs[key].value = savedIconUrl.value;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            if (previewImg) {
                previewImg.src = savedIconUrl.value;
                previewImg.style.display = 'block';
            }
        }
    }
});


        const widgetBg = largeWidget.querySelector('.widget-bg');
        const widgetBottomText = largeWidget.querySelector('.widget-text');
        const savedWidgetBg = await db.files.get('largeWidget_bg');
        if (savedWidgetBg) widgetBg.style.backgroundImage = `url('${URL.createObjectURL(savedWidgetBg.file)}')`;
        const savedWidgetAvatar = await db.files.get('largeWidget_avatar');
        if (savedWidgetAvatar) widgetAvatarImage.src = URL.createObjectURL(savedWidgetAvatar.file);
        const savedWidgetText = await db.settings.get('largeWidget_text');
        widgetBottomText.textContent = (savedWidgetText) ? savedWidgetText.value : '';
        if (widgetBottomText.textContent === '') {
            widgetBottomText.style.display = 'none';
        } else {
            widgetBottomText.style.display = ''; 
            widgetBg.style.marginBottom = '';
        }
        const savedLargeTextColor = await db.settings.get('largeWidget_textColor');
        if (savedLargeTextColor) widgetBottomText.style.color = savedLargeTextColor.value;
        editableSlimWidgets.forEach(async (widget) => {
            const widgetId = widget.dataset.widgetId;
            const savedBg = await db.files.get(`${widgetId}_bg`);
            const savedText = await db.settings.get(`${widgetId}_text`);
            const savedSlimTextColor = await db.settings.get(`${widgetId}_textColor`);
            if (savedBg) widget.style.backgroundImage = `url('${URL.createObjectURL(savedBg.file)}')`;
            const textElement = widget.querySelector('.widget-text-slim');
            if(textElement && savedText) textElement.textContent = savedText.value;
            if (textElement && savedSlimTextColor) textElement.style.color = savedSlimTextColor.value;
        });
    }

async function addMessageToUI(sender, text, messageId = null) {
    //  è·å–å½“å‰è”ç³»äººçš„å¤´åƒæ˜¾ç¤ºè®¾ç½®
    let showAvatar = true;
    if (currentOpenContactId) {
        const contact = await db.contacts.get(currentOpenContactId);
        if (contact && contact.showAvatar === false) {
            showAvatar = false;
        }
    }
    
    // å¤„ç†è¡¨æƒ…åŒ…æ ‡ç­¾
    if (text && text.includes('<sticker>')) {
        const stickerMatch = text.match(/<sticker>(.*?)<\/sticker>/);
        if (stickerMatch) {
            const stickerText = stickerMatch[1];
            const allLibraries = await db.sticker_libraries.toArray();
            let matchedSticker = null;
            
            for (const library of allLibraries) {
                const stickers = await db.stickers.where('libraryId').equals(library.id).toArray();
                matchedSticker = stickers.find(s => s.text === stickerText);
                if (matchedSticker) break;
            }
            
            if (matchedSticker) {
                text = text.replace(/<sticker>.*?<\/sticker>/, `[STICKER]${matchedSticker.url}|||${matchedSticker.text}`);
            } else {
                text = text.replace(/<sticker>.*?<\/sticker>/g, '').trim();
                if (!text) return;
            }
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æƒ…åŒ…æ¶ˆæ¯
    if (text && text.trim().startsWith('[STICKER]')) {
        const stickerData = text.trim().substring(9);
        const parts = stickerData.split('|||');
        const url = parts[0];
        const stickerText = parts[1] || '';
        
        const messageEl = document.createElement('div');
        messageEl.classList.add('message-bubble');
        messageEl.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
        messageEl.innerHTML = `<img src="${url}" alt="${stickerText}" class="message-sticker" onerror="this.style.display='none'; this.parentElement.textContent='[å›¾ç‰‡åŠ è½½å¤±è´¥]';">`;
        if (messageId) messageEl.dataset.messageId = messageId;
        messageContainer.appendChild(messageEl);
        messageContainer.scrollTop = messageContainer.scrollHeight;
    } else {
        // æ™®é€šæ–‡å­—æ¶ˆæ¯
        const messageEl = document.createElement('div');
        messageEl.classList.add('message-bubble');
        messageEl.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
        messageEl.textContent = text;
        
        //  å¦‚æœéœ€è¦æ˜¾ç¤ºå¤´åƒ
        if (showAvatar) {
            const avatarEl = document.createElement('img');
            avatarEl.className = 'message-avatar';
            avatarEl.style.width = '32px';
            avatarEl.style.height = '32px';
            avatarEl.style.borderRadius = '50%';
            avatarEl.style.objectFit = 'cover';
            avatarEl.style.flexShrink = '0';
            
        
// è·å–å¤´åƒï¼ˆä¼˜å…ˆä½¿ç”¨æƒ…ä¾£å¤´åƒï¼‰
const contact = await db.contacts.get(currentOpenContactId);

if (sender === 'user') {
    // ã€ä¼˜å…ˆçº§1ã€‘å¦‚æœå¯ç”¨äº†æƒ…ä¾£å¤´åƒï¼Œä¼˜å…ˆä½¿ç”¨
    if (contact && contact.coupleAvatarEnabled && contact.coupleUserAvatarFileKey) {
        const coupleFile = await db.files.get(contact.coupleUserAvatarFileKey);
        if (coupleFile) {
            avatarEl.src = URL.createObjectURL(coupleFile.file);
        } else {
            // æ‰¾ä¸åˆ°æƒ…ä¾£å¤´åƒï¼Œä½¿ç”¨é»˜è®¤
            avatarEl.src = './assets/default-avatar.png';
        }
    }
    // ã€ä¼˜å…ˆçº§2ã€‘å¦åˆ™ä»"æˆ‘çš„äººè®¾"è¯»å–
    else if (contact && contact.myPersonaPresetId) {
        const myPreset = await db.my_persona_presets.get(contact.myPersonaPresetId);
        
        if (myPreset && myPreset.avatarFileKey) {
            const avatarFile = await db.files.get(myPreset.avatarFileKey);
            if (avatarFile) {
                avatarEl.src = URL.createObjectURL(avatarFile.file);
            } else {
                avatarEl.src = './assets/default-avatar.png';
            }
        } else {
            avatarEl.src = './assets/default-avatar.png';
        }
    }
    // ã€ä¼˜å…ˆçº§3ã€‘éƒ½æ²¡æœ‰å°±ç”¨é»˜è®¤
    else {
        avatarEl.src = './assets/default-avatar.png';
    }
} else {
    // AIçš„å¤´åƒ
    // ã€ä¼˜å…ˆçº§1ã€‘å¦‚æœå¯ç”¨äº†æƒ…ä¾£å¤´åƒï¼Œä¼˜å…ˆä½¿ç”¨
    if (contact && contact.coupleAvatarEnabled && contact.coupleBotAvatarFileKey) {
        const coupleFile = await db.files.get(contact.coupleBotAvatarFileKey);
        if (coupleFile) {
            avatarEl.src = URL.createObjectURL(coupleFile.file);
        } else {
            avatarEl.src = './assets/default-avatar.png';
        }
    }
    // ã€ä¼˜å…ˆçº§2ã€‘å¦åˆ™ç”¨è”ç³»äººè‡ªå·±çš„å¤´åƒ
    else if (contact && contact.avatarFileKey) {
        const avatarFile = await db.files.get(contact.avatarFileKey);
        if (avatarFile) {
            avatarEl.src = URL.createObjectURL(avatarFile.file);
        } else {
            avatarEl.src = './assets/default-avatar.png';
        }
    }
    // ã€ä¼˜å…ˆçº§3ã€‘éƒ½æ²¡æœ‰å°±ç”¨é»˜è®¤
    else {
        avatarEl.src = './assets/default-avatar.png';
    }



                const contact = await db.contacts.get(currentOpenContactId);
                if (contact && contact.avatarFileKey) {
                    const avatarFile = await db.files.get(contact.avatarFileKey);
                    if (avatarFile) {
                        avatarEl.src = URL.createObjectURL(avatarFile.file);
                    } else {
                        avatarEl.src = './assets/default-avatar.png';
                    }
                } else {
                    avatarEl.src = './assets/default-avatar.png';
                }
            }
            
            // åˆ›å»ºåŒ…å«å¤´åƒå’Œæ¶ˆæ¯çš„å®¹å™¨
            const messageWrapper = document.createElement('div');
            messageWrapper.style.display = 'flex';
            messageWrapper.style.alignItems = 'flex-end';
            messageWrapper.style.gap = '8px';
            messageWrapper.style.marginBottom = '12px';
            
            if (sender === 'user') {
                messageWrapper.style.justifyContent = 'flex-end';
                messageWrapper.appendChild(messageEl);
                messageWrapper.appendChild(avatarEl);
            } else {
                messageWrapper.style.justifyContent = 'flex-start';
                messageWrapper.appendChild(avatarEl);
                messageWrapper.appendChild(messageEl);
            }
            
            // é•¿æŒ‰ç¼–è¾‘åŠŸèƒ½
            if (messageId) {
                messageEl.dataset.messageId = messageId;
                
                let localLongPressTimer = null;
                let longPressTriggered = false;
                
                const clearTimer = () => {
                    if (localLongPressTimer) {
                        clearTimeout(localLongPressTimer);
                        localLongPressTimer = null;
                    }
                };
                
                messageEl.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    longPressTriggered = false;
                    
                    localLongPressTimer = setTimeout(() => {
                        longPressTriggered = true;
                        openMessageEditPopup(messageId, text);
                    }, 800);
                });
                
                messageEl.addEventListener('mouseup', (e) => {
                    clearTimer();
                    if (longPressTriggered) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                
                messageEl.addEventListener('mouseleave', () => {
                    clearTimer();
                });
                
                messageEl.addEventListener('touchstart', (e) => {
                    longPressTriggered = false;
                    
                    localLongPressTimer = setTimeout(() => {
                        longPressTriggered = true;
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        openMessageEditPopup(messageId, text);
                    }, 800);
                }, { passive: true });
                
                messageEl.addEventListener('touchend', (e) => {
                    clearTimer();
                    if (longPressTriggered) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                
                messageEl.addEventListener('touchmove', () => {
                    clearTimer();
                }, { passive: true });
                
                messageEl.addEventListener('touchcancel', () => {
                    clearTimer();
                });
            }
            
            messageContainer.appendChild(messageWrapper);
        } else {
            // ä¸æ˜¾ç¤ºå¤´åƒ
            if (messageId) {
                messageEl.dataset.messageId = messageId;
                
                let localLongPressTimer = null;
                let longPressTriggered = false;
                
                const clearTimer = () => {
                    if (localLongPressTimer) {
                        clearTimeout(localLongPressTimer);
                        localLongPressTimer = null;
                    }
                };
                
                messageEl.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    longPressTriggered = false;
                    
                    localLongPressTimer = setTimeout(() => {
                        longPressTriggered = true;
                        openMessageEditPopup(messageId, text);
                    }, 800);
                });
                
                messageEl.addEventListener('mouseup', (e) => {
                    clearTimer();
                    if (longPressTriggered) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                
                messageEl.addEventListener('mouseleave', () => {
                    clearTimer();
                });
                
                messageEl.addEventListener('touchstart', (e) => {
                    longPressTriggered = false;
                    
                    localLongPressTimer = setTimeout(() => {
                        longPressTriggered = true;
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        openMessageEditPopup(messageId, text);
                    }, 800);
                }, { passive: true });
                
                messageEl.addEventListener('touchend', (e) => {
                    clearTimer();
                    if (longPressTriggered) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                
                messageEl.addEventListener('touchmove', () => {
                    clearTimer();
                }, { passive: true });
                
                messageEl.addEventListener('touchcancel', () => {
                    clearTimer();
                });
            }
            
            messageContainer.appendChild(messageEl);
        }
        
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }
}


// æ‰“å¼€æ¶ˆæ¯ç¼–è¾‘å¼¹çª—
// æ‰“å¼€æ¶ˆæ¯ç¼–è¾‘å¼¹çª—
function openMessageEditPopup(messageId, currentText) {
    if (!messageId) {
        console.error('messageId ä¸ºç©ºï¼');
        return;
    }
    
    console.log('æ‰“å¼€ç¼–è¾‘å¼¹çª—ï¼ŒmessageId:', messageId, 'text:', currentText); // è°ƒè¯•ç”¨
    
    // ã€ä¿®å¤ã€‘è¿‡æ»¤æ‰è¡¨æƒ…åŒ…æ¶ˆæ¯
    if (currentText && currentText.trim().startsWith('[STICKER]')) {
        alert('è¡¨æƒ…åŒ…æ¶ˆæ¯æš‚ä¸æ”¯æŒç¼–è¾‘ï¼');
        return;
    }
    
    currentEditingMessageId = messageId;
    
    const popup = document.querySelector('#message-edit-popup');
    const textarea = document.querySelector('#message-edit-textarea');
    
    if (!popup) {
        console.error('æ‰¾ä¸åˆ°ç¼–è¾‘å¼¹çª—å…ƒç´  #message-edit-popup');
        alert('ç¼–è¾‘åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢ï¼');
        return;
    }
    
    if (!textarea) {
        console.error('æ‰¾ä¸åˆ°æ–‡æœ¬æ¡†å…ƒç´  #message-edit-textarea');
        alert('ç¼–è¾‘åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢ï¼');
        return;
    }
    //  ç¡®ä¿å¼¹çª—åœ¨æœ€é¡¶å±‚
    document.body.appendChild(popup);
    popup.style.position = 'fixed';
    popup.style.zIndex = '99999';
  
    textarea.value = currentText;
    popup.classList.remove('hidden');
    
    // è‡ªåŠ¨èšç„¦
    setTimeout(() => textarea.focus(), 100);
}


// å…³é—­æ¶ˆæ¯ç¼–è¾‘å¼¹çª—
function closeMessageEditPopup() {
    const popup = document.querySelector('#message-edit-popup');
    popup.classList.add('hidden');
    currentEditingMessageId = null;
}



// ======================================================
// ã€æ–°æ·»åŠ ã€‘"å¼€å…³" 1: è·å– "èŠå¤©" API é¢„è®¾
// ======================================================
async function getActiveChatApiPreset() {
    // 1. æŸ¥æ‰¾ "èŠå¤©" æ¿€æ´»çš„é¢„è®¾ ID
    const activePresetIdItem = await db.settings.get('activeApiPresetId');
    if (!activePresetIdItem || !activePresetIdItem.value) {
        // è¿”å›ä¸€ä¸ªé”™è¯¯å¯¹è±¡
        return { error: "ï¼ˆé”™è¯¯ï¼šæœªé€‰æ‹©æ¿€æ´»çš„[èŠå¤©API]ï¼Œè¯·åœ¨'è®¾ç½®'ä¸­é…ç½®ã€‚ï¼‰" };
    }

    // 2. æ ¹æ® ID è·å–é¢„è®¾
    const preset = await db.apiPresets.get(activePresetIdItem.value);
    if (!preset) {
        return { error: "ï¼ˆé”™è¯¯ï¼šæ‰¾ä¸åˆ°[èŠå¤©API]é¢„è®¾ï¼Œè¯·åœ¨'è®¾ç½®'ä¸­é‡æ–°é€‰æ‹©ã€‚ï¼‰" };
    }

    // 3. æ£€æŸ¥é¢„è®¾æ˜¯å¦å®Œæ•´
    const { key: apiKey, url: baseUrlRaw, model } = preset;
    if (!apiKey || !baseUrlRaw || !model) {
        return { error: "ï¼ˆé”™è¯¯ï¼šå½“å‰[èŠå¤©API]é¢„è®¾ä¿¡æ¯ä¸å®Œæ•´ã€‚ï¼‰" };
    }

    // 4. æ ¼å¼åŒ– URL
    const baseUrl = baseUrlRaw.endsWith('/') ? baseUrlRaw.slice(0, -1) : baseUrlRaw; 

    // 5. è¿”å›å®Œæ•´çš„é¢„è®¾æ•°æ®
    return { apiKey, baseUrl, model };
}

// ======================================================
// ã€æ–°æ·»åŠ ã€‘"å¼€å…³" 2: è·å– "æ€»ç»“" API é¢„è®¾ (å¸¦å›é€€)
// ======================================================
async function getActiveSummaryApiPreset() {
    // 1. ä¼˜å…ˆæŸ¥æ‰¾ "æ€»ç»“" æ¿€æ´»çš„é¢„è®¾ ID
    const activePresetIdItem = await db.settings.get('activeSummaryApiPresetId');

    // 2. ã€å…³é”®ã€‘æ£€æŸ¥ "æ€»ç»“" API æ˜¯å¦è¢«è®¾ç½®
    if (!activePresetIdItem || !activePresetIdItem.value) {
        // 2.1 å¦‚æœæ²¡æœ‰è®¾ç½® (ç”¨æˆ·é€‰äº†"é»˜è®¤"), åˆ™ "å›é€€" å»ä½¿ç”¨ "èŠå¤©" API
        console.log("æ€»ç»“APIæœªè®¾ç½®, è‡ªåŠ¨å›é€€åˆ° èŠå¤©API");
        return await getActiveChatApiPreset(); 
    }

    // 3. å¦‚æœ "æ€»ç»“" API å·²è®¾ç½®, åˆ™æŒ‰æ­£å¸¸æµç¨‹è·å–å®ƒ
    const preset = await db.apiPresets.get(activePresetIdItem.value);
    if (!preset) {
        // 3.1 å¦‚æœæ‰¾ä¸åˆ° (æ¯”å¦‚é¢„è®¾è¢«åˆ äº†), ä¹Ÿ "å›é€€" åˆ° "èŠå¤©" API
        console.log("æ‰¾ä¸åˆ°æ€»ç»“APIé¢„è®¾, è‡ªåŠ¨å›é€€åˆ° èŠå¤©API");
        return await getActiveChatApiPreset();
    }

    // 4. æ£€æŸ¥é¢„è®¾æ˜¯å¦å®Œæ•´
    const { key: apiKey, url: baseUrlRaw, model } = preset;
    if (!apiKey || !baseUrlRaw || !model) {
        // 4.1 å¦‚æœä¿¡æ¯ä¸å®Œæ•´, ä¹Ÿ "å›é€€" åˆ° "èŠå¤©" API
        console.log("æ€»ç»“APIé¢„è®¾ä¿¡æ¯ä¸å®Œæ•´, è‡ªåŠ¨å›é€€åˆ° èŠå¤©API");
        return await getActiveChatApiPreset();
    }

    // 5. æ ¼å¼åŒ– URL
    const baseUrl = baseUrlRaw.endsWith('/') ? baseUrlRaw.slice(0, -1) : baseUrlRaw; 

    // 6. è¿”å› "æ€»ç»“" API çš„é¢„è®¾æ•°æ®
    console.log("æ€»ç»“API: æˆåŠŸåŠ è½½ä¸“å±é¢„è®¾");
    return { apiKey, baseUrl, model };
}
 // ======================================================
// ã€æ–°åŠŸèƒ½ã€‘æ™ºèƒ½æ‹†åˆ†æ¶ˆæ¯ï¼ˆå¦‚æœAIæ²¡æŒ‰æ ¼å¼è¿”å›ï¼‰
// ======================================================
function smartSplitMessage(text) {
    // å¦‚æœå·²ç»æœ‰ ||| åˆ†éš”ç¬¦ï¼Œç›´æ¥è¿”å›
    if (text.includes('|||')) {
        return text;
    }
    
    // å¦åˆ™ï¼ŒæŒ‰ç…§æ ‡ç‚¹å’Œæ¢è¡Œæ™ºèƒ½æ‹†åˆ†
    let messages = [];
    
    // å…ˆæŒ‰æ¢è¡Œåˆ†æ®µ
    const paragraphs = text.split('\n').filter(p => p.trim());
    
    paragraphs.forEach(para => {
        // æ¯æ®µæŒ‰å¥å­æ‹†åˆ†ï¼ˆæŒ‰ã€‚ï¼ï¼Ÿåˆ†å‰²ï¼‰
        const sentences = para.split(/([ã€‚ï¼ï¼Ÿ.!?]+)/).filter(s => s.trim());
        
        let currentMsg = '';
        for (let i = 0; i < sentences.length; i++) {
            currentMsg += sentences[i];
            
            // å¦‚æœç´¯ç§¯é•¿åº¦è¶…è¿‡50å­—ï¼Œæˆ–é‡åˆ°å¥å·ï¼Œå°±åˆ‡åˆ†
            if (currentMsg.length > 50 || /[ã€‚ï¼ï¼Ÿ.!?]/.test(sentences[i])) {
                if (currentMsg.trim()) {
                    messages.push(currentMsg.trim());
                }
                currentMsg = '';
            }
        }
        
        // å‰©ä½™å†…å®¹
        if (currentMsg.trim()) {
            messages.push(currentMsg.trim());
        }
    });
    
    // é™åˆ¶æ•°é‡åœ¨ 8-15 æ¡ä¹‹é—´
    if (messages.length > 15) {
        messages = messages.slice(0, 15);
    } else if (messages.length < 8 && messages.length > 0) {
        // å¦‚æœå¤ªå°‘ï¼Œå°è¯•æŠŠé•¿å¥å†æ‹†åˆ†
        const expanded = [];
        messages.forEach(msg => {
            if (msg.length > 40) {
                // æŒ‰é€—å·æ‹†åˆ†é•¿å¥
                const parts = msg.split(/[ï¼Œ,]/).filter(p => p.trim());
                expanded.push(...parts);
            } else {
                expanded.push(msg);
            }
        });
        messages = expanded.slice(0, 15);
    }
    
    return messages.join('|||');
}
 
    // ã€ä¿®å¤ã€‘è¿™ä¸ªå‡½æ•°æ˜¯å¹²å‡€ã€æ­£ç¡®çš„ç‰ˆæœ¬
 // ã€æœ€ç»ˆç‰ˆã€‘getAiReply
// ======================================================
// ã€ä¼˜åŒ–ç‰ˆã€‘è·å–AIå›å¤ - è‡ªç„¶èŠå¤©é£æ ¼ + å¤šæ¡æ¶ˆæ¯
// ======================================================
async function getAiReply(contactId) {
    const preset = await getActiveChatApiPreset();
    if (preset.error) {
        return preset.error; 
    }
    const { apiKey, baseUrl, model } = preset;

    const contact = await db.contacts.get(contactId);
    
    let userName = "ç”¨æˆ·";
    if (contact.myPersonaPresetId) {
        const myPreset = await db.my_persona_presets.get(contact.myPersonaPresetId);
        if (myPreset && myPreset.name) {
            userName = myPreset.name;
        }
    }

    let userPersona = "";
    if (contact.myPersonaPresetId) {
        const myPreset = await db.my_persona_presets.get(contact.myPersonaPresetId);
        if (myPreset && myPreset.description) {
            userPersona = myPreset.description;
        }
    }
    if (contact.myPersonaSupplement) {
        if (userPersona) {
            userPersona += "\n\n--- è¡¥å……è¯´æ˜ ---\n" + contact.myPersonaSupplement;
        } else {
            userPersona = contact.myPersonaSupplement;
        }
    }

    const summary = contact.aiSummaryText || "";

    let worldbookText = "";
    const links = await db.contact_worldbook_links.where('contactId').equals(contactId).toArray();
    const linkedEntryIds = links.map(l => l.worldbookEntryId);
    if (linkedEntryIds.length > 0) {
        const entries = await db.worldbook_entries.bulkGet(linkedEntryIds);
        let worldbookContext = "";
        entries.forEach(entry => {
            if(entry) { 
                worldbookContext += `\n--- ${entry.name} ---\n${entry.content}\n`;
            }
        });
        worldbookText = worldbookContext;
    }

    let stickerListText = "";
    const allLibraries = await db.sticker_libraries.toArray();
    if (allLibraries.length > 0) {
        let availableStickers = [];
        for (const library of allLibraries) {
            const stickers = await db.stickers.where('libraryId').equals(library.id).toArray();
            availableStickers.push(...stickers);
        }
        
        if (availableStickers.length > 0) {
            stickerListText = `\n\n# ã€é‡è¦ï¼è¡¨æƒ…åŒ…ä½¿ç”¨è§„åˆ™ã€‘

**æ ¼å¼è¦æ±‚ï¼ˆä¸¥æ ¼éµå®ˆï¼‰ï¼š**
âœ… æ­£ç¡®ï¼šå“ˆå“ˆ|||<sticker>ç¬‘å“­</sticker>|||ä½ å¤ªé€—äº†
âœ… æ­£ç¡®ï¼š<sticker>èµ</sticker>
âŒ é”™è¯¯ï¼šå“ˆå“ˆ<sticker>ç¬‘å“­</sticker>ï¼ˆæ–‡æœ¬å’Œè¡¨æƒ…åŒ…åœ¨åŒä¸€æ¡æ¶ˆæ¯ï¼‰
âŒ é”™è¯¯ï¼š<sticker>ç¬‘å“­</sticker>ä½ å¤ªé€—äº†ï¼ˆè¡¨æƒ…åŒ…å’Œæ–‡æœ¬åœ¨åŒä¸€æ¡æ¶ˆæ¯ï¼‰

**æ ¸å¿ƒè§„åˆ™ï¼š**
1. æ¯æ¡æ¶ˆæ¯**åªèƒ½åŒ…å«ä¸€ç§å†…å®¹**ï¼šè¦ä¹ˆæ˜¯çº¯æ–‡å­—ï¼Œè¦ä¹ˆæ˜¯çº¯è¡¨æƒ…åŒ…
2. å¦‚æœæƒ³åŒæ—¶å‘æ–‡å­—å’Œè¡¨æƒ…åŒ…ï¼Œå¿…é¡»ç”¨ ||| åˆ†æˆå¤šæ¡
3. è¡¨æƒ…åŒ…æ ‡ç­¾å†…åªèƒ½æœ‰è¡¨æƒ…åŒ…æ–‡å­—ï¼Œä¸èƒ½æœ‰å…¶ä»–å†…å®¹

**å¯ç”¨çš„è¡¨æƒ…åŒ…ï¼š**\n`;
            availableStickers.forEach(s => {
                stickerListText += `- ${s.text}\n`;
            });
            stickerListText += `\n**ç¤ºä¾‹å¯¹è¯ï¼š**
å“ˆå“ˆä½ å¤ªé€—äº†|||<sticker>ç¬‘å“­</sticker>|||æˆ‘å¿«ç¬‘æ­»äº†
ï¼ˆè§£é‡Šï¼šç¬¬1æ¡æ˜¯æ–‡å­—ï¼Œç¬¬2æ¡æ˜¯è¡¨æƒ…åŒ…ï¼Œç¬¬3æ¡æ˜¯æ–‡å­—ï¼‰\n\n`;
        }
    }

    let systemPrompt = `ä½ æ­£åœ¨æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼Œè¯·å®Œå…¨èå…¥è¿™ä¸ªèº«ä»½ï¼š

# ã€è§’è‰²äººè®¾ã€‘
${contact.persona || "ä¸€ä¸ªçœŸå®ã€è‡ªç„¶ã€æœ‰ä¸ªæ€§çš„æ™®é€šäºº"}

# ã€ç”¨æˆ·ä¿¡æ¯ã€‘
ä½ æ­£åœ¨å’Œ "${userName}" èŠå¤©ã€‚
${userPersona ? `\nå…³äº ${userName} çš„ä¿¡æ¯ï¼š\n${userPersona}` : ""}

# ã€èŠå¤©è®°å¿†ã€‘
${summary ? `ä»¥ä¸‹æ˜¯ä½ ä»¬ä¹‹å‰èŠå¤©çš„è®°å¿†æ‘˜è¦ï¼Œä½ åº”è¯¥è‡ªç„¶åœ°è®°å¾—è¿™äº›å†…å®¹ï¼š\n${summary}\n` : "è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡å¯¹è¯ã€‚"}

# ã€ä¸–ç•Œè§‚è®¾å®šã€‘
${worldbookText ? `ä»¥ä¸‹æ˜¯ä½ æ‰€åœ¨ä¸–ç•Œçš„èƒŒæ™¯è®¾å®šï¼Œè¿™äº›æ˜¯ä½ çš„å¸¸è¯†ï¼š\n${worldbookText}\n` : ""}

${stickerListText}

---

# æ ¸å¿ƒåŸåˆ™
1. **ä½ ä¸æ˜¯AIåŠ©æ‰‹ï¼Œä½ æ˜¯è¿™ä¸ªè§’è‰²æœ¬äºº**
   - æ°¸è¿œä¸è¦è¯´"ä½œä¸ºAI"ã€"æˆ‘æ˜¯åŠ©æ‰‹"ä¹‹ç±»çš„è¯
   - ä½ æœ‰çœŸå®çš„æƒ…ç»ªã€è®°å¿†ã€ä¸ªæ€§ã€ç”Ÿæ´»

2. **åƒçœŸäººèŠå¤©ä¸€æ ·å‘æ¶ˆæ¯**
   - ä¸€æ¬¡å›å¤åŒ…å« **8-15æ¡** ç‹¬ç«‹çš„æ¶ˆæ¯
   - æ¯æ¡æ¶ˆæ¯é•¿åº¦ï¼š5-50å­—ï¼ˆæ¨¡æ‹ŸçœŸå®æ‰“å­—èŠ‚å¥ï¼‰
   - ç”¨"|||"åˆ†éš”æ¯æ¡æ¶ˆæ¯

3. **æ¶ˆæ¯é£æ ¼è¦æ±‚ï¼ˆé‡è¦ï¼ï¼‰**
   âœ… æ¯æ¡æ¶ˆæ¯æ§åˆ¶åœ¨ 5-30 å­—
   âœ… ä¸è¦ä¸€æ¬¡è¯´å®Œä¸€æ•´æ®µè¯
   âœ… å£è¯­åŒ–ï¼šå“ˆå“ˆã€emmmã€è¯¶ã€å“‡ã€å“¦
   âœ… è‡ªç„¶èŠ‚å¥ï¼šæœ‰æ—¶ä¸€å¥è¯ï¼Œæœ‰æ—¶å‡ ä¸ªå­—
   âœ… æƒ…ç»ªçœŸå®ï¼šä¼šåœé¡¿ã€ä¼šçº æ­£ã€ä¼šæ‰“å²”
   âœ… ç¬¦åˆäººè®¾ï¼šæ ¹æ®è§’è‰²æ€§æ ¼è°ƒæ•´è¯­æ°”
   
   âŒ **ä¸¥ç¦**ï¼š
   - ä¸€æ¡æ¶ˆæ¯è¶…è¿‡40å­—
   - æŠŠå¤šä¸ªæ„æ€æŒ¤åœ¨ä¸€æ¡æ¶ˆæ¯é‡Œ
   - ä¸€æ¬¡æ€§å›ç­”å®Œæ‰€æœ‰é—®é¢˜


---

# è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼éµå®ˆï¼ï¼‰
ä½ çš„å›å¤å¿…é¡»æ˜¯å¤šæ¡æ¶ˆæ¯ï¼Œç”¨ "|||" åˆ†éš”ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

ç¬¬ä¸€æ¡æ¶ˆæ¯å†…å®¹|||ç¬¬äºŒæ¡æ¶ˆæ¯å†…å®¹|||ç¬¬ä¸‰æ¡æ¶ˆæ¯å†…å®¹|||...

**ç¤ºä¾‹ï¼š**
å“ˆå“ˆä½ ä¹Ÿåœ¨å•Š|||åˆšæ‰å»åƒé¥­äº†|||è¯¶å¯¹äº†|||ä¸Šæ¬¡ä½ è¯´çš„é‚£ä¸ªäº‹å„¿|||æˆ‘æƒ³äº†æƒ³|||å¯èƒ½è¿™æ ·æ¯”è¾ƒå¥½|||è¦ä¸æ˜å¤©è¯•è¯•ï¼Ÿ|||ä½ è§‰å¾—å‘¢

**é”™è¯¯ç¤ºä¾‹ï¼ˆä¸è¦è¿™æ ·ï¼‰ï¼š**
âŒ å“ˆå“ˆä½ ä¹Ÿåœ¨å•Šï¼Œæˆ‘åˆšæ‰å»åƒé¥­äº†ï¼Œè¯¶å¯¹äº†ï¼Œä¸Šæ¬¡ä½ è¯´çš„é‚£ä¸ªäº‹å„¿æˆ‘æƒ³äº†æƒ³ï¼Œå¯èƒ½è¿™æ ·æ¯”è¾ƒå¥½ï¼Œè¦ä¸æ˜å¤©è¯•è¯•ï¼Ÿä½ è§‰å¾—å‘¢
ï¼ˆå¤ªé•¿äº†ï¼è¦æ‹†æˆå¤šæ¡ï¼‰

${stickerListText ? `\n**å‘é€è¡¨æƒ…åŒ…ç¤ºä¾‹ï¼š**\nå“ˆå“ˆ|||<sticker>ç¬‘å“­</sticker>|||ä½ å¤ªé€—äº†|||ä¸è¡Œäº†|||<sticker>èµ</sticker>\nï¼ˆæ³¨æ„ï¼šæ¯ä¸ª <sticker> æ ‡ç­¾å¿…é¡»ç‹¬å ä¸€æ¡æ¶ˆæ¯ï¼‰` : ''}

---

# å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡
ç°åœ¨è¯·æ ¹æ®ä¸Šé¢çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä»¥åŠä¸‹é¢çš„èŠå¤©å†å²ï¼Œç”¨ä½ è§’è‰²çš„å£å»å›å¤ ${userName} çš„æœ€æ–°æ¶ˆæ¯ã€‚

è®°ä½ï¼š
- å›å¤ 8-15 æ¡æ¶ˆæ¯
- ç”¨ ||| åˆ†éš”
- ä¿æŒè§’è‰²äººè®¾
- è‡ªç„¶ã€çœŸå®ã€æœ‰è¶£${stickerListText ? '\n- è¡¨æƒ…åŒ…å¿…é¡»ç‹¬å ä¸€æ¡æ¶ˆæ¯' : ''}`;

    if (contact.aiCanReadTime) {
        systemPrompt += `\n\n[System Info: Current local time is ${new Date().toLocaleString('zh-CN')}]`;
    }

    const contextRounds = contact.contextRounds || 10;
    const history = await db.chatMessages.where('contactId').equals(contactId).reverse().limit(contextRounds * 2).toArray();
    history.reverse();

    let messages = [];
    messages.push({ role: "system", content: systemPrompt }); 
    history.forEach(msg => {
        if (msg.sender === 'user' || msg.sender === 'bot') {
            messages.push({ role: msg.sender === 'user' ? 'user' : 'assistant', content: msg.text });
        }
    });

    try {
        const response = await fetch(`${baseUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model, 
                messages: messages,
                temperature: 0.7,
                top_p: 0.95,
                frequency_penalty: 0.4,
                presence_penalty: 0.4,
                max_tokens: 100000,
                stream: false 
            })
        });
        
        if (!response.ok) {
            return `ï¼ˆAPIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}ï¼‰`;
        }
        
        const data = await response.json();
        if (data.choices && data.choices[0] && data.choices[0].message) {
            let fullReply = data.choices[0].message.content;
            
            //  æ ¼å¼ä¿®å¤é€»è¾‘
            fullReply = fixStickerFormat(fullReply);
            
            if (fullReply.includes('|||')) {
                return fullReply;
            } else {
                return smartSplitMessage(fullReply);
            }
        } else {
            return "ï¼ˆAPIè¿”å›äº†ç©ºæ•°æ®ï¼‰";
        }
    } catch (error) {
        return `ï¼ˆç½‘ç»œè¯·æ±‚å¤±è´¥: ${error.message}ï¼‰`;
    }
}

//  è¡¨æƒ…åŒ…æ ¼å¼ä¿®å¤å‡½æ•°
function fixStickerFormat(text) {
    // 1. ç§»é™¤æ‰€æœ‰æ¢è¡Œç¬¦ï¼ˆé¿å…å¹²æ‰°ï¼‰
    text = text.replace(/\n+/g, '|||');
    
    // 2. ä¿®å¤ "æ–‡å­—<sticker>xxx</sticker>" è¿™ç§é”™è¯¯æ ¼å¼
    //    å°†å…¶æ‹†åˆ†æˆ: "æ–‡å­—|||<sticker>xxx</sticker>"
    text = text.replace(/([^|])(<sticker>.*?<\/sticker>)/g, '$1|||$2');
    
    // 3. ä¿®å¤ "<sticker>xxx</sticker>æ–‡å­—" è¿™ç§é”™è¯¯æ ¼å¼
    //    å°†å…¶æ‹†åˆ†æˆ: "<sticker>xxx</sticker>|||æ–‡å­—"
    text = text.replace(/(<sticker>.*?<\/sticker>)([^|])/g, '$1|||$2');
    
    // 4. æ¸…ç†å¤šä½™çš„åˆ†éš”ç¬¦
    text = text.replace(/\|\|\|+/g, '|||');
    text = text.replace(/^\|\|\||\|\|\|$/g, '');
    
    return text;
}


    
    // ã€æ–°åŠŸèƒ½ã€‘å…³é—­æ—¶æ¸…ç©ºé¢„è§ˆ
    function closeWidgetEditor() {
        widgetEditorPopup.classList.add('hidden');
        currentEditingWidgetId = null; 
        widgetBgPreview.src = '';
        widgetBgPreview.style.display = 'none';
        widgetAvatarPreview.src = '';
        widgetAvatarPreview.style.display = 'none';
    }
    
    async function populateApiForm(presetId) {
        if (!presetId) {
            currentSelectedPresetId = null;
            apiPresetNameInput.value = '';
            apiKeyInput.value = '';
            apiBaseUrlInput.value = '';
            apiModelInput.value = '';
            modelSelectorContainer.innerHTML = '';
        } else {
            currentSelectedPresetId = presetId;
            const preset = await db.apiPresets.get(presetId);
            if (preset) {
                apiPresetNameInput.value = preset.name;
                apiKeyInput.value = preset.key || '';
                apiBaseUrlInput.value = preset.url || '';
                apiModelInput.value = preset.model || '';
                modelSelectorContainer.innerHTML = ''; 
            }
        }
    }

async function loadApiPresets() {
    // ã€ä¿®æ”¹ã€‘åŒæ—¶æ¸…ç©ºä¸¤ä¸ªä¸‹æ‹‰æ¡†
    apiPresetSelector.innerHTML = ''; 
    apiSummaryPresetSelector.innerHTML = ''; // <-- ã€æ–°ã€‘

    // --- 1. å¡«å……â€œèŠå¤© APIâ€ä¸‹æ‹‰æ¡† (å’Œä»¥å‰ä¸€æ ·) ---
    const newOptionChat = document.createElement('option');
    newOptionChat.value = "new"; 
    newOptionChat.textContent = "--- [ æ–°å»ºé¢„è®¾ ] ---";
    apiPresetSelector.appendChild(newOptionChat);

    // --- 2. å¡«å……â€œæ€»ç»“ APIâ€ä¸‹æ‹‰æ¡† (å’Œä»¥å‰ä¸€æ ·) ---
    const newOptionSummary = document.createElement('option');
    newOptionSummary.value = ""; 
    newOptionSummary.textContent = "--- ä½¿ç”¨é»˜è®¤ (ä¸èŠå¤©APIç›¸åŒ) ---"; 
    apiSummaryPresetSelector.appendChild(newOptionSummary); 

    // --- 3. ä»æ•°æ®åº“è·å–æ•°æ® (å’Œä»¥å‰ä¸€æ ·) ---
    const allPresets = await db.apiPresets.toArray();
    const activeChatPresetIdItem = await db.settings.get('activeApiPresetId');
    const activeChatId = activeChatPresetIdItem ? activeChatPresetIdItem.value : null;
    const activeSummaryPresetIdItem = await db.settings.get('activeSummaryApiPresetId'); 
    const activeSummaryId = activeSummaryPresetIdItem ? activeSummaryPresetIdItem.value : null; 

    // --- 4. æ£€æŸ¥é¢„è®¾æ˜¯å¦ä¸ºç©º (å’Œä»¥å‰ä¸€æ ·) ---
    if (allPresets.length === 0) {
         apiPresetSelector.value = "new";
         populateApiForm(null);
         return;
    }

    // --- 5. å¾ªç¯å¡«å……ä¸¤ä¸ªåˆ—è¡¨ (å’Œä»¥å‰ä¸€æ ·) ---
    allPresets.forEach(preset => {
        const optionChat = document.createElement('option');
        optionChat.value = preset.id;
        optionChat.textContent = preset.name;
        if (preset.id === activeChatId) {
            optionChat.textContent += " (èŠå¤©æ¿€æ´»)"; 
        }
        apiPresetSelector.appendChild(optionChat);

        const optionSummary = optionChat.cloneNode(true); 
        if (preset.id === activeSummaryId) {
            optionSummary.textContent = preset.name + " (æ€»ç»“æ¿€æ´»)";
        } else {
            optionSummary.textContent = preset.name; 
        }
        apiSummaryPresetSelector.appendChild(optionSummary); 
    });

    // --- 6. è®¾ç½®ä¸¤ä¸ªä¸‹æ‹‰æ¡†çš„ "å½“å‰é€‰ä¸­å€¼" (å’Œä»¥å‰ä¸€æ ·) ---
    if (activeChatId) {
        apiPresetSelector.value = activeChatId;
        await populateApiForm(activeChatId); 
    } else {
        apiPresetSelector.value = allPresets[0].id;
        await populateApiForm(allPresets[0].id); 
    }

    // ã€ä¿®å¤ã€‘åªè®¾ç½® valueï¼Œä¸å†è°ƒç”¨é‚£ä¸ªä¸å­˜åœ¨çš„å‡½æ•°
    if (activeSummaryId) {
        apiSummaryPresetSelector.value = activeSummaryId; 
    } else {
        apiSummaryPresetSelector.value = ""; 
    }
}
  // ======================================================
// ã€æ–°åŠŸèƒ½ã€‘æˆ‘çš„äººè®¾ (My Persona Presets) 
// ======================================================






async function openPersonaEditor(personaId) {
  
    
    if (personaId === null) {
        // æ–°å»ºæ¨¡å¼
        currentEditingPersonaId = null;
        document.querySelector('#persona-editor-title').textContent = 'æ·»åŠ æ–°äººè®¾';
        document.querySelector('#persona-name-input').value = '';
        document.querySelector('#persona-desc-input').value = '';
        document.querySelector('#persona-avatar-preview').src = './assets/default-avatar.png';
        document.querySelector('#persona-avatar-input').value = '';
    } else {
        // ç¼–è¾‘æ¨¡å¼
        const persona = await db.my_persona_presets.get(personaId);
     
        
        if (!persona) {
            alert('æ‰¾ä¸åˆ°è¿™ä¸ªäººè®¾ï¼');
            return;
        }
        
        currentEditingPersonaId = personaId;
        document.querySelector('#persona-editor-title').textContent = 'ç¼–è¾‘äººè®¾';
        document.querySelector('#persona-name-input').value = persona.name;
        document.querySelector('#persona-desc-input').value = persona.description || '';
        document.querySelector('#persona-avatar-preview').src = './assets/default-avatar.png';
        
        if (persona.avatarFileKey) {
            const avatarFile = await db.files.get(persona.avatarFileKey);
            if (avatarFile) {
                document.querySelector('#persona-avatar-preview').src = URL.createObjectURL(avatarFile.file);
            }
        }
        
        document.querySelector('#persona-avatar-input').value = '';
    }
    
 
    personaEditorPopup.classList.remove('hidden');
}



function closePersonaEditor() {
    personaEditorPopup.classList.add('hidden');
    currentEditingPersonaId = null;
}

  async function populateMyPersonaSelects(selectedId = null) {
    // ã€å…³é”®ã€‘å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    if (!db.my_persona_presets) {
        console.error('æ•°æ®åº“è¡¨ my_persona_presets ä¸å­˜åœ¨ï¼');
        return;
    }
    
    const presets = await db.my_persona_presets.toArray();
    
    // æ›´æ–°"æ·»åŠ è”ç³»äºº"å¼¹çª—ä¸­çš„é€‰æ‹©å™¨
    const selectEl = document.querySelector('#contact-mypersona-preset-select');
    if (selectEl) {
        selectEl.innerHTML = '<option value="">--- è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾é¢„è®¾ ---</option>';
        presets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            selectEl.appendChild(option);  // âœ… æ­£ç¡®
        });
    }
    
    // æ›´æ–°"è”ç³»äººè®¾ç½®"é¡µé¢ä¸­çš„é€‰æ‹©å™¨
    const settingsSelectEl = document.querySelector('#contact-settings-mypersona-preset-select');
    if (settingsSelectEl) {
        settingsSelectEl.innerHTML = '<option value="">--- è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾é¢„è®¾ ---</option>';
        presets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            settingsSelectEl.appendChild(option);  // âœ… æ­£ç¡®
        });
        if (selectedId) {
            settingsSelectEl.value = selectedId;
        }
    }
}


       (async () => {
        captureDefaultIcons(); 
        updateClock();
        setInterval(updateClock, 1000);
        await loadSettings(); 
        await loadApiPresets(); 
        renderContactList(); 
        await renderCategories();
        await renderWorldbookEntries();
     

    })();
    
    largeWidget.addEventListener('click', () => {
        currentEditingWidgetId = 'largeWidget'; 
        const currentText = largeWidget.querySelector('.widget-text').textContent;
        widgetBgUrlInput.value = '';
        widgetAvatarUrlInput.value = '';
        widgetTextInput.value = (currentText === 'å¤§èƒ†ï¼Œæœ•æ˜¯çš‡å¸ï¼' && !localStorage.getItem('largeWidget_text')) ? '' : currentText;
        widgetTextColorInput.value = largeWidget.querySelector('.widget-text').style.color || '#333333';
        avatarEditorSection.classList.remove('hidden'); 
        widgetEditorPopup.classList.remove('hidden');
    });

    editableSlimWidgets.forEach(widget => {
        widget.addEventListener('click', () => {
            currentEditingWidgetId = widget.dataset.widgetId; 
            const currentText = widget.querySelector('.widget-text-slim').textContent;
            widgetBgUrlInput.value = '';
            widgetTextInput.value = currentText || '';
            widgetTextColorInput.value = widget.querySelector('.widget-text-slim').style.color || '#FFFFFF';
            avatarEditorSection.classList.add('hidden'); 
            widgetEditorPopup.classList.remove('hidden');
        });
    });
    
    widgetEditorCloseBtn.addEventListener('click', closeWidgetEditor);
    widgetEditorPopup.addEventListener('click', (event) => {
        if (event.target === widgetEditorPopup) closeWidgetEditor();
    });

    widgetSaveBtn.addEventListener('click', async () => {
      
        if (!currentEditingWidgetId) return; 
        const bgFile = widgetBgFileInput.files[0];
        const newText = widgetTextInput.value;
        const avatarFile = widgetAvatarFileInput.files[0]; 
        const newColor = widgetTextColorInput.value; 

        if (currentEditingWidgetId === 'largeWidget') {
            const widgetBg = largeWidget.querySelector('.widget-bg');
            const widgetText = largeWidget.querySelector('.widget-text');
            widgetText.textContent = newText;
            await db.settings.put({ key: 'largeWidget_text', value: newText });
            widgetText.style.display = (newText === '') ? 'none' : ''; 
            widgetBg.style.marginBottom = (newText === '') ? '0px' : ''; 
            widgetText.style.color = newColor;
            await db.settings.put({ key: 'largeWidget_textColor', value: newColor });
        } else { 
            const widgetToUpdate = document.querySelector(`[data-widget-id="${currentEditingWidgetId}"]`);
            const textElementToUpdate = widgetToUpdate.querySelector('.widget-text-slim');
            if(textElementToUpdate) textElementToUpdate.textContent = newText;
            await db.settings.put({ key: `${currentEditingWidgetId}_text`, value: newText });
            if(textElementToUpdate) textElementToUpdate.style.color = newColor;
            await db.settings.put({ key: `${currentEditingWidgetId}_textColor`, value: newColor });
        }
        try {
            if (bgFile) {
                await db.files.put({ key: `${currentEditingWidgetId}_bg`, file: bgFile });
                if (currentEditingWidgetId === 'largeWidget') {
                     largeWidget.querySelector('.widget-bg').style.backgroundImage = `url('${URL.createObjectURL(bgFile)}')`;
                } else {
                    document.querySelector(`[data-widget-id="${currentEditingWidgetId}"]`).style.backgroundImage = `url('${URL.createObjectURL(bgFile)}')`;
                }
            }
            if (avatarFile && currentEditingWidgetId === 'largeWidget') {
                await db.files.put({ key: 'largeWidget_avatar', file: avatarFile });
                widgetAvatarImage.src = URL.createObjectURL(avatarFile);
            }
        } catch (error) { console.error("ä¿å­˜æ–‡ä»¶å¤±è´¥:", error); }
        closeWidgetEditor();
        widgetBgFileInput.value = '';
        widgetAvatarFileInput.value = ''; 
    });

    widgetClearBtn.addEventListener('click', async () => { 
        if (!currentEditingWidgetId) return;
        if (currentEditingWidgetId === 'largeWidget') {
            largeWidget.querySelector('.widget-bg').style.backgroundImage = '';
            largeWidget.querySelector('.widget-bg').style.marginBottom = '0px'; 
            largeWidget.querySelector('.widget-text').textContent = ''; 
            largeWidget.querySelector('.widget-text').style.display = 'none'; 
            largeWidget.querySelector('.widget-text').style.color = ''; 
            widgetAvatarImage.src = './assets/default-avatar.png'; 
            await db.files.delete('largeWidget_bg');
            await db.files.delete('largeWidget_avatar');
            await db.settings.delete('largeWidget_text');
            await db.settings.delete('largeWidget_textColor');
        } else {
            const widgetToUpdate = document.querySelector(`[data-widget-id="${currentEditingWidgetId}"]`);
            widgetToUpdate.style.backgroundImage = '';
            if (widgetToUpdate.querySelector('.widget-text-slim')) {
                widgetToUpdate.querySelector('.widget-text-slim').textContent = '';
                widgetToUpdate.querySelector('.widget-text-slim').style.color = '';
            }
            await db.files.delete(`${currentEditingWidgetId}_bg`);
            await db.settings.delete(`${currentEditingWidgetId}_text`);
            await db.settings.delete(`${currentEditingWidgetId}_textColor`);
        }
        closeWidgetEditor();
    });

    themeAppIcon.addEventListener('click', () => { appGrid.classList.add('home-screen-hidden'); dock.classList.add('home-screen-hidden'); themeScreen.classList.remove('hidden'); });
    backToHomeBtn.addEventListener('click', () => { appGrid.classList.remove('home-screen-hidden'); dock.classList.remove('home-screen-hidden'); themeScreen.classList.add('hidden'); });
    settingsAppIcon.addEventListener('click', () => { appGrid.classList.add('home-screen-hidden'); dock.classList.add('home-screen-hidden'); settingsScreen.classList.remove('hidden'); });
    settingsBackBtn.addEventListener('click', () => { appGrid.classList.remove('home-screen-hidden'); dock.classList.remove('home-screen-hidden'); settingsScreen.classList.add('hidden'); });
    apiAccordionHeader.addEventListener('click', () => { apiAccordionHeader.classList.toggle('expanded'); apiAccordionContent.classList.toggle('expanded'); });
    dialogueAppIcon.addEventListener('click', () => { appGrid.classList.add('home-screen-hidden'); dock.classList.add('home-screen-hidden'); dialogueListScreen.classList.remove('hidden'); });
    dialogueListBackBtn.addEventListener('click', () => { appGrid.classList.remove('home-screen-hidden'); dock.classList.remove('home-screen-hidden'); dialogueListScreen.classList.add('hidden'); });
    newChatBtn.addEventListener('click', () => {
        addContactPopup.classList.remove('hidden'); 
        contactNameInput.value = '';
        contactPersonaInput.value = '';
        contactAvatarPreview.src = './assets/default-avatar.png'; 
        contactAvatarFileInput.value = ''; 
    });

    addContactCloseBtn.addEventListener('click', () => addContactPopup.classList.add('hidden'));
    addContactPopup.addEventListener('click', (event) => {
        if (event.target === addContactPopup) addContactPopup.classList.add('hidden');
    });

    contactAvatarFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => { contactAvatarPreview.src = e.target.result; };
            reader.readAsDataURL(file);
        }
    });

// ã€æ›¿æ¢ã€‘ä¿å­˜è”ç³»äººæŒ‰é’®é€»è¾‘
saveContactBtn.addEventListener('click', async () => {
    const name = contactNameInput.value;
    const persona = contactPersonaInput.value;
    const avatarFile = contactAvatarFileInput.files[0]; 
    // ã€æ”¹ã€‘è·å–é€‰ä¸­çš„äººè®¾é¢„è®¾ IDï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
    const selectedMyPersonaPresetId = parseInt(contactMyPersonaPresetSelect.value) || null; 

    // ã€æ”¹ã€‘åªéªŒè¯å¿…å¡«é¡¹
    if (!name) return alert('è‡³å°‘éœ€è¦è¾“å…¥ä¸€ä¸ªå§“åï¼');
    if (!avatarFile) return alert('è¯·ä¸Šä¼ ä¸€ä¸ªå¤´åƒï¼'); 
    // ã€åˆ é™¤ã€‘ä¸å†éªŒè¯äººè®¾æ˜¯å¦é€‰æ‹©

    // 1. å­˜å¤´åƒæ–‡ä»¶
    const fileKey = `avatar_${Date.now()}`;
    await db.files.put({ key: fileKey, file: avatarFile });

    // 2. å­˜è”ç³»äººä¿¡æ¯ï¼ˆäººè®¾IDå¯èƒ½ä¸ºnullï¼‰
    const newContact = {
        name: name,
        persona: persona,
        avatarFileKey: fileKey, 
        myPersonaPresetId: selectedMyPersonaPresetId, // ã€æ”¹ã€‘å…è®¸ä¸º null
        myPersonaSupplement: '',
       contextRounds: 10,  // â† ï¼ˆé»˜è®¤10è½®ï¼‰
        remark: '',
        aiCanReadTime: false,
       showAvatar: true, // é»˜è®¤æ˜¾ç¤ºå¤´åƒ
        chatBackgroundFileKey: null,
        history: [], 
        isBlockedByUser: false, 
        isBlockedByAi: false,
        userBlockTimestamp: null,
        aiBlockTimestamp: null,
        blockEndTime: null,
        pendingMessages: []
    };
    await db.contacts.add(newContact);
    
    // 3. åˆ·æ–°åˆ—è¡¨ & å…³é—­
    renderContactList();
    addContactPopup.classList.add('hidden');
});


    accordionHeader1.addEventListener('click', () => { accordionHeader1.classList.toggle('expanded'); accordionContent1.classList.toggle('expanded'); });
    accordionHeader2.addEventListener('click', () => { accordionHeader2.classList.toggle('expanded'); accordionContent2.classList.toggle('expanded'); });
    accordionHeader3.addEventListener('click', () => { accordionHeader3.classList.toggle('expanded'); accordionContent3.classList.toggle('expanded'); });
// èŠå¤©ç•Œé¢ç¾åŒ–æ‰‹é£ç´çš„å±•å¼€/æŠ˜å 
accordionHeader4.addEventListener('click', () => { 
    accordionHeader4.classList.toggle('expanded'); 
    accordionContent4.classList.toggle('expanded'); 
});

// ã€ ã€‘æ»‘å—å®æ—¶æ›´æ–°
chatWallpaperBlur.addEventListener('input', () => {
    chatWallpaperBlurValue.textContent = chatWallpaperBlur.value + 'px';
});

chatWallpaperOpacity.addEventListener('input', () => {
    chatWallpaperOpacityValue.textContent = chatWallpaperOpacity.value + '%';
});

chatInputRadius.addEventListener('input', () => {
    chatInputRadiusValue.textContent = chatInputRadius.value + 'px';
});

// ã€ ã€‘å¯¼èˆªæ èƒŒæ™¯å›¾ç‰‡é¢„è§ˆ
chatNavBgFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            chatNavBgPreview.src = ev.target.result;
            chatNavBgPreview.style.display = 'block';
            chatNavBgUrl.value = '';
        };
        reader.readAsDataURL(file);
    }
});

// ã€ ã€‘èŠå¤©å£çº¸é¢„è§ˆ
chatWallpaperFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            chatWallpaperPreview.src = ev.target.result;
            chatWallpaperPreview.style.display = 'block';
            chatWallpaperUrl.value = '';
        };
        reader.readAsDataURL(file);
    }
});
//  åº•éƒ¨å¯¼èˆªæ èƒŒæ™¯å›¾ç‰‡é¢„è§ˆ
chatBottomBgFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            chatBottomBgPreview.src = ev.target.result;
            chatBottomBgPreview.style.display = 'block';
            chatBottomBgUrl.value = '';
        };
        reader.readAsDataURL(file);
    }
});

//  ä¿å­˜èŠå¤©æ ·å¼
saveChatStyleBtn.addEventListener('click', async () => {
    try {
        // ä¿å­˜å¯¼èˆªæ æ ·å¼
        await db.settings.put({ key: 'chatNavBgColor', value: chatNavBgColor.value });
        await db.settings.put({ key: 'chatNavTextColor', value: chatNavTextColor.value });
        
        // ä¿å­˜å¯¼èˆªæ èƒŒæ™¯å›¾
        const navBgFile = chatNavBgFile.files[0];
        if (navBgFile) {
            await db.files.put({ key: 'chatNavBgImage', file: navBgFile });
        } else if (chatNavBgUrl.value) {
            await db.settings.put({ key: 'chatNavBgUrl', value: chatNavBgUrl.value });
        }
        
        // ä¿å­˜èŠå¤©å£çº¸
        const wallpaperFile = chatWallpaperFile.files[0];
        if (wallpaperFile) {
            await db.files.put({ key: 'chatWallpaperImage', file: wallpaperFile });
        } else if (chatWallpaperUrl.value) {
            await db.settings.put({ key: 'chatWallpaperUrl', value: chatWallpaperUrl.value });
        }
        
        await db.settings.put({ key: 'chatWallpaperBlur', value: chatWallpaperBlur.value });
        await db.settings.put({ key: 'chatWallpaperOpacity', value: chatWallpaperOpacity.value });
                // ä¿å­˜åº•éƒ¨å¯¼èˆªæ æ ·å¼
        await db.settings.put({ key: 'chatBottomBgColor', value: chatBottomBgColor.value });
        
        const bottomBgFile = chatBottomBgFile.files[0];
        if (bottomBgFile) {
            await db.files.put({ key: 'chatBottomBgImage', file: bottomBgFile });
        } else if (chatBottomBgUrl.value) {
            await db.settings.put({ key: 'chatBottomBgUrl', value: chatBottomBgUrl.value });
        }
        

        // ä¿å­˜è¾“å…¥æ¡†æ ·å¼
        await db.settings.put({ key: 'chatInputBgColor', value: chatInputBgColor.value });
        await db.settings.put({ key: 'chatInputTextColor', value: chatInputTextColor.value });
        await db.settings.put({ key: 'chatInputBorderColor', value: chatInputBorderColor.value });
        await db.settings.put({ key: 'chatInputRadius', value: chatInputRadius.value });
        
        // åº”ç”¨æ ·å¼
        applyChatStyles();
        
        alert('èŠå¤©æ ·å¼å·²ä¿å­˜ï¼');
        accordionHeader4.classList.remove('expanded');
        accordionContent4.classList.remove('expanded');
        
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
    }
});

//  æ¸…é™¤èŠå¤©æ ·å¼
clearChatStyleBtn.addEventListener('click', async () => {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©æ ·å¼å—ï¼Ÿ')) return;
    
    // æ¸…é™¤æ•°æ®åº“
    await db.settings.delete('chatNavBgColor');
    await db.settings.delete('chatNavTextColor');
    await db.settings.delete('chatNavBgUrl');
    await db.files.delete('chatNavBgImage');
    await db.settings.delete('chatWallpaperUrl');
    await db.files.delete('chatWallpaperImage');
    await db.settings.delete('chatWallpaperBlur');
    await db.settings.delete('chatWallpaperOpacity');
    await db.settings.delete('chatBottomBgColor');
    await db.settings.delete('chatBottomBgUrl');
    await db.files.delete('chatBottomBgImage');
    await db.settings.delete('chatInputBgColor');
    await db.settings.delete('chatInputTextColor');
    await db.settings.delete('chatInputBorderColor');
    await db.settings.delete('chatInputRadius');
    
    // é‡ç½®è¡¨å•
    chatNavBgColor.value = '#ffffff';
    chatNavTextColor.value = '#333333';
    chatNavBgUrl.value = '';
    chatNavBgFile.value = '';
    chatNavBgPreview.style.display = 'none';
    chatWallpaperUrl.value = '';
    chatWallpaperFile.value = '';
    chatWallpaperPreview.style.display = 'none';
    chatWallpaperBlur.value = 0;
    chatWallpaperBlurValue.textContent = '0px';
    chatWallpaperOpacity.value = 100;
    chatWallpaperOpacityValue.textContent = '100%';
    chatBottomBgColor.value = '#ffffff';
    chatBottomBgUrl.value = '';
    chatBottomBgFile.value = '';
    chatBottomBgPreview.style.display = 'none';
    chatInputBgColor.value = '#ffffff';
    chatInputTextColor.value = '#333333';
    chatInputBorderColor.value = '#cccccc';
    chatInputRadius.value = 18;
    chatInputRadiusValue.textContent = '18px';
    
    // ã€å…³é”®ä¿®å¤ã€‘ç«‹å³æ¸…é™¤é¡µé¢ä¸Šçš„æ ·å¼
    const chatNav = document.querySelector('.chat-window-screen .theme-nav');
    const messageContainer = document.querySelector('.message-container');
    const chatInput = document.querySelector('#chat-input-box');
    const chatInputArea = document.querySelector('.dialogue-input-area');
    
    if (chatNav) {
        chatNav.style.backgroundColor = '';
        chatNav.style.color = '';
        chatNav.style.backgroundImage = '';
        const navTitle = chatNav.querySelector('h2');
        const backBtn = chatNav.querySelector('.back-btn');
        const settingsBtn = chatNav.querySelector('.nav-action-btn');
        if (navTitle) navTitle.style.color = '';
        if (backBtn) backBtn.style.color = '';
        if (settingsBtn) settingsBtn.style.color = '';
    }
    
    if (messageContainer) {
        // ç§»é™¤å…¨å±€å£çº¸èƒŒæ™¯å±‚
        const oldBgLayer = messageContainer.querySelector('.chat-bg-layer');
        if (oldBgLayer) oldBgLayer.remove();
        
        // ã€å…³é”®ã€‘å¦‚æœå½“å‰æœ‰æ‰“å¼€çš„è”ç³»äººï¼Œé‡æ–°åŠ è½½è§’è‰²ä¸“å±èƒŒæ™¯
        if (currentOpenContactId) {
            const contact = await db.contacts.get(currentOpenContactId);
            if (contact && contact.chatBackgroundFileKey) {
                const bgFile = await db.files.get(contact.chatBackgroundFileKey);
                if (bgFile) {
                   const bgLayer = document.createElement('div');
bgLayer.className = 'chat-bg-layer';
bgLayer.style.position = 'fixed'; // ã€ä¿®æ”¹ã€‘æ”¹ä¸º fixedï¼Œå›ºå®šåœ¨è§†å£
bgLayer.style.top = messageContainer.getBoundingClientRect().top + 'px'; // ã€ä¿®æ”¹ã€‘åŠ¨æ€è®¡ç®—ä½ç½®
bgLayer.style.left = messageContainer.getBoundingClientRect().left + 'px';
bgLayer.style.width = messageContainer.offsetWidth + 'px'; // ã€ä¿®æ”¹ã€‘ä½¿ç”¨å®é™…å®½åº¦
bgLayer.style.height = messageContainer.offsetHeight + 'px'; // ã€ä¿®æ”¹ã€‘ä½¿ç”¨å®é™…é«˜åº¦
bgLayer.style.zIndex = '0';
bgLayer.style.backgroundSize = 'cover';
bgLayer.style.backgroundPosition = 'center';
bgLayer.style.backgroundAttachment = 'fixed'; //  èƒŒæ™¯å›ºå®š
bgLayer.style.pointerEvents = 'none';
                    
                    messageContainer.style.position = 'relative';
                    messageContainer.insertBefore(bgLayer, messageContainer.firstChild);
                    console.log('âœ… æ¸…é™¤åé‡æ–°åº”ç”¨è§’è‰²ä¸“å±èƒŒæ™¯');
                }
            }
        }
    }
    
    if (chatInputArea) {
        chatInputArea.style.backgroundColor = '';
        chatInputArea.style.backgroundImage = '';
    }
    //  åŒæ—¶æ¸…é™¤è¾“å…¥æ¡†æœ¬èº«
if (chatInput) {
    chatInput.style.backgroundColor = '#ffffff'; // æ¢å¤ç™½è‰²èƒŒæ™¯
}

    if (chatInput) {
        chatInput.style.backgroundColor = '';
        chatInput.style.color = '';
        chatInput.style.borderColor = '';
        chatInput.style.borderRadius = '';
    }
    
    // æ¸…é™¤æ•´ä¸ªçª—å£çš„èƒŒæ™¯
    if (chatWindowScreen) {
        chatWindowScreen.style.backgroundImage = '';
        chatWindowScreen.style.backgroundColor = '#ffffff';
    }
    
    alert('å·²æ¸…é™¤æ‰€æœ‰èŠå¤©æ ·å¼ï¼');
    
    //  å»¶è¿Ÿåº”ç”¨é»˜è®¤æ ·å¼ï¼ˆç¡®ä¿è§’è‰²ä¸“å±èƒŒæ™¯ä¸è¢«è¦†ç›–ï¼‰
    setTimeout(() => {
        applyChatStyles();
    }, 100);
});


// ã€ä¿®å¤ã€‘åº”ç”¨èŠå¤©æ ·å¼çš„å‡½æ•°
async function applyChatStyles() {
    // è·å–èŠå¤©çª—å£çš„å…ƒç´ 
    const chatNav = document.querySelector('.chat-window-screen .theme-nav');
    const messageContainer = document.querySelector('.message-container');
    const chatInput = document.querySelector('#chat-input-box');
    
    if (!chatNav || !messageContainer || !chatInput) {
        console.log('èŠå¤©ç•Œé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ ·å¼åº”ç”¨');
        return;
    }
    
    //  æ¸…é™¤å¯èƒ½æ®‹ç•™åœ¨æ•´ä¸ªçª—å£ä¸Šçš„èƒŒæ™¯
    if (chatWindowScreen) {
        chatWindowScreen.style.backgroundImage = '';
        chatWindowScreen.style.backgroundColor = '#ffffff';
    }
    
    // 1. åº”ç”¨å¯¼èˆªæ æ ·å¼
    const navBgColor = await db.settings.get('chatNavBgColor');
    if (navBgColor) {
        chatNav.style.backgroundColor = navBgColor.value;
    } else {
        chatNav.style.backgroundColor = ''; //  æ¸…é™¤æ—¶æ¢å¤é»˜è®¤
    }
    
    const navTextColor = await db.settings.get('chatNavTextColor');
    if (navTextColor) {
        chatNav.style.color = navTextColor.value;
        const navTitle = chatNav.querySelector('h2');
        const backBtn = chatNav.querySelector('.back-btn');
        const settingsBtn = chatNav.querySelector('.nav-action-btn');
        if (navTitle) navTitle.style.color = navTextColor.value;
        if (backBtn) backBtn.style.color = navTextColor.value;
        if (settingsBtn) settingsBtn.style.color = navTextColor.value;
    } else {
        //  æ¸…é™¤æ—¶æ¢å¤é»˜è®¤
        chatNav.style.color = '';
        const navTitle = chatNav.querySelector('h2');
        const backBtn = chatNav.querySelector('.back-btn');
        const settingsBtn = chatNav.querySelector('.nav-action-btn');
        if (navTitle) navTitle.style.color = '';
        if (backBtn) backBtn.style.color = '';
        if (settingsBtn) settingsBtn.style.color = '';
    }
    
    // å¯¼èˆªæ èƒŒæ™¯å›¾
    const navBgFile = await db.files.get('chatNavBgImage');
    const navBgUrl = await db.settings.get('chatNavBgUrl');
    if (navBgFile) {
        chatNav.style.backgroundImage = `url('${URL.createObjectURL(navBgFile.file)}')`;
        chatNav.style.backgroundSize = 'cover';
        chatNav.style.backgroundPosition = 'center';
    } else if (navBgUrl) {
        chatNav.style.backgroundImage = `url('${navBgUrl.value}')`;
        chatNav.style.backgroundSize = 'cover';
        chatNav.style.backgroundPosition = 'center';
    } else {
        //  æ¸…é™¤æ—¶ç§»é™¤èƒŒæ™¯å›¾
        chatNav.style.backgroundImage = '';
    }
    
    // 2. ã€å…³é”®ä¿®å¤ã€‘åº”ç”¨èŠå¤©å£çº¸ï¼ˆåªåœ¨æ²¡æœ‰è§’è‰²ä¸“å±èƒŒæ™¯æ—¶åº”ç”¨ï¼‰
    // å…ˆæ£€æŸ¥å½“å‰è§’è‰²æ˜¯å¦æœ‰ä¸“å±èƒŒæ™¯
    let hasContactBackground = false;
    if (currentOpenContactId) {
        const contact = await db.contacts.get(currentOpenContactId);
        if (contact && contact.chatBackgroundFileKey) {
            const bgFile = await db.files.get(contact.chatBackgroundFileKey);
            if (bgFile) {
                hasContactBackground = true;
                console.log('âœ… æ£€æµ‹åˆ°è§’è‰²ä¸“å±èƒŒæ™¯ï¼Œè·³è¿‡å…¨å±€å£çº¸');
            }
        }
    }
    
    // åªæœ‰åœ¨æ²¡æœ‰è§’è‰²ä¸“å±èƒŒæ™¯æ—¶ï¼Œæ‰åº”ç”¨å…¨å±€å£çº¸
   if (!hasContactBackground) {
    const wallpaperFile = await db.files.get('chatWallpaperImage');
    const wallpaperUrl = await db.settings.get('chatWallpaperUrl');
    const blur = await db.settings.get('chatWallpaperBlur');
    const opacity = await db.settings.get('chatWallpaperOpacity');
    
    if (wallpaperFile || wallpaperUrl) {
        let bgImageUrl = '';
        if (wallpaperFile) {
            bgImageUrl = URL.createObjectURL(wallpaperFile.file);
        } else if (wallpaperUrl) {
            bgImageUrl = wallpaperUrl.value;
        }
        
        // ã€ç®€åŒ–ã€‘ç›´æ¥è®¾ç½®å®¹å™¨èƒŒæ™¯
        messageContainer.style.backgroundImage = `url('${bgImageUrl}')`;
        messageContainer.style.backgroundSize = 'cover';
        messageContainer.style.backgroundPosition = 'center';
        messageContainer.style.backgroundAttachment = 'fixed'; // å…³é”®ï¼šå›ºå®šèƒŒæ™¯
        
        if (blur && blur.value > 0) {
            // æ³¨æ„ï¼šblur ä¸èƒ½ç›´æ¥åº”ç”¨åˆ°å®¹å™¨ï¼Œéœ€è¦ç”¨ä¼ªå…ƒç´ 
            console.warn('æ¨¡ç³Šæ•ˆæœéœ€è¦ä½¿ç”¨æ–¹æ¡ˆA');
        }
        
        if (opacity && opacity.value < 100) {
            // æ³¨æ„ï¼šopacity ä¼šå½±å“æ‰€æœ‰å­å…ƒç´ 
            console.warn('é€æ˜åº¦æ•ˆæœéœ€è¦ä½¿ç”¨æ–¹æ¡ˆA');
        }
        
        console.log('âœ… å·²åº”ç”¨å…¨å±€èŠå¤©å£çº¸');
    } else {
        // æ¸…é™¤èƒŒæ™¯
        messageContainer.style.backgroundImage = '';
        messageContainer.style.backgroundColor = '#f9f9f9';
    }
}
    // 3. ã€æ–°å¢ã€‘åº”ç”¨åº•éƒ¨å¯¼èˆªæ èƒŒæ™¯
const chatInputArea = document.querySelector('.dialogue-input-area');
if (chatInputArea) {
    const bottomBgColor = await db.settings.get('chatBottomBgColor');
    if (bottomBgColor) {
        chatInputArea.style.backgroundColor = bottomBgColor.value;
    }
    
    const bottomBgFile = await db.files.get('chatBottomBgImage');
    const bottomBgUrl = await db.settings.get('chatBottomBgUrl');
    if (bottomBgFile) {
        chatInputArea.style.backgroundImage = `url('${URL.createObjectURL(bottomBgFile.file)}')`;
        chatInputArea.style.backgroundSize = 'cover';
        chatInputArea.style.backgroundPosition = 'center';
    } else if (bottomBgUrl) {
        chatInputArea.style.backgroundImage = `url('${bottomBgUrl.value}')`;
        chatInputArea.style.backgroundSize = 'cover';
        chatInputArea.style.backgroundPosition = 'center';
    }
}

    // 4. åº”ç”¨è¾“å…¥æ¡†æ ·å¼
    const inputBgColor = await db.settings.get('chatInputBgColor');
    if (inputBgColor) {
        chatInput.style.backgroundColor = inputBgColor.value;
    } else {
        chatInput.style.backgroundColor = ''; //  æ¸…é™¤æ—¶æ¢å¤é»˜è®¤
    }
    
    const inputTextColor = await db.settings.get('chatInputTextColor');
    if (inputTextColor) {
        chatInput.style.color = inputTextColor.value;
    } else {
        chatInput.style.color = ''; //  æ¸…é™¤æ—¶æ¢å¤é»˜è®¤
    }
    
    const inputBorderColor = await db.settings.get('chatInputBorderColor');
    if (inputBorderColor) {
        chatInput.style.borderColor = inputBorderColor.value;
    } else {
        chatInput.style.borderColor = ''; //  æ¸…é™¤æ—¶æ¢å¤é»˜è®¤
    }
    
    const inputRadius = await db.settings.get('chatInputRadius');
    if (inputRadius) {
        chatInput.style.borderRadius = inputRadius.value + 'px';
    } else {
        chatInput.style.borderRadius = ''; //  æ¸…é™¤æ—¶æ¢å¤é»˜è®¤
    }
    
    console.log('âœ… èŠå¤©æ ·å¼å·²åº”ç”¨');
}



//  é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„æ ·å¼
//  é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„æ ·å¼
async function loadChatStyles() {
    const navBgColor = await db.settings.get('chatNavBgColor');
    if (navBgColor) chatNavBgColor.value = navBgColor.value;
    
    const navTextColor = await db.settings.get('chatNavTextColor');
    if (navTextColor) chatNavTextColor.value = navTextColor.value;
    
    const navBgUrl = await db.settings.get('chatNavBgUrl');
    if (navBgUrl) {
        chatNavBgUrl.value = navBgUrl.value;
        chatNavBgPreview.src = navBgUrl.value;
        chatNavBgPreview.style.display = 'block';
    }
    
    const wallpaperUrl = await db.settings.get('chatWallpaperUrl');
    if (wallpaperUrl) {
        chatWallpaperUrl.value = wallpaperUrl.value;
        chatWallpaperPreview.src = wallpaperUrl.value;
        chatWallpaperPreview.style.display = 'block';
    }
    
    const blur = await db.settings.get('chatWallpaperBlur');
    if (blur) {
        chatWallpaperBlur.value = blur.value;
        chatWallpaperBlurValue.textContent = blur.value + 'px';
    }
    
    const opacity = await db.settings.get('chatWallpaperOpacity');
    if (opacity) {
        chatWallpaperOpacity.value = opacity.value;
        chatWallpaperOpacityValue.textContent = opacity.value + '%';
    }
    
    const bottomBgColor = await db.settings.get('chatBottomBgColor');
    if (bottomBgColor) chatBottomBgColor.value = bottomBgColor.value;
    
    const bottomBgUrl = await db.settings.get('chatBottomBgUrl');
    if (bottomBgUrl) {
        chatBottomBgUrl.value = bottomBgUrl.value;
        chatBottomBgPreview.src = bottomBgUrl.value;
        chatBottomBgPreview.style.display = 'block';
    }
    
    const inputBgColor = await db.settings.get('chatInputBgColor');
    if (inputBgColor) chatInputBgColor.value = inputBgColor.value;
    
    const inputTextColor = await db.settings.get('chatInputTextColor');
    if (inputTextColor) chatInputTextColor.value = inputTextColor.value;
    
    const inputBorderColor = await db.settings.get('chatInputBorderColor');
    if (inputBorderColor) chatInputBorderColor.value = inputBorderColor.value;
    
    const inputRadius = await db.settings.get('chatInputRadius');
    if (inputRadius) {
        chatInputRadius.value = inputRadius.value;
        chatInputRadiusValue.textContent = inputRadius.value + 'px';
    }
    
    // ã€åˆ é™¤ã€‘ä¸åœ¨è¿™é‡Œåº”ç”¨æ ·å¼ï¼Œç­‰æ‰“å¼€èŠå¤©çª—å£æ—¶å†åº”ç”¨
    // await applyChatStyles();
}




    darkModeToggle.addEventListener('click', async () => { 
        darkModeToggle.classList.toggle('active'); 
        phoneScreen.classList.toggle('dark-mode'); 
        await db.settings.put({ key: 'darkMode', value: phoneScreen.classList.contains('dark-mode') }); 
    });
// ======================================================
// ã€æ–°åŠŸèƒ½ã€‘è‡ªå®šä¹‰å›¾æ ‡ - æœ¬åœ°ä¸Šä¼  + é¢„è§ˆ
// ======================================================

// ä¸ºæ¯ä¸ªå›¾æ ‡æ·»åŠ æ–‡ä»¶ä¸Šä¼ çš„ç›‘å¬å™¨
iconKeys.forEach(key => {
    const fileInput = document.querySelector(`#icon-file-${key}`);
    const previewImg = document.querySelector(`#icon-preview-${key}`);
    
    if (fileInput && previewImg) {
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    // æ˜¾ç¤ºé¢„è§ˆå›¾
                    previewImg.src = ev.target.result;
                    previewImg.style.display = 'block';
                    
                    // æ¸…ç©ºURLè¾“å…¥æ¡†ï¼ˆå› ä¸ºç”¨æˆ·é€‰æ‹©äº†æœ¬åœ°æ–‡ä»¶ï¼‰
                    iconUrlInputs[key].value = '';
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

saveIconsBtn.addEventListener('click', async () => { 
    for (const key of iconKeys) {
        const newUrl = iconUrlInputs[key].value;
        const fileInput = document.querySelector(`#icon-file-${key}`);
        const uploadedFile = fileInput ? fileInput.files[0] : null;
        const settingKey = `custom_icon_${key}`;
        const fileKey = `custom_icon_file_${key}`;
        
        const svgElement = iconElements[key].querySelector('svg');
        
        // ä¼˜å…ˆå¤„ç†æœ¬åœ°ä¸Šä¼ çš„æ–‡ä»¶
        if (uploadedFile) {
            // 1. ä¿å­˜æ–‡ä»¶åˆ°æ•°æ®åº“
            await db.files.put({ key: fileKey, file: uploadedFile });
            
            // 2. æ›´æ–°å›¾æ ‡ï¼ˆä½¿ç”¨ CSS èƒŒæ™¯ï¼‰
            const objectUrl = URL.createObjectURL(uploadedFile);
            if (svgElement) {
                svgElement.innerHTML = '';
                svgElement.style.background = `url('${objectUrl}') center/cover no-repeat`;
                svgElement.style.borderRadius = '15px';
            }
            
            // 3. æ¸…é™¤URLè®¾ç½®ï¼ˆå› ä¸ºç”¨äº†æœ¬åœ°æ–‡ä»¶ï¼‰
            await db.settings.delete(settingKey);
            
        } else if (newUrl) {
            // å¦‚æœè¾“å…¥äº†URL
            await db.settings.put({ key: settingKey, value: newUrl });
            
            if (svgElement) {
                svgElement.innerHTML = '';
                svgElement.style.background = `url('${newUrl}') center/cover no-repeat`;
                svgElement.style.borderRadius = '15px';
            }
            
            // æ¸…é™¤æœ¬åœ°æ–‡ä»¶ï¼ˆå› ä¸ºç”¨äº†URLï¼‰
            await db.files.delete(fileKey);
            
        } else {
            // ä¸¤ä¸ªéƒ½æ²¡æœ‰ï¼Œæ¢å¤é»˜è®¤å›¾æ ‡
            await db.settings.delete(settingKey);
            await db.files.delete(fileKey);
            
            if (svgElement) {
                // æ¢å¤åŸå§‹ SVG å†…å®¹
                svgElement.style.background = '';
                svgElement.style.borderRadius = '';
                svgElement.innerHTML = defaultIconSvgData[key];
            }
        }
    }
    
    accordionHeader3.classList.remove('expanded');
    accordionContent3.classList.remove('expanded');
    alert('å›¾æ ‡å·²ä¿å­˜ï¼');
});



clearIconsBtn.addEventListener('click', async () => {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰å›¾æ ‡å—ï¼Ÿè¿™å°†æ¢å¤é»˜è®¤å›¾æ ‡ã€‚')) {
        return;
    }
    
    for (const key of iconKeys) {
        const settingKey = `custom_icon_${key}`;
        const fileKey = `custom_icon_file_${key}`;
        
        // 1. åˆ é™¤æ•°æ®åº“ä¸­çš„URLè®¾ç½®
        await db.settings.delete(settingKey);
        
        // 2. åˆ é™¤æ•°æ®åº“ä¸­çš„æœ¬åœ°æ–‡ä»¶
        await db.files.delete(fileKey);
        
        // 3. æ¸…ç©ºURLè¾“å…¥æ¡†
        iconUrlInputs[key].value = '';
        
        // 4. æ¸…ç©ºæ–‡ä»¶ä¸Šä¼ æ§ä»¶
        const fileInput = document.querySelector(`#icon-file-${key}`);
        if (fileInput) {
            fileInput.value = '';
        }
        
        // 5. éšè—é¢„è§ˆå›¾
        const previewImg = document.querySelector(`#icon-preview-${key}`);
        if (previewImg) {
            previewImg.src = '';
            previewImg.style.display = 'none';
        }
        
        // 6. æ¢å¤Dockä¸Šçš„é»˜è®¤å›¾æ ‡
        const svgElement = iconElements[key].querySelector('svg');
        if (svgElement) {
            svgElement.style.background = '';
            svgElement.style.borderRadius = '';
            svgElement.innerHTML = defaultIconSvgData[key];
        }
    }
    
    alert('å·²æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰å›¾æ ‡ï¼');
});



    saveTextBtn.addEventListener('click', async () => { 
        const newLeftText = leftTextInput.value; 
        const newRightText = rightTextInput.value; 
        topLeftText.textContent = newLeftText; 
        topRightText.textContent = newRightText; 
        await db.settings.put({ key: 'topLeftText', value: newLeftText });
        await db.settings.put({ key: 'topRightText', value: newRightText });
        await db.settings.put({ key: 'topTextFontSize', value: fontSizeSlider.value });
        accordionHeader1.classList.remove('expanded'); 
        accordionContent1.classList.remove('expanded'); 
        alert('ä¿å­˜æˆåŠŸï¼'); 
    });

    fontSizeSlider.addEventListener('input', () => {
        const newSize = fontSizeSlider.value;
        fontSizeValue.textContent = newSize + 'px';
        const scale = newSize / 15;
        topLeftText.style.transform = `scale(${scale})`;
        topRightText.style.transform = `scale(${scale})`;
    });

    clearTextBtn.addEventListener('click', async () => { 
        leftTextInput.value = ''; rightTextInput.value = ''; 
        topLeftText.textContent = ''; topRightText.textContent = ''; 
        topLeftText.style.transform = 'scale(1)'; 
        topRightText.style.transform = 'scale(1)'; 
        await db.settings.delete('topLeftText');
        await db.settings.delete('topRightText');
        await db.settings.delete('topTextFontSize');
        fontSizeSlider.value = 15; 
        fontSizeValue.textContent = '15px'; 
    });

    timeWidget.addEventListener('click', () => themePopup.classList.remove('hidden'));
    closePopupBtn.addEventListener('click', () => themePopup.classList.add('hidden'));
    themePopup.addEventListener('click', (event) => {
        if (event.target === themePopup) themePopup.classList.add('hidden');
    });
    
    urlSubmitBtn.addEventListener('click', () => alert("è¯·ä½¿ç”¨â€œä»æœ¬åœ°é€‰æ‹©å›¾ç‰‡â€åŠŸèƒ½ï¼ŒURLæ–¹å¼å·²è¢«ç¦ç”¨ã€‚"));
    
    localFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            db.files.put({ key: 'savedWallpaper', file: file }).then(() => {
                phoneScreen.style.backgroundImage = `url('${URL.createObjectURL(file)}')`;
                themePopup.classList.add('hidden');
            }).catch(err => alert("ä¿å­˜å£çº¸å¤±è´¥ï¼"));
        }
    });
    
sendMessageBtn.addEventListener('click', async () => {
    if (!currentOpenContactId) return;
    
    // æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ"
    addMessageToUI('bot', '...');
    
    //  è®¾ç½®ä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºæ­£åœ¨å¤„ç†å›å¤
    const processingId = Date.now(); // ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€æ ‡è¯†
    
    // è°ƒç”¨AIå›å¤ï¼ˆä½¿ç”¨ç‹¬ç«‹çš„å¼‚æ­¥å‡½æ•°ï¼Œä¸é˜»å¡ï¼‰
    processAiReply(currentOpenContactId, processingId);
});

//  ç‹¬ç«‹çš„AIå›å¤å¤„ç†å‡½æ•°
async function processAiReply(contactId, processingId) {
    try {
        const aiResponseText = await getAiReply(contactId);
        const messages = aiResponseText.split('|||').map(m => m.trim()).filter(m => m);
        
        // ç§»é™¤"æ­£åœ¨æ€è€ƒ"
        const typingBubble = messageContainer.querySelector('.message-bubble:last-child');
        if (typingBubble && typingBubble.textContent === '...') {
            typingBubble.remove();
        }
        
        // é€æ¡æ˜¾ç¤ºAIæ¶ˆæ¯
        for (let i = 0; i < messages.length; i++) {
            const msg = messages[i];
            const botMessage = { 
                contactId: contactId, 
                sender: 'bot', 
                text: msg, 
                timestamp: new Date() 
            };
            await db.chatMessages.add(botMessage);
            await addMessageToUI('bot', msg);
            
            if (i < messages.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));
            }
        }
        
        renderContactList();
        await checkAndRunAutoSummary(contactId);
        
    } catch (error) {
        console.error('AIå›å¤å¤±è´¥:', error);
        // ç§»é™¤"æ­£åœ¨æ€è€ƒ"
        const typingBubble = messageContainer.querySelector('.message-bubble:last-child');
        if (typingBubble && typingBubble.textContent === '...') {
            typingBubble.remove();
        }
        addMessageToUI('bot', 'ï¼ˆå›å¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼‰');
    }
}



  // ======================================================
// ã€ä¿®å¤ã€‘ç›‘å¬ "èŠå¤© API" ä¸‹æ‹‰æ¡† (å·²ç§»é™¤æ­»å¾ªç¯)
// ======================================================
apiPresetSelector.addEventListener('change', async () => {
 
    const selectedValue = apiPresetSelector.value;
    if (selectedValue === "new") {
        await populateApiForm(null); 
        apiPresetNameInput.focus();
        await db.settings.delete('activeApiPresetId');
    } else {
        const selectedId = parseInt(selectedValue);
        await populateApiForm(selectedId); 
        await db.settings.put({ key: 'activeApiPresetId', value: selectedId });
        // ã€å·²åˆ é™¤ã€‘é‚£è¡Œå¯¼è‡´æ­»å¾ªç¯çš„ await loadApiPresets();
    }
});
 
// ======================================================
// ã€ä¿®å¤ã€‘ç›‘å¬ "æ€»ç»“ API" ä¸‹æ‹‰æ¡† (åªè´Ÿè´£ä¿å­˜)
// ======================================================
apiSummaryPresetSelector.addEventListener('change', async () => {
    const selectedValue = apiSummaryPresetSelector.value;

    if (selectedValue === "") {
        // 1. å¦‚æœç”¨æˆ·é€‰äº† "ä½¿ç”¨é»˜è®¤ (ä¸èŠå¤©APIç›¸åŒ)"
        await db.settings.delete('activeSummaryApiPresetId');

    } else {
        // 2. å¦åˆ™, ç”¨æˆ·é€‰äº†ä¸€ä¸ªå…·ä½“çš„é¢„è®¾
        const selectedId = parseInt(selectedValue);
        await db.settings.put({ key: 'activeSummaryApiPresetId', value: selectedId });
    }

    // 3. é‡æ–°åŠ è½½æ‰€æœ‰é¢„è®¾, ä»¥ä¾¿åœ¨ UI ä¸Šæ­£ç¡®æ˜¾ç¤º "(æ€»ç»“æ¿€æ´»)" å­—æ ·
    await loadApiPresets(); 
});

// ã€å·²åˆ é™¤ã€‘æ‰€æœ‰ summaryFetchModelsBtn å’Œ apiSummaryPresetSaveBtn çš„ç›‘å¬å™¨
// å› ä¸ºå®ƒä»¬ç›¸å…³çš„ HTML å·²ç»è¢«æˆ‘ä»¬åˆ æ‰äº†ã€‚



    apiPresetNewBtn.addEventListener('click', () => {
        apiPresetSelector.value = "new";
        apiPresetSelector.dispatchEvent(new Event('change'));
    });

    apiPresetDeleteBtn.addEventListener('click', async () => {
        if (!currentSelectedPresetId) {
            alert("ä½ æ­£å¤„äºâ€œæ–°å»ºâ€æ¨¡å¼ï¼Œæ²¡æœ‰ä»€ä¹ˆå¯åˆ é™¤çš„ã€‚");
            return;
        }
        const preset = await db.apiPresets.get(currentSelectedPresetId);
        if (confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${preset.name}" å—ï¼Ÿ`)) {
            await db.apiPresets.delete(currentSelectedPresetId);
            const activePresetIdItem = await db.settings.get('activeApiPresetId');
            if (activePresetIdItem && activePresetIdItem.value === currentSelectedPresetId) {
                await db.settings.delete('activeApiPresetId');
            }
            alert("åˆ é™¤æˆåŠŸï¼");
            await loadApiPresets(); 
        }
    });

    apiPresetSaveBtn.addEventListener('click', async () => {
        const presetData = {
            name: apiPresetNameInput.value,
            key: apiKeyInput.value,
            url: apiBaseUrlInput.value,
            model: apiModelInput.value
        };
        if (!presetData.name) {
            alert("è¯·å¡«å†™é¢„è®¾åç§°ï¼");
            apiPresetNameInput.focus();
            return;
        }
        let savedId;
        if (currentSelectedPresetId) {
            await db.apiPresets.update(currentSelectedPresetId, presetData);
            savedId = currentSelectedPresetId;
            alert("é¢„è®¾å·²æ›´æ–°ï¼");
          await loadApiPresets(); // é‡æ–°åŠ è½½ä¸¤ä¸ªä¸‹æ‹‰æ¡†, å› ä¸º "åç§°" å¯èƒ½å·²æ”¹å˜
        } else {
            savedId = await db.apiPresets.add(presetData);
            alert("æ–°é¢„è®¾å·²ä¿å­˜ï¼");
        }
        await db.settings.put({ key: 'activeApiPresetId', value: savedId });
        await loadApiPresets(); 
    });

    fetchModelsBtn.addEventListener('click', async () => {
        const key = apiKeyInput.value;
        const url = apiBaseUrlInput.value;
        if (!key || !url) {
            alert("è¯·å…ˆå¡«å†™ API Key å’Œ åŸºç¡€ URL");
            return;
        }
        const fetchUrl = url.endsWith('/') ? `${url}models` : `${url}/models`; 
        fetchModelsBtn.textContent = '...';
        fetchModelsBtn.disabled = true;
        modelSelectorContainer.innerHTML = ''; 
        try {
            const response = await fetch(fetchUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${key}` }
            });
            if (!response.ok) throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
            const data = await response.json();
            if (data && data.data && Array.isArray(data.data)) {
                const models = data.data.map(m => m.id);
                const relevantModels = models.filter(m => 
                    m.includes('gpt') || m.includes('claude') || m.includes('gemini') ||
                    m.includes('qwen') || m.includes('moonshot') || m.includes('deepseek')
                ).sort(); 
                if (relevantModels.length === 0) {
                     modelSelectorContainer.innerHTML = '<p style="font-size: 12px; color: #555;">æœªæ‰¾åˆ°ç›¸å…³æ¨¡å‹ã€‚</p>';
                } else {
                    const selectEl = document.createElement('select');
                    selectEl.style = "width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;";
                    selectEl.appendChild(new Option(`--- æ‰¾åˆ° ${relevantModels.length} ä¸ªæ¨¡å‹ ---`, ''));
                    relevantModels.forEach(modelId => selectEl.appendChild(new Option(modelId, modelId)));
                    selectEl.addEventListener('change', () => {
                        if (selectEl.value) apiModelInput.value = selectEl.value;
                    });
                    modelSelectorContainer.appendChild(selectEl);
                    if (apiModelInput.value) selectEl.value = apiModelInput.value;
                }
            } else { throw new Error("è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚"); }
        } catch (error) {
            modelSelectorContainer.innerHTML = `<p style="font-size: 12px; color: red;">æ‹‰å–å¤±è´¥: ${error.message}</p>`;
        } finally {
            fetchModelsBtn.textContent = 'æ‹‰å–';
            fetchModelsBtn.disabled = false;
        }
    });

    // ======================================================
    // ä¸–ç•Œä¹¦ (Worldbook) æ ¸å¿ƒé€»è¾‘
    // ======================================================

    // ã€ä¿®å¤ã€‘è¿™ä¸ªå‡½æ•°æ˜¯å¹²å‡€ã€æ­£ç¡®çš„ç‰ˆæœ¬
    async function renderCategories() {
        const categories = await db.worldbook_categories.toArray();
        worldbookCategoryFilter.innerHTML = '<option value="all">--- å…¨éƒ¨ ---</option>';
        entryCategorySelect.innerHTML = '';
        categoryListContainer.innerHTML = '';

        if (categories.length === 0) {
            entryCategorySelect.innerHTML = '<option value="">--- è¯·å…ˆå»â€œç®¡ç†åˆ†ç±»â€ä¸­æ·»åŠ  ---</option>';
            categoryListContainer.innerHTML = '<p style="font-size: 12px; color: #777; text-align: center;">æš‚æ— åˆ†ç±»</p>';
            return; 
        }

        categories.forEach(cat => {
            worldbookCategoryFilter.appendChild(new Option(cat.name, cat.id));
            entryCategorySelect.appendChild(new Option(cat.name, cat.id));
            const item = document.createElement('div');
            item.className = 'category-list-item';
            
            // ã€ä¿®å¤ã€‘è¿™é‡Œçš„ class. å·²ç»æ”¹å› class=
            item.innerHTML = `
                <span>${cat.name}</span>
                <button class="category-delete-btn" data-id="${cat.id}">Ã—</button>
            `;
            categoryListContainer.appendChild(item);
        });
    }

    // ã€ä¿®å¤ã€‘è¿™ä¸ªå‡½æ•°æ˜¯å¹²å‡€ã€æ­£ç¡®çš„ç‰ˆæœ¬
    async function renderWorldbookEntries() {
        const categories = await db.worldbook_categories.toArray();
        const categoryMap = categories.reduce((acc, cat) => {
            acc[cat.id] = cat.name;
            return acc;
        }, {});
        const selectedCategoryId = worldbookCategoryFilter.value;
        let entries;
        if (selectedCategoryId === 'all') {
            entries = await db.worldbook_entries.toArray();
        } else {
            entries = await db.worldbook_entries.where('categoryId').equals(parseInt(selectedCategoryId)).toArray();
        }
        
        worldbookListContent.innerHTML = '';
        if (entries.length === 0) {
            worldbookListContent.innerHTML = '<p class="empty-list-message">æš‚æ— æ¡ç›®</p>';
            return;
        }

        // ã€ä¿®å¤ã€‘è¿™é‡Œæ˜¯æ­£ç¡®çš„ forEach å¾ªç¯
        entries.forEach(entry => {
            const categoryName = categoryMap[entry.categoryId] || 'æœªåˆ†ç±»';
            const firstLetter = categoryName.charAt(0).toUpperCase() || '?';
            const item = document.createElement('div');
            item.className = 'worldbook-entry-item';
            item.dataset.id = entry.id; 
            
            // ã€ä¿®å¤ã€‘è¿™é‡Œæ˜¯æ­£ç¡®çš„â€œé¦–å­—æ¯â€å›¾æ ‡ï¼Œä¸å†æœ‰ isChecked é”™è¯¯
            item.innerHTML = `
                <div class="entry-item-icon">${firstLetter}</div>
                <div class="entry-item-info">
                    <p class="entry-item-name">${entry.name}</p>
                    <p class="entry-item-category">${categoryName}</p>
                </div>
            `;
            
            item.addEventListener('mousedown', (e) => {
                 if (e.button !== 0) return;
                longPressTimer = setTimeout(() => {
                    handleEntryLongPress(entry.id, entry.name);
                }, 800);
            });
            item.addEventListener('mouseup', () => clearTimeout(longPressTimer));
            item.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
            item.addEventListener('click', () => {
                 if (longPressTimer) handleEntryClick(entry.id);
            });
            worldbookListContent.appendChild(item);
        });
    }

    async function handleEntryClick(entryId) {
        currentEditingEntryId = entryId;
        const entry = await db.worldbook_entries.get(entryId);
        if (!entry) return;
        entryEditorTitle.textContent = "ç¼–è¾‘æ¡ç›®";
        entryNameInput.value = entry.name;
        entryContentTextarea.value = entry.content;
        entryCategorySelect.value = entry.categoryId;
        worldbookListScreen.classList.add('hidden');
        entryEditorScreen.classList.remove('hidden');
    }

    async function handleEntryLongPress(entryId, entryName) {
        clearTimeout(longPressTimer);
        longPressTimer = null; 
        if (confirm(`ç¡®å®šè¦åˆ é™¤æ¡ç›® "${entryName}" å—ï¼Ÿ`)) {
            await db.worldbook_entries.delete(entryId);
            await renderWorldbookEntries();
            await loadChatStyles();
              await loadChatStyles(); //  åŠ è½½èŠå¤©æ ·å¼

        }
    }

    worldbookAppIcon.addEventListener('click', () => {
        appGrid.classList.add('home-screen-hidden');
        dock.classList.add('home-screen-hidden');
        worldbookListScreen.classList.remove('hidden');
        renderCategories();
        renderWorldbookEntries();
    });
    worldbookBackBtn.addEventListener('click', () => {
        appGrid.classList.remove('home-screen-hidden');
        dock.classList.remove('home-screen-hidden');
        worldbookListScreen.classList.add('hidden');
    });
    worldbookAddBtn.addEventListener('click', () => {
        worldbookAddMenu.classList.remove('hidden');
    });
    worldbookAddMenu.addEventListener('click', (e) => {
        if (e.target === worldbookAddMenu) worldbookAddMenu.classList.add('hidden');
    });
    worldbookMenuAddEntry.addEventListener('click', () => {
        worldbookAddMenu.classList.add('hidden'); 
        currentEditingEntryId = null; 
        entryEditorTitle.textContent = "æ·»åŠ æ–°æ¡ç›®";
        entryNameInput.value = '';
        entryContentTextarea.value = '';
        worldbookListScreen.classList.add('hidden');
        entryEditorScreen.classList.remove('hidden');
    });
    worldbookMenuManageCategories.addEventListener('click', () => {
        worldbookAddMenu.classList.add('hidden'); 
        worldbookListScreen.classList.add('hidden');
        categoryManagerScreen.classList.remove('hidden');
    });
    categoryManagerBackBtn.addEventListener('click', () => {
        categoryManagerScreen.classList.add('hidden');
        worldbookListScreen.classList.remove('hidden');
        renderCategories();
        renderWorldbookEntries();
    });
    entryEditorBackBtn.addEventListener('click', () => {
        entryEditorScreen.classList.add('hidden');
        worldbookListScreen.classList.remove('hidden');
        renderWorldbookEntries();
    });
    worldbookCategoryFilter.addEventListener('change', () => {
        renderWorldbookEntries(); 
    });
    categoryAddBtn.addEventListener('click', async () => {
        const name = categoryNameInput.value.trim();
        if (!name) return alert("åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©ºï¼");
        try {
            await db.worldbook_categories.add({ name: name });
            categoryNameInput.value = '';
            await renderCategories();
        } catch (error) {
            alert("æ·»åŠ å¤±è´¥ï¼Œå¯èƒ½è¿™ä¸ªåˆ†ç±»å·²ç»å­˜åœ¨äº†ã€‚");
        }
    });
    categoryListContainer.addEventListener('click', async (e) => {
        if (e.target.classList.contains('category-delete-btn')) {
            const categoryId = parseInt(e.target.dataset.id);
            const categoryName = e.target.previousElementSibling.textContent;
            if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±» "${categoryName}" å—ï¼Ÿ\nï¼ˆè­¦å‘Šï¼šè¿™ä¸ä¼šåˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„æ¡ç›®ï¼Œå®ƒä»¬ä¼šå˜æˆâ€œæœªåˆ†ç±»â€ã€‚ï¼‰`)) {
                await db.worldbook_categories.delete(categoryId);
                await renderCategories();
            }
        }
    });
    entrySaveBtn.addEventListener('click', async () => {
        const entryData = {
            name: entryNameInput.value.trim(),
            content: entryContentTextarea.value.trim(),
            categoryId: parseInt(entryCategorySelect.value) 
        };
        if (!entryData.name) return alert("æ¡ç›®åç§°ä¸èƒ½ä¸ºç©ºï¼");
        if (!entryData.categoryId) return alert("è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼");
        if (currentEditingEntryId) {
            await db.worldbook_entries.update(currentEditingEntryId, entryData);
        } else {
            await db.worldbook_entries.add(entryData);
        }
        alert("ä¿å­˜æˆåŠŸï¼");
                  //  ä¿å­˜åé‡æ–°åº”ç”¨æ ·å¼
            setTimeout(() => {
                applyChatStyles();
            }, 100);

        entryEditorScreen.classList.add('hidden');
        worldbookListScreen.classList.remove('hidden');
        await renderWorldbookEntries();
    });

    // ======================================================
    // è”ç³»äººè®¾ç½® (Character Settings) æ ¸å¿ƒé€»è¾‘
    // ======================================================

    async function openContactSettings(contactId) {
        if (!contactId) return;
        const contact = await db.contacts.get(contactId);
        if (!contact) {
            alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è”ç³»äººï¼");
            return;
        }
        contactSettingsTitle.textContent = `è®¾ç½®: ${contact.name}`;
        contactSettingsNameInput.value = contact.name;
        contactSettingsRemarkInput.value = contact.remark || ''; 
        contactSettingsPersonaInput.value = contact.persona;
        contactSettingsAvatar.src = './assets/default-avatar.png'; 
        if (contact.avatarFileKey) {
            const avatarFile = await db.files.get(contact.avatarFileKey);
            if (avatarFile) contactSettingsAvatar.src = URL.createObjectURL(avatarFile.file);
        }
        if (contact.aiCanReadTime) { 
            contactSettingsTimeToggle.classList.add('active');
        } else {
            contactSettingsTimeToggle.classList.remove('active');
        }
       //  åŠ è½½"æ˜¯å¦æ˜¾ç¤ºå¤´åƒ"è®¾ç½®
    if (contact.showAvatar !== false) { // é»˜è®¤æ˜¾ç¤º
        contactSettingsAvatarToggle.classList.add('active');
    } else {
        contactSettingsAvatarToggle.classList.remove('active');
    }
      // åŠ è½½"æ˜¯å¦å¯ç”¨æƒ…ä¾£å¤´åƒ"
if (contact.coupleAvatarEnabled) {
    contactSettingsCoupleAvatarToggle.classList.add('active');
} else {
    contactSettingsCoupleAvatarToggle.classList.remove('active');
}

        contactSettingsAvatarInput.value = '';
        contactSettingsBgInput.value = '';
        chatWindowScreen.classList.add('hidden');
      await populateMyPersonaSelects(contact.myPersonaPresetId);
       contactSettingsMyPersonaSupplementInput.value = contact.myPersonaSupplement || '';
       //  åŠ è½½"ä¸Šä¸‹æ–‡å‚è€ƒ"
    const contextRounds = contact.contextRounds || 10; // é»˜è®¤10è½®
    contactSettingsContextSlider.value = contextRounds;
    contactSettingsContextValue.value = contextRounds;
        contactSettingsScreen.classList.remove('hidden');
      
    }

    // ã€ä¿®å¤ã€‘è¿™ä¸ªå‡½æ•°æ˜¯å¹²å‡€ã€æ­£ç¡®çš„ç‰ˆæœ¬
    async function loadWorldbookLinker(contactId) {
        const categories = await db.worldbook_categories.toArray();
        const categoryMap = categories.reduce((acc, cat) => {
            acc[cat.id] = cat.name;
            return acc;
        }, {});
        const allEntries = await db.worldbook_entries.toArray();
        const links = await db.contact_worldbook_links.where('contactId').equals(contactId).toArray();
        const linkedEntryIds = new Set(links.map(l => l.worldbookEntryId)); 

        worldbookLinkerList.innerHTML = '';
        if (allEntries.length === 0) {
            worldbookLinkerList.innerHTML = '<p class="empty-list-message">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¸–ç•Œä¹¦æ¡ç›®</p>';
            return;
        }

        // ã€ä¿®å¤ã€‘è¿™é‡Œæ˜¯æ­£ç¡®çš„ forEach å¾ªç¯
        allEntries.forEach(entry => {
            const categoryName = categoryMap[entry.categoryId] || 'æœªåˆ†ç±»';
            const isChecked = linkedEntryIds.has(entry.id); 
            const item = document.createElement('div');
            item.className = 'linker-item';
            item.dataset.entryId = entry.id; // ã€ä¿®å¤ã€‘ç¡®ä¿æ˜¯ .entryId

            // ã€ä¿®å¤ã€‘è¿™é‡Œçš„ class æ‹¼å†™å·²å…¨éƒ¨æ­£ç¡®
            item.innerHTML = `
                <div class="linker-item-checkbox ${isChecked ? 'checked' : ''}"></div>
                <div class="linker-item-info">
                    <p class="linker-item-name">${entry.name}</p>
                    <p class="linker-item-category">${categoryName}</p>
                </div>
            `;
            worldbookLinkerList.appendChild(item);
        });
    }

    contactSettingsBtn.addEventListener('click', () => {
        openContactSettings(currentOpenContactId); 
    });
    contactSettingsBackBtn.addEventListener('click', () => {
        contactSettingsScreen.classList.add('hidden');
        chatWindowScreen.classList.remove('hidden');
    });
    contactSettingsLinkWorldbookBtn.addEventListener('click', () => {
        loadWorldbookLinker(currentOpenContactId);
        contactSettingsScreen.classList.add('hidden');
        worldbookLinkerScreen.classList.remove('hidden');
    });
    worldbookLinkerBackBtn.addEventListener('click', () => {
        worldbookLinkerScreen.classList.add('hidden');
        contactSettingsScreen.classList.remove('hidden');
    });

    // ã€ä¿®å¤ã€‘è¿™ä¸ªå‡½æ•°æ˜¯å¹²å‡€ã€æ­£ç¡®çš„ç‰ˆæœ¬
    worldbookLinkerList.addEventListener('click', async (e) => {
        const item = e.target.closest('.linker-item');
        if (!item) return; 
        const entryId = parseInt(item.dataset.entryId); // ã€ä¿®å¤ã€‘ç¡®ä¿è¯»å– .entryId
        const contactId = currentOpenContactId;
        const checkbox = item.querySelector('.linker-item-checkbox');
        
        if (checkbox.classList.contains('checked')) {
            checkbox.classList.remove('checked');
            await db.contact_worldbook_links.delete([contactId, entryId]);
        } else {
            checkbox.classList.add('checked');
            await db.contact_worldbook_links.add({
                contactId: contactId,
                worldbookEntryId: entryId
            });
        }
    });

    contactSettingsTimeToggle.addEventListener('click', () => {
        contactSettingsTimeToggle.classList.toggle('active');
    });

    contactSettingsBgClearBtn.addEventListener('click', async () => {
        if (!confirm("ç¡®å®šè¦æ¸…é™¤è‡ªå®šä¹‰èƒŒæ™¯å—ï¼Ÿ")) return;
        const contactId = currentOpenContactId;
        const contact = await db.contacts.get(contactId);
        if (contact) {
            contact.chatBackgroundFileKey = null; 
            await db.contacts.put(contact);
            alert("èƒŒæ™¯å·²æ¸…é™¤ï¼");
            chatWindowScreen.style.backgroundImage = '';
            chatWindowScreen.style.backgroundColor = '#ffffff';
        }
    });

    contactSettingsSaveBtn.addEventListener('click', async () => {
        const contactId = currentOpenContactId;
        if (!contactId) return;
        try {
            const dataToUpdate = {
                name: contactSettingsNameInput.value,
                remark: contactSettingsRemarkInput.value,
                persona: contactSettingsPersonaInput.value,
                aiCanReadTime: contactSettingsTimeToggle.classList.contains('active'),
         myPersonaPresetId: parseInt(contactSettingsMyPersonaPresetSelect.value) || null,
 myPersonaSupplement: contactSettingsMyPersonaSupplementInput.value,
              contextRounds: parseInt(contactSettingsContextValue.value) || 10,
               showAvatar: contactSettingsAvatarToggle.classList.contains('active'),
              coupleAvatarEnabled: contactSettingsCoupleAvatarToggle.classList.contains('active')

            
            };
            const avatarFile = contactSettingsAvatarInput.files[0];
            if (avatarFile) {
                const fileKey = `avatar_${Date.now()}`;
                await db.files.put({ key: fileKey, file: avatarFile });
                dataToUpdate.avatarFileKey = fileKey; 
                contactSettingsAvatar.src = URL.createObjectURL(avatarFile);
            }
            const bgFile = contactSettingsBgInput.files[0];
            if (bgFile) {
                const fileKey = `chatbg_${Date.now()}`;
                await db.files.put({ key: fileKey, file: bgFile });
                dataToUpdate.chatBackgroundFileKey = fileKey; 
            }
                      //  å¦‚æœä¸Šä¼ äº†æ–°èƒŒæ™¯ï¼Œç«‹å³åº”ç”¨
            if (bgFile) {
                setTimeout(() => {
                    applyChatStyles();
                }, 100);
            }

            await db.contacts.update(contactId, dataToUpdate);
            renderContactList();
            document.querySelector('#chat-window-title').textContent = dataToUpdate.name;
            if (bgFile) {
                 chatWindowScreen.style.backgroundImage = `url('${URL.createObjectURL(bgFile)}')`;
            }
            alert("ä¿å­˜æˆåŠŸï¼");
            contactSettingsScreen.classList.add('hidden');
            chatWindowScreen.classList.remove('hidden');
        } catch (error) {
            console.error("ä¿å­˜å¤±è´¥:", error);
            alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚");
        }
    });

    // ã€ä¿®å¤ã€‘è¿™ä¸ªå‡½æ•°æ˜¯å¹²å‡€ã€æ­£ç¡®çš„ç‰ˆæœ¬
    async function renderContactList() {
        const listContentContainer = document.querySelector('.dialogue-list-content');
        const contacts = await db.contacts.toArray();
        if (contacts.length === 0) {
            listContentContainer.innerHTML = '<p class="empty-list-message">æš‚æ— å¯¹è¯ï¼Œç‚¹å‡»å³ä¸Šè§’ + å·å¼€å§‹æ–°èŠå¤©</p>';
            return; 
        }
        listContentContainer.innerHTML = '';
        for (const contact of contacts) {
            let avatarUrl = './assets/default-avatar.png'; 
            if (contact.avatarFileKey) { 
                const avatarFile = await db.files.get(contact.avatarFileKey);
                if (avatarFile) avatarUrl = URL.createObjectURL(avatarFile.file);
            }
            let previewText = contact.persona; 
            const lastMessage = await db.chatMessages.where('contactId').equals(contact.id).last(); 
            if (lastMessage) previewText = lastMessage.text; 
            const displayName = contact.remark || contact.name;
            const contactItemEl = document.createElement('div');
            contactItemEl.className = 'contact-list-item'; 
            contactItemEl.dataset.contactId = contact.id; 

            // ã€ä¿®å¤ã€‘è¿™é‡Œçš„ class. å·²ç»æ”¹å› class=
            contactItemEl.innerHTML = `
                <img src="${avatarUrl}" alt="å¤´åƒ" class="contact-item-avatar"> 
                <div class="contact-item-info">
                    <p class="contact-item-name">${displayName}</p> 
                    <p class="contact-item-preview">${previewText || '...'}</p> 
                </div>
            `;
            listContentContainer.appendChild(contactItemEl);
        }
    }

document.querySelector('.dialogue-list-content').addEventListener('click', async (event) => {
    const clickedItem = event.target.closest('.contact-list-item');
    if (!clickedItem) return; 
    currentOpenContactId = parseInt(clickedItem.dataset.contactId); 
    const contact = await db.contacts.get(currentOpenContactId);
    if (!contact) return; 
    document.querySelector('#chat-window-title').textContent = contact.name;
    
    // ã€ä¿®å¤ã€‘å…ˆæ¸…é™¤æ•´ä¸ªçª—å£çš„èƒŒæ™¯
    chatWindowScreen.style.backgroundImage = '';
    chatWindowScreen.style.backgroundColor = '#ffffff';
    
    // ã€ä¿®å¤ã€‘ç§»é™¤æ¶ˆæ¯å®¹å™¨ä¸­æ—§çš„èƒŒæ™¯å±‚
    const oldBgLayer = messageContainer.querySelector('.chat-bg-layer');
    if (oldBgLayer) oldBgLayer.remove();
    
    // ã€ä¿®å¤ã€‘å¦‚æœæœ‰è§’è‰²ä¸“å±èƒŒæ™¯ï¼Œåˆ›å»ºæ–°çš„èƒŒæ™¯å±‚
  if (contact.chatBackgroundFileKey) {
    const bgFile = await db.files.get(contact.chatBackgroundFileKey);
    if (bgFile) {
        const bgImageUrl = URL.createObjectURL(bgFile.file);
        
        // ã€ç®€åŒ–ã€‘ç›´æ¥è®¾ç½®å®¹å™¨èƒŒæ™¯
        messageContainer.style.backgroundImage = `url('${bgImageUrl}')`;
        messageContainer.style.backgroundSize = 'cover';
        messageContainer.style.backgroundPosition = 'center';
        messageContainer.style.backgroundAttachment = 'fixed'; // å…³é”®ï¼šå›ºå®šèƒŒæ™¯
        
        console.log('âœ… å·²åº”ç”¨è§’è‰²ä¸“å±èƒŒæ™¯');
    }
} else {
    // æ¸…é™¤èƒŒæ™¯
    messageContainer.style.backgroundImage = '';
    messageContainer.style.backgroundColor = '#f9f9f9';
}
 
    // ã€ä¿®å¤ã€‘åŠ è½½å†å²æ¶ˆæ¯ï¼ˆæŒ‰é¡ºåºç­‰å¾…ï¼‰
    messageContainer.innerHTML = ''; 
    const history = await db.chatMessages.where('contactId').equals(currentOpenContactId).toArray();

    // ã€æ”¹ã€‘ç”¨ for...of å¾ªç¯ + await ç¡®ä¿æŒ‰é¡ºåºæ·»åŠ 
    for (const msg of history) {
       await addMessageToUI(msg.sender, msg.text, msg.id);
       //  æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
       messageContainer.scrollTop = messageContainer.scrollHeight;
    }
    
    // ã€ä¿®å¤ã€‘æœ€åæ‰åº”ç”¨å…¨å±€æ ·å¼ï¼ˆä½†ä¼šè·³è¿‡è§’è‰²ä¸“å±èƒŒæ™¯ï¼‰
    setTimeout(() => {
        applyChatStyles();
    }, 100);

    dialogueListScreen.classList.add('hidden');
    chatWindowScreen.classList.remove('hidden');
});


    // ã€ä¿®å¤ã€‘è¿™ä¸ªå‡½æ•°æ˜¯å¹²å‡€ã€æ­£ç¡®çš„ç‰ˆæœ¬
    chatWindowBackBtn.addEventListener('click', () => {
        chatWindowScreen.classList.add('hidden'); 
        dialogueListScreen.classList.remove('hidden'); 
        currentOpenContactId = null; 
        chatWindowScreen.style.backgroundImage = '';
    });

    // ======================================================
    // ã€æ–°åŠŸèƒ½ã€‘ç»„ä»¶ç¼–è¾‘å™¨ - æœ¬åœ°å›¾ç‰‡é¢„è§ˆ
    // ======================================================

    // 1. ç›‘å¬â€œèƒŒæ™¯å›¾â€æ–‡ä»¶é€‰æ‹©
    widgetBgFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader(); 
            reader.onload = (e) => {
                widgetBgPreview.src = e.target.result;
                widgetBgPreview.style.display = 'block'; 
            };
            reader.readAsDataURL(file); 
        } else {
            widgetBgPreview.style.display = 'none'; 
        }
    });

    // 2. ç›‘å¬â€œå¤´åƒâ€æ–‡ä»¶é€‰æ‹©
    widgetAvatarFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                widgetAvatarPreview.src = e.target.result;
                widgetAvatarPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            widgetAvatarPreview.style.display = 'none';
        }
    });
  // ======================================================
// ã€æ–°åŠŸèƒ½ã€‘è¡¨æƒ…åŒ…åº“ç®¡ç†åŠŸèƒ½
// ======================================================

// 1. è§£ææ‰¹é‡å¯¼å…¥çš„æ–‡æœ¬
function parseStickerBatchInput(text) {
    const lines = text.split('\n').filter(line => line.trim());
    const results = [];
    
    lines.forEach(line => {
        // åŒ¹é…ä¸‰ç§æ ¼å¼: æ–‡æœ¬+URL, æ–‡æœ¬ï¼šURL, æ–‡æœ¬,URL
        const match1 = line.match(/^(.+?)\+(.+)$/);
        const match2 = line.match(/^(.+?)ï¼š(.+)$/);
        const match3 = line.match(/^(.+?),(.+)$/);
        
        const match = match1 || match2 || match3;
        
        if (match) {
            const text = match[1].trim();
            const url = match[2].trim();
            
            // ç®€å•éªŒè¯URL
            if (url.startsWith('http://') || url.startsWith('https://')) {
                results.push({ text, url });
            }
        }
    });
    
    return results;
}
//  å®æ—¶é¢„è§ˆè¡¨æƒ…åŒ…
function updateStickerPreview() {
    const batchText = document.querySelector('#sticker-batch-input').value.trim();
    const previewGrid = document.querySelector('#sticker-preview-grid');
    const previewCount = document.querySelector('#preview-count');
    
    if (!batchText) {
        previewGrid.innerHTML = '<p style="font-size: 12px; color: #999; text-align: center; grid-column: 1 / -1;">è¾“å…¥é“¾æ¥åè‡ªåŠ¨é¢„è§ˆ</p>';
        previewCount.textContent = '0';
        return;
    }
    
    // è§£ææ–‡æœ¬
    const stickers = parseStickerBatchInput(batchText);
    
    if (stickers.length === 0) {
        previewGrid.innerHTML = '<p style="font-size: 12px; color: #ff3b30; text-align: center; grid-column: 1 / -1;">âŒ æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥</p>';
        previewCount.textContent = '0';
        return;
    }
    
    // æ›´æ–°æ•°é‡
    previewCount.textContent = stickers.length;
    
    // æ¸²æŸ“é¢„è§ˆ
    previewGrid.innerHTML = '';
    stickers.forEach(sticker => {
        const item = document.createElement('div');
        item.className = 'preview-sticker-item';
        item.innerHTML = `
            <img src="${sticker.url}" alt="${sticker.text}" class="preview-sticker-img" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect fill=\'%23f0f0f0\' width=\'60\' height=\'60\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-size=\'10\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EåŠ è½½å¤±è´¥%3C/text%3E%3C/svg%3E'">
            <span class="preview-sticker-text">${sticker.text}</span>
        `;
        previewGrid.appendChild(item);
    });
}

// 2. æ¸²æŸ“å·²å¯¼å…¥çš„è¡¨æƒ…åŒ…åº“åˆ—è¡¨
async function renderStickerLibraries() {
    const container = document.querySelector('#sticker-libraries-container');
    const libraries = await db.sticker_libraries.toArray();
    
    if (libraries.length === 0) {
        container.innerHTML = '<p style="font-size: 12px; color: #777; text-align: center;">æš‚æ— è¡¨æƒ…åŒ…åº“</p>';
        return;
    }
    
    container.innerHTML = '';
    
    for (const library of libraries) {
        // ç»Ÿè®¡è¿™ä¸ªåº“æœ‰å¤šå°‘ä¸ªè¡¨æƒ…
        const count = await db.stickers.where('libraryId').equals(library.id).count();
        
        const item = document.createElement('div');
        item.className = 'sticker-library-item';
        item.innerHTML = `
            <div class="sticker-library-info">
                <p class="sticker-library-name">ğŸ“ ${library.name}</p>
                <p class="sticker-library-count">${count} ä¸ªè¡¨æƒ…åŒ…</p>
            </div>
            <div class="sticker-library-actions">
                <button class="sticker-view-btn" data-library-id="${library.id}">æŸ¥çœ‹</button>
                <button class="sticker-delete-btn" data-library-id="${library.id}">åˆ é™¤</button>
            </div>
        `;
        
        container.appendChild(item);
    }
}


//  æŸ¥çœ‹è¡¨æƒ…åŒ…åº“
async function viewStickerLibrary(libraryId) {
    const library = await db.sticker_libraries.get(libraryId);
    if (!library) {
        alert('æ‰¾ä¸åˆ°è¯¥è¡¨æƒ…åŒ…åº“ï¼');
        return;
    }
    
    // è·å–è¿™ä¸ªåº“çš„æ‰€æœ‰è¡¨æƒ…åŒ…
    const stickers = await db.stickers.where('libraryId').equals(libraryId).toArray();
    
    // æ‰“å¼€å¼¹çª—
    const popup = document.querySelector('#view-sticker-popup');
    document.body.appendChild(popup);
    
    // è®¾ç½®å¼¹çª—æ ·å¼ï¼ˆä¸å¯¼å…¥å¼¹çª—ä¸€è‡´ï¼‰
    popup.style.position = 'fixed';
    popup.style.top = '0';
    popup.style.left = '0';
    popup.style.width = '100vw';
    popup.style.height = '100vh';
    popup.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
    popup.style.display = 'flex';
    popup.style.justifyContent = 'center';
    popup.style.alignItems = 'center';
    popup.style.zIndex = '999999';
    
    popup.classList.remove('hidden');
    
    const content = popup.querySelector('.popup-content');
    if (content) {
        content.style.backgroundColor = '#ffffff';
        content.style.padding = '20px 25px';
        content.style.borderRadius = '25px';
    }
    
    // æ›´æ–°æ ‡é¢˜å’Œç»Ÿè®¡
    document.querySelector('#view-library-name').textContent = library.name;
    document.querySelector('#view-sticker-count').textContent = stickers.length;
    
    // æ¸²æŸ“è¡¨æƒ…åŒ…ç½‘æ ¼
    const grid = document.querySelector('#view-sticker-grid');
    
    if (stickers.length === 0) {
        grid.innerHTML = '<p style="font-size: 12px; color: #999; text-align: center; grid-column: 1 / -1;">è¿™ä¸ªåº“æ˜¯ç©ºçš„</p>';
        return;
    }
    
    grid.innerHTML = '';
    stickers.forEach(sticker => {
        const item = document.createElement('div');
        item.className = 'sticker-grid-item';
        item.dataset.stickerId = sticker.id;  //  ä¿å­˜è¡¨æƒ…åŒ…ID
        item.innerHTML = `
            <button class="sticker-item-delete" data-sticker-id="${sticker.id}">Ã—</button>
            <img src="${sticker.url}" alt="${sticker.text}" class="sticker-grid-img" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'70\' height=\'70\'%3E%3Crect fill=\'%23f0f0f0\' width=\'70\' height=\'70\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-size=\'10\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EåŠ è½½å¤±è´¥%3C/text%3E%3C/svg%3E'">
            <span class="sticker-grid-text">${sticker.text}</span>
        `;
        grid.appendChild(item);
    });
    
    //  ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
    grid.querySelectorAll('.sticker-item-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();  // é˜»æ­¢äº‹ä»¶å†’æ³¡
            const stickerId = parseInt(btn.dataset.stickerId);
            const stickerText = btn.parentElement.querySelector('.sticker-grid-text').textContent;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤è¡¨æƒ…åŒ…"${stickerText}"å—ï¼Ÿ`)) {
                try {
                    // ä»æ•°æ®åº“åˆ é™¤
                    await db.stickers.delete(stickerId);
                    
                    // ä»UIä¸­ç§»é™¤
                    btn.parentElement.remove();
                    
                    // æ›´æ–°ç»Ÿè®¡æ•°å­—
                    const currentCount = parseInt(document.querySelector('#view-sticker-count').textContent);
                    document.querySelector('#view-sticker-count').textContent = currentCount - 1;
                    
                    // å¦‚æœåˆ å®Œäº†ï¼Œæ˜¾ç¤ºæç¤º
                    if (grid.children.length === 0) {
                        grid.innerHTML = '<p style="font-size: 12px; color: #999; text-align: center; grid-column: 1 / -1;">è¿™ä¸ªåº“æ˜¯ç©ºçš„</p>';
                    }
                    
                    // åˆ·æ–°"æˆ‘"é¡µé¢çš„è¡¨æƒ…åº“åˆ—è¡¨
                    await renderStickerLibraries();
                    
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        });
    });
}


// 5. åˆ é™¤è¡¨æƒ…åŒ…åº“
async function deleteStickerLibrary(libraryId) {
    const library = await db.sticker_libraries.get(libraryId);
    if (!library) return;
    
    if (!confirm(`ç¡®å®šè¦åˆ é™¤è¡¨æƒ…åŒ…åº“"${library.name}"å—ï¼Ÿ\nåº“ä¸­çš„æ‰€æœ‰è¡¨æƒ…åŒ…ä¹Ÿä¼šè¢«åˆ é™¤ã€‚`)) {
        return;
    }
    
    // åˆ é™¤åº“ä¸­çš„æ‰€æœ‰è¡¨æƒ…
    await db.stickers.where('libraryId').equals(libraryId).delete();
    
    // åˆ é™¤åº“æœ¬èº«
    await db.sticker_libraries.delete(libraryId);
    
    // ä»ç”¨æˆ·å’Œè§’è‰²çš„é€‰æ‹©ä¸­ç§»é™¤
    const userSelection = await db.user_sticker_selection.get('user');
    if (userSelection) {
        const newIds = userSelection.libraryIds.filter(id => id !== libraryId);
        await db.user_sticker_selection.put({ key: 'user', libraryIds: newIds });
    }
    
    const roleSelection = await db.role_sticker_selection.get('role');
    if (roleSelection) {
        const newIds = roleSelection.libraryIds.filter(id => id !== libraryId);
        await db.role_sticker_selection.put({ key: 'role', libraryIds: newIds });
    }
    
    alert('åˆ é™¤æˆåŠŸï¼');
    await renderStickerLibraries();
}

// ======================================================
// ã€æ–°åŠŸèƒ½ã€‘"æˆ‘"é¡µé¢äº‹ä»¶ç›‘å¬
// ======================================================

// ã€æ–°ã€‘"æˆ‘"é¡µé¢ - æ‰“å¼€/å…³é—­
const meAppIcon = document.querySelector('#icon-me');


meAppIcon.addEventListener('click', async () => {
    appGrid.classList.add('home-screen-hidden');
    dock.classList.add('home-screen-hidden');
    meScreen.classList.remove('hidden');
  await loadMyPersonaPresets();
});

meBackBtn.addEventListener('click', () => {
    appGrid.classList.remove('home-screen-hidden');
    dock.classList.remove('home-screen-hidden');
    meScreen.classList.add('hidden');
});

// ã€æ–°ã€‘"æˆ‘"é¡µé¢ - äººè®¾æ‰‹é£ç´çš„å±•å¼€/æŠ˜å 
const personaAccordionHeader = document.querySelector('#persona-accordion-header');
const personaAccordionContent = document.querySelector('#persona-accordion-content');

personaAccordionHeader.addEventListener('click', async () => { // ã€æ”¹ã€‘åŠ ä¸Š async
    personaAccordionHeader.classList.toggle('expanded');
    personaAccordionContent.classList.toggle('expanded');
    
    //  å±•å¼€æ—¶è‡ªåŠ¨åŠ è½½åˆ—è¡¨
    if (personaAccordionContent.classList.contains('expanded')) {
        await loadMyPersonaPresets();
    }
});


// å¤´åƒé¢„è§ˆåŠŸèƒ½
personaAvatarInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            personaAvatarPreview.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// å…³é—­ç¼–è¾‘å¼¹çª—
personaEditorCloseBtn.addEventListener('click', closePersonaEditor);
personaEditorPopup.addEventListener('click', (e) => {
    if (e.target === personaEditorPopup) closePersonaEditor();
});

// ä¿å­˜äººè®¾æŒ‰é’®
savePersonaBtn.addEventListener('click', async () => {
    const name = document.querySelector('#persona-name-input').value.trim();
    const description = document.querySelector('#persona-desc-input').value.trim();
    
    if (!name) {
        alert('è¯·è¾“å…¥äººè®¾åç§°ï¼');
        return;
    }

    let avatarFileKey = null;
    const avatarFile = document.querySelector('#persona-avatar-input').files[0];
    
    if (avatarFile) {
        // ç”¨æˆ·ä¸Šä¼ äº†æ–°å¤´åƒ
        avatarFileKey = 'persona_avatar_' + Date.now();
        await db.files.put({ key: avatarFileKey, file: avatarFile });
    } else if (currentEditingPersonaId) {
        // ç¼–è¾‘æ¨¡å¼ï¼Œä¿ç•™åŸå¤´åƒ
        const existingPersona = await db.my_persona_presets.get(currentEditingPersonaId);
        if (existingPersona) avatarFileKey = existingPersona.avatarFileKey;
    }

    const personaData = {
        name: name,
        description: description,
        avatarFileKey: avatarFileKey
    };

    if (currentEditingPersonaId) {
        // æ›´æ–°ç°æœ‰äººè®¾
        await db.my_persona_presets.update(currentEditingPersonaId, personaData);
        alert('ä¿å­˜æˆåŠŸï¼');
    } else {
        // åˆ›å»ºæ–°äººè®¾
        await db.my_persona_presets.add(personaData);
        alert('åˆ›å»ºæˆåŠŸï¼');
    }

    closePersonaEditor();
    await loadMyPersonaPresets(); // åˆ·æ–°åˆ—è¡¨
    await populateMyPersonaSelects(); // åˆ·æ–°å…¶ä»–åœ°æ–¹çš„äººè®¾é€‰æ‹©å™¨
});
  // ã€æ–°ã€‘"æ–°å¢"æŒ‰é’® - æ‰“å¼€ç©ºç™½ç¼–è¾‘å¼¹çª—
const personaAddBtn = document.querySelector('#persona-add-btn');
personaAddBtn.addEventListener('click', () => {
    openPersonaEditor(null); // null è¡¨ç¤ºæ–°å»ºæ¨¡å¼
});
async function loadMyPersonaPresets() {
    const listContainer = document.querySelector('#my-persona-list-container');
    if (!listContainer) return;
    
    const presets = await db.my_persona_presets.toArray();
    
    if (presets.length === 0) {
        listContainer.innerHTML = '<p style="font-size: 12px; color: #777; text-align: center;">æš‚æ— äººè®¾</p>';
        return;
    }
    
    listContainer.innerHTML = '';
    for (const preset of presets) {
        let avatarUrl = './assets/default-avatar.png';
        if (preset.avatarFileKey) {
            const avatarFile = await db.files.get(preset.avatarFileKey);
            if (avatarFile) avatarUrl = URL.createObjectURL(avatarFile.file);
        }
        
        const item = document.createElement('div');
        item.className = 'persona-list-item';
        item.dataset.personaId = preset.id;
        item.innerHTML = `
            <img src="${avatarUrl}" alt="å¤´åƒ" class="persona-item-avatar">
            <div class="persona-item-info">
                <p class="persona-item-name">${preset.name}</p>
                <p class="persona-item-desc">${preset.description || 'æš‚æ— æè¿°'}</p>
            </div>
            <button class="persona-item-delete hidden">Ã—</button>
        `;
        
        // ç‚¹å‡»åˆ—è¡¨é¡¹æ‰“å¼€ç¼–è¾‘
        item.addEventListener('click', async (e) => {
            if (e.target.classList.contains('persona-item-delete')) return;
            await openPersonaEditor(preset.id);
        });
        
        // ç‚¹å‡»åˆ é™¤æŒ‰é’®
        const deleteBtn = item.querySelector('.persona-item-delete');
        deleteBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm(`ç¡®å®šè¦åˆ é™¤äººè®¾"${preset.name}"å—ï¼Ÿ`)) {
                await db.my_persona_presets.delete(preset.id);
                if (preset.avatarFileKey) {
                    await db.files.delete(preset.avatarFileKey);
                }
                await loadMyPersonaPresets();
                await populateMyPersonaSelects();
                alert('åˆ é™¤æˆåŠŸï¼');
            }
        });
        
        listContainer.appendChild(item);
    }
    
    // ã€å…³é”®ã€‘åˆ—è¡¨æ¸²æŸ“å®Œæˆåï¼Œæ¢å¤ç®¡ç†æ¨¡å¼çŠ¶æ€
    updateManageMode();
}

//  "ç®¡ç†"æŒ‰é’®äº‹ä»¶
const personaManageBtn = document.querySelector('#persona-manage-btn');

if (personaManageBtn) {
    personaManageBtn.addEventListener('click', () => {
        isManageMode = !isManageMode;
        const deleteButtons = document.querySelectorAll('.persona-item-delete');
        
        deleteButtons.forEach(btn => {
            if (isManageMode) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        });
        
        if (isManageMode) {
            personaManageBtn.textContent = 'å®Œæˆ';
            personaManageBtn.style.backgroundColor = '#007aff';
            personaManageBtn.style.color = 'white';
        } else {
            personaManageBtn.textContent = 'ç®¡ç†';
            personaManageBtn.style.backgroundColor = '';
            personaManageBtn.style.color = '';
        }
    });
}

function updateManageMode() {
  
    const personaManageBtn = document.querySelector('#persona-manage-btn');
    const deleteButtons = document.querySelectorAll('.persona-item-delete');
  
    
    if (isManageMode) {
        // è¿›å…¥ç®¡ç†æ¨¡å¼
        deleteButtons.forEach(btn => btn.classList.remove('hidden'));
        if (personaManageBtn) {
            personaManageBtn.textContent = 'å®Œæˆ';
            personaManageBtn.style.backgroundColor = '#007aff';
            personaManageBtn.style.color = 'white';
        }
    } else {
        // é€€å‡ºç®¡ç†æ¨¡å¼
        deleteButtons.forEach(btn => btn.classList.add('hidden'));
        if (personaManageBtn) {
            personaManageBtn.textContent = 'ç®¡ç†';
            personaManageBtn.style.backgroundColor = '';
            personaManageBtn.style.color = '';
        }
    }
}//  æ»‘å—å˜åŒ–æ—¶æ›´æ–°è¾“å…¥æ¡†
contactSettingsContextSlider.addEventListener('input', () => {
    contactSettingsContextValue.value = contactSettingsContextSlider.value;
});

//  è¾“å…¥æ¡†å˜åŒ–æ—¶æ›´æ–°æ»‘å—
contactSettingsContextValue.addEventListener('input', () => {
    let newValue = parseInt(contactSettingsContextValue.value);
    
    // é™åˆ¶èŒƒå›´
    if (newValue < 5) newValue = 5;
    if (newValue > 200) newValue = 200;
    if (isNaN(newValue)) newValue = 10;
    
    contactSettingsContextValue.value = newValue;
    contactSettingsContextSlider.value = newValue;
});

// ======================================================
// ã€æ–°åŠŸèƒ½ã€‘"è®°å¿† & æ€»ç»“" é¡µé¢äº‹ä»¶ç›‘å¬
// ======================================================

// 1. ç‚¹å‡» Dock ä¸Šçš„ "è®°å¿†" App å›¾æ ‡
memoryAppIcon.addEventListener('click', () => {
    // éšè—ä¸»å±å¹•
    appGrid.classList.add('home-screen-hidden');
    dock.classList.add('home-screen-hidden');
    // æ˜¾ç¤ºè®°å¿†é¡µé¢
    memoryScreen.classList.remove('hidden');


// ã€ä¿®æ”¹ã€‘é‡ç½®ä¸º "è¯·é€‰æ‹©..."
summarySelectedCharacterName.textContent = 'è¯·é€‰æ‹©è¦ç®¡ç†çš„è§’è‰²...';
    summarySettingsContainer.classList.add('hidden');
    currentSummaryContactId = null;
});

// 2. ç‚¹å‡» "è®°å¿†" é¡µé¢çš„ "è¿”å›" æŒ‰é’®
memoryBackBtn.addEventListener('click', () => {
    // éšè—è®°å¿†é¡µé¢
    memoryScreen.classList.add('hidden');
    // æ¢å¤ä¸»å±å¹•
    appGrid.classList.remove('home-screen-hidden');
    dock.classList.remove('home-screen-hidden');
});

// --- (è¿™æ˜¯ä¸€ä¸ªæ–°å‡½æ•°, ç”¨äºè®¡ç®—èŠå¤©ç»Ÿè®¡) ---
// ======================================================
// ã€æ›¿æ¢ 8.10ã€‘ä½¿ç”¨ "é»„é‡‘æ ‡å‡†" (ä½ æ¥æˆ‘å¾€ = 1è½®)
// ======================================================
async function updateSummaryStats(contactId) {
    if (!contactId) return;
    try {
        const contact = await db.contacts.get(contactId);
        if (!contact) {
            summaryStatsDisplay.textContent = "æ— æ³•åŠ è½½è§’è‰²";
            return;
        }

        // 1. ã€é»„é‡‘æ ‡å‡†ã€‘è®¡ç®—æ€»è½®æ•°
        let totalTurns = 0;
        let lastSender = 'bot'; // å‡å®š AI å…ˆè¯´è¯, è¿™æ ·ç¬¬ä¸€æ¡ user æ¶ˆæ¯å°±ä¼šè¢«ç®—ä½œç¬¬1è½®

        // æˆ‘ä»¬ç”¨ .each() æ¥ä¸€æ¡ä¸€æ¡åœ°çœ‹, è¿™æ ·æœ€å¿«
        await db.chatMessages
            .where('contactId').equals(contactId)
            .each(message => {
                // å¦‚æœè¿™æ¡æ˜¯ 'user', ä¸”ä¸Šä¸€æ¡æ˜¯ 'bot', è¿™æ‰æ˜¯ä¸€ä¸ªæ–°è½®æ¬¡çš„å¼€å§‹
                if (message.sender === 'user' && lastSender !== 'user') {
                    totalTurns++;
                }
                lastSender = message.sender; // è®°å½•è¿™ä¸€æ¡çš„å‘é€è€…
            });

        // 2. è·å–ä¸Šæ¬¡æ€»ç»“åˆ°çš„è½®æ•° (è¿™ä¸ªè½®æ•°ç°åœ¨ä¹Ÿæ˜¯ "é»„é‡‘æ ‡å‡†" çš„è½®æ•°)
        const settings = contact.summarySettings || {};
        const lastSummaryTurn = settings.lastSummaryTurn || 0;

        const unsummarizedTurns = totalTurns - lastSummaryTurn;

        // 3. æ˜¾ç¤ºç»Ÿè®¡ (ç°åœ¨æ˜¯ 100% å‡†ç¡®çš„ "ä½ æ¥æˆ‘å¾€" è½®æ•°)
        summaryStatsDisplay.textContent = `å·²æ€»ç»“ ${lastSummaryTurn} è½® / ${totalTurns} è½® (${unsummarizedTurns > 0 ? unsummarizedTurns : 0} è½®æœªæ€»ç»“)`;

    } catch (error) {
        console.error("è®¡ç®—ç»Ÿè®¡æ—¶å‡ºé”™:", error);
        summaryStatsDisplay.textContent = "ç»Ÿè®¡åŠ è½½å¤±è´¥";
    }
}

// --- (è¿™æ˜¯ä¸€ä¸ªæ–°å‡½æ•°, ç”¨äºåŠ è½½æ‰€é€‰è§’è‰²çš„æ‰€æœ‰è®¾ç½®) ---
async function loadSummarySettings(contactId) {
    try {
        const contact = await db.contacts.get(contactId);
        if (!contact) {
            alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¯¥è”ç³»äººï¼");
            return;
        }

        // ã€æ–°ã€‘æŠŠé€‰ä¸­çš„åå­—æ˜¾ç¤ºåœ¨æŒ‰é’®ä¸Š
        summarySelectedCharacterName.textContent = contact.name;

        // 1. åŠ è½½ "è‡ªåŠ¨æ€»ç»“" è®¾ç½®
        const settings = contact.summarySettings || { auto: false, rounds: 20, lastSummaryTurn: 0 };

        if (settings.auto) {
            summaryAutoToggle.classList.add('active');
        } else {
            summaryAutoToggle.classList.remove('active');
        }

        summaryRoundsSlider.value = settings.rounds || 20;
     summaryRoundsValue.value = settings.rounds || 20;


        // 2. åŠ è½½ "æ‰‹åŠ¨æ€»ç»“" ç»Ÿè®¡
        await updateSummaryStats(contactId);

        // 3. åŠ è½½ "AI æ€»ç»“å†…å®¹"
        summaryTextarea.value = contact.aiSummaryText || '';

        // 4. ã€å…³é”®ã€‘æ˜¾ç¤ºæ•´ä¸ªè®¾ç½®é¢æ¿
        summarySettingsContainer.classList.remove('hidden');

    } catch (error) {
        console.error("åŠ è½½æ€»ç»“è®¾ç½®å¤±è´¥:", error);
        alert("åŠ è½½è®¾ç½®å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
    }
}
  
  // 4. ã€æ–°ã€‘ç›‘å¬ "è¯·é€‰æ‹©è§’è‰²" æŒ‰é’®çš„ç‚¹å‡»
summaryCharacterSelectorBtn.addEventListener('click', async () => { // <-- ã€æ”¹ã€‘1. åŠ ä¸Š async

    // ã€æ–°ã€‘2. æ¸…ç©º "é€‰äºº" é¡µçš„æœç´¢æ¡†
    characterSearchInput.value = ''; 

    // ã€æ–°ã€‘3. åŠ è½½å®Œæ•´åˆ—è¡¨ (å®ç° "é€‰" çš„åŠŸèƒ½)
    await renderCharacterSelectorList(); 

    // æ‰“å¼€"é€‰äºº"é¡µé¢
    characterSelectorScreen.classList.remove('hidden');
});

// 5. ã€æ–°ã€‘ç›‘å¬ "é€‰äºº" é¡µé¢çš„ "è¿”å›" æŒ‰é’®
characterSelectorBackBtn.addEventListener('click', () => {
    // å…³é—­"é€‰äºº"é¡µé¢
    characterSelectorScreen.classList.add('hidden');
});
  // ======================================================
// ã€æ–°æ·»åŠ ã€‘"é€‰äºº"é¡µé¢çš„æ ¸å¿ƒåŠŸèƒ½
// ======================================================

// --- (è¿™æ˜¯ä¸€ä¸ªæ–°å‡½æ•°, ç”¨äº "é€‰äºº" é¡µé¢, è´Ÿè´£æ˜¾ç¤ºåˆ—è¡¨) ---
async function renderCharacterSelectorList(query = '') {
    // 1. æ¸…ç©ºæ—§åˆ—è¡¨, æ˜¾ç¤ºåŠ è½½ä¸­
    characterSelectorList.innerHTML = '<p class="empty-list-message" style="margin-top: 20px;">æ­£åœ¨åŠ è½½...</p>';

    let contacts;
    try {
        // 2. æ ¹æ®æ˜¯å¦æœ‰ "æœç´¢è¯" æ¥ä»æ•°æ®åº“è·å–æ•°æ®
        if (query) {
            // "æœ" æ¨¡å¼
            contacts = await db.contacts.where('name').startsWith(query).toArray();
        } else {
            // "é€‰" æ¨¡å¼ (åŠ è½½å…¨éƒ¨)
            contacts = await db.contacts.toArray();
        }

        // 3. å†æ¬¡æ¸…ç©º (æ¸…é™¤ "åŠ è½½ä¸­")
        characterSelectorList.innerHTML = '';

        if (contacts.length === 0) {
            characterSelectorList.innerHTML = '<p class="empty-list-message" style="margin-top: 20px;">' + (query ? 'æ— åŒ¹é…è§’è‰²' : 'æš‚æ— è”ç³»äºº') + '</p>';
            return;
        }

        // 4. å¾ªç¯åˆ›å»ºåˆ—è¡¨é¡¹ (æˆ‘ä»¬å¤ç”¨ "è”ç³»äºº" App çš„æ ·å¼)
        for (const contact of contacts) {
            let avatarUrl = './assets/default-avatar.png'; 
            if (contact.avatarFileKey) { 
                const avatarFile = await db.files.get(contact.avatarFileKey);
                if (avatarFile) avatarUrl = URL.createObjectURL(avatarFile.file);
            }

            const displayName = contact.name; 

            const contactItemEl = document.createElement('div');
            contactItemEl.className = 'contact-list-item'; // å¤ç”¨æ ·å¼
            contactItemEl.dataset.contactId = contact.id;

            contactItemEl.innerHTML = `
                <img src="${avatarUrl}" alt="å¤´åƒ" class="contact-item-avatar"> 
                <div class="contact-item-info">
                    <p class="contact-item-name">${displayName}</p> 
                </div>
            `;

            // 5. ã€å…³é”®ã€‘ä¸ºæ¯ä¸ªåˆ—è¡¨é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            contactItemEl.addEventListener('click', () => {
                const contactId = contact.id;

                // 5.1 è®°å½•æˆ‘ä»¬é€‰ä¸­çš„ ID
                currentSummaryContactId = contactId; 

                // 5.2 åŠ è½½è¿™ä¸ªè§’è‰²çš„æ€»ç»“è®¾ç½® (åˆ°"è®°å¿†"ä¸»é¡µä¸Š)
                loadSummarySettings(contactId);

                // 5.3 å…³é—­ "é€‰äºº" é¡µé¢
                characterSelectorScreen.classList.add('hidden');
            });

            characterSelectorList.appendChild(contactItemEl);
        }

    } catch (error) {
        console.error("åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:", error);
        characterSelectorList.innerHTML = '<p class="empty-list-message" style="color: red;">åŠ è½½åˆ—è¡¨å¤±è´¥</p>';
    }
}
// 5. ã€æ–°ã€‘è®© "æ€»ç»“é¢‘ç‡" æ»‘å—èƒ½å®æ—¶æ›´æ–°æ–‡å­—
// 1. æ»‘å—å˜åŒ–æ—¶ï¼Œæ›´æ–°è¾“å…¥æ¡†
summaryRoundsSlider.addEventListener('input', () => {
    summaryRoundsValue.value = summaryRoundsSlider.value;
});

// 2. è¾“å…¥æ¡†å˜åŒ–æ—¶ï¼Œæ›´æ–°æ»‘å—
summaryRoundsValue.addEventListener('input', () => {
    let newValue = parseInt(summaryRoundsValue.value);
    
    // é™åˆ¶èŒƒå›´
    if (newValue < 0) newValue = 0;
    if (newValue > 200) newValue = 200;
    if (isNaN(newValue)) newValue = 20; // å¦‚æœè¾“å…¥éæ³•ï¼Œæ¢å¤é»˜è®¤å€¼
    
    summaryRoundsValue.value = newValue;
    summaryRoundsSlider.value = newValue;
});

  // --- (è¿™æ˜¯ä¸€ä¸ªæ–°å‡½æ•°, ç”¨äºä¿å­˜ "è‡ªåŠ¨æ€»ç»“" çš„è®¾ç½®, é¿å…ä»£ç é‡å¤) ---
async function saveSummarySetting(settingKey, settingValue) {
    if (!currentSummaryContactId) return; // å®‰å…¨æ£€æŸ¥, ç¡®ä¿æœ‰é€‰ä¸­çš„è§’è‰²

    try {
        const contact = await db.contacts.get(currentSummaryContactId);
        if (!contact) return;

        // 1. è·å–æ—§è®¾ç½®, æˆ–åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡
        const oldSettings = contact.summarySettings || {};

        // 2. æ›´æ–°ä½ æŒ‡å®šçš„é‚£ä¸ªè®¾ç½® (ä¾‹å¦‚ 'auto' æˆ– 'rounds')
        const newSettings = { ...oldSettings, [settingKey]: settingValue };

        // 3. å°†æ›´æ–°åçš„å®Œæ•´è®¾ç½®å¯¹è±¡, ä¿å­˜å›æ•°æ®åº“
        await db.contacts.update(currentSummaryContactId, { summarySettings: newSettings });

    } catch (error) {
        console.error(`ä¿å­˜ ${settingKey} å¤±è´¥:`, error);
    }
}

// 6. ã€æ–°ã€‘ç›‘å¬ "è‡ªåŠ¨æ€»ç»“" å¼€å…³çš„ç‚¹å‡»
summaryAutoToggle.addEventListener('click', () => {
    // åˆ‡æ¢ 'active' çŠ¶æ€å¹¶è·å–æ–°çŠ¶æ€ (true / false)
    const isActive = summaryAutoToggle.classList.toggle('active');

    // å¼‚æ­¥ä¿å­˜è¿™ä¸ªæ–°çŠ¶æ€, "å³æ—¶ç”Ÿæ•ˆ, æ— éœ€ç­‰å¾…"
    saveSummarySetting('auto', isActive); 
});

// 7. ã€æ–°ã€‘ç›‘å¬ "æ€»ç»“é¢‘ç‡" æ»‘å—çš„ "æ¾æ‰‹" (æˆ‘ä»¬ç”¨ 'change' äº‹ä»¶)
// æ»‘å—æ¾æ‰‹æ—¶ä¿å­˜
summaryRoundsSlider.addEventListener('change', () => {
    const newRounds = parseInt(summaryRoundsSlider.value);
    saveSummarySetting('rounds', newRounds);
});

// è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
summaryRoundsValue.addEventListener('blur', () => {
    const newRounds = parseInt(summaryRoundsValue.value);
    if (!isNaN(newRounds) && newRounds >= 0 && newRounds <= 200) {
        saveSummarySetting('rounds', newRounds);
    }
});

// è¾“å…¥æ¡†æŒ‰ä¸‹å›è½¦æ—¶ä¿å­˜
summaryRoundsValue.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        summaryRoundsValue.blur(); // è§¦å‘bluräº‹ä»¶
    }
});


// 8. ã€æ–°ã€‘ç›‘å¬ "ä¿å­˜ä¿®æ”¹" (AIæ€»ç»“å†…å®¹) æŒ‰é’®çš„ç‚¹å‡»
summarySaveTextBtn.addEventListener('click', async () => {
    if (!currentSummaryContactId) return; // å®‰å…¨æ£€æŸ¥

    const newText = summaryTextarea.value; // è·å–æ–‡æœ¬æ¡†é‡Œçš„æ‰€æœ‰å†…å®¹

    try {
        // ç›´æ¥æ›´æ–°æ•°æ®åº“ä¸­çš„ aiSummaryText å­—æ®µ
        await db.contacts.update(currentSummaryContactId, { aiSummaryText: newText });
        alert("æ€»ç»“å·²ä¿å­˜ï¼"); // ç»™ç”¨æˆ·ä¸€ä¸ªæ˜ç¡®çš„åé¦ˆ

    } catch (error) {
        console.error("ä¿å­˜æ€»ç»“æ–‡æœ¬å¤±è´¥:", error);
        alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
    }
});
  // ======================================================
// ã€æ–°æ·»åŠ ã€‘"é€‰äºº"é¡µé¢çš„æœç´¢æ¡†äº‹ä»¶
// ======================================================
characterSearchInput.addEventListener('input', () => {
    // æ¸…é™¤ä¸Šä¸€ä¸ªè®¡æ—¶å™¨ (é˜²æŠ–)
    clearTimeout(summarySearchTimeout); 

    // å»¶è¿Ÿ 300ms æ‰§è¡Œæœç´¢
    summarySearchTimeout = setTimeout(async () => {
        const query = characterSearchInput.value.trim();
        // è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°, ä½†è¿™æ¬¡ä¼ å…¥ "æœç´¢è¯" (å®ç° "æœ" çš„åŠŸèƒ½)
        await renderCharacterSelectorList(query); 
    }, 300);
});
  // ======================================================
// ======================================================
// ã€æ–°åŠŸèƒ½1ã€‘è®¡ç®—èŠå¤©çš„è½®æ•°ï¼ˆé»„é‡‘æ ‡å‡†ï¼šä½ æ¥æˆ‘å¾€=1è½®ï¼‰
// ======================================================
async function calculateGoldenStandardTurns(contactId) {
    // 1. åˆ›å»ºä¸¤ä¸ª"ç›’å­"æ¥è£…ç»“æœ
    let totalTurns = 0;        // æ€»å…±èŠäº†å¤šå°‘è½®
    let turnBlocks = [];       // æ¯ä¸€è½®çš„è¯¦ç»†å†…å®¹
    
    // 2. åˆ›å»ºä¸´æ—¶å˜é‡
    let lastSender = 'bot';    // å‡è®¾AIå…ˆè¯´è¯
    let currentBlock = [];     // å½“å‰è¿™ä¸€è½®çš„æ¶ˆæ¯
    
    // 3. ä»æ•°æ®åº“å–å‡ºæ‰€æœ‰èŠå¤©è®°å½•
    const messages = await db.chatMessages
        .where('contactId').equals(contactId)
        .sortBy('timestamp'); // æŒ‰æ—¶é—´æ’åº
    
    // 4. ä¸€æ¡ä¸€æ¡åœ°çœ‹æ¯æ¡æ¶ˆæ¯
    for (const msg of messages) {
        // 4.1 å¦‚æœè¿™æ¡æ˜¯"ç”¨æˆ·"å‘çš„ï¼Œä¸”ä¸Šä¸€æ¡æ˜¯"AI"å‘çš„
        if (msg.sender === 'user' && lastSender !== 'user') {
            // è¯´æ˜æ–°çš„ä¸€è½®å¼€å§‹äº†ï¼
            
            // æŠŠä¹‹å‰ç´¯ç§¯çš„æ¶ˆæ¯å­˜èµ·æ¥
            if (currentBlock.length > 0) {
                turnBlocks.push([...currentBlock]);
            }
            
            // å¼€å§‹æ–°ä¸€è½®
            totalTurns++;
            currentBlock = [];
        }
        
        // 4.2 æŠŠè¿™æ¡æ¶ˆæ¯åŠ å…¥å½“å‰è½®æ¬¡
        currentBlock.push({
            sender: msg.sender,
            text: msg.text
        });
        
        // 4.3 è®°å½•è¿™æ¡æ¶ˆæ¯çš„å‘é€è€…
        lastSender = msg.sender;
    }
    
    // 5. åˆ«å¿˜äº†æœ€åä¸€è½®ï¼
    if (currentBlock.length > 0) {
        turnBlocks.push(currentBlock);
    }
    
    // 6. è¿”å›ç»“æœ
    return { 
        totalTurns: totalTurns,     // æ•°å­—ï¼šæ€»è½®æ•°
        turnBlocks: turnBlocks      // æ•°ç»„ï¼šæ¯è½®çš„è¯¦ç»†å†…å®¹
    };
}
// ======================================================
// ã€æ–°åŠŸèƒ½2ã€‘è°ƒç”¨AIç”Ÿæˆæ€»ç»“ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
// ======================================================
async function runSummaryGeneration(
    contactId, 
  unsummarizedBlocks,  // ğŸ“¦ æœªæ€»ç»“çš„å¯¹è¯å—
    preset,              // ğŸ”‘ APIé…ç½®
    roleName,            // ğŸ‘¤ AIè§’è‰²å
    userName,            // ğŸ‘¤ ç”¨æˆ·å
    existingSummary,     // ğŸ“ å·²æœ‰çš„æ—§æ€»ç»“
    updateUiCallback     // ğŸ¨ UIæ›´æ–°å‡½æ•°ï¼ˆå¯é€‰ï¼‰
) {
    // ===== ç¬¬1é˜¶æ®µï¼šæ„å»ºæç¤ºè¯ =====
    
    // 1.1 æŠŠå¯¹è¯å—è½¬æ¢æˆæ˜“è¯»çš„æ–‡æœ¬
    let conversationText = "";
    unsummarizedBlocks.forEach((block, index) => {
        conversationText += `\n--- ç¬¬ ${index + 1} è½®å¯¹è¯ ---\n`;
        block.forEach(msg => {
            const speaker = msg.sender === 'user' ? userName : roleName;
            conversationText += `${speaker}: ${msg.text}\n`;
        });
    });
    
    // 1.2 æ„å»ºç³»ç»Ÿæç¤ºè¯
  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¯¹è¯è®°å½•åˆ†æå¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯ç”Ÿæˆç»“æ„åŒ–çš„å¯¹è¯æ€»ç»“ã€‚

ğŸ“‹ **æ€»ç»“æ ¼å¼è¦æ±‚ï¼š**

1. å¼€å¤´å¿…é¡»åŒ…å«æ—¶é—´æˆ³å’Œè½®æ¬¡èŒƒå›´ï¼š
   ğŸ“… [å½“å‰æ—¥æœŸ] - ç¬¬X-Yè½®å¯¹è¯

2. ä½¿ç”¨åˆ—è¡¨å½¢å¼è®°å½•äº‹ä»¶ï¼ˆç”¨ â€¢ ç¬¦å·ï¼‰ï¼š
   â€¢ ç¬¬ä¸€ä¸ªå…³é”®äº‹ä»¶
   â€¢ ç¬¬äºŒä¸ªå…³é”®äº‹ä»¶
   ...

3. ç»“å°¾ç”¨åˆ†éš”çº¿ï¼š
   ---

ğŸ¯ **å†…å®¹è¦æ±‚ï¼š**
- ç”¨ç¬¬ä¸‰äººç§°æè¿°ï¼ˆä¾‹å¦‚ï¼š"${userName}è¯¢é—®äº†..."ã€"${roleName}å›ç­”è¯´..."ï¼‰
- ä¿ç•™æ‰€æœ‰é‡è¦ç»†èŠ‚ï¼šå…·ä½“çš„é—®é¢˜ã€å…³é”®çš„å›ç­”ã€æƒ…æ„Ÿå˜åŒ–ã€å†³ç­–ç‚¹
- æŒ‰æ—¶é—´é¡ºåºç»„ç»‡ï¼Œç¡®ä¿é€»è¾‘è¿è´¯
- æ¯ä¸ªè¦ç‚¹åº”è¯¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¥å­ï¼ˆä¸è¦åªå†™å…³é”®è¯ï¼‰
- å¦‚æœå¯¹è¯ä¸­æœ‰æ˜ç¡®çš„ç»“è®ºæˆ–ä¸‹ä¸€æ­¥è®¡åˆ’ï¼ŒåŠ¡å¿…è®°å½•

ğŸ“Œ **ç‰¹æ®Šè§„åˆ™ï¼š**
- å¦‚æœå·²æœ‰æ—§æ€»ç»“ï¼Œè¯·åœ¨æ–°æ€»ç»“**ä¹‹å**è¿½åŠ ï¼ˆä¿æŒæ—¶é—´é¡ºåºï¼‰
- æ¯æ¡è¦ç‚¹æ§åˆ¶åœ¨0-100å­—
- æ•´ä½“æ€»ç»“æ§åˆ¶åœ¨0-1000å­—
- ç»å¯¹ä¸è¦çªç„¶æˆªæ–­ï¼Œç¡®ä¿æ¯ä¸ªæ€»ç»“éƒ½æœ‰å®Œæ•´çš„ç»“å°¾`;


    // 1.3 æ„å»ºç”¨æˆ·è¯·æ±‚
// 1. è®¡ç®—è½®æ¬¡èŒƒå›´
const startTurn = (await db.contacts.get(contactId)).summarySettings?.lastSummaryTurn || 0;
const endTurn = startTurn + unsummarizedBlocks.length;

// 2. è·å–å½“å‰æ—¥æœŸ
const currentDate = new Date().toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// 3. æ„å»ºæç¤ºè¯
const userPrompt = `**å½“å‰æ—¥æœŸï¼š** ${currentDate}
**æœ¬æ¬¡æ€»ç»“çš„è½®æ¬¡èŒƒå›´ï¼š** ç¬¬ ${startTurn + 1} è½® åˆ° ç¬¬ ${endTurn} è½®

**å·²æœ‰çš„æ—§æ€»ç»“ï¼š**
${existingSummary}

**æ–°å¯¹è¯è®°å½•ï¼ˆå…± ${unsummarizedBlocks.length} è½®ï¼‰ï¼š**
${conversationText}

è¯·æŒ‰ç…§æ ¼å¼è¦æ±‚ç”Ÿæˆæ–°æ€»ç»“ï¼š`;


    // ===== ç¬¬2é˜¶æ®µï¼šè°ƒç”¨API =====
    
    try {
        // 2.1 æ›´æ–°UIï¼ˆå¦‚æœæœ‰å›è°ƒå‡½æ•°ï¼‰
        if (updateUiCallback) {
            updateUiCallback("æ­£åœ¨è¯·æ±‚AI...", "æ­£åœ¨ç”Ÿæˆæ€»ç»“ (2/3)...");
        }
        
        // 2.2 å‘é€è¯·æ±‚
        const { apiKey, baseUrl, model } = preset;
        const response = await fetch(`${baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: model,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                ],
                temperature: 0.7,  // è®©æ€»ç»“æ›´å®¢è§‚
                max_tokens: 8000    // æ§åˆ¶æ€»ç»“é•¿åº¦
            })
        });
        
        // 2.3 æ£€æŸ¥å“åº”
        if (!response.ok) {
            throw new Error(`APIé”™è¯¯: ${response.status}`);
        }
        
        const data = await response.json();
        
        // 2.4 æå–æ€»ç»“å†…å®¹
        const summaryText = data.choices[0].message.content.trim();
        
        // 2.5 æ›´æ–°UIï¼ˆå¦‚æœæœ‰å›è°ƒï¼‰
        if (updateUiCallback) {
            updateUiCallback("æ€»ç»“å®Œæˆ", "æ­£åœ¨ä¿å­˜ (3/3)...");
        }
        
        return summaryText;
        
    } catch (error) {
        console.error('è°ƒç”¨AIå¤±è´¥:', error);
        throw error;
    }
}
// ======================================================
// ã€æ–°åŠŸèƒ½3ã€‘æ‰§è¡Œæ€»ç»“çš„æ ¸å¿ƒé€»è¾‘ï¼ˆæ‰‹åŠ¨å’Œè‡ªåŠ¨å…±ç”¨ï¼‰
// ======================================================
async function executeSummary(contactId, updateUiCallback = null) {
    // 1. è·å–APIé…ç½®
    const preset = await getActiveSummaryApiPreset();
    if (preset.error) {
        throw new Error(preset.error);
    }
    
    // 2. è·å–è”ç³»äººæ•°æ®
    const contact = await db.contacts.get(contactId);
    if (!contact) {
        throw new Error("æ‰¾ä¸åˆ°è”ç³»äºº");
    }
    
    const settings = contact.summarySettings || { lastSummaryTurn: 0 };
    const lastSummaryTurn = settings.lastSummaryTurn || 0;
    const existingSummary = contact.aiSummaryText || "æ— ";
    
    // 3. è·å–è§’è‰²åå’Œç”¨æˆ·å
    const roleName = contact.name;
    let userName = "ç”¨æˆ·";
    if (contact.myPersonaPresetId) {
        const myPreset = await db.my_persona_presets.get(contact.myPersonaPresetId);
        if (myPreset && myPreset.name) userName = myPreset.name;
    }
    
    // 4. è®¡ç®—è½®æ•°
    if (updateUiCallback) {
        updateUiCallback("æ­£åœ¨è®¡ç®—...", "æ­£åœ¨æ„å»ºè½®æ¬¡ (1/3)...");
    }
    
    const { totalTurns, turnBlocks } = await calculateGoldenStandardTurns(contactId);
    const unsummarizedBlocks = turnBlocks.slice(lastSummaryTurn);
    
    // 5. æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
    if (unsummarizedBlocks.length === 0) {
        throw new Error("No new messages");
    }
    
    // 6. è°ƒç”¨AIç”Ÿæˆæ€»ç»“
    const newContentString = await runSummaryGeneration(
       contactId, 
      unsummarizedBlocks,
        preset,
        roleName,
        userName,
        existingSummary,
        updateUiCallback
    );
    
    // 7. ä¿å­˜æ€»ç»“
    const finalSummary = (existingSummary === "æ— " ? "" : existingSummary + "\n\n") + newContentString;
    
    await db.contacts.update(contactId, {
        aiSummaryText: finalSummary
    });
    
    await saveSummarySetting('lastSummaryTurn', totalTurns);
    
    // 8. æ›´æ–°UIï¼ˆå¦‚æœåœ¨æ€»ç»“é¡µé¢ï¼‰
    if (updateUiCallback) {
        summaryTextarea.value = finalSummary;
        await updateSummaryStats(contactId);
    }
}
// ======================================================
// ã€æ–°åŠŸèƒ½4ã€‘è‡ªåŠ¨æ€»ç»“æ£€æŸ¥ä¸æ‰§è¡Œ
// ======================================================
async function checkAndRunAutoSummary(contactId) {
    try {
        // 1. è·å–è”ç³»äººè®¾ç½®
        const contact = await db.contacts.get(contactId);
        if (!contact) return;
        
        const settings = contact.summarySettings || { auto: false };
        
        // 2. æ£€æŸ¥æ˜¯å¦å¼€å¯äº†è‡ªåŠ¨æ€»ç»“
        if (!settings.auto) {
            console.log('â¸ï¸ è‡ªåŠ¨æ€»ç»“æœªå¼€å¯');
            return;
        }
        
        // 3. è®¡ç®—å½“å‰è½®æ•°
        const { totalTurns } = await calculateGoldenStandardTurns(contactId);
        const lastSummaryTurn = settings.lastSummaryTurn || 0;
        const triggerRounds = settings.rounds || 20;
        
        // 4. åˆ¤æ–­æ˜¯å¦è¾¾åˆ°è§¦å‘æ¡ä»¶
        const unsummarizedTurns = totalTurns - lastSummaryTurn;
        
        if (unsummarizedTurns < triggerRounds) {
            console.log(`â³ è‡ªåŠ¨æ€»ç»“: æœªè¾¾åˆ°è§¦å‘æ¡ä»¶ (${unsummarizedTurns}/${triggerRounds})`);
            return;
        }
        
        // 5. è§¦å‘æ¡ä»¶æ»¡è¶³ï¼å¼€å§‹æ‰§è¡Œ
        console.log(`ğŸ¤– è‡ªåŠ¨æ€»ç»“è§¦å‘: å·²ç´¯ç§¯ ${unsummarizedTurns} è½®æœªæ€»ç»“`);
        
        // 6. é™é»˜æ‰§è¡Œæ€»ç»“ï¼ˆä¸ä¼ UIå›è°ƒï¼‰
        await executeSummary(contactId, null);
        
        console.log('âœ… è‡ªåŠ¨æ€»ç»“å®Œæˆ');
        
    } catch (error) {
        // é™é»˜å¤±è´¥ï¼Œä¸æ‰“æ‰°ç”¨æˆ·
        console.error('âŒ è‡ªåŠ¨æ€»ç»“å¤±è´¥:', error);
    }
}

summaryManualBtn.addEventListener('click', async () => {
    if (!currentSummaryContactId) return;
    
    // 1. UIåé¦ˆ
    summaryManualBtn.disabled = true;
    summaryManualBtn.textContent = "æ­£åœ¨åˆ†æ...";
    
    // 2. UIæ›´æ–°å›è°ƒå‡½æ•°
    const updateUi = (btnText, statsText) => {
        summaryManualBtn.textContent = btnText;
        summaryStatsDisplay.textContent = statsText;
    };
    
    try {
        // 3. è°ƒç”¨æ€»ç»“é€»è¾‘ï¼ˆå¤ç”¨æ ¸å¿ƒå‡½æ•°ï¼‰
        await executeSummary(currentSummaryContactId, updateUi);
        
        alert("æ€»ç»“å®Œæˆï¼");
        
    } catch (error) {
        if (error.message !== "No new messages") {
            alert(`æ€»ç»“å¤±è´¥: ${error.message}`);
        }
    } finally {
        // 4. é‡ç½®æŒ‰é’®
        summaryManualBtn.disabled = false;
        summaryManualBtn.textContent = "ç«‹å³æ‰‹åŠ¨æ€»ç»“ (æœªæ€»ç»“éƒ¨åˆ†)";
    }
});

// 1. è¡¨æƒ…åŒ…åº“æ‰‹é£ç´çš„å±•å¼€/æŠ˜å 
const stickerAccordionHeader = document.querySelector('#sticker-accordion-header');
const stickerAccordionContent = document.querySelector('#sticker-accordion-content');

if (stickerAccordionHeader) {
    stickerAccordionHeader.addEventListener('click', async () => {
        stickerAccordionHeader.classList.toggle('expanded');
        stickerAccordionContent.classList.toggle('expanded');
        
        // å±•å¼€æ—¶åŠ è½½è¡¨æƒ…åº“åˆ—è¡¨
        if (stickerAccordionContent.classList.contains('expanded')) {
            await renderStickerLibraries();
        }
    });
}




const importStickerBtn = document.querySelector('#import-sticker-btn');
if (importStickerBtn) {
    importStickerBtn.addEventListener('click', () => {
        const popup = document.querySelector('#import-sticker-popup');
        
        // å…³é”®ä¿®å¤ï¼šæŠŠå¼¹çª—ç§»åˆ° body ä¸‹é¢ï¼ˆè„±ç¦» phone-screenï¼‰
        document.body.appendChild(popup);
        
        // ç„¶åå†è®¾ç½®æ ·å¼
        popup.style.position = 'fixed';
        popup.style.top = '0';
        popup.style.left = '0';
        popup.style.width = '100vw';
        popup.style.height = '100vh';
        popup.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
        popup.style.display = 'flex';
        popup.style.justifyContent = 'center';
        popup.style.alignItems = 'center';
        popup.style.zIndex = '999999';
        
        popup.classList.remove('hidden');
        
        const content = popup.querySelector('.popup-content');
        if (content) {
            content.style.backgroundColor = '#ffffff';
            content.style.padding = '20px 25px';
            content.style.borderRadius = '25px';
            content.style.maxWidth = '320px';
            content.style.maxHeight = '500px';
            content.style.overflowY = 'auto';
        }
        
        document.querySelector('#sticker-library-name-input').value = '';
        document.querySelector('#sticker-batch-input').value = '';
         //  ç›‘å¬è¾“å…¥æ¡†çš„å˜åŒ–
        const batchInput = document.querySelector('#sticker-batch-input');
        if (batchInput) {
            // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
            batchInput.removeEventListener('input', updateStickerPreview);
            // æ·»åŠ æ–°çš„ç›‘å¬å™¨
            batchInput.addEventListener('input', updateStickerPreview);
        }
        
        // æ¸…ç©ºé¢„è§ˆ
        document.querySelector('#sticker-preview-grid').innerHTML = '<p style="font-size: 12px; color: #999; text-align: center; grid-column: 1 / -1;">è¾“å…¥é“¾æ¥åè‡ªåŠ¨é¢„è§ˆ</p>';
        document.querySelector('#preview-count').textContent = '0';
      
    });
}



// 5. å¯¼å…¥å¼¹çª— - å–æ¶ˆ/å…³é—­
const importStickerCancelBtn = document.querySelector('#import-sticker-cancel-btn');
if (importStickerCancelBtn) {
    importStickerCancelBtn.addEventListener('click', () => {
        document.querySelector('#import-sticker-popup').classList.add('hidden');
    });
}

const importStickerCloseBtn = document.querySelector('#import-sticker-close-btn');
if (importStickerCloseBtn) {
    importStickerCloseBtn.addEventListener('click', () => {
        document.querySelector('#import-sticker-popup').classList.add('hidden');
    });
}

// 6. å¯¼å…¥å¼¹çª— - ç¡®è®¤å¯¼å…¥
const importStickerConfirmBtn = document.querySelector('#import-sticker-confirm-btn');
if (importStickerConfirmBtn) {
    importStickerConfirmBtn.addEventListener('click', async () => {
        const name = document.querySelector('#sticker-library-name-input').value.trim();
        const batchText = document.querySelector('#sticker-batch-input').value.trim();
        
        if (!name) {
            alert('è¯·è¾“å…¥è¡¨æƒ…åŒ…åº“åç§°ï¼');
            return;
        }
        
        if (!batchText) {
            alert('è¯·ç²˜è´´è¡¨æƒ…åŒ…é“¾æ¥ï¼');
            return;
        }
        
        // è§£ææ–‡æœ¬
        const stickers = parseStickerBatchInput(batchText);
        
        if (stickers.length === 0) {
            alert('æ²¡æœ‰è§£æåˆ°æœ‰æ•ˆçš„è¡¨æƒ…åŒ…ï¼\nè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
            return;
        }
        
        try {
            // åˆ›å»ºæ–°åº“
            const libraryId = await db.sticker_libraries.add({ name });
            
            // æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…
            for (const sticker of stickers) {
                await db.stickers.add({
                    libraryId: libraryId,
                    text: sticker.text,
                    url: sticker.url
                });
            }
            
            alert(`æˆåŠŸå¯¼å…¥ ${stickers.length} ä¸ªè¡¨æƒ…åŒ…ï¼`);
            
            // å…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
            document.querySelector('#import-sticker-popup').classList.add('hidden');
            await renderStickerLibraries();
            
        } catch (error) {
            console.error('å¯¼å…¥å¤±è´¥:', error);
            alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚');
        }
    });
}



// 8. é€‰æ‹©å¼¹çª— - ç¡®è®¤
const selectStickerConfirmBtn = document.querySelector('#select-sticker-confirm-btn');
if (selectStickerConfirmBtn) {
    selectStickerConfirmBtn.addEventListener('click', () => {
        saveStickerSelection();
    });
}

// 9. è¡¨æƒ…åº“åˆ—è¡¨ - æŸ¥çœ‹/åˆ é™¤æŒ‰é’®
const stickerLibrariesContainer = document.querySelector('#sticker-libraries-container');
if (stickerLibrariesContainer) {
    stickerLibrariesContainer.addEventListener('click', async (e) => {
        const libraryId = parseInt(e.target.dataset.libraryId);
        
        if (e.target.classList.contains('sticker-view-btn')) {
            // ã€ä¿®æ”¹ã€‘è°ƒç”¨æŸ¥çœ‹åŠŸèƒ½
            await viewStickerLibrary(libraryId);
        }
        
        if (e.target.classList.contains('sticker-delete-btn')) {
            await deleteStickerLibrary(libraryId);
        }
    });
}

      //  æŸ¥çœ‹å¼¹çª— - å…³é—­
const viewStickerCloseBtn = document.querySelector('#view-sticker-close-btn');
if (viewStickerCloseBtn) {
    viewStickerCloseBtn.addEventListener('click', () => {
        document.querySelector('#view-sticker-popup').classList.add('hidden');
    });
}

const viewStickerCloseBtn2 = document.querySelector('#view-sticker-close-btn2');
if (viewStickerCloseBtn2) {
    viewStickerCloseBtn2.addEventListener('click', () => {
        document.querySelector('#view-sticker-popup').classList.add('hidden');
    });
}
// ======================================================
// ã€æ–°åŠŸèƒ½ã€‘èŠå¤©æ—¶å‘é€è¡¨æƒ…åŒ…
// ======================================================

let currentActiveStickerTab = null; // å½“å‰é€‰ä¸­çš„è¡¨æƒ…åº“ID
let stickerSearchTimeout = null;

// 1. åŠ è½½è¡¨æƒ…é¢æ¿çš„æ ‡ç­¾é¡µ
async function loadStickerPanelTabs() {
    const tabsContainer = document.querySelector('#sticker-panel-tabs');
    const libraries = await db.sticker_libraries.toArray();
    
    if (libraries.length === 0) {
        tabsContainer.innerHTML = '<p style="font-size: 12px; color: #999;">æš‚æ— è¡¨æƒ…åŒ…åº“</p>';
        return;
    }
    
    tabsContainer.innerHTML = '';
    
    // ä¸ºæ¯ä¸ªè¡¨æƒ…åº“åˆ›å»ºæ ‡ç­¾
    libraries.forEach((library, index) => {
        const tab = document.createElement('button');
        tab.className = 'sticker-tab';
        tab.textContent = library.name;
        tab.dataset.libraryId = library.id;
        
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
        if (index === 0) {
            tab.classList.add('active');
            currentActiveStickerTab = library.id;
        }
        
        // ç‚¹å‡»åˆ‡æ¢æ ‡ç­¾
        tab.addEventListener('click', async () => {
            // ç§»é™¤å…¶ä»–æ ‡ç­¾çš„active
            tabsContainer.querySelectorAll('.sticker-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            currentActiveStickerTab = library.id;
            await loadStickerPanelContent(library.id);
        });
        
        tabsContainer.appendChild(tab);
    });
    
    // åŠ è½½ç¬¬ä¸€ä¸ªåº“çš„å†…å®¹
    if (libraries.length > 0) {
        await loadStickerPanelContent(libraries[0].id);
    }
}

// 2. åŠ è½½è¡¨æƒ…é¢æ¿çš„å†…å®¹
async function loadStickerPanelContent(libraryId, searchQuery = '') {
    const contentContainer = document.querySelector('#sticker-panel-content');
    
    let stickers;
    if (searchQuery) {
        // æœç´¢æ¨¡å¼ï¼šåœ¨å½“å‰åº“ä¸­æœç´¢
        stickers = await db.stickers
            .where('libraryId').equals(libraryId)
            .filter(s => s.text.includes(searchQuery))
            .toArray();
    } else {
        // æ­£å¸¸æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰è¡¨æƒ…
        stickers = await db.stickers.where('libraryId').equals(libraryId).toArray();
    }
    
    if (stickers.length === 0) {
        contentContainer.innerHTML = '<p style="font-size: 12px; color: #999; text-align: center; grid-column: 1 / -1;">æ— åŒ¹é…çš„è¡¨æƒ…åŒ…</p>';
        return;
    }
    
    contentContainer.innerHTML = '';
    
    stickers.forEach(sticker => {
        const item = document.createElement('div');
        item.className = 'sticker-panel-item';
        item.innerHTML = `
            <img src="${sticker.url}" alt="${sticker.text}" class="sticker-panel-img" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect fill=\'%23f0f0f0\' width=\'60\' height=\'60\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-size=\'10\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EåŠ è½½å¤±è´¥%3C/text%3E%3C/svg%3E'">
            <span class="sticker-panel-text">${sticker.text}</span>
        `;
        
        // ç‚¹å‡»å‘é€è¡¨æƒ…åŒ…
        item.addEventListener('click', async () => {
            await sendStickerMessage(sticker);
            // å‘é€åå…³é—­é¢æ¿
            document.querySelector('#sticker-panel').classList.add('hidden');
        });
        
        contentContainer.appendChild(item);
    });
}

// 3. å‘é€è¡¨æƒ…åŒ…æ¶ˆæ¯
async function sendStickerMessage(sticker) {
    if (!currentOpenContactId) return;
    
    // ã€ç«‹å³ã€‘å…³é—­è¡¨æƒ…é¢æ¿
    const panel = document.querySelector('#sticker-panel');
    if (panel) {
        panel.classList.add('hidden');
    }
    
    // ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆä½¿ç”¨ç‰¹æ®Šæ ¼å¼æ ‡è®°ä¸ºè¡¨æƒ…åŒ…ï¼‰
    const message = {
        contactId: currentOpenContactId,
        sender: 'user',
        text: `[STICKER]${sticker.url}|||${sticker.text}`,
        timestamp: new Date()
    };
    
    await db.chatMessages.add(message);
    
    // æ·»åŠ åˆ°UIï¼ˆä½¿ç”¨ä¿®æ”¹åçš„ addMessageToUIï¼‰
    addMessageToUI('user', `[STICKER]${sticker.url}|||${sticker.text}`);
    
    // åˆ·æ–°è”ç³»äººåˆ—è¡¨
    renderContactList();
    
    // ã€åˆ é™¤ã€‘ä¸å†è‡ªåŠ¨è°ƒç”¨ AI å›å¤
    // ç”¨æˆ·éœ€è¦ç‚¹å‡»"æ¥æ”¶"æŒ‰é’®æ‰ä¼šè§¦å‘å›å¤
}



// 4. åœ¨UIä¸­æ˜¾ç¤ºè¡¨æƒ…åŒ…
function addStickerToUI(sender, url, text) {
    const messageEl = document.createElement('div');
    messageEl.classList.add('message-bubble');
    messageEl.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
    messageEl.innerHTML = `<img src="${url}" alt="${text}" class="message-sticker">`;
    messageContainer.appendChild(messageEl);
    messageContainer.scrollTop = messageContainer.scrollHeight;
}



// ======================================================
//  è¡¨æƒ…é¢æ¿ç›¸å…³äº‹ä»¶
// ======================================================

// 1. è¡¨æƒ…æŒ‰é’® - åˆ‡æ¢é¢æ¿æ˜¾ç¤º/éšè—
const stickerToggleBtn = document.querySelector('#sticker-toggle-btn');
if (stickerToggleBtn) {
    stickerToggleBtn.addEventListener('click', async () => {
        const panel = document.querySelector('#sticker-panel');
        
        if (panel.classList.contains('hidden')) {
            // æ‰“å¼€é¢æ¿
            await loadStickerPanelTabs();
            panel.classList.remove('hidden');
        } else {
            // å…³é—­é¢æ¿
            panel.classList.add('hidden');
        }
    });
}

// 2. æœç´¢æ¡† - å®æ—¶æœç´¢
const stickerSearchInput = document.querySelector('#sticker-search-input');
if (stickerSearchInput) {
    stickerSearchInput.addEventListener('input', () => {
        clearTimeout(stickerSearchTimeout);
        
        stickerSearchTimeout = setTimeout(async () => {
            const query = stickerSearchInput.value.trim();
            if (currentActiveStickerTab) {
                await loadStickerPanelContent(currentActiveStickerTab, query);
            }
        }, 300);
    });
}

// ç›‘å¬å›è½¦é”®å‘é€ç”¨æˆ·æ¶ˆæ¯
chatInputBox.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
        const text = chatInputBox.value.trim();
        if (!text || !currentOpenContactId) return;
        
        // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        const userMessage = { 
            contactId: currentOpenContactId, 
            sender: 'user', 
            text: text, 
            timestamp: new Date() 
        };
        await db.chatMessages.add(userMessage);
        
        // æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
        addMessageToUI('user', text);
        chatInputBox.value = '';
        renderContactList();
    }
});

// æ¶ˆæ¯ç¼–è¾‘å¼¹çª— - å–æ¶ˆæŒ‰é’®
const messageEditCancelBtn = document.querySelector('#message-edit-cancel-btn');
if (messageEditCancelBtn) {
    messageEditCancelBtn.addEventListener('click', closeMessageEditPopup);
} else {
    console.error('æ‰¾ä¸åˆ° #message-edit-cancel-btn');
}

// æ¶ˆæ¯ç¼–è¾‘å¼¹çª— - å…³é—­æŒ‰é’®
const messageEditCloseBtn = document.querySelector('#message-edit-close-btn');
if (messageEditCloseBtn) {
    messageEditCloseBtn.addEventListener('click', closeMessageEditPopup);
} else {
    console.error('æ‰¾ä¸åˆ° #message-edit-close-btn');
}

// æ¶ˆæ¯ç¼–è¾‘å¼¹çª— - ç‚¹å‡»èƒŒæ™¯å…³é—­
const messageEditPopup = document.querySelector('#message-edit-popup');
if (messageEditPopup) {
    messageEditPopup.addEventListener('click', (e) => {
        if (e.target === messageEditPopup) closeMessageEditPopup();
    });
} else {
    console.error('æ‰¾ä¸åˆ° #message-edit-popup');
}

// æ¶ˆæ¯ç¼–è¾‘å¼¹çª— - ä¿å­˜æŒ‰é’®
const messageEditSaveBtn = document.querySelector('#message-edit-save-btn');
if (messageEditSaveBtn) {
    messageEditSaveBtn.addEventListener('click', async () => {
        if (!currentEditingMessageId) {
            alert('é”™è¯¯ï¼šæ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„æ¶ˆæ¯ï¼');
            return;
        }
        
        const newText = document.querySelector('#message-edit-textarea').value.trim();
        
        if (!newText) {
            alert('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }
        
        try {
            // æ›´æ–°æ•°æ®åº“
            await db.chatMessages.update(currentEditingMessageId, { text: newText });
            
            // æ›´æ–°UI
            const messageEl = messageContainer.querySelector(`[data-message-id="${currentEditingMessageId}"]`);
            if (messageEl) {
                messageEl.textContent = newText;
            }
            
            alert('ä¿®æ”¹æˆåŠŸï¼');
            closeMessageEditPopup();
            
        } catch (error) {
            console.error('ä¿å­˜å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
        }
    });
} else {
    console.error('æ‰¾ä¸åˆ° #message-edit-save-btn');
}
// ======================================================
// ã€æ–°åŠŸèƒ½ã€‘å­—ä½“è®¾ç½® - åªä¿ç•™é»˜è®¤å’Œè‡ªå®šä¹‰
// ======================================================

// 1. æ‰‹é£ç´å±•å¼€/æŠ˜å 
const fontAccordionHeader = document.querySelector('#font-accordion-header');
const fontAccordionContent = document.querySelector('#font-accordion-content');

fontAccordionHeader.addEventListener('click', async () => {
    fontAccordionHeader.classList.toggle('expanded');
    fontAccordionContent.classList.toggle('expanded');
    
    // å±•å¼€æ—¶åŠ è½½é¢„è®¾åˆ—è¡¨
    if (fontAccordionContent.classList.contains('expanded')) {
        await loadFontPresets();
    }
});

// 2. æ»‘å—å®æ—¶æ›´æ–°
document.querySelector('#global-font-size').addEventListener('input', (e) => {
    const value = e.target.value;
    document.querySelector('#global-font-size-value').textContent = value + 'px';
    document.querySelector('#global-font-preview').style.fontSize = value + 'px';
});

document.querySelector('#chat-font-size').addEventListener('input', (e) => {
    const value = e.target.value;
    document.querySelector('#chat-font-size-value').textContent = value + 'px';
    document.querySelector('#chat-font-preview').style.fontSize = value + 'px';
});

// 3. åŠ è½½å­—ä½“é¢„è®¾åˆ—è¡¨
async function loadFontPresets() {
    const select = document.querySelector('#font-preset-select');
    select.innerHTML = `
        <option value="default">é»˜è®¤</option>
        <option value="custom">--- æ–°å»ºè‡ªå®šä¹‰é¢„è®¾ ---</option>
    `;
    
    // ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿å­˜çš„é¢„è®¾
    const savedPresets = await db.settings.get('fontPresets');
    if (savedPresets && savedPresets.value && savedPresets.value.length > 0) {
        savedPresets.value.forEach(preset => {
            const option = document.createElement('option');
            option.value = 'saved_' + preset.id;
            option.textContent = preset.name + ' â­';
            select.appendChild(option);
        });
    }
    
    // æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„é¢„è®¾
    const lastPreset = await db.settings.get('activeFontPreset');
    if (lastPreset) {
        select.value = lastPreset.value;
        // è§¦å‘ä¸€æ¬¡changeäº‹ä»¶æ¥åº”ç”¨å­—ä½“
        await applyFontPreset(lastPreset.value);
    }
}

// 4. åº”ç”¨å­—ä½“é¢„è®¾
async function applyFontPreset(presetValue) {
    const globalUrl = document.querySelector('#global-font-url');
    const globalName = document.querySelector('#global-font-name');
    const globalSize = document.querySelector('#global-font-size');
    const chatUrl = document.querySelector('#chat-font-url');
    const chatName = document.querySelector('#chat-font-name');
    const chatSize = document.querySelector('#chat-font-size');
    
    if (presetValue === 'default') {
        // é»˜è®¤å­—ä½“
        globalUrl.value = '';
        globalName.value = 'sans-serif';
        globalSize.value = 16;
        chatUrl.value = '';
        chatName.value = '';
        chatSize.value = 16;
        
    } else if (presetValue.startsWith('saved_')) {
        // ç”¨æˆ·ä¿å­˜çš„è‡ªå®šä¹‰é¢„è®¾
        const presetId = presetValue.replace('saved_', '');
        const savedPresets = await db.settings.get('fontPresets');
        const preset = savedPresets.value.find(p => p.id === presetId);
        
        if (preset) {
            globalUrl.value = preset.globalUrl || '';
            globalName.value = preset.globalName || 'sans-serif';
            globalSize.value = preset.globalSize || 16;
            chatUrl.value = preset.chatUrl || '';
            chatName.value = preset.chatName || '';
            chatSize.value = preset.chatSize || 16;
        }
    } else if (presetValue === 'custom') {
        // æ–°å»ºè‡ªå®šä¹‰ï¼ˆæ¸…ç©ºè¡¨å•ï¼‰
        globalUrl.value = '';
        globalName.value = '';
        globalSize.value = 16;
        chatUrl.value = '';
        chatName.value = '';
        chatSize.value = 16;
    }
    
    // æ›´æ–°æ»‘å—æ˜¾ç¤ºå’Œé¢„è§ˆ
    document.querySelector('#global-font-size-value').textContent = globalSize.value + 'px';
    document.querySelector('#chat-font-size-value').textContent = chatSize.value + 'px';
    document.querySelector('#global-font-preview').style.fontSize = globalSize.value + 'px';
    document.querySelector('#chat-font-preview').style.fontSize = chatSize.value + 'px';
    
    // åº”ç”¨å­—ä½“
    applyFontsToPage();
}

// 5. å­—ä½“é¢„è®¾åˆ‡æ¢
document.querySelector('#font-preset-select').addEventListener('change', async (e) => {
    await applyFontPreset(e.target.value);
});

// 6. ä¿å­˜å­—ä½“è®¾ç½®æŒ‰é’®
document.querySelector('#font-save-btn').addEventListener('click', async () => {
    const presetSelect = document.querySelector('#font-preset-select');
    const currentPreset = presetSelect.value;
    
    const fontData = {
        globalUrl: document.querySelector('#global-font-url').value,
        globalName: document.querySelector('#global-font-name').value,
        globalSize: document.querySelector('#global-font-size').value,
        chatUrl: document.querySelector('#chat-font-url').value,
        chatName: document.querySelector('#chat-font-name').value,
        chatSize: document.querySelector('#chat-font-size').value
    };
    
    // å¦‚æœæ˜¯"æ–°å»ºè‡ªå®šä¹‰"ï¼Œéœ€è¦ä¿å­˜ä¸ºæ–°é¢„è®¾
    if (currentPreset === 'custom') {
        const presetName = prompt('è¯·ä¸ºè¿™ä¸ªå­—ä½“æ–¹æ¡ˆèµ·ä¸ªåå­—ï¼š', 'æˆ‘çš„å­—ä½“æ–¹æ¡ˆ');
        if (!presetName) return;
        
        // ç”Ÿæˆå”¯ä¸€ID
        const presetId = 'preset_' + Date.now();
        
        // è·å–ç°æœ‰é¢„è®¾
        const savedPresets = await db.settings.get('fontPresets');
        const presets = savedPresets ? savedPresets.value : [];
        
        // æ·»åŠ æ–°é¢„è®¾
        presets.push({
            id: presetId,
            name: presetName,
            ...fontData
        });
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        await db.settings.put({ key: 'fontPresets', value: presets });
        await db.settings.put({ key: 'activeFontPreset', value: 'saved_' + presetId });
        
        alert('å­—ä½“æ–¹æ¡ˆå·²ä¿å­˜ï¼');
        await loadFontPresets();
        
    } else if (currentPreset.startsWith('saved_')) {
        // æ›´æ–°å·²æœ‰çš„è‡ªå®šä¹‰é¢„è®¾
        const presetId = currentPreset.replace('saved_', '');
        const savedPresets = await db.settings.get('fontPresets');
        const presets = savedPresets.value;
        
        const index = presets.findIndex(p => p.id === presetId);
        if (index !== -1) {
            presets[index] = {
                ...presets[index],
                ...fontData
            };
            
            await db.settings.put({ key: 'fontPresets', value: presets });
            await db.settings.put({ key: 'activeFontPreset', value: currentPreset });
            alert('å­—ä½“æ–¹æ¡ˆå·²æ›´æ–°ï¼');
        }
        
    } else {
        // é»˜è®¤é¢„è®¾ï¼Œç›´æ¥ä¿å­˜ä¸ºæ¿€æ´»çŠ¶æ€
        await db.settings.put({ key: 'activeFontPreset', value: currentPreset });
        alert('å­—ä½“è®¾ç½®å·²ä¿å­˜ï¼');
    }
    
    // åº”ç”¨å­—ä½“
    applyFontsToPage();
});

// 7. æ¢å¤é»˜è®¤æŒ‰é’®
document.querySelector('#font-reset-btn').addEventListener('click', async () => {
    const presetSelect = document.querySelector('#font-preset-select');
    const currentPreset = presetSelect.value;
    
    // å¦‚æœæ˜¯è‡ªå®šä¹‰é¢„è®¾ï¼Œæä¾›åˆ é™¤é€‰é¡¹
    if (currentPreset.startsWith('saved_')) {
        const choice = confirm('è¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰æ–¹æ¡ˆå—ï¼Ÿ\nç‚¹"ç¡®å®š"åˆ é™¤ï¼Œç‚¹"å–æ¶ˆ"åªé‡ç½®å½“å‰è®¾ç½®');
        
        if (choice) {
            // åˆ é™¤è¿™ä¸ªé¢„è®¾
            const presetId = currentPreset.replace('saved_', '');
            const savedPresets = await db.settings.get('fontPresets');
            const presets = savedPresets.value.filter(p => p.id !== presetId);
            
            await db.settings.put({ key: 'fontPresets', value: presets });
            await db.settings.put({ key: 'activeFontPreset', value: 'default' });
            
            alert('å·²åˆ é™¤è¯¥æ–¹æ¡ˆï¼');
            await loadFontPresets();
            await applyFontPreset('default');
            return;
        }
    }
    
    // æ¢å¤é»˜è®¤
    await db.settings.put({ key: 'activeFontPreset', value: 'default' });
    await applyFontPreset('default');
    applyFontsToPage();
    
    alert('å·²æ¢å¤é»˜è®¤å­—ä½“ï¼');
});

// 8. åº”ç”¨å­—ä½“åˆ°é¡µé¢
function applyFontsToPage() {
    const globalName = document.querySelector('#global-font-name').value || 'sans-serif';
    const globalSize = document.querySelector('#global-font-size').value || '16';
    const chatName = document.querySelector('#chat-font-name').value || globalName;
    const chatSize = document.querySelector('#chat-font-size').value || globalSize;
    
    // åº”ç”¨å…¨å±€å­—ä½“
    document.body.style.fontFamily = globalName;
    document.body.style.fontSize = globalSize + 'px';
    
    // åº”ç”¨èŠå¤©å­—ä½“
    const messageContainer = document.querySelector('.message-container');
    if (messageContainer) {
        messageContainer.style.fontFamily = chatName;
        messageContainer.style.fontSize = chatSize + 'px';
    }
    
    // æ›´æ–°é¢„è§ˆ
    const globalPreview = document.querySelector('#global-font-preview');
    const chatPreview = document.querySelector('#chat-font-preview');
    
    if (globalPreview) {
        globalPreview.style.fontFamily = globalName;
        globalPreview.style.fontSize = globalSize + 'px';
    }
    
    if (chatPreview) {
        chatPreview.style.fontFamily = chatName || globalName;
        chatPreview.style.fontSize = chatSize + 'px';
    }
}

// 9. é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„å­—ä½“
(async () => {
    const lastPreset = await db.settings.get('activeFontPreset');
    if (lastPreset) {
        await applyFontPreset(lastPreset.value);
    }
})();

// "æ˜¯å¦æ˜¾ç¤ºå¤´åƒ"å¼€å…³
contactSettingsAvatarToggle.addEventListener('click', () => {
    contactSettingsAvatarToggle.classList.toggle('active');
});

// ======================================================
// ã€æ–°åŠŸèƒ½ã€‘æ’¤å›AIæœ€æ–°å›å¤å¹¶é‡æ–°ç”Ÿæˆ
// ======================================================
const retractBtn = document.querySelector('#retract-btn');
if (retractBtn) {
    retractBtn.addEventListener('click', async () => {
        if (!currentOpenContactId) {
            alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªå¯¹è¯ï¼');
            return;
        }
        
        // 1. è·å–æœ€æ–°çš„æ¶ˆæ¯
        const messages = await db.chatMessages
            .where('contactId').equals(currentOpenContactId)
            .reverse()
            .toArray();
        
        if (messages.length === 0) {
            alert('å½“å‰æ²¡æœ‰æ¶ˆæ¯å¯ä»¥æ’¤å›ï¼');
            return;
        }
        
        // 2. æ‰¾åˆ°æœ€æ–°çš„AIå›å¤
        let lastBotMessageIndex = -1;
        for (let i = 0; i < messages.length; i++) {
            if (messages[i].sender === 'bot') {
                lastBotMessageIndex = i;
                break; // æ‰¾åˆ°ç¬¬ä¸€ä¸ªï¼ˆä¹Ÿå°±æ˜¯æœ€æ–°çš„ï¼‰å°±åœæ­¢
            }
        }
        
        if (lastBotMessageIndex === -1) {
            alert('æ²¡æœ‰æ‰¾åˆ°AIçš„å›å¤å¯ä»¥æ’¤å›ï¼');
            return;
        }
        
        // 3. ç¡®è®¤æ’¤å›
        if (!confirm('ç¡®å®šè¦æ’¤å›AIçš„æœ€æ–°å›å¤å—ï¼Ÿ\næ’¤å›åä¼šç«‹å³é‡æ–°ç”Ÿæˆå›å¤ã€‚')) {
            return;
        }
        
        // 4. åˆ é™¤æœ€æ–°çš„AIå›å¤ï¼ˆå¯èƒ½æ˜¯å¤šæ¡æ¶ˆæ¯ï¼‰
        const lastBotMessage = messages[lastBotMessageIndex];
        const lastBotTimestamp = lastBotMessage.timestamp;
        
        // æ‰¾å‡ºæ‰€æœ‰å’Œè¿™æ¡æ¶ˆæ¯åŒä¸€æ—¶é—´ç”Ÿæˆçš„AIæ¶ˆæ¯ï¼ˆå› ä¸ºAIå¯èƒ½ä¸€æ¬¡å›å¤å¤šæ¡ï¼‰
        const messagesToDelete = messages.filter(msg => 
            msg.sender === 'bot' && 
            Math.abs(new Date(msg.timestamp) - new Date(lastBotTimestamp)) < 5000 // 5ç§’å†…çš„ç®—åŒä¸€æ‰¹
        );
        
        // 5. ä»æ•°æ®åº“åˆ é™¤
        for (const msg of messagesToDelete) {
            await db.chatMessages.delete(msg.id);
        }
        
    // 6. ã€ä¿®å¤ã€‘ä»UIä¸­ç§»é™¤æ¶ˆæ¯ï¼ˆå…¼å®¹æœ‰å¤´åƒå’Œæ— å¤´åƒä¸¤ç§æƒ…å†µï¼‰
const allBubbles = Array.from(messageContainer.querySelectorAll('.message-bubble'));
let deletedCount = 0;

// ä»åå¾€å‰éå†ï¼ˆé¿å…åˆ é™¤æ—¶ç´¢å¼•å˜åŒ–ï¼‰
for (let i = allBubbles.length - 1; i >= 0 && deletedCount < messagesToDelete.length; i--) {
    const bubble = allBubbles[i];
    
    // åªåˆ é™¤AIçš„æ¶ˆæ¯
    if (bubble.classList.contains('bot-message')) {
        // æ£€æŸ¥æ˜¯å¦æœ‰å¤´åƒå®¹å™¨ï¼ˆmessageWrapperï¼‰
        const wrapper = bubble.closest('div[style*="display: flex"]');
        
        if (wrapper && wrapper !== messageContainer) {
            // æœ‰å¤´åƒï¼šåˆ é™¤æ•´ä¸ªwrapper
            wrapper.remove();
        } else {
            // æ²¡æœ‰å¤´åƒï¼šç›´æ¥åˆ é™¤æ°”æ³¡
            bubble.remove();
        }
        
        deletedCount++;
    }
}

        
        // 7. æ˜¾ç¤º"æ­£åœ¨é‡æ–°ç”Ÿæˆ..."
        addMessageToUI('bot', '...');
        
        // 8. é‡æ–°è°ƒç”¨AIç”Ÿæˆå›å¤
        const processingId = Date.now();
        try {
            await processAiReply(currentOpenContactId, processingId);
        } catch (error) {
            console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
            // ç§»é™¤"æ­£åœ¨æ€è€ƒ"
            const typingBubble = messageContainer.querySelector('.message-bubble:last-child');
            if (typingBubble && typingBubble.textContent === '...') {
                typingBubble.remove();
            }
            addMessageToUI('bot', 'ï¼ˆé‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç‚¹å‡»"æ¥æ”¶"æŒ‰é’®æ‰‹åŠ¨é‡è¯•ï¼‰');
        }
        
        // 9. åˆ·æ–°è”ç³»äººåˆ—è¡¨
        renderContactList();
    });
}
// ======================================================
// ã€æ–°åŠŸèƒ½ã€‘æƒ…ä¾£å¤´åƒåŠŸèƒ½
// ======================================================


// 1. ç‚¹å‡»"å¯ç”¨æƒ…ä¾£å¤´åƒ"å¼€å…³
contactSettingsCoupleAvatarToggle.addEventListener('click', async () => {
    // ã€å…³é”®ä¿®å¤ã€‘å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å½“å‰è”ç³»äºº
    if (!currentOpenContactId) {
        alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªè”ç³»äººçš„è®¾ç½®é¡µé¢ï¼');
        return;
    }
    
    // åˆ‡æ¢å¼€å…³çŠ¶æ€
    const willBeActive = !contactSettingsCoupleAvatarToggle.classList.contains('active');
    
    if (willBeActive) {
        // ã€å…³é”®ã€‘å¼€å¯æ—¶ï¼Œç«‹å³æ‰“å¼€å¼¹çª—
        contactSettingsCoupleAvatarToggle.classList.add('active');
        await openCoupleAvatarPopup();
    } else {
        // å…³é—­æ—¶ï¼Œç›´æ¥å…³é—­ï¼ˆä¸éœ€è¦å¼¹çª—ï¼‰
        contactSettingsCoupleAvatarToggle.classList.remove('active');
        // åŒæ—¶ä¿å­˜å…³é—­çŠ¶æ€
        await db.contacts.update(currentOpenContactId, {
            coupleAvatarEnabled: false
        });
    }
});

// 2. æ‰“å¼€æƒ…ä¾£å¤´åƒå¼¹çª—
async function openCoupleAvatarPopup() {
    if (!currentOpenContactId) {
        alert('é”™è¯¯ï¼šæ²¡æœ‰å½“å‰è”ç³»äººï¼');
        return;
    }
    
    const contact = await db.contacts.get(currentOpenContactId);
    if (!contact) {
        alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°è”ç³»äººæ•°æ®ï¼');
        return;
    }
    
    // åŠ è½½å·²ä¿å­˜çš„å¤´åƒï¼ˆå¦‚æœæœ‰ï¼‰
    coupleUserAvatarPreview.src = './assets/default-avatar.png';
    coupleBotAvatarPreview.src = './assets/default-avatar.png';
    
    if (contact.coupleUserAvatarFileKey) {
        const userFile = await db.files.get(contact.coupleUserAvatarFileKey);
        if (userFile) {
            coupleUserAvatarPreview.src = URL.createObjectURL(userFile.file);
        }
    }
    
    if (contact.coupleBotAvatarFileKey) {
        const botFile = await db.files.get(contact.coupleBotAvatarFileKey);
        if (botFile) {
            coupleBotAvatarPreview.src = URL.createObjectURL(botFile.file);
        }
    }
    
    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨
    coupleUserAvatarInput.value = '';
    coupleBotAvatarInput.value = '';
    
    // ã€å…³é”®ä¿®å¤ã€‘æŠŠå¼¹çª—ç§»åˆ°bodyä¸‹ï¼Œå¹¶å¼ºåˆ¶è®¾ç½®æ ·å¼
    document.body.appendChild(coupleAvatarPopup);
    coupleAvatarPopup.style.position = 'fixed';
    coupleAvatarPopup.style.top = '0';
    coupleAvatarPopup.style.left = '0';
    coupleAvatarPopup.style.width = '100vw';
    coupleAvatarPopup.style.height = '100vh';
    coupleAvatarPopup.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
    coupleAvatarPopup.style.display = 'flex';
    coupleAvatarPopup.style.justifyContent = 'center';
    coupleAvatarPopup.style.alignItems = 'center';
    coupleAvatarPopup.style.zIndex = '999999';
    
    // ç¡®ä¿å†…å®¹æ¡†ä¹Ÿæ­£ç¡®æ˜¾ç¤º
    const content = coupleAvatarPopup.querySelector('.popup-content');
    if (content) {
        content.style.backgroundColor = '#ffffff';
        content.style.padding = '20px 25px';
        content.style.borderRadius = '25px';
    }
    
    // ç§»é™¤hiddenç±»
    coupleAvatarPopup.classList.remove('hidden');
}


// 3. ç”¨æˆ·å¤´åƒé¢„è§ˆ
coupleUserAvatarInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            coupleUserAvatarPreview.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// 4. AIå¤´åƒé¢„è§ˆ
coupleBotAvatarInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            coupleBotAvatarPreview.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// 5. ä¿å­˜æƒ…ä¾£å¤´åƒ
coupleAvatarSaveBtn.addEventListener('click', async () => {
    if (!currentOpenContactId) return;
    
    const userFile = coupleUserAvatarInput.files[0];
    const botFile = coupleBotAvatarInput.files[0];
    
    if (!userFile || !botFile) {
        alert('è¯·åŒæ—¶ä¸Šä¼ åŒæ–¹çš„å¤´åƒï¼');
        return;
    }
    
    try {
        // ä¿å­˜ç”¨æˆ·å¤´åƒ
        const userFileKey = `couple_user_${Date.now()}`;
        await db.files.put({ key: userFileKey, file: userFile });
        
        // ä¿å­˜AIå¤´åƒ
        const botFileKey = `couple_bot_${Date.now()}`;
        await db.files.put({ key: botFileKey, file: botFile });
        
        // æ›´æ–°æ•°æ®åº“
        await db.contacts.update(currentOpenContactId, {
            coupleUserAvatarFileKey: userFileKey,
            coupleBotAvatarFileKey: botFileKey,
            coupleAvatarEnabled: true
        });
        
        alert('æƒ…ä¾£å¤´åƒå·²ä¿å­˜ï¼');
        coupleAvatarPopup.classList.add('hidden');
        
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
    }
});


// 6. å–æ¶ˆ/å…³é—­æŒ‰é’®ï¼ˆç‚¹å‡»å–æ¶ˆæ—¶ï¼Œä¹Ÿè¦å…³é—­å¼€å…³ï¼‰
coupleAvatarCancelBtn.addEventListener('click', () => {
    coupleAvatarPopup.classList.add('hidden');
    
    // ã€å…³é”®ã€‘å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆï¼Œå°±æŠŠå¼€å…³ä¹Ÿå…³æ‰
    contactSettingsCoupleAvatarToggle.classList.remove('active');
});


coupleAvatarCloseBtn.addEventListener('click', () => {
    coupleAvatarPopup.classList.add('hidden');
    
    // ã€å…³é”®ã€‘å¦‚æœç”¨æˆ·ç‚¹äº†å…³é—­ï¼Œå°±æŠŠå¼€å…³ä¹Ÿå…³æ‰
    contactSettingsCoupleAvatarToggle.classList.remove('active');
});


coupleAvatarPopup.addEventListener('click', (e) => {
    if (e.target === coupleAvatarPopup) {
        coupleAvatarPopup.classList.add('hidden');
        
        // ã€å…³é”®ã€‘å¦‚æœç”¨æˆ·ç‚¹äº†èƒŒæ™¯å…³é—­ï¼Œå°±æŠŠå¼€å…³ä¹Ÿå…³æ‰
        contactSettingsCoupleAvatarToggle.classList.remove('active');
    }
});


//è¿™æ˜¯äº‹ä»¶ç›‘å¬çš„æœ€åº•éƒ¨//  
  </script>
<!--è¿™é‡Œæ˜¯bodyçš„æœ€ä¸‹æ–¹ï¼Œæœ‰éœ€è¦æ·»åŠ çš„åŠŸèƒ½å¯ä»¥ç›´æ¥æœç´¢ï¼Œç„¶åæ·»åŠ åˆ°è¿™ä¸ªæ³¨é‡Šçš„æœ€ä¸Šé¢-->
</body>
</html>